<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>TG-Online v0.9</title>
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
    <style type="text/css">
        .list li {
            display: inline-block;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        a {
            margin: 6px;
            color: #C0C0C0;
        }
        a:link {
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: #666666;
            cursor: pointer;
        }
        .divorderbooks {
            display: block;
        }
        .tblorderbook {
            display: inline-block;
            border: 1px solid black;
            color: grey;
        }
        .th {
            /*font-size: 12px;*/
        }
        .yellowstrippriceup {
            font-size: 36px;
            color: blue;
            background-color: yellow;
        }
        .yellowstrippricedn {
            font-size: 36px;
            color: red;
            background-color: yellow;
        }
        .yellowstrippricenc {
            font-size: 36px;
            color: green;
            background-color: yellow;
        }
        .priceup {
            font-size: 36px;
            color: blue;
        }
        .pricedn {
            font-size: 36px;
            color: red;
        }
        .pricenc {
            font-size: 36px;
            color: green;
        }
        .yellowstripvolup {
            font-size: 18px;
            color: blue;
            background-color: yellow;
        }
        .yellowstripvoldn {
            font-size: 18px;
            color: red;
            background-color: yellow;
        }
        .yellowstripvolnc {
            font-size: 18px;
            color: green;
            background-color: yellow;
        }
        .volup {
            font-size: 18px;
            color: blue;
        }
        .voldn {
            font-size: 18px;
            color: red;
        }
        .volnc {
            font-size: 18px;
            color: green;
        }
    </style>
</head>
<body lang="en">
    <script>
        var sockjs_url = '/echo';
        var sockjs;
        var orderbooks = {};
        var ukx = [];

        var datain = function(msg) {
            try {
                var obj = JSON.parse(msg);

                if ("orderbooks" in obj) {
                    loadOrderBooks(obj.orderbooks);
                } else if ("orderbook" in obj) {
                    updateOrderBook(obj.orderbook);
                } else if ("index" in obj) {
                    updateIndex(obj.index);
                    displayIndex();
                }
            } catch(e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        var newconn = function() {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function()  {
                console.log("connection open");
                ob();
            };

            sockjs.onmessage = function(e) {
                datain(e.data);
            };

            sockjs.onclose = function()  {
                console.log("connection closed");
            };

            sockjs.onheartbeat = function() {
            };
        };

        newconn();

        function loadOrderBooks(orderbookarr) {
            for (var i = 0; i < orderbookarr.length; ++i) {
                updateOrderBook(orderbookarr[i]);
            }
        }

        function updateOrderBook(orderbook) {
            var level;

            // create an entry in the orderbooks array for this symbol
            if (!(orderbook.symbol in orderbooks)) {
                // 6 levels
                orderbooks[orderbook.symbol] = [{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0}];
            }

            var tbl = document.getElementById("tblorderbook:" + orderbook.symbol);
            if (tbl == null) {
                tbl = createOBTable(orderbook.symbol);
            }

            // update the prices
            for (var i = 0; i < orderbook.prices.length; ++i) {
                level = orderbook.prices[i].level - 1;

                if ("bid" in orderbook.prices[i]) {
                    tbl.rows[orderbook.prices[i].level+3].cells[1].innerHTML = orderbook.prices[i].bid;

                    if (orderbook.prices[i].bid > orderbooks[orderbook.symbol][level].bid) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "yellowstrippriceup";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "priceup";
                        }
                    } else if (orderbook.prices[i].bid < orderbooks[orderbook.symbol][level].bid) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "yellowstrippricedn";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "pricedn";
                        }
                    } else {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "yellowstrippricenc";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[1].className = "pricenc";
                        }
                    }
                    orderbooks[orderbook.symbol][level].bid = orderbook.prices[i].bid;
                }
                if ("bidvol" in orderbook.prices[i]) {
                    tbl.rows[orderbook.prices[i].level+3].cells[0].innerHTML = parseInt(orderbook.prices[i].bidvol);

                    if (orderbook.prices[i].bidvol > orderbooks[orderbook.symbol][level].bidvol) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "yellowstripvolup";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "volup";                            
                        }
                    } else if (orderbook.prices[i].bidvol < orderbooks[orderbook.symbol][level].bidvol) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "yellowstripvoldn";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "voldn";
                        }
                    } else {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "yellowstripvolnc";
                        } else {
                            tbl.rows[orderbook.prices[i].level+3].cells[0].className = "volnc";                            
                        }
                    }
                    orderbooks[orderbook.symbol][level].bidvol = orderbook.prices[i].bidvol;
                }
                if ("offer" in orderbook.prices[i]) {
                    tbl.rows[4-orderbook.prices[i].level].cells[2].innerHTML = orderbook.prices[i].offer;

                    if (orderbook.prices[i].offer > orderbooks[orderbook.symbol][level].offer) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "yellowstrippriceup";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "priceup";
                        }
                    } else if (orderbook.prices[i].offer < orderbooks[orderbook.symbol][level].offer) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "yellowstrippricedn";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "pricedn";
                        }
                    } else {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "yellowstrippricenc";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[2].className = "pricenc";
                        }
                    }
                    orderbooks[orderbook.symbol][level].offer = orderbook.prices[i].offer;
                }
                if ("offervol" in orderbook.prices[i]) {
                    tbl.rows[4-orderbook.prices[i].level].cells[3].innerHTML = parseInt(orderbook.prices[i].offervol);

                    if (orderbook.prices[i].offervol > orderbooks[orderbook.symbol][level].offervol) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "yellowstripvolup";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "volup";                            
                        }
                    } else if (orderbook.prices[i].offervol < orderbooks[orderbook.symbol][level].offervol) {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "yellowstripvoldn";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "voldn";                            
                        }
                    } else {
                        if (orderbook.prices[i].level == 1) {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "yellowstripvolnc";
                        } else {
                            tbl.rows[4-orderbook.prices[i].level].cells[3].className = "volnc";                            
                        }
                    }
                    orderbooks[orderbook.symbol][level].offervol = orderbook.prices[i].offervol;
                }
            }

            //displayOrderBook(orderbook.symbol);
        }

        function displayOrderBook(symbol) {
            var tbl = document.getElementById("tblorderbook:" + symbol);
            if (tbl == null) {
                createOBTable(symbol);
            }

            for (y = 0; y < orderbooks[symbol].length; ++y) {
            }
        }

        function updateIndex(index) {
            for (var i = 0; i < index.symbols.length; ++i) {
                ukx.push(index.symbols[i]);
            }
        }

        function displayIndex() {
            var lstindex = getList("lstindex");

            document.body.appendChild(lstindex);

            for (var i = 0; i < ukx.length; i++) {
                addElement(ukx[i].symbol, lstindex, i);
            }

            lstindex.onclick = function(e) {
                if (!e) e = window.event;
                element = e.target || e.srcElement;

                sockjs.send("{\"orderbookrequest\":" + JSON.stringify(element.innerHTML) + "}");
            }

            var divorderbooks = getDiv("divorderbooks");
            document.body.appendChild(divorderbooks);
        }

        function ob() {
            sockjs.send("{\"index\":" + JSON.stringify("UKX") + "}");
        }

        function createOBTable(symbol) {
           var tblorderbook = document.createElement("table");
            tblorderbook.createCaption();
            tblorderbook.innerHTML = symbol;
            tblorderbook.id = "tblorderbook:" + symbol;
            tblorderbook.className = "tblorderbook";

            createOBHeadings(tblorderbook);
            createOBDetail(tblorderbook);
            createOBTicket(tblorderbook);

            var divorderbooks = document.getElementById("divorderbooks");
            divorderbooks.appendChild(tblorderbook);

            return tblorderbook;
        }

        function createOBHeadings(tblorderbook) {
            var headingrow = tblorderbook.insertRow();

            /*var colbuy = document.createElement("th");
            colbuy.colSpan = 2;
            colbuy.innerHTML = "Buy Orders";
            colbuy.className = "";

            var colsell = document.createElement("th");
            colsell.colSpan = 2;
            colsell.innerHTML = "Sell Orders";
            colsell.className = "";*/

            var colbidvol = document.createElement("th");
            colbidvol.innerHTML = "Vol";
            colbidvol.className = "";

            var colbidprice = document.createElement("th");
            colbidprice.innerHTML = "Bid";
            colbidprice.className = "";

            var colofferprice = document.createElement("th");
            colofferprice.innerHTML = "Offer";
            colofferprice.className = "";

            var coloffervol = document.createElement("th");
            coloffervol.innerHTML = "Vol";
            coloffervol.className = "";

            //headingrow1.appendChild(colbuy);
            //headingrow1.appendChild(colsell);
            headingrow.appendChild(colbidvol);
            headingrow.appendChild(colbidprice);
            headingrow.appendChild(colofferprice);
            headingrow.appendChild(coloffervol);
        }

        function createOBDetail(tblorderbook) {
            for (var i = 0; i < 6; i++) {
                var obrow = tblorderbook.insertRow(-1);
                addOBRow(obrow);
            }
        }

        function addOBRow(obrow) {
            for (var k = 0; k < 4; ++k) {
                var col = document.createElement("td");

                /*switch (k) {
                case 0:
                    col.innerHTML = 0;
                    break;
                case 1:
                    col.innerHTML = 0;
                    break;
                case 2:
                    col.innerHTML = 0;
                    break;
                case 3:
                    col.innerHTML = 0;
                    break;
                default:
                }*/

                obrow.appendChild(col);
            }
        }

        function createOBTicket(tblorderbook) {
            return;
            var ticketrow = tblorderbook.insertRow(-1);

            var ticketcol = document.createElement("td");
            ticketrow.appendChild(ticketcol);

            var buysellcol = document.createElement("td");
            ticketrow.appendChild(buysellcol);

            var buysellbtn = document.createElement("button");
            buysellcol.appendChild(buysellbtn);
            //ticketcol.innerHTML = "Test";
        }

        function getList(liststr) {
            var list = document.getElementById(liststr);

            if (list == null) {
                list = document.createElement("list");
                list.className = "list";
                list.id = liststr;
            }

            return list;
        }

        function addElement(msg, list, index) {
            var listelem;

            listelem = document.createElement("li");
            listelem.setAttribute('value', index);

            newlink("lnk" + index, msg, "", listelem);

            list.appendChild(listelem);

            return listelem;
        }

        function newlink(id, text, classname, form) {
            var link = document.createElement('a');
            link.id = id;
            link.innerHTML = text;
            if (classname != "") {
                newlink.className = classname;
            }
            form.appendChild(link);
            return link;
        }

        function getDiv(divid, classname) {
            var div = document.getElementById(divid);

            if (div == null) {
                div = document.createElement("div");
                div.id = divid;
                div.className = classname;
            }

            return div;
        }
     </script>
</body>
</html>