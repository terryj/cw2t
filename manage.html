<!doctype html>
<html><head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>TG-Online Manager v0.9</title>
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
    <style>
        table {
            font-size: 21px;
        }
        table .tr {
            border-bottom: none;
        }
        table .colrightalign {
            text-align: right;
       }
        table .colleftalign {
            text-align: left;
        }
        table .colunderline {
            text-align: right;
            border-bottom: 1px solid #000;
        }
        table .coldoubleunderline {
            text-align: right;
            border-bottom: 1px double #000;
            text-decoration: underline;
        }
        .list {
            display: block;
            font-size: 24px;
            background-color: inherit;
            color: #666666;
            white-space: nowrap;
        }
        .list li:hover {
            background-color: #ddd;
            color: #666666;
            cursor: pointer;
        }
        .listchat {
            display: block;
            font-size: 24px;
            background-color: inherit;
            color: #666666;
            white-space: nowrap;
        }
        .listchat li:hover {
            background-color: inherit;
            color: #666666;
            cursor: pointer;
        }
        .menu li {
            display: inline;
            margin: 0 10px;
            font-size: 21px;
            background-color: inherit;
            color: #C0C0C0;
            cursor: pointer;
            white-space: nowrap;
        }
        .menu li:hover {
            background-color: inherit;
            color: #666666;
            text-decoration: underline;
        }
        .menu .menuitemselected {
            background-color: inherit;
            color: #666666;
        }
        .menu .menuitemchat {
            background-color: inherit;
            color: yellow;
        }
        .submenu{
            background-color: white;
            color: black;
            display: block;
            border: 2px;
        }
        .submenu li{
            color: red;
        }
        .submenu li:hover{
            background-color:blue;
        }
        .cw2t {
            /*width: 620px;*/
            width: 460px;
            font-size: 33px;
            background-color: inherit;
            color: #C0C0C0;
            white-space: nowrap;
        }
        .yellowstrip {
            background-color: yellow;
            color: inherit;
            /*width: 620px;*/
            width: 460px;
            white-space: nowrap;
            margin: 3px;
        }
        a {
            font-size: 18px;
            margin: 10px;
            background-color: inherit;
            color: #C0C0C0;
        }
        a:link {
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            background-color: inherit;
            color: #666666;
            cursor: pointer;
        }
        .linkselected {
            background-color: inherit;
            color: #666666;
            text-decoration: underline;
        }
        .depthstrip {
            /*width: 620px;*/
            width: 460px;
            white-space: nowrap;
            margin: 3px;
        }
        .headingstrip {
            /*width: 620px;*/
            width: 460px;
            white-space: nowrap;
            margin: 3px;
        }
        .bidquantity {
            display: inline-block;
            width: 80px;
            font-size: 21px;
            text-align: right;
            background-color: inherit;
            color: gray;
            cursor: pointer;
        }
        .offerquantity {
            display: inline-block;
            width: 80px;
            font-size: 21px;
            background-color: inherit;
            color: gray;
            cursor: pointer;
        }
        .bidquantityheading {
            display: inline-block;
            width: 80px;
            font-size: 12px;
            text-align: right;
            background-color: inherit;
            color: gray;
        }
        .offerquantityheading {
            display: inline-block;
            width: 80px;
            font-size: 12px;
            background-color: inherit;
            color: gray;
        }
        .yellowstripbidflashup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            background-color: blue;
            color: yellow;        
            cursor: pointer;
        }
        .yellowstripbidflashdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            background-color: red;
            color: yellow;        
            cursor: pointer;
        }
        .yellowstripbidflashnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            background-color: green;
            color: yellow;        
            cursor: pointer;
        }
        .bidflashup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            color: white;
            background-color: blue;
            cursor: pointer;
        }
        .bidflashdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            color: white;
            background-color: red;
            cursor: pointer;
        }
        .bidflashnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            background-color: green;
            color: white;
            cursor: pointer;
        }
        .yellowstripofferflashup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            background-color: blue;
            color: yellow;        
            cursor: pointer;
        }
        .yellowstripofferflashdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            background-color: red;
            color: yellow;        
            cursor: pointer;
        }
        .yellowstripofferflashnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            background-color: green;
            color: yellow;        
            cursor: pointer;
        }
        .offerflashup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            color: white;
            background-color: blue;
            cursor: pointer;
        }
        .offerflashdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            color: white;
            background-color: red;
            cursor: pointer;
        }
        .offerflashnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            color: white;
            background-color: green;
            cursor: pointer;
        }
        .yellowstripbidup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;
            color: blue;
            background-color: yellow;
            cursor: pointer;
        }
        .yellowstripbiddn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;
            color: red;
            background-color: yellow;
            cursor: pointer;
        }
        .yellowstripbidnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            color: green;        
            background-color: yellow;
            cursor: pointer;
        }
        .bidup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;
            color: blue;
            background-color: white;
            cursor: pointer;
        }
        .biddn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;
            color: red;
            background-color: white;
            cursor: pointer;
        }
        .bidnochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;    
            color: green;        
            background-color: white;
            cursor: pointer;
        }
       .yellowstripofferup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;
            color: blue;
            background-color: yellow;
            cursor: pointer;
        }
        .yellowstripofferdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;
            color: red;
            background-color: yellow;
            cursor: pointer;
        }
        .yellowstripoffernochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            color: green;        
            background-color: yellow;
            cursor: pointer;
        }
       .offerup {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;
            color: blue;
            background-color: white;
            cursor: pointer;
        }
        .offerdn {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;
            color: red;
            background-color: white;
            cursor: pointer;
        }
        .offernochange {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;    
            color: green;        
            background-color: white;
            cursor: pointer;
        }
        .bidheading {
            display: inline-block;
            width: 120px;
            font-size: 12px;
            text-align: right;
            background-color: inherit;
            color: gray;        
        }
        .offerheading {
            display: inline-block;
            width: 120px;
            font-size: 12px;
            text-align: left;
            background-color: inherit;
            color: gray;        
        }
        .bid {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: right;
            background-color: inherit;
            color: green;
            cursor: pointer;
        }
        .offer {
            display: inline-block;
            width: 120px;
            font-size: 33px;
            text-align: left;
            background-color: inherit;
            color: green;
            cursor: pointer;
        }
        .stock {
            display: inline-block;
            width: 180px;
            font-size: 27px;
            background-color: inherit;
            color: gray;
            cursor: pointer;
        }
        .stockheading {
            display: inline-block;
            width: 180px;
            font-size: 12px;
            background-color: inherit;
            color: gray;
        }
        .slash {
            display: inline-block;
            width: 20px;
            font-size: 24px;
            background-color: inherit;
            color: green;
            text-align: center;
        }
        .slashheading {
            display: inline-block;
            width: 20px;
            font-size: 12px;
            background-color: inherit;
            color: gray;
            text-align: center;
        }
        .level2 {
            display: inline-block;
            width: 19px;
            font-size: 33px;
            color: gray;
            background-color: inherit;
            cursor: pointer;
        }
        .removestock {
            display: inline-block;
            width: 19px;
            font-size: 21px;
            background-color: inherit;
            color: gray;
            cursor: pointer;
        }
        .level2heading {
            display: inline-block;
            width: 19px;
            font-size: 12px;
        }
        .forminstrument {
            /*width: 620px;*/
            width: 460px;
            white-space: nowrap;            
        }
        .orderquantity {
            width: 90px;
            font-size: 18px;
            margin-left: 3px;
        }
        .orderstock {
            background-color: inherit;
            color: gray;
            display: inline-block;
            width: 140px;
            font-size: 21px;
            margin-left: 3px;
            text-align: center;
        }
        .orderprice {
            width: 90px;
            font-size: 18px;
        }
        .orderbuttonbuy {
            font-size: 21px;
            border-style: none;
            background-color: blue;
            color: white;
            cursor: pointer;
        }
        .orderbuttonsell {
            font-size: 21px;
            border-style: none;
            background-color: red;
            color: white;
            cursor: pointer;
        }
        .ordermsg {
            background-color: inherit;
            color: #ccc;
            font-size: 18px;            
        }
        .forminstbutton {
            border-style: none;
            background-color: #ddd;
            color: inherit;
            cursor: pointer;
        }
        .formsigninlabel {
            display: inline-block;
            width: 95px;
            font-size: 21px;
            background-color: inherit;
            color: #C0C0C0;
        }
        .formsignininput {
            display: inline-block;
            width: 270px;
            line-height: 21px;
            font-size: 15px;
            background-color: inherit;
            color: gray;
        }
        .formbutton {
            border-style: none;
            background-color: #C0C0C0;
            color: inherit;
            font-size: 15px;
            cursor: pointer;
            height: 24px;
            width: 80px;
        }
        .formbuttonwide {
            border-style: none;
            background-color: #C0C0C0;
            color: inherit;
            font-size: 15px;
            cursor: pointer;
            height: 24px;
            width: 140px;
            margin-left: 3px;
        }
        .quotebuybutton {
            font-size: 21px;
            background-color: #ddd;
            color: blue;
            cursor: pointer;
        }
        .quotesellbutton {
            font-size: 21px;
            background-color: #ddd;
            color: red;
            cursor: pointer;
        }
        .quotereqquantity {
            font-size: 21px;
            margin-left: 3px;
            width: 99px;
            background-color: inherit;
            color: #C0C0C0;
        }
        .quotereqbutton {
            font-size: 21px;
            background-color: #ddd;
            color: gray;
            cursor: pointer;
        }
        .settlabel {
            /*font-size: 21px;*/
            background-color: inherit;
            color: gray;
        }
        .timerlabel {
            display: inline-block;
            width: 200px;
            font-size: 21px;
            text-align: center;
            background-color: inherit;
            color: #C0C0C0;
        }
        .ordertype {
            margin-left: 6px;
        }
        .stockbox {
            position: relative;
        }
        .stockboxinput {
            width: 120px;
            height: 20px;
        }
        .clientstockboxinput {
            width: 120px;
            height: 20px;            
            margin: 2px 0 15px 10px;
        }
        .stocklist {
            position: absolute;
            border: 1px solid gray;
            /*list-style: none;*/
            width: 600px;
            height: 300px;
            overflow: scroll;
            background-color: white;
            color: inherit;
        }
        .stocklist li:hover {
            background-color: #eee;
            color: #666666;
            cursor: pointer;
        }
        .clientbox {
            position: relative;
        }
        .clientboxinput {
            width: 120px;
            height: 20px;
        }
        .clientlist {
            position: absolute;
            border: 1px solid gray;
            z-index: 1;
            /*list-style: none;*/
            width: 600px;
            height: 300px;
            overflow: scroll;
            background-color: white;
            color: inherit;
        }
        .clientlist li:hover {
            background-color: #eee;
            color: #666666;
            cursor: pointer;
        }
        .getquotebutton {
            background-color: #ddd;
            color: inherit;
            width: 120px;
            cursor: pointer;
        }
        .quantitycashsel {
            font-size: 21px;
        }
        .formlabel {
            display: inline-block;
            width: 150px;
            font-size: 21px;
            text-align: right;
            background-color: inherit;
            color: gray;
        }
        .formlabelshort {
            display: inline-block;
            width: 127px;
            font-size: 21px;
            text-align: right;
            background-color: inherit;
            color: gray;
        }
        .forminput {
            display: inline-block;
            font-size: 18px;
            border: solid 1px #aacfe4;
            width: 450px;
            margin: 2px 0 15px 10px;
        }
        div .textarea {
            display: inline-block;
            border: 1px solid #aacfe4;
            font-size: 15px;
            width: 600px;
            height: 120px;
            margin: 2px 2px 10px 10px;
            vertical-align: top;
        }
        .formselect {
            display: inline-block;
            font-size: 18px;            
            margin: 2px 0 15px 10px;
        }
        .formcheckbox {
            display: inline-block;
            font-size: 15px;
            margin: 2px 4px 15px 10px;           
        }
        .chatbtn {
            font-size: 21px;
            background-color: #ddd;
            color: #666666;
            cursor: pointer;
        }
        .heading {
            font-size: 18px;
            background-color: inherit;
            color: #666666;
        }
        .rowlong {
            background-color: inherit;
            color: blue;
        }
        .rowshort {
            background-color: inherit;
            color: red;
        }
        .lsthol{
            display:inline-block;
            background-color:inherit;

        }
    </style>
</head>
<body lang="en">
    <div id="heading">
        <div id="cw2t" class="cw2t"></div>
    </div>
    <div id="main">
    </div>

    <script>
        var sockjs_url = '/echo';
        var sockjs;
        var selectedmenu = -1;
        var selectedlistelement = 0;
        var placeneworder = false;
        var orders = {};
        var orderbooks = {};
        var positions = {};
        var reserves = {};
        var cash = {};
        var margins = {};
        var trades = {};
        var instruments = {};
        var obdisplay = {};
        var ordervol = {};
        var ordertypes = {};
        var quotes = {};
        var indices = {};
        var timeinforces = {};
        var clients = {};
        var brokers = {};
        var ifas = {};
        var instrumenttypes = {};
        var cashtranstypes = {};
        var currencies = {};
        var clienttypes = {};
        var hedgebooks = {};
        var costs = {};
        var lastElement = null;
        var lastsymbol = null;
        var extendedsettlement = false;
        var defaultsettlcurrency = "GBP";
        var monthtext = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sept','Oct','Nov','Dec'];
        var pricetimer;
        var priceflash = {};
        var heartbeattimer = null;
        var inconnectiontest = false;
        var restarttimer;
        var userid;
        var operatortype = 2; // user
        var defaultHedgebook = "999999";
        var quoterequests = {};
        var connections = {};
        var chathistory = {};
        var cashhistory = {};
        var chatmenuoption = 9;
        var showvolume = false;
        var account = {};
        var coheading = "Thomas Grant & Company";
        var orderdivnumarr = {};
        var loggedout = false;
        var markets = {};
        var serverstatus = {};

        // redefine console.log for IE
        if (typeof console == "undefined") 
            var console = { log: function() {} };

        //
        // incoming data function
        // JSON data is parsed into an object & then processed
        //
        var datain = function(msg) {
            try {
                var obj = JSON.parse(msg);

                if ("orderbooks" in obj) {
                    loadOrderBooks(obj.orderbooks);
                } else if ("orderbook" in obj) {
                    updateOrderBook(obj.orderbook);
                } else if ("orders" in obj) {
                    clearOrders();
                    loadOrders(obj.orders);
                    displayOrders();
                } else if ("ordercancelreject" in obj) {
                    orderCancelReject(obj.ordercancelreject);
                } else if ("ordertypes" in obj) {
                    loadOrderTypes(obj.ordertypes);
                } else if ("order" in obj) {
                    updateOrder(obj.order);
                } else if ("trades" in obj) {
                    clearTrades();
                    loadTrades(obj.trades);
                    displayTrades();
                } else if ("trade" in obj) {
                    updateTrade(obj.trade);
                } else if ("quoterequests" in obj) {
                    clearQuoteRequests();
                    loadQuoteRequests(obj.quoterequests);
                    displayQuoteRequests();
                } else if ("quotes" in obj) {
                    clearQuotes();
                    loadQuotes(obj.quotes);
                    displayQuotes();
                } else if ("quoteack" in obj) {
                    quoteAckReceived(obj.quoteack);
                } else if ("quote" in obj) {
                    quoteReceived(obj.quote);
                } else if ("positions" in obj) {
                    clearPositions();
                    loadPositions(obj.positions);
                    displayPositions();
                } else if ("position" in obj) {
                    updatePosition(obj.position);
                } else if ("account" in obj) {
                    clearAccount();
                    loadAccount(obj.account);
                    displayAccount();
                } else if ("cashitem" in obj) {
                    updateCash(obj.cashitem);
                } else if ("cashtranstypes" in obj) {
                    loadCashtransTypes(obj.cashtranstypes);
                } else if ("cashtrans" in obj) {
                    updateCashtrans(obj.cashtrans);
                } else if ("cash" in obj) {
                    clearCash();
                    loadCash(obj.cash);
                    displayCash();
                } else if ("instrumenttypes" in obj) {
                    loadInstrumenttypes(obj.instrumenttypes);
                } else if ("instruments" in obj) {
                    loadInstruments(obj.instruments);
                } else if ("instrument" in obj) {
                    updateInstrument(obj.instrument);
                } else if ("margins" in obj) {
                    clearMargins();
                    loadMargins(obj.margins);
                    displayMargins();
                } else if ("reserves" in obj) {
                    clearReserves();
                    loadReserves(obj.reserves);
                    displayReserves();
                } else if ("signinreply" in obj) {
                    replySignIn(obj.signinreply);
                } else if ("index" in obj) {
                    loadIndex(obj.index);
                } else if ("clients" in obj) {
                    loadClients(obj.clients);
                } else if ("clienttypes" in obj) {
                    loadClienttypes(obj.clienttypes);
                } else if ("client" in obj) {
                    updateClient(obj.client);
                } else if ("brokers" in obj) {
                    loadBrokers(obj.brokers);
                } else if ("ifas" in obj) {
                    loadIfas(obj.ifas);
                } else if ("ifa" in obj) {
                    updateIfa(obj.ifa);
                } else if ("currencies" in obj) {
                    loadCurrencies(obj.currencies);
                } else if ("hedgebooks" in obj) {
                    loadHedgebooks(obj.hedgebooks);
                } else if ("hedgebook" in obj) {
                    updateHedgebook(obj.hedgebook);
                } else if ("costs" in obj) {
                    loadCosts(obj.costs);
                } else if ("cost" in obj) {
                    updateCost(obj.cost);
                } else if ("userid" in obj) {
                    userid = obj.userid;
                    start();
                } else if ("connections" in obj) {
                    clearConnections();
                    loadConnections(obj.connections);
                    displayConnections();
                } else if ("markets" in obj) {
                    loadMarkets(obj.markets);
                } else if ("holidays" in obj) {
                    displayHolidays(obj.holidays);
                } else if ("cashhistory" in obj) {
                    clearCashHistory();
                    loadCashHistory(obj.cashhistory);
                    displayCashHistory();
                } else if ("chat" in obj) {
                    newChat(obj.chat);
                } else if ("chathistory" in obj) {
                    clearChatHistory();
                    loadChatHistory(obj.chathistory);
                    displayChatHistory();
                } else if ("status" in obj) {
                    updateStatus(obj.status);
                } else {
                    console.log("Unknown message:" + msg);
                }
            } catch(e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        //
        // various load routines
        // these receive incoming data & store it in various objects as arrays
        // each element of the array stores a number of fields in a record format and is indexed
        //

        function loadIndex(index) {
            indices[index.name] = index.symbols;
            displayIndex(index.name);
        }

        function loadOrderBooks(orderbookarr) {
            for (var i = 0; i < orderbookarr.length; ++i) {
                orderbooks[orderbookarr[i].symbol] = orderbookarr[i];
            }

            if (selectedmenu == 0) {
                displayOrderBooks();
            }
        }

        function loadOrders(orderarr) {
            for (var i = 0; i < orderarr.length; ++i) {
                updateOrderVol(orderarr[i]);
                orders[orderarr[i].orderid] = orderarr[i];
            }
        }

        function loadPositions(positionarr) {
            for (var i = 0; i < positionarr.length; ++i) {
                positions[positionarr[i].positionid] = positionarr[i];
            }            
        }

        function loadCash(casharr) {
            for (var i = 0; i < casharr.length; ++i) {
                cash[casharr[i].currency] = casharr[i];
            }                        
        }

        function loadAccount(acctarr) {
            for (var i = 0; i < acctarr.length; ++i) {
                account[acctarr[i].currency] = acctarr[i];
            }
        }

        function loadMargins(marginarr) {
            for (var i = 0; i < marginarr.length; ++i) {
                margins[marginarr[i].currency] = marginarr[i];
            }                        
        }

        function loadReserves(reservearr) {
            var reskey;

            for (var i = 0; i < reservearr.length; ++i) {
                reskey = reservearr[i].symbol + ":" + reservearr[i].currency + ":" + reservearr.settldate;
                reserves[reskey] = reservearr[i];
            }                        
        }

        function loadTrades(tradearr) {
            for (var i = 0; i < tradearr.length; ++i) {
                trades[tradearr[i].tradeid] = tradearr[i];
            }                                    
        }

        function loadChatHistory(chathistarr) {
            for (var i = 0; i < chathistarr.length; ++i) {
                chathistory[chathistarr[i].chatid] = chathistarr[i];
            }                                                
        }
        //test
        function loadInstruments(instrumentarr) {
            for (var i = 0; i < instrumentarr.length; ++i) {
                instruments[instrumentarr[i].symbol] = instrumentarr[i];
            }
        }

        function loadOrderTypes(ordertypearr) {
            for (var i = 0; i < ordertypearr.length; ++i) {
                ordertypes[ordertypearr[i].id] = ordertypearr[i];
            }

            loadTimeinforces();                     
         }

        function loadTimeinforces() {
            timeinforces[0] = "Good For Day";
            timeinforces[1] = "Good Till Date";
            timeinforces[2] = "Good Till Cancelled";
        }

        function loadQuoteRequests(quotereqarr) {
            for (var i = 0; i < quotereqarr.length; ++i) {
                quoterequests[quotereqarr[i].quotereqid] = quotereqarr[i];
            }                                    
        }

        function loadQuotes(quotearr) {
            for (var i = 0; i < quotearr.length; ++i) {
                quotes[quotearr[i].quoteid] = quotearr[i];
            }                                    
        }

        function loadClients(clientarr) {
            for (var i = 0; i < clientarr.length; ++i) {
                clients[clientarr[i].clientid] = clientarr[i];
            }                                    
        }

        function loadBrokers(brokerarr) {
            for (var i = 0; i < brokerarr.length; ++i) {
                brokers[brokerarr[i].brokerid] = brokerarr[i];
            }                                                
        }

        function loadIfas(ifaarr) {
            for (var i = 0; i < ifaarr.length; ++i) {
                ifas[ifaarr[i].ifaid] = ifaarr[i];
            }                                                
        }

        function loadInstrumenttypes(insttypearr) {
            for (var i = 0; i < insttypearr.length; ++i) {
                instrumenttypes[insttypearr[i].instrumenttypeid] = insttypearr[i];
            }                                                
        }

        function loadCashtransTypes(cashtransarr) {
            for (var i = 0; i < cashtransarr.length; ++i) {
                cashtranstypes[cashtransarr[i].cashtranstypeid] = cashtransarr[i];
            }                                                            
        }

        function loadCurrencies(currencyarr) {
            for (var i = 0; i < currencyarr.length; ++i) {
                currencies[currencyarr[i]] = currencyarr[i];
            }                                                                        
        }

        function loadClienttypes(clienttypearr) {
            for (var i = 0; i < clienttypearr.length; ++i) {
                clienttypes[clienttypearr[i].clienttypeid] = clienttypearr[i];
            }                                                                        
        }

        function loadHedgebooks(hedgebookarr) {
            for (var i = 0; i < hedgebookarr.length; ++i) {
                hedgebooks[hedgebookarr[i].hedgebookkey] = hedgebookarr[i];
            }
        }

        function loadCosts(costsarr) {
            for (var i = 0; i < costsarr.length; ++i) {
                costs[costsarr[i].costkey] = costsarr[i];
            }
        }

        function loadConnections(connarr) {
            for (var i = 0; i < connarr.length; ++i) {
                connections[connarr[i].clientid] = connarr[i];
            }            
        }

        function loadCashHistory(cashhistarr) {
            for (var i = 0; i < cashhistarr.length; ++i) {
                cashhistory[cashhistarr[i].cashtransid] = cashhistarr[i];
            }            
        }

        function loadMarkets(marketarr) {
            for (var i = 0; i < marketarr.length; ++i) {
                markets[marketarr[i].market] = marketarr[i];
            }
        }

        // clear array routines

        function clearQuoteRequests() {
            quoterequests = [];
        }

        function clearQuotes() {
            quotes = [];
        }

        function clearOrders() {
            orders = [];
        }

        function clearTrades() {
            trades = [];
        }

        function clearPositions() {
            positions = [];
        }

        function clearConnections() {
            connections = [];
        }

        function clearChatHistory() {
            chathistory = [];
        }

        function clearCash() {
            cash = [];
        }

        function clearMargins() {
            margins = [];
        }

        function clearReserves() {
            reserves = [];
        }

        function clearCashHistory() {
            cashhistory = [];
        }

        function clearAccount() {
            account = [];
        }

        //
        // various update routines
        // these take a single data item & update the item based on its index
        //

        function updateStatus(status) {
            if ("tsstatus" in status) {
                serverstatus.tsstatus = parseInt(status.tsstatus);
            } else if ("psstatus" in status) {
                serverstatus.psstatus = parseInt(status.psstatus);                
            }

            if (selectedmenu == 12) {
                displayStatus();
            }
        }

        function updateTrade(trade) {
            var msg;

            msg = tradeMsg(trade);

            if (selectedmenu == 0) {
                addMessageToDiv(msg, "orderdiv:" + trade.symbol + ":" + trade.orderdivnum);
            }
        }

        function updatePosition(position) {
            var msg;
            var poskey = position.positionid;

            if (position.quantity == 0) {
                delete positions[poskey];

                if (selectedmenu == 4) {
                    removeElementFromList(poskey, list1);
                }
            } else {
                positions[poskey] = position;

                if (selectedmenu == 4) {
                    msg = positionMsg(position);
                    if (updateElement(msg, list1, poskey) == null) {
                        addElement(msg, list1, poskey);
                    }
                }
            }
        }

        function updateCash(cashitem) {
            var msg;

            if (cashitem.amount == 0) {
                delete cash[cashitem.currency];

                if (selectedmenu == 5) {
                    removeElementFromList(cashitem.currency, list1);
                }
            } else {
                cash[cashitem.currency] = cashitem;

                // display if we are looking at cash
                if (selectedmenu == 5) {
                    msg = JSON.stringify(cashitem);
                    if (updateElement(msg, list1, cashitem.currency) == null) {
                        addElement(msg, list1, cashitem.currency);
                    }
                }                
            }
        }

        function updateOrderBook(orderbook) {
            var level;

            // create an entry in the orderbooks array for this symbol
            if (!(orderbook.symbol in orderbooks)) {
                // 6 levels
                orderbooks[orderbook.symbol] = [{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0}];
            }

            // update the prices
            for (var i = 0; i < orderbook.prices.length; ++i) {
                level = orderbook.prices[i].level - 1;

                if ("bid" in orderbook.prices[i]) {
                    if (orderbook.prices[i].bid > orderbooks[orderbook.symbol][level].bid) {
                        orderbooks[orderbook.symbol][level].lastbidchange = 1;
                    } else if (orderbook.prices[i].bid < orderbooks[orderbook.symbol][level].bid) {
                        orderbooks[orderbook.symbol][level].lastbidchange = 2;
                    } else {
                        orderbooks[orderbook.symbol][level].lastbidchange = 0;                        
                    }
                    orderbooks[orderbook.symbol][level].bid = orderbook.prices[i].bid;
                    orderbooks[orderbook.symbol][level].bidflashcount = 3;
                    priceflash[orderbook.symbol] = true;
                }
                if ("offer" in orderbook.prices[i]) {
                    if (orderbook.prices[i].offer > orderbooks[orderbook.symbol][level].offer) {
                        orderbooks[orderbook.symbol][level].lastofferchange = 1;
                    } else if (orderbook.prices[i].offer < orderbooks[orderbook.symbol][level].offer) {
                        orderbooks[orderbook.symbol][level].lastofferchange = 2;
                    } else {
                        orderbooks[orderbook.symbol][level].lastofferchange = 0;                        
                    }
                    orderbooks[orderbook.symbol][level].offer = orderbook.prices[i].offer;
                    orderbooks[orderbook.symbol][level].offerflashcount = 3;
                    priceflash[orderbook.symbol] = true;
                }
                if ("bidvol" in orderbook.prices[i]) {
                    orderbooks[orderbook.symbol][level].bidvol = orderbook.prices[i].bidvol;                    
                }
                if ("offervol" in orderbook.prices[i]) {
                    orderbooks[orderbook.symbol][level].offervol = orderbook.prices[i].offervol;                    
                }
            }

            if (selectedmenu == 0) {
                displayOrderBook(orderbook.symbol);
            }
        }

        function updateInstrument(instrument) {
            var lblinstconf;

            instruments[instrument.symbol] = instrument;

            lblinstconf = document.getElementById("lblinstconf");
            if (lblinstconf != null) {
                lblinstconf.innerHTML = instrument.symbol + " updated ok";
            }
        }

        function updateCost(cost) {
            var lblcostsconf;

            costs[cost.costkey] = cost;

            lblcostsconf = document.getElementById("lblcostsconf");
            lblcostsconf.innerHTML = "Updated ok";
        }

        function updateHedgebook(hedgebook) {
            var lblhedgeconf;

            hedgebooks[hedgebook.hedgebookkey] = hedgebook;

            lblhedgeconf = document.getElementById("lblhedgeconf");
            if (lblhedgeconf != null) {
                lblhedgeconf.innerHTML = "Hedgebook updated Ok";
            }
        }

        function updateIfa(ifa) {
            var lblifaconf;

            ifas[ifa.ifaid] = ifa;

            lblifaconf = document.getElementById("lblifaconf");
            if (lblifaconf != null) {
                lblifaconf.innerHTML = ifa.name + " updated ok";
            }
        }

        function updateClient(client) {
            var frmclient;
            var inpclientid;
            var msg;

            clients[client.clientid] = client;

            if (selectedmenu != 1) {return};

            frmclient = document.getElementById("frmclient");
            if (frmclient != null) {
                inpclientid = document.getElementById("inpclientid");
                if (inpclientid != null) {
                    if (inpclientid.value == "") {
                        msg = client.name + " added ok";
                    } else {
                        msg = client.name + " updated ok";
                    }

                    displayClient(null, "frmclient", msg, "", "", "clientboxinput");
                }
            }
        }

        function updateCashtrans(cashtrans) {
            var lblcashconf;
            var msg = "";

            lblcashconf = document.getElementById("lblcashconf");
            if (lblcashconf != null) {
                msg += cashtranstypes[cashtrans.transtype].description;
                msg += " of " + cashtrans.amount + " " + cashtrans.currency;
                if (cashtrans.drcr == "1") {
                    msg += " added to ";
                } else {
                    msg += " taken from ";     
                }
                msg += clients[cashtrans.clientid].name;
                lblcashconf.innerHTML = msg;
            }

            clearField(inpclient);
            clearField(inpamount);
            clearField(inpdesc);
            clearField(inpref);
        }

        function updateOrder(order) {
            var msg;

            orders[order.orderid] = order;

            if (order.status == "0") {
                msg = "Order acknowledged, id: " + order.orderid;
                if ('text' in order && order.text != "") {
                    msg += ", " + order.text;
                }
            } else if (order.status == "1") {
                msg = "Order part-filled, order id: " + order.orderid;
            } else if (order.status == "2") {
                msg = "Order filled, order id: " + order.orderid;
            } else if (order.status == "8") {
                msg = "Order rejected, reason: " + getReasonDesc(order.reason);
                if (order.text != "") {
                    msg += " " + order.text;
                }
                msg += ", order id: " + order.orderid;
            } else if (order.status == "4") {
                msg = "Order cancelled";
            }

            if (selectedmenu == 0) {
                addMessageToDiv(msg, "orderdiv:" + order.symbol + ":" + order.orderdivnum);
            } else if (selectedmenu == 7) {
                removeElementFromList(order.orderid, list1);
                if (list1.childNodes.length == 0) {
                    addElement("No new orders", list1, 0)
                }
                msg = orderCancelMsg(order);
                addElement(msg, list5, order.orderid);
            }
        }

        function updateOrderVol(order) {
            var key = order.symbol + order.side + order.price;
 
            if (order.status == "0" || order.status == "1") {
                if (order.orderid in orders) {
                    ordervol[key] -= parseInt(orders[order.orderid].remquantity);
                }

                if (key in ordervol) {
                    ordervol[key] += parseInt(order.remquantity);
                } else {
                    ordervol[key] = parseInt(order.remquantity);
                }
            } else if (order.status == "2" || order.status == "4") {
                if (order.orderid in orders) {
                    ordervol[key] -= parseInt(orders[order.orderid].remquantity);
                }
            }
        }

        function updateElement(msg, list, index) {
            var listelement = null;

            for (var i = 0; i < list.childNodes.length; ++i) {
                if (list.childNodes[i].value == index) {
                    listelement = list.childNodes[i];
                    listelement.innerHTML = msg;
                    break;
                }
            }

            return listelement;
        }

        function start() {
            init();
            clearScreen();
            displayMenu();

            selectedmenu = 0;

            displayOrderBooks();
        }

        function startHeartbeatTimer() {
            stopHeartbeatTimer();
            // todo: either need to remove or JSONify the ping message
            heartbeattimer = setTimeout(connectionTest, 30000);            
        }

        function stopHeartbeatTimer() {
            clearTimeout(heartbeattimer);
        }

        function startPriceTimer() {
            pricetimer = setInterval(flashText, 1000);
        }

        function stopPriceTimer() {
            clearInterval(pricetimer);
        }

        function startRestartTimer() {
            var cw2theading = document.getElementById('cw2t');
            cw2theading.innerHTML = coheading + "- connection closed, retrying...";

            // attempt restart after 1-10 seconds
            var randomonetoten = Math.floor((Math.random()*10)+1);
            console.log("attempt restart after " + randomonetoten + " seconds");
            restarttimer = setTimeout(newconn, randomonetoten * 1000);
        }

        function stopRestartTimer() {
            clearTimeout(restarttimer);
        }

        function connectionTest() {
            if (inconnectiontest) {
                console.log("need to reconnect");
                return;
            }

            inconnectiontest = true;
        }

        //
        // sign-in form
        //
        function displayFormSignin() {
            var frmsignin;
            var emaillabel;
            var passwordlabel;
            var dummylabel;
            var email;
            var password;
            var btnsignin;
            var cw2theading;

            clearMenu();
            clearScreen();

            cw2theading = document.getElementById('cw2t');
            cw2theading.innerHTML = coheading;

            frmsignin = document.createElement("form");
            frmsignin.id = "frmsignin";

            emaillabel = document.createElement("label");
            emaillabel.innerHTML = "Email ";
            emaillabel.className = "formsigninlabel";

            passwordlabel = document.createElement("label");
            passwordlabel.innerHTML = "Password ";
            passwordlabel.className = "formsigninlabel";

            dummylabel = document.createElement("label");
            dummylabel.className = "formsigninlabel";

            email = document.createElement("input");
            email.className = "formsignininput";

            email.onkeypress = function(event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    disable();
                    signin();
                }
            }

            password = document.createElement("input");
            password.className = "formsignininput";

            password.onkeypress = function(event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    disable();
                    signin();
                }
            }

            btnsignin = document.createElement("input");
            btnsignin.type = "button";
            btnsignin.value = "Sign In";
            btnsignin.className = "formbutton";

            btnsignin.onclick = function() {
                disable();
                signin();
            }

            addNewLine(frmsignin, null);
            frmsignin.appendChild(emaillabel);
            frmsignin.appendChild(email);
            addNewLine(frmsignin, null);
            frmsignin.appendChild(passwordlabel);
            frmsignin.appendChild(password);
            addNewLine(frmsignin, null);
            addNewLine(frmsignin, null);
            frmsignin.appendChild(dummylabel);
            frmsignin.appendChild(btnsignin);

            main.appendChild(frmsignin);

            function disable() {
                btnsignin.disable = true;
                email.onkeypress = null;
                password.onkeypress = null;
            }

            function signin() {
                var signin = {};

                signin.email = email.value;
                signin.password = password.value;

                sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");
            }

            email.focus();
        }

        /*
        * this is the start...
        * set-up a sockjs connection & display the sign-in form
        * if the connection is lost, try to reconnect periodically
        */
        var newconn = function() {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function()  {
                console.log("connection open");
                stopRestartTimer();
                startPriceTimer();
                displayFormSignin();
                loggedout = false;
            };

            sockjs.onmessage = function(e) {
                datain(e.data);
            };

            sockjs.onclose = function()  {
                console.log("connection closed");
                stopRestartTimer();
                stopPriceTimer();
                if (!loggedout) {
                    startRestartTimer();
                } else {
                    newconn();
                }
            };

            sockjs.onheartbeat = function() {
            };
        };

        newconn();

        //
        // handles the flashing of colours on receiving prices
        //
        function flashText() {
            var bidprice;
            var offerprice;
            var removesymbol;

            for (var symbol in priceflash) {
                removesymbol = true;

                for (var i = 0; i < orderbooks[symbol].length; i++) {
                    // bid prices
                    orderbooks[symbol][i].bidflashcount--;
                    if (orderbooks[symbol][i].bidflashcount == 0) {
                        bidprice = document.getElementById("bidprice:" + symbol + ":" + i);
                        if (bidprice != null) {
                            if (i == 0) {
                                if (orderbooks[symbol][i].lastbidchange == 1) {
                                    bidprice.className = "yellowstripbidup";
                                } else if (orderbooks[symbol][i].lastbidchange == 2) {
                                    bidprice.className = "yellowstripbiddn";
                                } else {
                                    bidprice.className = "yellowstripbidnochange";
                                }
                            } else {
                                if (orderbooks[symbol][i].lastbidchange == 1) {
                                    bidprice.className = "bidup";
                                } else if (orderbooks[symbol][i].lastbidchange == 2) {
                                    bidprice.className = "biddn";
                                } else {
                                    bidprice.className = "bidnochange";
                                }
                            }
                        }
                    }

                    // offer prices
                    orderbooks[symbol][i].offerflashcount--;
                    if (orderbooks[symbol][i].offerflashcount == 0) {
                        offerprice = document.getElementById("offerprice:" + symbol + ":" + i);
                        if (offerprice != null) {
                            if (i == 0) {
                                if (orderbooks[symbol][i].lastofferchange == 1) {
                                    offerprice.className = "yellowstripofferup";
                                } else if (orderbooks[symbol][i].lastofferchange == 2) {
                                    offerprice.className = "yellowstripofferdn";
                                } else {
                                    offerprice.className = "yellowstripoffernochange";           
                                }
                            } else {
                                if (orderbooks[symbol][i].lastofferchange == 1) {
                                    offerprice.className = "offerup";
                                } else if (orderbooks[symbol][i].lastofferchange == 2) {
                                    offerprice.className = "offerdn";
                                } else {
                                    offerprice.className = "offernochange";
                                }
                            }
                        }
                    }

                    // keep track of whether we can remove this symbol
                    if (orderbooks[symbol][i].bidflashcount > 0 || orderbooks[symbol][i].offerflashcount > 0) {
                        removesymbol = false;
                    }
                }

                if (removesymbol) {
                    delete priceflash[symbol];
                }
            }
        }

        //
        // various clear routines
        // clears & removes parts of the display
        //

        function clearMenu() {
            var menu = document.getElementById("menu");
            if (menu != null) {
                for (var i = 0; i < menu.childNodes.length; ++i) {
                    menu.removeChild(menu.childNodes[i]);
                }
                heading.removeChild(menu);
            }
        }

        function clearHeadings() {
            for (var i = main.childNodes.length - 1; i >= 0; --i) {
                if (main.childNodes[i].nodeType == 3) { // changed for IE from...Node.TEXT_NODE) {
                    main.removeChild(main.childNodes[i]);
                }                
            }

            main.className = "";
        }

        function clearOrderBookHeadings() {
            var headingstrip = document.getElementById("headingstrip");
            if (headingstrip != null) {
                while (headingstrip.hasChildNodes()){
                    headingstrip.removeChild(headingstrip.childNodes[0]);
                }
                main.removeChild(headingstrip);
            }
        }

        function clearList(liststr, remove) {
            var list = document.getElementById(liststr);
            if (list != null) {
                while (list.hasChildNodes()){
                    list.removeChild(list.childNodes[0])
                }
                if (remove) {
                    main.removeChild(list);
                }
            }
        }

        function clearTable(tablestr) {
            var tbl = document.getElementById(tablestr);
            if (tbl != null) {
                while (tbl.hasChildNodes()){
                    tbl.removeChild(tbl.childNodes[0])
                }
                main.removeChild(tbl);
            }
        }

        function clearForm(formid, remove) {
            var frm = document.getElementById(formid);
            if (frm != null) {
                while (frm.hasChildNodes()){
                    frm.removeChild(frm.childNodes[0]);
                }
                if (remove) {
                    main.removeChild(frm);
                }
            }
        }

        function clearSymbolDiv(symbol) {
            var orderdivnum = getOrderDivNum(symbol);

            for (var i = 1; i <= orderdivnum; i++) {
                clearDiv("orderdiv:" + symbol + ":" + i);
            }

            delete orderdivnumarr[symbol];
        }

        function clearAllSymbolDivs() {
            for (var symbol in orderbooks) {
                clearSymbolDiv(symbol);
            }
        }

        function clearStrip(stripid) {
            var strip = document.getElementById(stripid);
            if (strip != null) {
                while (strip.hasChildNodes()){
                    strip.removeChild(strip.childNodes[0]);
                }
                main.removeChild(strip);
            }            
        }

        function clearStrips() {
            clearStrip("headingstrip");

            for (var symbol in orderbooks) {
                for (var i = 0; i < orderbooks[symbol].length; ++i) {
                    clearStrip("strip:" + symbol + ":" + i);
                    if (symbol in obdisplay) {
                        if (!(obdisplay[symbol].level2)) {
                            break;
                        }
                    }
                }
            }
        }

        function clearAllStrips(symbol) {
            var depth;

            if (obdisplay[symbol].level2) {
                depth = orderbooks[symbol].length;
            } else {
                depth = 1;
            }

            for (var i = 0; i < depth; ++i) {
                clearStrip("strip:" + symbol + ":" + i);
            }
        }

        function clearScreen() {
            clearHeadings();
            clearOrderBookHeadings();
            clearLists();
            clearDivs();
            clearForms();
            clearStrips();
            clearAllSymbolDivs();
            clearEmptyLines();
            clearTables();
            clearLabels();
        }

        function clearLabels() {
            clearElementById("lbltrades");
        }

        function clearLists() {
            clearList("list1", true);
            clearList("list2", true);
            clearList("list3", true);
            clearList("list4", true);
            clearList("list5", true);
            clearList("list6", true);
        }

        function clearForms() {
            clearForm("frmsignin", true);
            clearForm("frminstrument", true);
            clearForm("frmclient", true);
            clearForm("frmcash", true);
            clearForm("frmhedge", true);
            clearForm("frmproduct", true);
            clearForm("frmhedge", true);
            clearForm("frmcosts", true);
            clearForm("frmifa", true);
            clearForm("frmhistory", true);
            clearForm("frmpositions", true);
        }

        function clearTables() {
            clearTable("tblpositions");
            clearTable("tblaccount");
            clearTable("tblcashhistory");
            clearTable("tbltrades");
        }

        function clearDivs() {
            clearDiv("clientbox");
            clearDiv("stockbox");
            clearDiv("divholidays");
            clearDiv("divmonitor");
        }

        function clearEmptyLines() {
            for (var i = 1; i < 6; ++i) {
                clearElementById("emptyline:" + i);
            }
        }

        function clearField(fldname) {
            var fld = document.getElementById(fldname);
            if (fld != null) {
                fld.value = "";
            }
        }

        function clearElementById(element) {
            var elem = document.getElementById(element);
            if (elem != null) {
                elem.parentNode.removeChild(elem);
            }
        }

        //
        // add an element to a list
        // msg = message content, list = list, index = element value (should be numeric)
        //
        function addElement(msg, list, index) {
            var listelem;

            listelem = document.createElement("li");
            listelem.setAttribute('value', index);
            listelem.innerHTML = msg;

            list.appendChild(listelem);

            return listelem;
        }

        /*function orderCancel(event) {
            console.log(this);
            console.log(event);
            var element = ((window.event)?(event.srcElement):(event.target));
            var orderid = element.value;
            confirmOrderCancel(orderid);
        }*/

        function confirmOrderCancel(orderid) {
            var msg;
            var ordercancelrequest = {};

            msg = "Cancel order #" + orderid;
            msg += " to " + getSideDesc(orders[orderid].side);
            msg += " " + orders[orderid].remquantity;
            msg += " " + orders[orderid].symbol;
            if ('price' in orders[orderid]) {
                msg += " @ " + orders[orderid].price;
            }
            msg += " " + getOrdertypeDesc(orders[orderid].ordertype);

            var result = confirm(msg);
            if (result == true) {
                ordercancelrequest.clientid = orders[orderid].clientid;
                ordercancelrequest.orderid = orderid;
                ordercancelrequest.operatortype = operatortype;
                ordercancelrequest.operatorid = userid;

                sockjs.send("{\"ordercancelrequest\":" + JSON.stringify(ordercancelrequest) + "}");
            }
        }

        function confirmOrderFill(orderid) {
            var msg;
            var orderfillrequest = {};

            msg = "Fill order #" + orderid;
            msg += " to " + getSideDesc(orders[orderid].side);
            msg += " " + orders[orderid].remquantity;
            msg += " " + orders[orderid].symbol;
            if ('price' in orders[orderid]) {
                msg += " @ " + orders[orderid].price;
            }
            msg += " " + getOrdertypeDesc(orders[orderid].ordertype);
            
            var result = confirm(msg);
            if (result == true) {
                orderfillrequest.clientid = orders[orderid].clientid;
                orderfillrequest.orderid = orderid;
                orderfillrequest.operatortype = operatortype;
                orderfillrequest.operatorid = userid;

                sockjs.send("{\"orderfillrequest\":" + JSON.stringify(orderfillrequest) + "}");
            }
        }

        //
        // routine to display an selection box for products
        //
        function selectStock(frm, stockbox, displayname, focus, focusfield) {
            var stockboxinput;
            var stocklist;
            var searchtext;
            var inpsymboldesc;
            var inpsymbol;

            if (stockbox == null) {
                stockbox = document.createElement("div");
                stockbox.id = "stockbox";
                stockbox.className = "stockbox";

                main.appendChild(stockbox);
            }

            stockboxinput = document.createElement("input");
            stockboxinput.className = "stockboxinput";
            stockboxinput.id = "stockboxinput";
            stockboxinput.placeholder = "Symbol";

            stockboxinput.onkeyup = function() {
                clearList(stocklist.id, false);

                if (stockboxinput.value.length == 0) {
                    stocklist.style.visibility = "hidden";
                    return;
                }

                searchtext = stockboxinput.value.toLowerCase();

                for (var i in instruments) {
                    if (i.toLowerCase().indexOf(searchtext) == 0 || instruments[i].description.toLowerCase().indexOf(searchtext) == 0) {
                        addElement(i + " " + instruments[i].description, stocklist, i);
                    }
                }

                if (stocklist.getElementsByTagName('li').length > 0) {
                    stocklist.style.visibility = "visible";
                } else {
                    stocklist.style.visibility = "hidden";
                }
            }

            stocklist = document.createElement('ul');
            stocklist.id = "stocklist";
            stocklist.className = "stocklist";
            stocklist.style.visibility = "hidden";

            stocklist.onclick = function(e) {
                var firstspace;
                var symbol;
                var element;
                
                if (!e) e = window.event;
                element = e.target || e.srcElement;

                firstspace = element.innerHTML.indexOf(' ');
                symbol = element.innerHTML.substr(0, firstspace);

                if (frm == "watchlist") {
                    if (symbol in obdisplay) {
                        alert(symbol + " already in Watch List");
                        e.stopPropagation();
                    } else {
                        sockjs.send("{\"orderbookrequest\":" + JSON.stringify(symbol) + "}");
                        stocklist.style.visibility = "hidden";
                        stockboxinput.value = "";
                        stockboxinput.focus();
                    }
                } else if (frm == "frmproduct") {
                    displayProduct(instruments[symbol]);
                } else if (frm == "orderdiv") {
                    inpsymboldesc.value = instruments[symbol].description;
                    inpsymbol = document.getElementById("inpsymbol");
                    inpsymbol.value = symbol;
                }

                stocklist.style.visibility = "hidden";
                stockboxinput.value = "";

                if (focusfield) {
                    focusfield.focus();
                } else {
                    stockboxinput.focus();
                }
            }

            stockbox.appendChild(stockboxinput);

            if (displayname) {
                inpsymboldesc = newinput("inpsymboldesc", "forminput", stockbox, true);
            }

            stockbox.appendChild(stocklist);

            main.onclick = function(e) {
                var elem;

                if (!e) e = window.event;
                elem = e.target || e.srcElement;

                if (elem.id == "stocklist" || elem.id == "stockboxinput") {
                    return;
                }

                stocklist.style.visibility = "hidden";
            }

            if (focus) {
                stockboxinput.focus();
            }
        }

        function getList(liststr) {
            var list = document.getElementById(liststr);

            if (list == null) {
                list = document.createElement("list");
                list.className = "list";
                list.id = liststr;
            }

            main.appendChild(list);

            return list;
        }

        //
        // various display routines to display incoming data
        //

        function displayOrderBooks() {
            selectStock("watchlist", null, false, true, null);

            displayOrderBookHeadings();

            for (var symbol in orderbooks) {
                displayOrderBook(symbol);
            }
        }

        function displayOrderHeadings() {
            addHeading("New", list1);
            addHeading("Part-filled", list2);
            addHeading("Filled", list3);
            addHeading("Rejected", list4);
            addHeading("Cancelled", list5);
            addHeading("Expired", list6);
        }

        function displayPositions() {
            var tblpositions;
            var tblbody;
            var posrow;
            var headingrow;
            var numcols = 11;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            if (Object.keys(positions).length == 0) {
                var list = getList("list1");
                addElement("No positions", list, 0);
                return;
            }

            tblpositions = document.createElement("table");
            tblpositions.id = "tblpositions";
            tblpositions.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblpositions.appendChild(tblbody);
            main.appendChild(tblpositions);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                case 0:
                    col.innerHTML = "Symbol";
                    break;
                case 1:
                    col.innerHTML = "Currency";
                    break;
                case 2:
                    col.innerHTML = "Long/Short";
                    break;
                case 3:
                    col.innerHTML = "Quantity";
                    col.className = "colrightalign";
                    break;
                case 4:
                    col.innerHTML = "Cost";
                    col.className = "colrightalign";
                    break;
                case 5:
                    col.innerHTML = "Avg. Cost";
                    col.className = "colrightalign";
                    break;
                case 6:
                    col.innerHTML = "Margin";
                    col.className = "colrightalign";
                    break;
                case 7:
                    col.innerHTML = "Realised P&L";
                    col.className = "colrightalign";
                    break;
                case 8:
                    col.innerHTML = "Market Price";
                    col.className = "colrightalign";
                    break;
                case 9:
                    col.innerHTML = "Unrealised P&L";
                    col.className = "colrightalign";
                    break;
                case 10:
                    col.innerHTML = "View Trades";
                    break;
                default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            for (var x in positions) {
                var posrow = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                    case 0:
                        col.innerHTML = positions[x].symbol;
                        break;
                    case 1:
                        col.innerHTML = positions[x].currency;
                        break;
                    case 2:
                        if (positions[x].side == 1) {
                            col.innerHTML = "Long";
                            posrow.className = "rowlong";
                        } else {
                            col.innerHTML = "Short";                            
                            posrow.className = "rowshort";
                        }
                        break;
                    case 3:
                        col.innerHTML = positions[x].quantity;
                        col.className = "colrightalign";
                        break;
                    case 4:
                        col.innerHTML = positions[x].cost;
                        col.className = "colrightalign";
                        break;
                    case 5:
                        col.innerHTML = positions[x].averagecostpershare;
                        col.className = "colrightalign";
                        break;
                    case 6:
                        col.innerHTML = positions[x].margin;
                        col.className = "colrightalign";
                        break;
                    case 7:
                        col.innerHTML = positions[x].realisedpandl;
                        col.className = "colrightalign";
                        break;
                    case 8:
                        col.innerHTML = positions[x].mktprice;
                        col.className = "colrightalign";
                        break;
                    case 9:
                        col.innerHTML = positions[x].unrealisedpandl;
                        col.className = "colrightalign";
                        break;
                    case 10:
                        displayPostrades(col);
                        break;
                    default:
                    }

                    posrow.appendChild(col);
                }

                tblbody.appendChild(posrow);
            }

            function displayPostrades(col) {
                var tradehistoryrequest = {};

                var lnktrades = newlink(positions[x].symbol + ":" + positions[x].currency, "trades", "", col);

                lnktrades.onclick = function() {
                    var inpclientid = document.getElementById("inpclientid");
                    if (inpclientid != null) {
                        tradehistoryrequest.clientid = inpclientid.value;
                        tradehistoryrequest.positionkey = this.id;
                        sockjs.send("{\"tradehistoryrequest\":" + JSON.stringify(tradehistoryrequest) + "}");
                        whichPos(tradehistoryrequest.positionkey);
                    }
                }
            }

            function whichPos(pos) {
                var postrades = document.getElementById("postrades");
                if (postrades == null) {
                    postrades = document.createElement("input");
                    postrades.type = "hidden";
                    postrades.id = "postrades";
                    main.appendChild(postrades);
                }
                postrades.value = pos;
            }
        }

        function displayAccount() {
            var tblaccount;
            var tblbody;
            var numrows = 7;
            var firstcurr = true;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            if (Object.keys(account).length == 0) {
                var list = getList("list1");
                addElement("No cash or transactions", list, 0);
                return;
            }

            tblaccount = document.createElement("table");
            tblaccount.id = "tblaccount";

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblaccount.appendChild(tblbody);
            main.appendChild(tblaccount);

            for (var x in account) {
                if (!firstcurr) {
                    var emptyrow = document.createElement("tr");
                    var emptycol = document.createElement("td");
                    emptycol.innerHTML = "---";
                    emptyrow.appendChild(emptycol);
                    tblbody.appendChild(emptyrow);
                } else {
                    firstcurr = false;
                }

                var headingrow = document.createElement("tr");

                var col = document.createElement("td");
                col.innerHTML = account[x].currency;
                col.className = "colleftalign";

                headingrow.appendChild(col);
                tblbody.appendChild(headingrow);

                for (var i = 0; i < numrows; ++i) {
                    var row = document.createElement("tr");
                    var col = document.createElement("td");
                    var colval = document.createElement("td");

                    row.appendChild(col);

                    switch (i) {
                    case 0:
                        col.innerHTML = "Cash";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].cash);
                        colval.className = "colrightalign";
                        break;
                    case 1:
                        col.innerHTML = "Realised P&L";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].realisedpandl);
                        colval.className = "colunderline";
                        break;
                    case 2:
                        col.innerHTML = "Trading Balance";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].balance);
                        colval.className = "colrightalign";
                        var colempty = document.createElement("td");
                        row.appendChild(colempty);
                        break;
                    case 3:
                        col.innerHTML = "Unrealised P&L";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].unrealisedpandl);
                        colval.className = "colunderline";
                        var colempty = document.createElement("td");
                        row.appendChild(colempty);
                        break;
                    case 4:
                        col.innerHTML = "Equity";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].equity);
                        colval.className = "colrightalign";
                        var colempty1 = document.createElement("td");
                        row.appendChild(colempty1);
                        var colempty2 = document.createElement("td");
                        row.appendChild(colempty2);
                        break;
                    case 5:
                        col.innerHTML = "Margin";
                        col.className = "colleftalign";
                        colval.innerHTML = "(" + formatCurrency(account[x].margin) + ")";
                        colval.className = "colunderline";
                        var colempty1 = document.createElement("td");
                        row.appendChild(colempty1);
                        var colempty2 = document.createElement("td");
                        row.appendChild(colempty2);
                        break;
                    case 6:
                        col.innerHTML = "Free Margin";
                        col.className = "colleftalign";
                        colval.innerHTML = formatCurrency(account[x].freemargin);
                        colval.className = "coldoubleunderline";
                        var colempty1 = document.createElement("td");
                        row.appendChild(colempty1);
                        var colempty2 = document.createElement("td");
                        row.appendChild(colempty2);
                        var colempty3 = document.createElement("td");
                        row.appendChild(colempty3);
                        break;
                    default:
                    }

                    row.appendChild(colval);
                    tblbody.appendChild(row);
                }
            }
        }

        function displayOrders() {
            var firstorder = true;
            var firstorderpartfilled = true;
            var firstorderfilled = true;
            var firstorderrejected = true;
            var firstordercancelled = true;
            var firstorderexpired = true;
            var msg;
            var listelement;
            var lblnopartfilled;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            var list1 = getList("list1");
            var emptyline1 = addNewLine(main, "emptyline:1");
            var list2 = getList("list2");
            var emptyline2 = addNewLine(main, "emptyline:2");
            var list3 = getList("list3");
            var emptyline3 = addNewLine(main, "emptyline:3");
            var list4 = getList("list4");
            var emptyline4 = addNewLine(main, "emptyline:4");
            var list5 = getList("list5");
            var emptyline5 = addNewLine(main, "emptyline:5");
            var list6 = getList("list6");

            displayOrderHeadings();

            for (var x in orders) {
                if (orders[x].status == "0") { // new
                    if (firstorder) {
                        firstorder = false;
                    }

                    msg = orderNewMsg(orders[x]);
                    listelement = addElement(msg, list1, orders[x].orderid);
                    optionToViewCancel(listelement, true, true);
                } else if (orders[x].status == "1") { // part-filled
                    if (firstorderpartfilled) {
                        firstorderpartfilled = false;
                    }

                    msg = orderFillMsg(orders[x]);
                    listelement = addElement(msg, list2, orders[x].orderid);
                } else if (orders[x].status == "2") { // filled
                    if (firstorderfilled) {
                        firstorderfilled = false;
                    }

                    msg = orderFillMsg(orders[x]);
                    listelement = addElement(msg, list3, orders[x].orderid);
                } else if (orders[x].status == "8") { // rejected
                    if (firstorderrejected) {
                        firstorderrejected = false;
                    }

                    msg = orderRejectMsg(orders[x]);
                    listelement = addElement(msg, list4, orders[x].orderid);
                } else if (orders[x].status == "4") { // cancelled
                    if (firstordercancelled) {
                        firstordercancelled = false;
                    }

                    msg = orderCancelMsg(orders[x]);
                    listelement = addElement(msg, list5, orders[x].orderid);
                } else if (orders[x].status == "C") { // expired
                    if (firstorderexpired) {
                        firstorderexpired = false;
                    }

                    msg = orderExpireMsg(orders[x]);
                    listelement = addElement(msg, list6, orders[x].orderid);
                }
            }

            if (firstorder) {
                addElement("No new orders", list1, 0)
            }

            if (firstorderpartfilled) {
                addElement("No part-filled orders", list2, 0)
            } else {
                list2.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }                
            }

            if (firstorderfilled) {
                addElement("No filled orders", list3, 0)
            } else {
                list3.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }                                
            }

            if (firstorderrejected) {
                addElement("No rejected orders", list4, 0)
            } else {
                list4.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }                                
            }

            if (firstordercancelled) {
                addElement("No cancelled orders", list5, 0)
            } else {
                list5.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }                                
            }

            if (firstorderexpired) {
                addElement("No expired orders", list6, 0)
            } else {
                list6.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }                                
            }
        }

        function displayIndex(index) {
            var s;
            var sym;

            if (!(index in indices)) {return};

            for (var i = 0; i < indices[index].length; ++i) {
                sym = indices[index][i].symbol;
                if (sym in instruments) {
                    s = instruments[sym].symbol + ' ' + instruments[sym].description;
                    addElement(s, list1, sym);
                }
            }
        }

        function displayTrades() {
            var tbltrades;
            var tblbody;
            var traderow;
            var headingrow;
            var numcols = 19;

            if (selectedmenu == 7) {
                clearLists();
                clearEmptyLines();
                clearHeadings();
                clearTables();
            } else {
                clearElementById("emptyline:2");
                clearElementById("lbltrades");
                clearTable("tbltrades");
                clearList("list1", true);
            }

            var emptyline2 = addNewLine(main, "emptyline:2");

            if (selectedmenu == 8) {
                var postrades = document.getElementById("postrades");
                if (postrades != null) {
                    var lbltrades = newlabel("lbltrades", "Trades for position " + postrades.value, "", main);
                }
            }

            if (Object.keys(trades).length == 0) {
                var list = getList("list1");
                addElement("No trades", list, 0);
                return;
            }

            tbltrades = document.createElement("table");
            tbltrades.id = "tbltrades";
            tbltrades.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tbltrades.appendChild(tblbody);
            main.appendChild(tbltrades);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                case 0:
                    col.innerHTML = "Client";
                    break;
                case 1:
                    col.innerHTML = "Symbol";
                    break;
                case 2:
                    col.innerHTML = "Side";
                    break;
                case 3:
                    col.innerHTML = "Quantity";
                    col.className = "colrightalign";
                    break;
                case 4:
                    col.innerHTML = "Price";
                    col.className = "colrightalign";
                    break;
                case 5:
                    col.innerHTML = "Settlcurramt";
                    col.className = "colrightalign";
                    break;
                case 6:
                    col.innerHTML = "Nosettdays";
                    break;                
                case 7:
                    col.innerHTML = "Settl.Date";
                    break;
                case 8:
                    col.innerHTML = "Currency";
                    break;
                case 9:
                    col.innerHTML = "Commission";
                    col.className = "colrightalign";
                    break;
                case 10:
                    col.innerHTML = "Ptm Levy";
                    col.className = "colrightalign";
                    break;
                case 11:
                    col.innerHTML = "Stamp Duty";
                    col.className = "colrightalign";
                    break;
                case 12:
                    col.innerHTML = "Contract Charge";
                    col.className = "colrightalign";
                    break;
                case 13:
                    col.innerHTML = "Counterparty";
                    break;
                case 14:
                    col.innerHTML = "External Trade Id";
                    break;
                case 15:
                    col.innerHTML = "Timestamp";
                    break;
                case 16:
                    col.innerHTML = "Trade Id";
                    break;
                case 17:
                    col.innerHTML = "Finance";
                    col.className = "colrightalign";
                    break;
                case 18:
                    col.innerHTML = "Margin";
                    col.className = "colrightalign";
                    break;
                default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            for (var x in trades) {
                var traderow = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                    case 0:
                        col.innerHTML = trades[x].clientid;
                        break;
                    case 1:
                        col.innerHTML = trades[x].symbol;
                        break;
                    case 2:
                        col.innerHTML = getSideDesc(trades[x].side);
                        break;
                    case 3:
                        col.innerHTML = trades[x].quantity;
                        col.className = "colrightalign";
                        break;
                    case 4:
                        col.innerHTML = trades[x].price;
                        col.className = "colrightalign";
                        break;
                    case 5:
                        col.innerHTML = trades[x].settlcurramt;
                        col.className = "colrightalign";
                        break;
                    case 6:
                        col.innerHTML = "T+" + trades[x].nosettdays;
                        break;
                    case 7:
                        col.innerHTML = formatUTCDate(trades[x].futsettdate);
                        break;
                    case 8:
                        col.innerHTML = trades[x].settlcurrency;
                        break;
                    case 9:
                        col.innerHTML = trades[x].commission;
                        col.className = "colrightalign";
                        break;
                    case 10:
                        col.innerHTML = trades[x].ptmlevy;
                        col.className = "colrightalign";
                        break;
                    case 11:
                        col.innerHTML = trades[x].stampduty;
                        col.className = "colrightalign";
                        break;
                    case 12:
                        col.innerHTML = trades[x].contractcharge;
                        col.className = "colrightalign";
                        break;
                    case 13:
                        col.innerHTML = trades[x].counterpartyid;
                        break;
                    case 14:
                        col.innerHTML = trades[x].externaltradeid;
                        break;
                    case 15:
                        col.innerHTML = formatUTCDateTime(trades[x].timestamp);
                        break;
                    case 16:
                        col.innerHTML = trades[x].tradeid;
                        break;
                    case 17:
                        col.innerHTML = trades[x].finance;
                        break;
                    case 18:
                        col.innerHTML = trades[x].margin;
                        break;
                    default:
                    }

                    traderow.appendChild(col);
                }

                tblbody.appendChild(traderow);
            }
        }

        function displayChatHistory() {
            var firstchat = true;
            var msg;
            var list;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            list = getList("list1");

            for (var x in chathistory) {
                msg = chatMsg(chathistory[x]);
                addElement(msg, list, chathistory[x].chatid);
                firstchat = false;
            }

            if (firstchat) {
                addElement("No chat", list, 0);                
            } else {
                list.onclick = function(e) {
                    var element;
                    
                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    alert(chathistory[element.value].text)
                }
            }
        }

        function displayQuoteRequests() {
            var firstquoterequest = true;
            var msg;
            var list;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            list = getList("list1");

            for (var x in quoterequests) {
                msg = quoteRequestMsg(quoterequests[x]);
                addElement(msg, list, quoterequests[x].quotereqid);
                firstquoterequest = false;
            }

            if (firstquoterequest) {
                addElement("No quote requests", list, 0);                
            } else {
                list.onclick = function(e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewQuoteRequest(element.value);
                }
            }
        }

        function displayQuotes() {
            var firstquote = true;
            var msg;
            var list;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            list = getList("list1");

            for (var x in quotes) {
                msg = quoteMsg(quotes[x]);
                addElement(msg, list, quotes[x].quoteid);
                firstquote = false;
            }

            if (firstquote) {
                addElement("No quotes", list, 0);                
            } else {
                list.onclick = function(e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewQuote(element.value);
                }
            }
        }

        function displayCashHistory() {
            var tblcashhistory;
            var tblbody;
            var posrow;
            var headingrow;
            var numcols = 8;
            var firstrow;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();

            var emptyline = addNewLine(main, "emptyline:1");

            if (Object.keys(cashhistory).length == 0) {
                var list = getList("list1");
                addElement("No cash transactions", list, 0);
                return;
            }

            tblcashhistory = document.createElement("table");
            tblcashhistory.id = "tblcashhistory";
            tblcashhistory.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblcashhistory.appendChild(tblbody);
            main.appendChild(tblcashhistory);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                case 0:
                    col.innerHTML = "Datetime";
                    col.className = "colleftalign";
                    break;
                case 1:
                    col.innerHTML = "Currency";
                    col.className = "colleftalign";
                    break;
                case 2:
                    col.innerHTML = "Type";
                    col.className = "colleftalign";
                    break;
                case 3:
                    col.innerHTML = "Description";
                    col.className = "colleftalign";
                    break;
                case 4:
                    col.innerHTML = "Reference";
                    col.className = "colleftalign";
                    break;
                case 5:
                    col.innerHTML = "In(+)";
                    col.className = "colrightalign";
                    break;
                case 6:
                    col.innerHTML = "Out(-)";
                    col.className = "colrightalign";
                    break;
                case 7:
                    col.innerHTML = "Balance";
                    col.className = "colrightalign";
                    break;
                default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            firstrow = document.createElement("tr");

            for (var i = 0; i < numcols-1; ++i) {
                var col = document.createElement("td");
                if (i == 3) {
                    col.innerHTML = "Start Balance";
                } else {
                    col.innerHTML = "";
                }
                firstrow.appendChild(col);
            }

            var col = document.createElement("td");
            col.innerHTML = "0.00";
            col.className = "colrightalign";
            firstrow.appendChild(col);

            tblbody.appendChild(firstrow);

            for (var x in cashhistory) {
                var row = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                    case 0:
                        col.innerHTML = formatUTCDateTime(cashhistory[x].timestamp);
                        break;
                    case 1:
                        col.innerHTML = cashhistory[x].currency;
                        break;
                    case 2:
                        col.innerHTML = cashhistory[x].transtype;
                        break;
                    case 3:
                        col.innerHTML = cashhistory[x].description;
                        break;
                    case 4:
                        col.innerHTML = cashhistory[x].reference;
                        break;
                    case 5:
                        if (cashhistory[x].drcr == 1) {
                            var amount = formatCurrency(cashhistory[x].amount);
                            col.innerHTML = amount;
                        } else {
                            col.innerHTML = "";                            
                        }
                        col.className = "colrightalign";
                        break;
                    case 6:
                        if (cashhistory[x].drcr == 2) {
                            var amount = formatCurrency(cashhistory[x].amount);                            
                            col.innerHTML = amount;
                        } else {
                            col.innerHTML = "";                            
                        }
                        col.className = "colrightalign";
                        break;
                    case 7:
                        var balance = formatCurrency(cashhistory[x].balance);
                        col.innerHTML = balance;
                        col.className = "colrightalign";
                        break;
                    default:
                    }

                    row.appendChild(col);
                }

                tblbody.appendChild(row);
            }
        }

        function formatCurrency(num) {
            num = isNaN(num) || num === '' || num === null ? 0.00 : num;
            return parseFloat(num).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function marginMsg(margin) {
            return parseFloat(margin.amount).toFixed(2) + " " + margin.currency;            
        }

        function displayCash() {
            var firstCash = true;
            var tmpcasharr = [];

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            var list = getList("list1");

            var i = 0;
            for (var x in cash) {
                addElement(cashMsg(cash[x]), list, i);
                tmpcasharr[i] = cash[x].currency;
                i++;
                firstCash = false;
            }

            if (firstCash) {
                addElement("No cash", list, "");                
            } else {
                list.onclick = function(e) {
                    var element;
                    var historyrequest = {};

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    historyrequest.clientid = inpclientid.value;
                    historyrequest.currency = tmpcasharr[element.value];
                    sockjs.send("{\"cashhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
                }
            }
        }

        function displayMargins() {
            var firstMargin = true;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();

            var emptyline = addNewLine("emptyline:1");

            var list = getList("list1");

            for (var x in margins) {
                addElement(marginMsg(margins[x]), list, margins[x].currency);
                firstMargin = false;
            }

            if (firstMargin) {
                addElement("No margin", list, "");                
            }
        }

        function displayReserves() {
            var reskey;
            var msg;
            var firstReserve = true;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();

            var emptyline = addNewLine(main, "emptyline:1");

            var list = getList("list1");

            for (var x in reserves) {
                reskey = reserves[x].symbol + ":" + reserves[x].currency + ":" + reserves[x].settldate;
                msg = reserveMsg(reserves[x]);
                addElement(msg, list, reskey);
                firstReserve = false;
            }

            if (firstReserve) {
                addElement("No reserves", list, "");
            }
        }

        function optionToViewCancel(listelement, cancelorder, fillorder) {
            var addfuncdiv;

            if (!isTouchDevice()) {
                listelement.onmouseover = function() {
                    addfuncdiv.style.visibility = "visible";
                }
                listelement.onmouseout = function() {
                    addfuncdiv.style.visibility = "hidden";
                }
            }

            addfuncdiv = document.createElement('div');
            addfuncdiv.style.visibility = "hidden";

            var vieworderlnk = newlink("vieworderlnk", "View Order", "", addfuncdiv);

            vieworderlnk.onclick = function() {
                viewOrder(listelement.value);
            }

            if (cancelorder) {
                var cancelorderlnk = newlink("cancelorderlnk", "Cancel Order", "", addfuncdiv);

                cancelorderlnk.onclick = function() {
                    confirmOrderCancel(listelement.value);
                }
            }

            if (fillorder) {
                var fillorderlnk = newlink("fillorderlnk", "Fill Order", "", addfuncdiv);

                fillorderlnk.onclick = function() {
                    confirmOrderFill(listelement.value);
                }
            }

            listelement.appendChild(addfuncdiv);
        }

        //
        // various view routines to display a single list element in an alert box
        //

        function viewOrder(orderid) {
            var msg = "";
            var order;
            var fieldcontents;
            var fielddesc;

            order = orders[orderid];

            for (var field in order) {
                fieldcontents = order[field];

                switch (field) {
                    case 'side':
                        fielddesc = getSideDesc(fieldcontents);
                        break;
                    case 'status':
                        fielddesc = getOrderStatusDesc(fieldcontents);
                        break;
                    case 'ordertype':
                        fielddesc = getOrdertypeDesc(fieldcontents);                        
                        break;
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    case 'reason':
                        fielddesc = getReasonDesc(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function viewQuoteRequest(quotereqid) {
            var msg = "";
            var quoterequest;

            quoterequest = quoterequests[quotereqid];

            for (var field in quoterequest) {
                msg += field + ": " + quoterequest[field] + "\n";
            }

            alert(msg);
        }

        function viewQuote(quoteid) {
            var msg = "";
            var quote;
            var fieldcontents;
            var fielddesc;

            quote = quotes[quoteid];

            for (var field in quote) {
                fieldcontents = quote[field];

                switch (field) {
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function viewTrade(tradeid) {
            var msg = "";
            var trade;
            var fieldcontents;
            var fielddesc;

            trade = trades[tradeid];

            for (var field in trade) {
                fieldcontents = trade[field];

                switch (field) {
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function viewCashHistory(cashtransid) {
            var msg = "";
            var cashhist;
            var fieldcontents;
            var fielddesc;

            cashhist = cashhistory[cashtransid];

            for (var field in cashhist) {
                fieldcontents = cashhist[field];

                switch (field) {
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);            
        }

        function requestPortfolio() {
            var inpclientid;

            var frmpositions = getForm("frmpositions");

            selectClient("frmpositions", null, null, true, "", "inpclientid", "", false);

            var lnkpositions = newlink("lnkpositions", "Positions", "", frmpositions);
            var lnkcash = newlink("lnkcash", "Cash", "", frmpositions);
            //var lnkmargin = newlink("lnkmargin", "Margin", "", frmpositions);
            //var lnkreserves = newlink("lnkreserves", "Reserves", "", frmpositions);
            var lnkaccount = newlink("lnkaccount", "Account", "", frmpositions);

            lnkpositions.onclick = function() {
                var positionrequest = {};

                if (!validateClientid()) {return;}

                setSelected(lnkpositions);
                positionrequest.clientid = inpclientid.value;
                sockjs.send("{\"positionrequest\":" + JSON.stringify(positionrequest) + "}");
            }

            lnkcash.onclick = function() {
                var cashrequest = {};

                if (!validateClientid()) {return;}

                setSelected(lnkcash);
                cashrequest.clientid = inpclientid.value;
                sockjs.send("{\"cashrequest\":" + JSON.stringify(cashrequest) + "}");
            }

            /*lnkmargin.onclick = function() {
                var marginrequest = {};

                if (!validateClientid()) {return;}

                setSelected(lnkmargin);
                marginrequest.clientid = inpclientid.value;
                sockjs.send("{\"marginrequest\":" + JSON.stringify(marginrequest) + "}");
            }

            lnkreserves.onclick = function() {
                var reservesrequest = {};

                if (!validateClientid()) {return;}

                setSelected(lnkreserves);
                reservesrequest.clientid = inpclientid.value;
                sockjs.send("{\"reservesrequest\":" + JSON.stringify(reservesrequest) + "}");
            }*/

            lnkaccount.onclick = function() {
                var accountrequest = {};

                if (!validateClientid()) {return;}

                setSelected(lnkaccount);
                accountrequest.clientid = inpclientid.value;
                sockjs.send("{\"accountrequest\":" + JSON.stringify(accountrequest) + "}");
            }

            inpclientid = document.createElement("input");
            inpclientid.type = "hidden";
            inpclientid.id = "inpclientid";
            inpclientid.value = "";

            frmpositions.appendChild(inpclientid);

            main.appendChild(frmpositions);

            function validateClientid() {
                if (inpclientid.value == "") {
                    alert("Please select a client");
                    selectClientFocus("clientboxinput");
                    return false;
                }

                return true;
            }

            function setSelected(link) {
                lnkpositions.className = "";
                lnkcash.className = "";
                //lnkmargin.className = "";
                //lnkreserves.className = "";
                lnkaccount.className = "";

                link.className = "linkselected";
            }
        }

        function requestConnections() {
            sockjs.send("{\"connectionrequest\":\"client\"}");
        }

        function displayConnections() {
            var firstconnection = true;
            var list;
            var msg;

            clearLists();

            list = getList("list1");

            for (var x in connections) {
                msg = connections[x].name;

                if ('pendingchat' in connections[x] && connections[x].pendingchat) {
                    msg += " *** chat pending ***";
                }

                addElement(msg, list, connections[x].clientid);
                firstconnection = false;
            }

            if (firstconnection) {
                addElement("No connections", list, 0);                
            } else {
                list.onclick = function(e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    chatConnection(element);
                }
            }
        }

        //
        // start a chat conversation
        //
        function chatConnection(elem) {
            var chatid;
            var chattext;
            var chattextlen;
            var pendingchatrequest = {};

            var ls = document.getElementById("list1");
            ls.className = "listchat";

            if ('pendingchat' in connections[elem.value] && connections[elem.value].pendingchat) {
                pendingchatrequest.clientid = elem.value;
                sockjs.send("{\"pendingchatrequest\":" + JSON.stringify(pendingchatrequest) + "}");
            }

            var chatdiv = getDiv("chatdiv:" + elem.value);

            chattext = document.getElementById("chattext:" + elem.value);
            if (chattext != null) {
                return;
            }

            chattext = document.createElement("textarea");
            chattext.id = "chattext:" + elem.value;

            chatdiv.appendChild(chattext);

            addNewLine(chatdiv, null);

            var chatbtn = newbutton("btnchat:" + elem.value, "Send", "chatbtn", chatdiv);

            chatid = document.createElement("input");
            chatid.type = "hidden";
            chatid.id = "chatid:" + elem.value;
            chatid.value = "0";

            chattextlen = document.createElement("input");
            chattextlen.type = "hidden";
            chattextlen.id = "chattextlen:" + elem.value;

            chatdiv.appendChild(chatid);
            chatdiv.appendChild(chattextlen);

            elem.appendChild(chatdiv);

            chatbtn.onclick = function(event) {
                var chat = {};

                event = event || window.event;  // cross-browser event

                chat.chatid = chatid.value;
                chat.clientid = elem.value;
                chat.text = chattext.value.substr(chattextlen.value);

                sockjs.send("{\"chat\":" + JSON.stringify(chat) + "}");

                if (event.stopPropagation) {
                    // W3C standard variant
                    event.stopPropagation();
                } else {
                    // IE variant
                    event.cancelBubble = true;
                }
            }

            chattext.focus();
            chattext.value = ">>";;
            chattextlen.value = chattext.value.length;
        }

        function newChat(chat) {
            var chattext;
            var chattextlen;
            var chatid;
            var menuitemchat;
            var list;
            var items;

            // if chat not selected, just highlight the menu option
            if (selectedmenu != chatmenuoption) {
                menuitemchat = document.getElementById("menuitemchat");
                if (menuitemchat != null) {
                    menuitemchat.className = "menuitemchat";
                }
                return;
            }

            // is the relevant client selected?
            chattext = document.getElementById("chattext:" + chat.clientid);
            if (chattext == null) {
                // highlight client connection
                list = document.getElementById("list1");
                if (list != null) {
                    items = list.getElementsByTagName("li");

                    for (var i = 0; i < items.length; ++i) {
                        if (items[i].value == chat.clientid) {
                            items[i].innerHTML += " *** chat pending ***";
                            break;
                        }
                    }
                }
                return;
            }

            chattext.focus();

            if (chattext.value != "") {
                chattext.value += "\n";
            }
            chattext.value += chat.text + "\n" + ">>";

            chattextlen = document.getElementById("chattextlen:" + chat.clientid);
            if (chattextlen != null) {
                chattextlen.value = chattext.value.length;
            }

            chatid = document.getElementById("chatid:" + chat.clientid);
            if (chatid != null) {
                chatid.value = chat.chatid;
            }
        }

        function addHeading(text, list) {
            var newtext = document.createTextNode(text);
            main.insertBefore(newtext, list);
            main.className = "heading";
        }

        function removeHeading(text) {
            for (var i = 0; i < main.childNodes.length; ++i) {
                if (main.childNodes[i].nodeType == 3 && main.childNodes[i].nodeValue == text) {
                    main.removeChild(main.childNodes[i]);
                    break;
                }
            }
        }

        function removeElementFromList(index, list) {
            for (var i = 0; i < list.childNodes.length; ++i) {
                if (list.childNodes[i].value == index) {
                    list.removeChild(list.childNodes[i]);
                    break;
                }
            }
        }

        //
        // various message routines to display formatted messages
        //

        function quoteRequestMsg(quoterequest) {
            var msg;

            if (quoterequest.quantity != "") {
                msg = quoterequest.quantity;
            } else {
                msg = quoterequest.cashorderqty + " (value)";                
            }

            msg += " " + quoterequest.symbol + " requested in " + quoterequest.settlcurrency + ", T+" + quoterequest.nosettdays + " at " + formatUTCDateTime(quoterequest.timestamp);

            return msg;
        }

        function quoteMsg(quote) {
            var msg;

            msg = quote.symbol + " in " + quote.settlcurrency + ", T+" + quote.nosettdays + ", quoted " + quote.bidpx + " to Sell, " + quote.offerpx + " to Buy, at " + formatUTCDateTime(quote.transacttime) + ", quote id " + quote.quoteid;

            if ('orderid' in quote) {
                msg += ", order id " + quote.orderid;
            } else {
                msg += ", no order placed";
            }

            return msg;
        }

        function orderNewMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }
            msg += " " + getOrdertypeDesc(order.ordertype) + ", order id " + order.orderid + ", placed at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderFillMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += ", T+" + order.nosettdays + ", " + getOrdertypeDesc(order.ordertype);
            if (order.remquantity > 0) {
                msg += ", " + order.remquantity  + " remaining";
            }
            msg += ", order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderRejectMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.remquantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg +=  " " + getOrdertypeDesc(order.ordertype) + ", rejected, reason: " + getReasonDesc(order.reason);

            if (order.text != "") {
                msg += " " + order.text;
            }

            msg += ", order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderCancelMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol + ", " + order.remquantity + " remaining";

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += " " + getOrdertypeDesc(order.ordertype) + ", cancelled, order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderExpireMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol + ", " + order.remquantity + " remaining";

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += " " + getOrdertypeDesc(order.ordertype) + ", expired, order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function tradeMsg(trade) {
            var msg;

            msg = getSideDescTrade(trade.side) + " " + trade.quantity + " " + trade.symbol + " @ " + trade.price;

            if (trade.settlcurrency != "GBP" || trade.settlcurrency != trade.currency) {
                msg += " (" + trade.settlcurrency + ")"
            }

            msg += ", T+" + trade.nosettdays + ", trade id: " + trade.tradeid + ", order id: " + trade.orderid + ", executed " + formatUTCDateTime(trade.timestamp);

            if (trade.clientid in clients) {
                msg += " for " + clients[trade.clientid].name;
            }

            return msg;
        }

        function cashHistoryMsg(cashhist) {
            var msg;

            msg = cashhist.timestamp + " " + cashtranstypes[cashhist.transtype].description + " " + cashhist.amount + " " + cashhist.currency;

            return msg;
        }

        function chatMsg(chat) {
            var msg;

            msg = "Chat id:" + chat.chatid + " with " + chat.user + ", started at " + formatUTCDateTime(chat.timestamp);

            return msg;
        }

        function cashMsg(cash) {
            return formatCurrency(cash.amount) + " " + cash.currency;
        }

        function getSideDescTrade(side) {
            if (side == "1") {
                return "Bought ";
            } else {
                return "Sold ";
            }
        }

        function positionMsg(position) {
            var msg;

            if (position.longshort == "1") {
                msg = "Long ";
            } else {
                msg = "Short ";
            }
            msg += position.quantity + " " + position.symbol + ", cost " + parseFloat(position.cost).toFixed(2) + " " + position.currency;

            return msg;
        }

        function reserveMsg(reserve) {
            return reserve.quantity + " " + reserve.symbol + " " + reserve.currency + " " + reserve.settldate;
        }

        function orderCancelReject(ordercancelreject) {
            alert("Request to cancel order #" + ordercancelreject.orderid + " rejected, reason: " + ordercancelreject.reasondesc);
        }

        function removeOrderBook(symbol) {
            var stockboxinput;

            if (symbol in orderbooks) {
                clearSymbolDiv(symbol);
                clearAllStrips(symbol);

                if (obdisplay[symbol].previoussymbol != null) {
                    if (obdisplay[symbol].insertbefore != null) {
                        obdisplay[obdisplay[symbol].previoussymbol].insertbefore = obdisplay[symbol].insertbefore;
                    } else {
                        obdisplay[obdisplay[symbol].previoussymbol].insertbefore = null;                        
                    }
                }

                if (obdisplay[symbol].insertbefore != null) {
                    if (obdisplay[symbol].previoussymbol != null) {
                        obdisplay[obdisplay[symbol].insertbefore].previoussymbol = obdisplay[symbol].previoussymbol;
                    } else {
                        obdisplay[obdisplay[symbol].insertbefore].previoussymbol = null;
                    }
                }

                if (symbol == lastsymbol) {
                    if (obdisplay[symbol].previoussymbol != null) {
                        lastsymbol = obdisplay[symbol].previoussymbol;
                    } else {
                        lastsymbol = null;
                    }
                }

                delete obdisplay[symbol];
                delete orderbooks[symbol];
                delete priceflash[symbol];

                if (Object.keys(orderbooks).length == 0) {
                    clearOrderBookHeadings();
                }

                stockboxinput = document.getElementById("stockboxinput");
                if (stockboxinput != null) {
                    stockboxinput.focus();
                }
            }
        }

        function displayOrderBook(symbol) {
            var strip;
            var display = {};
            var bidprice;
            var offerprice;
            var bidquantity;
            var offerquantity;
            var level2;
            var stock;
            var slash;
            var y;
            var removestock;
            var orderdiv;
            var nextsymbol;
            var links;

            if (!(symbol in orderbooks)) {
                return;
            }

            if (!(symbol in obdisplay)) {
                display.level2 = false;
                display.insertbefore = null;
                display.previoussymbol = null;
                obdisplay[symbol] = display;

                displayOrderBookHeadings();

                if (lastsymbol != null) {
                    obdisplay[lastsymbol].insertbefore = symbol;
                    obdisplay[symbol].previoussymbol = lastsymbol;
                }
                lastsymbol = symbol;
            }

            for (y = 0; y < orderbooks[symbol].length; ++y) {
                strip = document.getElementById("strip:" + symbol + ":" + y);
                if (strip != null) {
                    bidprice = document.getElementById("bidprice:" + symbol + ":" + y);
                    offerprice = document.getElementById("offerprice:" + symbol + ":" + y);
                    if (showvolume) {
                        bidquantity = document.getElementById("bidquantity:" + symbol + ":" + y);
                        offerquantity = document.getElementById("offerquantity:" + symbol + ":" + y);
                    }
                } else {
                    // first time through, so create elements
                    strip = document.createElement('div');
                    strip.id = "strip:" + symbol + ":" + y;

                    if (!isTouchDevice()) {
                        strip.onmouseover = function() {
                            links.style.visibility = "visible";
                        }
                        strip.onmouseout = function() {
                            links.style.visibility = "hidden";
                        }
                    }

                    if (showvolume) {
                        level2 = document.createElement('span');
                        level2.className = "level2";
                    }
                    stock = document.createElement('span');
                    stock.className = "stock";
                    bidprice = document.createElement('span');
                    bidprice.id = "bidprice:" + symbol + ":" + y;
                    bidprice.title = "Place a new limit sell order";
                    bidprice.onclick = function() {setOrderPrice(this, "2", symbol);}
                    offerprice = document.createElement('span');
                    offerprice.id = "offerprice:" + symbol + ":" + y;
                    offerprice.title = "Place a new limit buy order";
                    offerprice.onclick = function() {setOrderPrice(this, "1", symbol);}

                    if (showvolume) {
                        bidquantity = document.createElement('span');
                        bidquantity.className = "bidquantity";
                        bidquantity.id = "bidquantity:" + symbol + ":" + y;
                        bidquantity.title = "Place a new limit sell order";
                        bidquantity.onclick = function() {setOrderQuantity(this, "2", symbol);}
                        offerquantity = document.createElement('span');
                        offerquantity.className = "offerquantity";
                        offerquantity.id = "offerquantity:" + symbol + ":" + y;
                        offerquantity.title = "Place a new limit buy order";
                        offerquantity.onclick = function() {setOrderQuantity(this, "1", symbol);}
                    }

                    slash = document.createElement('span');
                    slash.className = "slash";
                    slash.innerHTML = "/";
                    removestock = document.createElement('span');
                    removestock.className = "removestock";

                    if (y == 0) {
                        strip.className = "yellowstrip";

                        links = document.createElement('div');

                        if (!isTouchDevice()) {
                            links.style.visibility = "hidden";
                        }

                        var reqquotelnk = newlink("reqquotelnk", "Request Quote", "", links);
                        var buyorderlnk = newlink("buyorderlnk", "Limit Buy", "", links);
                        var sellorderlnk = newlink("sellorderlnk", "Limit Sell", "", links);
                        var clearquotelnk = newlink("clearquotelnk", "Clear", "", links);

                        reqquotelnk.onclick = function() {requestQuote(symbol);}
                        buyorderlnk.onclick = function() {placeOrder(symbol, '1', 0, 0);}
                        sellorderlnk.onclick = function() {placeOrder(symbol, '2', 0, 0);}
                        clearquotelnk.onclick = function() {clearSymbolDiv(symbol);}

                        if (showvolume) {
                            level2.onclick = function() {
                                clearAllStrips(symbol);
                                obdisplay[symbol].level2 = !obdisplay[symbol].level2;
                                displayOrderBook(symbol);
                            }

                            if (obdisplay[symbol].level2) {
                                level2.title = "hide depth";
                                level2.innerHTML = "-";
                            } else {
                                level2.title = "show depth";
                                level2.innerHTML = "+";
                            }
                        }

                        stock.innerHTML = symbol;
                        stock.title = "Request a quote";

                        stock.onclick = function() {
                            requestQuote(symbol);
                        }

                        removestock.innerHTML = "x";
                        removestock.title = "Remove from Watch List";

                        removestock.onclick = function() {
                            if (symbol in obdisplay) {
                                removeOrderBook(symbol);
                                sockjs.send("{\"orderbookremoverequest\":" + JSON.stringify(symbol) + "}");
                            } else {
                                alert(symbol + " not in Watch List");
                            }
                        }
                    } else {
                        strip.className = "depthstrip";
                    }

                    if (showvolume) {
                        strip.appendChild(level2);
                    }
                    strip.appendChild(stock);
                    if (showvolume) {
                        strip.appendChild(bidquantity);
                    }
                    strip.appendChild(bidprice);
                    strip.appendChild(slash);
                    strip.appendChild(offerprice);
                    if (showvolume) {
                        strip.appendChild(offerquantity);
                    }
                    strip.appendChild(removestock);

                    if (y == 0) {
                        strip.appendChild(links);
                    }

                    orderdiv = document.getElementById("orderdiv:" + symbol + ":1");

                    if (orderdiv != null) {
                        main.insertBefore(strip, orderdiv);
                    } else if (obdisplay[symbol].insertbefore == null) {
                        main.appendChild(strip);
                    } else {
                        nextsymbol = document.getElementById("strip:" + obdisplay[symbol].insertbefore + ":0");
                        main.insertBefore(strip, nextsymbol);
                    }
                }

                priceChange(symbol, y, bidprice, offerprice);

                bidprice.innerHTML = orderbooks[symbol][y].bid;
                offerprice.innerHTML = orderbooks[symbol][y].offer;

                if (showvolume) {
                    bidquantity.innerHTML = orderbooks[symbol][y].bidvol;
                    offerquantity.innerHTML = orderbooks[symbol][y].offervol;
                }

                if (!obdisplay[symbol].level2) {break;}
            }
        }

        function isTouchDevice() {
            try {
                document.createEvent("TouchEvent");
                return true;
            }
            catch (e) {
                return false;
            }
        }

        function priceChange(symbol, y, bidprice, offerprice) {
            if (y == 0) {
                // bid
                if (orderbooks[symbol][y].bidflashcount > 0) {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "yellowstripbidflashup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "yellowstripbidflashdn";
                    } else {
                        bidprice.className = "yellowstripbidflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "yellowstripbidup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "yellowstripbiddn";
                    } else {
                        bidprice.className = "yellowstripbidnochange";
                    }                            
                }

                // offer
                if (orderbooks[symbol][y].offerflashcount > 0) {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "yellowstripofferflashup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "yellowstripofferflashdn";
                    } else {
                        offerprice.className = "yellowstripofferflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "yellowstripofferup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "yellowstripofferdn";
                    } else {
                        offerprice.className = "yellowstripoffernochange";
                    }                            
                }
            } else {
                // bid
                if (orderbooks[symbol][y].bidflashcount > 0) {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "bidflashup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "bidflashdn";
                    } else {
                        bidprice.className = "bidflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "bidup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "biddn";
                    } else {
                        bidprice.className = "bidnochange";
                    }                            
                }

                // offer
                if (orderbooks[symbol][y].offerflashcount > 0) {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "offerflashup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "offerflashdn";
                    } else {
                        offerprice.className = "offerflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "offerup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "offerdn";
                    } else {
                        offerprice.className = "offernochange";
                    }                            
                }
            }
        }

        function displayOrderBookHeadings() {
            var headingstrip;
            var headinglevel2;
            var headingstock;
            var headingbidquantity;
            var headingbidprice;
            var headingofferprice;
            var headingofferquantity;
            var headingslash;

            if (Object.keys(orderbooks).length == 0) {
                return;
            }

            headingstrip = document.getElementById("headingstrip");
            if (headingstrip != null) {
                return;
            }

            headingstrip = document.createElement('div');
            headingstrip.id = "headingstrip";
            headingstrip.className = "headingstrip";
            if (showvolume) {
                headinglevel2 = document.createElement('span');
                headinglevel2.className = "level2heading";
            }
            headingstock = document.createElement('span');
            headingstock.innerHTML = "Stock";
            headingstock.className = "stockheading";
            if (showvolume) {
                headingbidquantity = document.createElement('span');
                headingbidquantity.innerHTML = "Bid Vol";
                headingbidquantity.className = "bidquantityheading";
            }
            headingbidprice = document.createElement('span');
            headingbidprice.innerHTML = "Bid Price";
            headingbidprice.className = "bidheading";
            headingofferprice = document.createElement('span');
            headingofferprice.innerHTML = "Offer Price";
            headingofferprice.className = "offerheading";
            if (showvolume) {
                headingofferquantity = document.createElement('span');
                headingofferquantity.innerHTML = "Offer Vol";
                headingofferquantity.className = "offerquantityheading";
            }
            headingslash = document.createElement('span');
            headingslash.innerHTML = "/";
            headingslash.className = "slashheading";
            if (showvolume) {
                headingstrip.appendChild(headinglevel2);
            }
            headingstrip.appendChild(headingstock);
            if (showvolume) {
                headingstrip.appendChild(headingbidquantity);
            }
            headingstrip.appendChild(headingbidprice);
            headingstrip.appendChild(headingslash);
            headingstrip.appendChild(headingofferprice);
            if (showvolume) {
                headingstrip.appendChild(headingofferquantity);
            }

            main.appendChild(headingstrip);
        }

        function getOrderDivNum(symbol) {
            var orderdivnum = 0;

            if (symbol in orderdivnumarr) {
                orderdivnum = orderdivnumarr[symbol];
            }

            return orderdivnum;
        }

        function incrOrderDivNum(symbol) {
            if (symbol in orderdivnumarr) {
                orderdivnumarr[symbol]++;
            } else {
                orderdivnumarr[symbol] = 1;
            }

            return orderdivnumarr[symbol];
        }

        function requestQuote(symbol) {
            var quotereqbutton;
            var quotereqqty;
            var orderdiv;
            var quantity;
            var cashorderqty;
            var currencysel;
            var qtyascashorshares = 1;
            var settlperiod;
            var lblquantity;
            var lblsettle;
            var inpclientid;
            var lblcurrency;
            var focusfield;
            var focusfldstr;
            var quotereqqtystr;
            var inpclientidstr;
            var orderdivnum;

            // get the order div. number for this symbol as there may be more than one
            orderdivnum = incrOrderDivNum(symbol);

            symbolstr = symbol + ":" + orderdivnum;
            orderdiv = getDiv("orderdiv:" + symbolstr, symbol);
            inpclientidstr = "inpclientid:" + symbolstr;
            quotereqqtystr = "quotereqquantity:" + symbolstr;
            focusfldstr = "clientboxinput:" + symbolstr;

            selectClient("orderdiv", orderdiv, symbolstr, true, null, inpclientidstr, quotereqqtystr, false);

            // remember the client
            inpclientid = document.createElement("input");
            inpclientid.type = "hidden";
            inpclientid.id = inpclientidstr;

            quotereqqty = document.createElement("input");
            quotereqqty.className = "quotereqquantity";
            quotereqqty.placeholder = getQuantityDesc(qtyascashorshares);
            quotereqqty.id = quotereqqtystr;

            quotereqqty.onkeypress = function(event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            quantitycashsel = document.createElement("select");
            quantitycashsel.id = "quantitycashsel:" + symbolstr;

            quantitycashsel[0] = new Option("Number of shares", 1, true, true);
            quantitycashsel[1] = new Option("Cash amount", 2, false, false);

            quantitycashsel.onchange = function() {
                qtyascashorshares = quantitycashsel[quantitycashsel.selectedIndex].value;
                quotereqqty.placeholder = getQuantityDesc(qtyascashorshares);
                quotereqqty.focus();
            }
            quantitycashsel.className = "formselect";

            lblquantity = document.createElement("label");
            lblquantity.innerHTML = "Quantity:";
            lblquantity.className = "formlabelshort";
            lblcurrency = document.createElement("label");
            lblcurrency.className = "formlabelshort";
            lblcurrency.innerHTML = "Currency:";
            lblsettle = document.createElement("label");
            lblsettle.className = "formlabelshort";
            lblsettle.innerHTML = "Settlement:";

            // option to change settlement currency
            currencysel = document.createElement("select");
            currencysel.id = "currency";
            currencysel.className = "formselect";

            populateCurrencies(currencysel, defaultsettlcurrency);

            settlperiod = document.createElement("select");
            settlperiod.id = "settlperiod";
            settlperiod.className = "formselect";

            populateSettlPeriod(settlperiod, instruments[symbol].instrumenttype);

            quotereqbutton = document.createElement("input");
            quotereqbutton.type = "button";
            quotereqbutton.className = "quotereqbutton";
            quotereqbutton.id = "quotereqbutton";
            quotereqbutton.value = "Request a quote";

            quotereqbutton.onclick = function() {
                sendIt();
            }

            addNewLine(orderdiv, null);
            orderdiv.appendChild(lblquantity);
            orderdiv.appendChild(quantitycashsel);
            orderdiv.appendChild(quotereqqty);
            addNewLine(orderdiv, null);
            orderdiv.appendChild(lblcurrency);
            orderdiv.appendChild(currencysel);
            addNewLine(orderdiv, null);
            orderdiv.appendChild(lblsettle);
            orderdiv.appendChild(settlperiod);
            addNewLine(orderdiv, null);
            orderdiv.appendChild(quotereqbutton);
            orderdiv.appendChild(inpclientid);

            function sendIt() {
                if (inpclientid.value == "") {
                    alert("Enter a client");
                    focusfield = document.getElementById(focusfldstr);
                    focusfield.focus();
                    return;
                }

                if (validateNumeric(quotereqqty, getQuantityDesc(qtyascashorshares))) {
                    if (qtyascashorshares == 1) {
                        quantity = quotereqqty.value;
                        cashorderqty = "";
                    } else {
                        cashorderqty = quotereqqty.value;
                        quantity = "";                        
                    }

                    sendRequestQuote(inpclientid.value, symbol, quantity, cashorderqty, instruments[symbol].currency, currencysel[currencysel.selectedIndex].value, settlperiod[settlperiod.selectedIndex].value, orderdivnum);

                    disable();
                } else {
                    quotereqqty.focus();
                }
            }
 
            function disable() {
                quotereqbutton.disabled = true;
                quotereqqty.disabled = true;
                quotereqqty.onkeypress = null;
            }
        }

        function getQuantityDesc(qtyval) {
            var qtydesc;

            if (qtyval == 1) {
                qtydesc = "Quantity";
            } else {
                qtydesc = "Cash Amt";                    
            }

            return qtydesc;
        }

        // todo: get it right
        function formatToUTCDate(day, month, year) {
            if (day.length == 1) {
                day = "0" + day;
            }
            if (month.length == 1) {
                month = "0" + month;
            }
            return year + month + day;
        }

        function formatToUTCTime(hour, minute, second) {
            return (hour + ":" + minute + ":" + second);
        }

        function formatUTCDate(utcdate) {
            var month = parseInt(utcdate.substr(4, 2));
            return (utcdate.substr(6, 2) + " " + monthtext[month-1] + " " + utcdate.substr(0, 4));
        }

        function formatUTCDateTime(utcdatetime) {
            return (formatUTCDate(utcdatetime) + utcdatetime.substr(8));
        }

        function displayElement(element, symbol) {
            var nextsymbol;

            if (symbol == null || obdisplay[symbol].insertbefore == null) {
                main.appendChild(element);
            } else {
                nextsymbol = document.getElementById("strip:" + obdisplay[symbol].insertbefore + ":0");
                main.insertBefore(element, nextsymbol);
            }
        }

        function getDiv(divid, symbol) {
            var div = document.getElementById(divid);

            if (div == null) {
                div = document.createElement("div");
                div.id = divid;
                displayElement(div, symbol);
            }

            return div;
        }

        function sendRequestQuote(clientid, symbol, quantity, cashorderqty, currency, settlcurrency, nosettdays, orderdivnum) {
            var quotereq = {};
            var msg;

            quotereq.clientid = clientid;
            quotereq.quantity = quantity;
            quotereq.cashorderqty = cashorderqty;
            quotereq.symbol = symbol;
            quotereq.currency = currency;
            quotereq.settlcurrency = settlcurrency;
            quotereq.nosettdays = nosettdays;
            quotereq.operatortype = operatortype;
            quotereq.operatorid = userid;
            quotereq.orderdivnum = orderdivnum;

            sockjs.send("{\"quoterequest\":" + JSON.stringify(quotereq) + "}");

            msg = "Placed a quote request for ";
            if (quantity != "") {
                msg += quantity;
            } else {
                msg += cashorderqty + " " + settlcurrency + " of";
            }

            msg += " " + symbol + " for settlement T+" + nosettdays;

            if (settlcurrency != instruments[symbol].currency) {
                msg += " in " + settlcurrency;
            }

            addMessageToDiv(msg, "orderdiv:" + symbol + ":" + orderdivnum);
        }

        function validateNumeric(field, fieldname) {
            if (field.value == "") {
                alert("Enter a " + fieldname);
                field.focus();
                return false;
            } else if (isNaN(field.value)) {
                alert(fieldname + " must be numeric");
                field.focus();
                return false;
            } else if (field.value <= 0) {
                alert(fieldname + " must be greater than zero");
                field.focus();
                return false;                
            }

            return true;
        }

        function clearDiv(divid) {
            var div = document.getElementById(divid);
            if (div != null) {
                while(div.hasChildNodes()){
                    div.removeChild(div.childNodes[0]);
                }
                main.removeChild(div);
            }
        }

        function addMessageToDiv(msg, divid) {
            var div;
            var msglabel;

            div = document.getElementById(divid);
            if (div != null) {
                msglabel = document.createElement("label");
                msglabel.innerHTML = "<br>" + msg;

                div.appendChild(msglabel);
            }
        }

        function quoteAckReceived(quoteack) {
            var msg;

            msg = " Quote request rejected, reason: " + quoteack.quoterejectreasondesc;
            if ('text' in quoteack && quoteack.text != "") {
                msg += ", " + quoteack.text;
            }

            if (selectedmenu == 0) {
                addMessageToDiv(msg, "orderdiv:" + quoteack.symbol + ":" + quoteack.orderdivnum);
            }
        }

        function quoteReceived(quote) {
            var buybutton;
            var sellbutton;
            var timerlabel;
            var numsecsremaining;
            var timer;
            var timertext = "Seconds Remaining";
            var orderdiv;
            var msg;
            var sellmsg;
            var buymsg;

            quotes[quote.quoteid] = quote;

            sellmsg = "Sell " + quote.bidquantity + " " + quote.symbol;
            buymsg = "Buy " + quote.offerquantity + " " + quote.symbol;

            if (quote.nosettdays != "3" && quote.nosettdays != "0") {
                sellmsg += " " + "T+" + quote.nosettdays;
                buymsg += " " + "T+" + quote.nosettdays;                
            }

            sellmsg += " @ " + quote.bidpx;
            buymsg += " @ " + quote.offerpx;

            if (parseFloat(quote.bidfinance) != 0) {
                sellmsg += ", finance " + quote.bidfinance;
                if (quote.nosettdays == "0") {
                    sellmsg += " per day";
                }
            }
            if (parseFloat(quote.offerfinance) != 0) {
                buymsg += ", finance " + quote.offerfinance;
                if (quote.nosettdays == "0") {
                    buymsg += " per day";
                }
            }

            if (quote.settlcurrency != "GBP" || quote.settlcurrency != instruments[quote.symbol].currency) {
                sellmsg += " " + quote.settlcurrency;
                buymsg += " " + quote.settlcurrency;
            }

            sellbutton = document.createElement("input");
            sellbutton.type = "button";
            sellbutton.className = "quotesellbutton";
            sellbutton.value = sellmsg;

            sellbutton.onclick = function() {
                sendOrder(quote.clientid, quote.symbol, '2', quote.bidquantity, quote.bidpx, 'D', quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "", quote.orderdivnum);
                disable();
            }

            buybutton = document.createElement("input");
            buybutton.type = "button";
            buybutton.className = "quotebuybutton";
            buybutton.value = buymsg;

            buybutton.onclick = function() {
                sendOrder(quote.clientid, quote.symbol, '1', quote.offerquantity, quote.offerpx, 'D', quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "", quote.orderdivnum);
                disable();
            }

            numsecsremaining = parseInt(quote.noseconds);

            timerlabel = document.createElement("label");
            timerlabel.innerHTML = numsecsremaining + " " + timertext;
            timerlabel.className = "timerlabel";

            numsecsremaining = parseInt(quote.noseconds);
            timer = setInterval(function() {
                numsecsremaining -= 1;
                if (numsecsremaining == 0) {
                    disable();
                    timerlabel.innerHTML = "Quote Expired";
                } else {
                    timerlabel.innerHTML = numsecsremaining + " " + timertext;
                }
            }, 1000);
            // todo: clear if form is closed

            if (selectedmenu == 0) {
                orderdiv = getDiv("orderdiv:" + quote.symbol + ":" + quote.orderdivnum, quote.symbol);

                addNewLine(orderdiv, null);
                orderdiv.appendChild(sellbutton);
                orderdiv.appendChild(timerlabel);
                orderdiv.appendChild(buybutton);
            }

            function disable() {
                clearInterval(timer);
                buybutton.disabled = true;
                buybutton.style.cursor = 'default';
                sellbutton.disabled = true;
                sellbutton.style.cursor = 'default';
            }
        }

        function placeOrder(symbol, side, quantity, price) {
            var stocklabel;
            var quantityinput;
            var priceinput;
            var btn;
            var ordertypesel;
            var orderdiv;
            var ordertype = '2';
            var settlabel;
            var timeinforce;
            var expiredate = "";
            var expiretime = "";
            var qtydesc;
            var timeinforcesel;
            var pricedesc;
            var settlcurrency;
            var currencysel;
            var qtyascashorshares = 1;
            var expireday;
            var expiremonth;
            var expireyear;
            var settlperiod;
            var nosettdays;
            var inpclientid;
            var inpclientidstr;
            var focusfldstr;
            var orderdivnum;

            clearSymbolDiv(symbol);

            orderdivnum = incrOrderDivNum(symbol);

            orderdiv = getDiv("orderdiv:" + symbol + ":" + orderdivnum, symbol);
            focusfldstr = "orderquantity:" + symbol;
            inpclientidstr = "inpclientid:" + symbol;

            selectClient("orderdiv", orderdiv, symbol, true, null, inpclientidstr, focusfldstr, false);

            // remember the client
            inpclientid = document.createElement("input");
            inpclientid.type = "hidden";
            inpclientid.id = inpclientidstr;

            btn = document.createElement("input");
            btn.type = "button";
            btn.id = "orderbuysell" + symbol;
            btn.value = getSideDesc(side);
            if (side == "1") {
                btn.className = "orderbuttonbuy";
            } else {
                btn.className = "orderbuttonsell";
            }

            btn.onclick = function() {
                sendIt();
            }

            quantityinput = document.createElement("input");
            quantityinput.id = "orderquantity:" + symbol;
            quantityinput.className = "orderquantity";
            quantityinput.placeholder = "Quantity";

            if (quantity != 0) {
                quantityinput.value = quantity;
            }

            quantityinput.onkeypress = function(event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            stocklabel = document.createElement("label");
            stocklabel.className = "orderstock";
            stocklabel.innerHTML = symbol;// + " @ ";

            atlabel = document.createElement("label");
            atlabel.innerHTML = " @ ";

            /*ordertypesel = document.createElement("select");
            ordertypesel.id = "ordertype" + symbol;
            ordertypesel.className = "ordertype";
            for (var i in ordertypes) {
                option = document.createElement("option");
                option.setAttribute('value', i);
                option.innerHTML = ordertypes[i].description;
                ordertypesel.appendChild(option);
            }

            ordertypesel.onchange = function() {
                ordertype = ordertypesel[ordertypesel.selectedIndex].value;
                pricedisplay();
            }*/

            priceinput = document.createElement("input");
            priceinput.id = "orderprice:" + symbol;
            priceinput.className = "orderprice";
            pricedesc = "PriceLimit";

            if (priceinput.placeholder == undefined) {
            } else {
                priceinput.placeholder = pricedesc;
            }

            priceinput.onkeypress = function(event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            timeinforcesel = document.createElement("select");
            timeinforcesel.id = "timeinforce:" + symbol;
            timeinforcesel.className = "timeinforce";
            for (var i in timeinforces) {
                option = document.createElement("option");
                // todo: this is a hack
                if (i == 0) {
                    timeinforce = "0";
                } else if (i == 1) {
                    timeinforce = "6";
                } else if (i == 2) {                  
                    timeinforce = "1";
                }
                option.setAttribute('value', timeinforce);
                option.innerHTML = timeinforces[i];
                timeinforcesel.appendChild(option);
            }

            timeinforcesel.onchange = function() {
                timeinforce = timeinforcesel[timeinforcesel.selectedIndex].value;
                expiredatedisplay();
            }

            function expiredatedisplay() {
                if (timeinforce == "6") {
                    expireday = document.getElementById("expireday:" + symbol);
                    if (expireday == null) {
                        expireday = document.createElement("select");
                        expireday.id = "expireday:" + symbol;
                        expiremonth = document.createElement("select");
                        expiremonth.id = "expiremonth:" + symbol;
                        expireyear = document.createElement("select");
                        expireyear.id = "expireyear:" + symbol;
                        /*expirehour = document.createElement("select");
                        expirehour.id = "expirehour:" + symbol;
                        expireminute = document.createElement("select");
                        expireminute.id = "expireminute:" + symbol;
                        expiresecond = document.createElement("select");
                        expiresecond.id = "expiresecond:" + symbol;*/

                        populateDate(expireday, expiremonth, expireyear, new Date());
                        //populateTime(expirehour, expireminute, expiresecond);

                        orderdiv.insertBefore(expireday, settlabel);
                        orderdiv.insertBefore(expiremonth, settlabel);
                        orderdiv.insertBefore(expireyear, settlabel);
                        //orderdiv.insertBefore(expirehour, settlabel);
                        //orderdiv.insertBefore(expireminute, settlabel);
                        //orderdiv.insertBefore(expiresecond, settlabel);
                    }
                } else {
                    expireday = document.getElementById("expireday:" + symbol);
                    if (expireday != null) {
                        orderdiv.removeChild(expireday);
                    }
                    expiremonth = document.getElementById("expiremonth:" + symbol);
                    if (expiremonth != null) {
                        orderdiv.removeChild(expiremonth);
                    }
                    expireyear = document.getElementById("expireyear:" + symbol);
                    if (expireyear != null) {
                        orderdiv.removeChild(expireyear);
                    }
                    /*expirehour = document.getElementById("expirehour:" + symbol);
                    if (expirehour != null) {
                        orderdiv.removeChild(expirehour);
                    }
                    expireminute = document.getElementById("expireminute:" + symbol);
                    if (expireday != null) {
                        orderdiv.removeChild(expireminute);
                    }
                    expiresecond = document.getElementById("expiresecond:" + symbol);
                    if (expiresecond != null) {
                        orderdiv.removeChild(expiresecond);
                    }*/
                }                
            }

            settlabel = document.createElement("label");
            settlabel.innerHTML = " for settlement ";
            settlabel.className = "settlabel";

            settlcurrency = defaultsettlcurrency;

            // todo: combine with quoterequest?
            if (instruments[symbol].currency != defaultsettlcurrency) {
                settlabel.innerHTML = settlabel.innerHTML + "in ";
                currencysel = document.createElement("select");
                currencysel.id = "currency" + symbol;
                currencysel.className = "currency";
                currencysel[0] = new Option(defaultsettlcurrency, defaultsettlcurrency, true, true);
                currencysel[1] = new Option(instruments[symbol].currency, instruments[symbol].currency, false, false);

                currencysel.onchange = function() {
                    settlcurrency = currencysel[currencysel.selectedIndex].value;
                }
            }

            /*settday = document.createElement("select");
            settday.id = "ordersettday:" + symbol;
            settmonth = document.createElement("select");
            settmonth.id = "ordersettmonth:" + symbol;
            settyear = document.createElement("select");
            settyear.id = "ordersettyear:" + symbol;

            populateDate(settday, settmonth, settyear, getDefaultSettleDate());*/

            settlperiod = document.createElement("select");
            settlperiod.id = "settlperiod:" + symbol;
            settlperiod.className = "formselect";

            //settlperiod[0] = new Option("GBP", defaultsettlcurrency, true, true);

            populateSettlPeriod(settlperiod, instruments[symbol].instrumenttype);

            addNewLine(orderdiv, null);
            orderdiv.appendChild(btn);
            orderdiv.appendChild(quantityinput);
            orderdiv.appendChild(stocklabel);
            orderdiv.appendChild(atlabel);
            orderdiv.appendChild(priceinput);
            //orderdiv.appendChild(ordertypesel);
            orderdiv.appendChild(timeinforcesel);
            orderdiv.appendChild(settlabel);
            if (instruments[symbol].currency != defaultsettlcurrency) {
                orderdiv.appendChild(currencysel);
            }
            //orderdiv.appendChild(settday);
            //orderdiv.appendChild(settmonth);
            //orderdiv.appendChild(settyear);
            orderdiv.appendChild(settlperiod);
            orderdiv.appendChild(inpclientid);

            //pricedisplay();

            function disable() {
                btn.disabled = true;
                btn.style.cursor = 'default';
                quantityinput.disabled = true;
                quantityinput.onkeypress = null;
                priceinput.disabled = true;
                priceinput.onkeypress = null;
            }

            /*function pricedisable() {
                priceinput.disabled = true;
                priceinput.onkeypress = null;
            }*/

            /*function pricedisplay() {
                if (ordertype == '1') {
                    stocklabel.innerHTML = symbol;
                    priceinput = document.getElementById("orderprice:" + symbol);
                    if (priceinput != null) {
                        orderdiv.removeChild(priceinput);
                    }
                } else {
                    stocklabel.innerHTML = symbol + " @ ";
                    priceinput = document.getElementById("orderprice:" + symbol);
                    if (priceinput == null) {
                        priceinput = document.createElement("input");
                        priceinput.id = "orderprice:" + symbol;
                        priceinput.className = "orderprice";
                        priceinput.placeholder = "PriceLimit";
                        if (price != 0) {
                            priceinput.value = price;
                        }

                        priceinput.onkeypress = function(event) {
                            event = event || window.event;  // cross-browser event

                            if (event.keyCode == 13) {
                                sendIt();
                            }
                        }

                        orderdiv.insertBefore(priceinput, ordertypesel);
                        priceinput.focus();
                    }
                }
            }*/

            function sendIt() {
                var settdate = ""; // calculated by server

                if ((!validateNumeric(quantityinput, getQuantityDesc(qtyascashorshares))) || (!validateNumeric(priceinput, pricedesc))) {
                    return;
                }

                // todo: validate timeinforce
                timeinforce = timeinforcesel[timeinforcesel.selectedIndex].value;
                if (timeinforce == "6") {
                    expiredate = formatToUTCDate(expireday.value, expiremonth.value, expireyear.value);
                    expiretime = "00:00:00";//formatToUTCTime(expirehour.value, expireminute.value, expiresecond.value);
                }

                nosettdays = settlperiod[settlperiod.selectedIndex].value;

                sendOrder(inpclientid.value, symbol, getSide(btn.value), quantityinput.value, priceinput.value, ordertype, settlcurrency, nosettdays, settdate, "", timeinforce, expiredate, expiretime, "1");

                disable();
            }
        }

        function populateSettlPeriod(settlperiod, instrumenttype) {
            settlperiod.options.length = 0;

            if (instrumenttype == "DE" || instrumenttype == "IE") {
                for (var i = 0; i < 10; i++) {
                    var s = i + 1;
                    if (s == 3) {
                        settlperiod[i] = new Option("T+" + s, s, true, true);
                    } else {
                        settlperiod[i] = new Option("T+" + s, s, false, false);
                    }
                }
            } else if (instrumenttype == "CCFD") {
                settlperiod[0] = new Option("T+10", 10, true, true);
            } else {
                settlperiod[0] = new Option("T+0 (Rolling)", 0, true, true);
            }
        }

        function sendOrder(clientid, symbol, side, quantity, price, ordertype, settlcurrency, nosettdays, settdate, quoteid, timeinforce, expiredate, expiretime, orderdivnum) {
            var neworder = {};
            var msg;

            neworder.clientid = clientid;
            neworder.side = side;
            neworder.quantity = quantity;
            neworder.symbol = symbol;
            neworder.currency = instruments[symbol].currency;
            neworder.price = price;
            neworder.ordertype = ordertype;
            neworder.settlcurrency = settlcurrency;
            neworder.nosettdays = nosettdays;
            neworder.futsettdate = settdate;
            neworder.quoteid = quoteid;
            neworder.timeinforce = timeinforce;
            neworder.expiredate = expiredate;
            neworder.expiretime = expiretime;
            neworder.operatortype = operatortype;
            neworder.operatorid = userid;
            neworder.orderdivnum = orderdivnum;

            sockjs.send("{\"order\":" + JSON.stringify(neworder) + "}");

            msg = "Placed order to " + getSideDesc(side) + " " + quantity + " " + symbol;
            if (price != "") {
                msg += " @ " + price;
            }
            msg += ", " + getOrdertypeDesc(ordertype);

            if (instruments[symbol].instrumenttype == "DE") {
                msg += ", for settlement T+" + nosettdays;
                if (settdate != "") {
                    msg += " (" + formatUTCDate(settdate) + ")";
                }
            } else {
                msg += ", for rolling settlement";
            }

            if (neworder.settlcurrency != "GBP" || neworder.settlcurrency != neworder.currency) {
                msg += " in " + neworder.settlcurrency;
            }

            if (quoteid != "") {
                msg += ", quote id " + quoteid;
            }

            addMessageToDiv(msg, "orderdiv:" + symbol + ":" + orderdivnum);
        }

        function getSideDesc(side) {
            if (side == '1') {
                return 'Buy';
            } else {
                return 'Sell';
            }
        }

        function getSide(sidedesc) {
            if (sidedesc == 'Buy') {
                return '1';
            } else {
                return '2';
            }            
        }

        function getOrdertypeDesc(ordertype) {
            if (ordertype in ordertypes) {
                return ordertypes[ordertype].description;
            } else {
                return "";
            }
        }

        function setOrderPrice(elem, side, symbol) {
            var priceelem = document.getElementById(elem.id);
            placeOrder(symbol, side, 0, priceelem.innerHTML);
        }

        function setOrderQuantity(elem, side, symbol) {
            var cumqty = 0;
            var price = 0;
            var quantityelemid;
            var quantityelem;
            var priceelem;

            for (var i = 0; i < orderbooks[symbol].length; ++i) {
                if (side == "1") {
                    quantityelemid = "offerquantity:" + symbol + ":" + i;
                } else {
                    quantityelemid = "bidquantity:" + symbol + ":" + i;                    
                }

                quantityelem = document.getElementById(quantityelemid);
                cumqty += parseInt(quantityelem.innerHTML);

                if (quantityelemid == elem.id) {
                    if (side == "1") {
                        priceelem = document.getElementById("offerprice:" + symbol + ":" + i);
                    } else {
                        priceelem = document.getElementById("bidprice:" + symbol + ":" + i);                    
                    }
                    price = priceelem.innerHTML;
                    break;
                }
            }

            placeOrder(symbol, side, cumqty, price);
        }

        function cancelOrderQuantity(elem, side, symbol) {
            var price;

            // todo: fix

            //var quantity = document.getElementById(elem.id);

            /*for (var i = 0; i < orderbooks[symbol].length; ++i) {
                if (side == "1") {
                    quantityelem = document.getElementById("mybidquantity:" + symbol + ":" + i);
                } else {
                    quantityelem = document.getElementById("myofferquantity:" + symbol + ":" + i);                    
                }

                if (quantityelem == quantity) {
                    if (side == "1") {
                        priceelem = document.getElementById("bidprice:" + symbol + ":" + i);
                    } else {
                        priceelem = document.getElementById("offerprice:" + symbol + ":" + i);                    
                    }
                    price = priceelem.innerHTML;
                    break;                    
                }
            }*/

            for (var i in orders) {
                if ((orders[i].status == "0" || orders[i].status == "1") && orders[i].price == price && orders[i].side == side) {
                    confirmOrderCancel(orders[i].orderid);
                }
            }
        }

        //
        // reply from sign-in
        // if successful, data will start arriving
        //
        function replySignIn(reply) {
            var frm;
            var lblreason;
            var cw2theading;

            frm = document.getElementById("frmsignin");
            if (frm != null) {
                if (!reply.success) {
                    lblreason = document.getElementById("lblReason");
                    if (lblreason == null) {
                        lblreason = document.createElement("label");
                        lblreason.id = "lblReason";
                        frm.appendChild(lblreason);
                    }

                    lblreason.innerHTML = " " + reply.reason;
                } else {
                    // clear the screen
                    clearForm("frmsignin", true);

                    cw2theading = document.getElementById('cw2t');
                    cw2theading.innerHTML = coheading + " - " + reply.email;
                }
            }
        }

        //
        // main menu
        //
        function displayMenu() {
            var menu;
            var menuarr;
            var menuitem;

            menu = document.createElement('ul');
            menu.className = "menu";
            menu.id = "menu";

            // build the main menu - reset chatmenuoption if changed
            menuarr = ["Watch List", "Clients", "Cash", "Products", "Hedge Books", "Costs", "IFA's", "History", "Portfolio", "Chat", "Holidays", "End Of Day", "Monitor", "Log Out"];

            for (var i = 0; i < menuarr.length; ++i) {
                menuitem = document.createElement("li");
                menuitem.value = i;
                menuitem.innerHTML = menuarr[i];

                if (i == 0) {
                    menuitem.className = "menuitemselected";
                    lastElement = menuitem;
                } else if (i == chatmenuoption) { // change if menu changed
                    menuitem.id = "menuitemchat";
                } else if (i > 13){ // when the amount of items in the menu exceed 13 then..//
                    var nwmnu = new menuitem(); //... this will create a new list..//
                    nwmnu.value = j; // ..add the items onto the list..//
                    nwmnu.innerHTML = menuarr[j]//.. and display them !!//
                }
                menu.appendChild(menuitem);
            }

            heading.appendChild(menu);

            /*
            //
            // Alex, this needs work...
            //
            menu.onclick = function(dS){
            //Creating the submenu
                var index = ["item1", "item2", "item3", "item4", "item5"]

                var submenu = getDiv("divsubmenu");
                submenu.id = "submenu";
                submenu.className = "submenu";

                var smenulist = document.createElement("ul");
                for (index = 0; index < 5; ++index) {
                    li = document.createElement('li');
                    li.innerHTML = "SubMenu" + index;

                    smenulist.appendChild(li);
                }

                submenu.appendChild(smenulist);

                menu.appendChild(submenu);

                submenu.onclick = function(){
                // the items on the submenu
                }
            }*/

            //end

            //submenu.onclick = function(){
                // the items on the submenu
                
            //}

            menu.onclick = function(e) {
                var element;

                if (!e) e = window.event;
                element = e.target || e.srcElement;

                clearScreen();

                element.className = "menuitemselected";
                if (lastElement != null) {
                    lastElement.className = "menu";
                }
                lastElement = element;
                selectedmenu = element.value;

                switch (selectedmenu) {
                case 0:
                    displayOrderBooks();
                    break;
                case 1:
                    maintainClients();
                    break;
                case 2:
                    maintainCash();
                    break;
                case 3:
                    maintainProducts();
                    break;
                case 4:
                    maintainHedgebooks();
                    break;
                case 5:
                    maintainCosts();
                    break;
                case 6:
                    maintainIfas();
                    break;
                case 7:
                    requestHistory();
                    break;
                case 8:
                    requestPortfolio();
                    break;
                case 9:
                    requestConnections();
                    break;
                case 10:
                    holidays();
                    break;
                case 11:
                    endOfDay();
                    break;
                case 12:
                    monitor();
                    break;
                case 13:
                    logout();
                    break;
                }
            }
        }

        function logout() {
            sockjs.close();
            loggedout = true;
        }

        function selectClient(frm, clientbox, symbol, displayname, namefld, idfld, focusfldstr, allclientopt) {
            var clientboxinput;
            var clientlist;
            var searchtext;
            var arrnames;
            var focusfld;
            var inpclient;

            if (clientbox == null) {
                clientbox = document.createElement("div");
                clientbox.id = "clientbox";
                clientbox.className = "clientbox";

                main.appendChild(clientbox);
            }

            clientboxinput = document.createElement("input");
            clientboxinput.className = "clientboxinput";

            if (clientboxinput.placeholder == undefined) {
                // Placeholder is not supported - todo: consider writing alternative
            } else {
                clientboxinput.placeholder = "Client Name";
            }

            clientboxinput.onkeyup = function(e) {
                clearList(clientlist.id, false);

                if (clientboxinput.value.length == 0) {
                    if (e.keyCode != 13) {
                        clientlist.style.visibility = "hidden";
                        return;
                    } else {
                        searchtext = "";

                        for (var i in clients) {
                            addElement(clients[i].name, clientlist, i);
                        }

                        if (allclientopt) {
                            addElement("All clients", clientlist, 0);                            
                        }
                    }
                } else {
                    searchtext = clientboxinput.value.toLowerCase();

                    for (var i in clients) {
                        arrnames = clients[i].name.split(' ');

                        for (var j = 0; j < arrnames.length; j++) {
                            if (arrnames[j].toLowerCase().indexOf(searchtext) == 0) {
                                addElement(clients[i].name, clientlist, i);
                            }
                        }
                    }

                    if (allclientopt) {
                        addElement("All clients", clientlist, 0);                            
                    }
                }

                if (clientlist.getElementsByTagName('li').length > 0) {
                    clientlist.style.visibility = "visible";
                } else {
                    clientlist.style.visibility = "hidden";
                }
            }

            clientlist = document.createElement('ul');
            clientlist.className = "clientlist";
            clientlist.style.visibility = "hidden";

            if (symbol != null) {
                clientboxinput.id = "clientboxinput:" + symbol;
                clientlist.id = "clientlist:" + symbol;
            } else {
                clientboxinput.id = "clientboxinput";
                clientlist.id = "clientlist";
            }

            clientlist.onclick = function(e) {
                var element;
                var client = {};
                
                if (!e) e = window.event;
                element = e.target || e.srcElement;

                clientlist.style.visibility = "hidden";
                clientboxinput.value = "";

                if (element.value == 0) {
                    client.name = "All clients";
                    client.clientid = 0;
                } else {
                    client = clients[element.value];
                }

                displayClient(client, frm, "", namefld, idfld, "");

                clearHeadings();
                clearLists();
                clearTables();
                clearElementById("lbltrades");

                if (focusfldstr != "") {
                    focusfld = document.getElementById(focusfldstr);
                    focusfld.focus();
                } else {
                    clientboxinput.focus();
                }
            }

            clientbox.appendChild(clientboxinput);

            if (displayname) {
                if (symbol != null) {
                    inpclient = newinput("inpclient:" + symbol, "forminput", clientbox, true);
                } else {
                    inpclient = newinput("inpclient", "forminput", clientbox, true);
                }
                namefld = inpclient.id;
            }

            clientbox.appendChild(clientlist);

            main.onclick = function(e) {
                var elem;

                if (!e) e = window.event;
                elem = e.target || e.srcElement;

                if (elem.id == "clientlist" || elem.id == "clientboxinput") {
                    return;
                }

                clientlist.style.visibility = "hidden";
            }

            clientboxinput.focus();            
        }

        function selectClientFocus(focusfldstr) {
            var focusfld = document.getElementById(focusfldstr);
            if (focusfld != null) {
                focusfld.focus();
            }
        }

        function maintainClients() {
            selectClient("frmclient", null, null, false, "inpname", "inpclientid", "", false);

            var frmclient = getForm("frmclient");

            addNewLine(frmclient, null);
            var lblname = newlabel("lblname", "Name:", "formlabel", frmclient);
            var inpname = newinput("inpname", "forminput", frmclient);

            addNewLine(frmclient, null);
            var lblemail = newlabel("lblemail", "Email:", "formlabel", frmclient);
            var inpemail = newinput("inpemail", "forminput", frmclient);

            addNewLine(frmclient, null);
            var lblmobile = newlabel("lblmobile", "Mobile:", "formlabel", frmclient);
            var inpmobile = newinput("inpmobile", "forminput", frmclient);

            addNewLine(frmclient, null);
            var lbladdress = newlabel("lbladdress", "Address:", "formlabel", null);
            var inpaddress = document.createElement("textarea");
            inpaddress.id = "inpaddress";
            var divaddress = document.createElement("div");
            divaddress.appendChild(lbladdress);
            divaddress.appendChild(inpaddress);
            frmclient.appendChild(divaddress);

            addNewLine(frmclient, null);
            var lblbroker = newlabel("lblbroker", "Broker:", "formlabel", frmclient);
            var selbroker = newselect("selbroker", "formselect", frmclient);

            addNewLine(frmclient, null);
            var lblbrokerclientcode = newlabel("lblbrokerclientcode", "Broker Client Code:", "formlabel", frmclient);
            var inpbrokerclientcode = newinput("inpbrokerclientcode", "forminput", frmclient);

            addNewLine(frmclient, null);
            var lblifa = newlabel("lblifa", "IFA:", "formlabel", frmclient);
            var selifa = newselect("selifa", "formselect", frmclient);

            addNewLine(frmclient, null);
            var lbltype = newlabel("lbltype", "Client Type:", "formlabel", frmclient);
            var seltype = newselect("seltype", "formselect", frmclient);

            addNewLine(frmclient, null);
            var lblcantrade = newlabel("lblcantrade", "Can Trade:", "formlabel", frmclient);

            for (var i in instrumenttypes) {
                var chkinsttype = document.createElement("input");
                chkinsttype.type = "checkbox";
                chkinsttype.id = "checkbox:" + instrumenttypes[i].instrumenttypeid;
                chkinsttype.className = "formcheckbox";

                var textinsttype = document.createTextNode(instrumenttypes[i].description);

                frmclient.appendChild(chkinsttype);
                frmclient.appendChild(textinsttype);
            }

            addNewLine(frmclient, null);
            var lblhedge = newlabel("lblhedge", "Hedge:", "formlabel", frmclient);
            var opthedgeyes = newoption("opthedgeyes", "opthedge", "formcheckbox", frmclient);
            var lblhedgeyes = newlabel("lblhedgeyes", "Yes", "", frmclient);
            var opthedgeno = newoption("opthedgeno", "opthedge", "formcheckbox", frmclient);
            var lblhedgeno = newlabel("lblhedgeno", "No", "", frmclient);

            addNewLine(frmclient, null);
            var lblcommpercent = newlabel("lblcommpercent", "Commission Override %:", "formlabel", frmclient);
            var inpcommpercent = newinput("inpcommpercent", "forminput", frmclient);

            addNewLine(frmclient, null);
            var lblclientid = newlabel("lblclientid", "Client Id:", "formlabel", frmclient);
            var inpclientid = newinput("inpclientid", "forminput", frmclient, true);

            addNewLine(frmclient, null);
            var btnupdate = newbutton("btnupdate", "Add", "formbutton", frmclient);
            var btnnewclient = newbutton("btnnewclient", "New Client", "formbuttonwide", frmclient);

            addNewLine(frmclient, null);
            var lblclientconf = newlabel("lblclientconf", "", "", frmclient);

            btnupdate.onclick = function() {
                var client = {};
                var insttypes = [];
                var chkinsttype;

                if (inpname.value == "") {
                    alert("Please enter a name");
                    inpname.focus();
                    return;
                }

                if (inpemail.value == "") {
                    alert("Please enter an email address");
                    inpemail.focus();
                    return;                        
                }

                client.name = inpname.value;
                client.mobile = inpmobile.value;
                client.brokerid = selbroker[selbroker.selectedIndex].value;
                client.brokerclientcode = inpbrokerclientcode.value;
                client.clientid = inpclientid.value;
                client.address = inpaddress.value;
                client.email = inpemail.value;
                client.commissionpercent = inpcommpercent.value;

                if (selifa.selectedIndex == 0) {
                    client.ifaid = "";
                } else {
                    client.ifaid = selifa[selifa.selectedIndex].value;
                }

                client.type = seltype[seltype.selectedIndex].value;

                if (opthedgeyes.checked) {
                    client.hedge = 1;
                } else {
                    client.hedge = 0;                    
                }

                for (var i in instrumenttypes) {
                    chkinsttype = document.getElementById("checkbox:" + instrumenttypes[i].instrumenttypeid);

                    if (chkinsttype.checked) {
                        insttypes.push(instrumenttypes[i].instrumenttypeid);
                    }

                    client.insttypes = insttypes;
                }

                sockjs.send("{\"newclient\":" + JSON.stringify(client) + "}");
            }

            btnnewclient.onclick = function() {
                displayClient(null, "frmclient", "", "inpname", "inpclientid", "");
                inpname.focus();
            }

            main.appendChild(frmclient);

            inpclientid.disabled = true;

            displayClient(null, "frmclient", "", "", "", "");
        }

        function displayClient(client, frm, msg, namefld, idfld, focusfldstr) {
            var inpclient;
            var inpname;
            var inpmobile;
            var selbroker;
            var inpbrokerclientcode;
            var inpclientid;
            var inpaddress;
            var inpemail;
            var selifa;
            var chkinsttype;
            var found;
            var lblclientconf;
            var seltype;
            var opthedgeyes;
            var opthedgeno;
            var btnupdate;
            var btnnewclient;
            var inpclientid;
            var focusfld;
            var inpcommpercent;

            if (frm == "frmclient") {
                inpname = document.getElementById("inpname");
                inpmobile = document.getElementById("inpmobile");
                selbroker = document.getElementById("selbroker");
                inpbrokerclientcode = document.getElementById("inpbrokerclientcode");
                inpclientid = document.getElementById("inpclientid");
                inpaddress = document.getElementById("inpaddress");
                inpemail = document.getElementById("inpemail");
                selifa = document.getElementById("selifa");
                seltype = document.getElementById("seltype");
                opthedgeyes = document.getElementById("opthedgeyes");
                opthedgeno = document.getElementById("opthedgeno");
                btnupdate = document.getElementById("btnupdate");
                btnnewclient = document.getElementById("btnnewclient");
                inpcommpercent = document.getElementById("inpcommpercent");

                // create an empty client
                if (client == null) {
                    client = {
                        name:  '',
                        mobile:    '',
                        brokerid:  1,
                        brokerclientcode: '',
                        clientid: '',
                        address: '',
                        email: '',
                        ifaid: 0,
                        insttypes: [],
                        type: 1,
                        hedge: 1,
                        commissionpercent: ''
                    };
                }

                if (inpname != null) {
                    inpname.value = client.name;
                    inpmobile.value = client.mobile;
                    populateBrokers(selbroker, client.brokerid);
                    inpbrokerclientcode.value = client.brokerclientcode;
                    inpclientid.value = client.clientid;
                    inpaddress.value = client.address;
                    inpemail.value = client.email;
                    populateIfas(selifa, client.ifaid, 0);
                    populateClientTypes(seltype, client.type);
                    inpcommpercent.value = client.commissionpercent;

                    if (parseInt(client.hedge)) {
                        opthedgeyes.checked = true;
                    } else {
                        opthedgeno.checked = true;                        
                    }

                    for (var i in instrumenttypes) {
                        chkinsttype = document.getElementById("checkbox:" + instrumenttypes[i].instrumenttypeid);
                        if (chkinsttype != null) {
                            found = false;
                            for (j = 0; j < client.insttypes.length; j++) {
                                if (client.insttypes[j] == instrumenttypes[i].instrumenttypeid) {
                                    chkinsttype.checked = true;
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                chkinsttype.checked = false;
                            }
                        }
                    }

                    lblclientconf = document.getElementById("lblclientconf");
                    if (lblclientconf != null) {
                        lblclientconf.innerHTML = msg;
                    }

                    if (client.name == "") {
                        btnupdate.value = "Add";
                        btnnewclient.style.visibility = "hidden";
                    } else {
                        btnupdate.value = "Update";
                        btnnewclient.style.visibility = "visible";
                    }
                }
            } else {
                inpclient = document.getElementById(namefld);
                inpclient.value = client.name;
                inpclientid = document.getElementById(idfld);
                inpclientid.value = client.clientid;
            }

            if (focusfldstr != "") {
                focusfld = document.getElementById(focusfldstr);
                if (focusfld != null) {
                    focusfld.focus();
                }
            }
        }

        function displaySymbol(symbol) {
            var inpsymbol;
            var settlperiod;

            inpsymbol = document.getElementById("inpsymbol");
            if (inpsymbol != null) {
                inpsymbol.value = symbol;
            }

            settlperiod = document.getElementById("settlperiod");
            if (settlperiod != null) {
                populateSettlPeriod(settlperiod, instruments[symbol].instrumenttype);
            }
        }

        function maintainCash() {
            var frmcash;
            var lblclient;
            var lblcurrency;
            var lbltranstype;
            var lblamount;
            var lbldesc;
            var selcurrency;
            var seltranstype;
            var inpclient;
            var inpamount;
            var inpdesc;
            var btnupdate;
            var lblcashconf;
            var inpclientid;
            var clientboxinput;
            var lblref;
            var inpref;
            var settlday;
            var settlmonth;
            var settlyear;

            selectClient("frmcash", null, null, false, "inpclient", "inpclientid", "", false);

            frmcash = getForm("frmcash");

            lblclient = document.createElement("label");
            lblclient.className = "formlabel";
            lblclient.innerHTML = "Client:";
            inpclient = document.createElement("input");
            inpclient.className = "forminput";
            inpclient.id = "inpclient";
            lblcurrency = document.createElement("label");
            lblcurrency.className = "formlabel";
            lblcurrency.innerHTML = "Currency:";
            selcurrency = document.createElement("select");
            selcurrency.id = "selcurrency";
            selcurrency.className = "formselect";
            lbltranstype = document.createElement("label");
            lbltranstype.className = "formlabel";
            lbltranstype.innerHTML = "Type:";
            seltranstype = document.createElement("select");
            seltranstype.id = "seltranstype";
            seltranstype.className = "formselect";
            lblamount = document.createElement("label");
            lblamount.className = "formlabel";
            lblamount.innerHTML = "Amount:";
            inpamount = document.createElement("input");
            inpamount.id = "inpamount";
            inpamount.className = "forminput";
            lbldesc = document.createElement("label");
            lbldesc.className = "formlabel";
            lbldesc.innerHTML = "Description:";
            inpdesc = document.createElement("input");
            inpdesc.id = "inpdesc";
            inpdesc.className = "forminput";
            lblref = document.createElement("label");
            lblref.className = "formlabel";
            lblref.innerHTML = "Reference:";
            inpref = document.createElement("input");
            inpref.id = "inpref";
            inpref.className = "forminput";
            inpclientid = document.createElement("input");
            inpclientid.type = "hidden";
            inpclientid.id = "inpclientid";
            lblsettldate = document.createElement("label");
            lblsettldate.className = "formlabel";
            lblsettldate.innerHTML = "Settlement Date:";
            settlday = document.createElement("select");
            settlday.id = "settlday";
            settlday.className = "formselect";
            settlmonth = document.createElement("select");
            settlmonth.id = "settlmonth";
            settlmonth.className = "formselect";
            settlyear = document.createElement("select");
            settlyear.id = "settlyear";
            settlyear.className = "formselect";

            btnupdate = document.createElement("input");
            btnupdate.type = "button";
            btnupdate.value = "Add";
            btnupdate.className = "formbutton";

            btnupdate.onclick = function() {
                var cashtrans = {};

                if (inpclientid.value == "") {
                    alert("Please select a client");
                    selectClientFocus("clientboxinput");
                    return;
                }

                if (selcurrency.selectedIndex == -1) {
                    alert("No currency selected. Please contact Support");
                    return;
                }

                if (seltranstype.selectedIndex == -1) {
                    alert("No transaction type selected. Please contact Support");
                    return;
                }

                if (!validateNumeric(inpamount, "Amount")) {
                    return;
                }

                cashtrans.clientid = inpclientid.value;
                cashtrans.currency = selcurrency[selcurrency.selectedIndex].value;
                cashtrans.transtype = seltranstype[seltranstype.selectedIndex].value;
                cashtrans.amount = inpamount.value;
                cashtrans.description = inpdesc.value;
                cashtrans.reference = inpref.value;

                if (optdr.checked) {
                    cashtrans.drcr = 1;
                } else {
                    cashtrans.drcr = 2;                    
                }

                cashtrans.settldate = formatToUTCDate(settlday[settlday.selectedIndex].value, settlmonth[settlmonth.selectedIndex].value, settlyear[settlyear.selectedIndex].value);

                sockjs.send("{\"cashtrans\":" + JSON.stringify(cashtrans) + "}");
            }

            lblcashconf = document.createElement("label");
            lblcashconf.id = "lblcashconf";

            populateCurrencies(selcurrency, "GBP");
            populateCashtranstypes(seltranstype, "CA");
            populateDate(settlday, settlmonth, settlyear, new Date());

            inpclient.disabled = true;

            addNewLine(frmcash, null);
            frmcash.appendChild(lblclient);
            frmcash.appendChild(inpclient);
            addNewLine(frmcash, null);
            frmcash.appendChild(lblcurrency);
            frmcash.appendChild(selcurrency);
            addNewLine(frmcash, null);
            frmcash.appendChild(lbltranstype);
            frmcash.appendChild(seltranstype);
            addNewLine(frmcash, null);
            var lbldrcr = newlabel("lbldrcr", "In(+)/Out(-):", "formlabel", frmcash);
            var optdr = newoption("optdr", "optdrcr", "formcheckbox", frmcash);
            var lbldr = newlabel("lbldr", "In", "", frmcash);
            var optcr = newoption("optcr", "optdrcr", "formcheckbox", frmcash);
            var lblcr = newlabel("lblcr", "Out", "", frmcash);
            optdr.checked = true;
            addNewLine(frmcash, null);
            frmcash.appendChild(lblamount);
            frmcash.appendChild(inpamount);
            addNewLine(frmcash, null);
            frmcash.appendChild(lblsettldate);
            frmcash.appendChild(settlday);
            frmcash.appendChild(settlmonth);
            frmcash.appendChild(settlyear);
            addNewLine(frmcash, null);
            frmcash.appendChild(lbldesc);
            frmcash.appendChild(inpdesc);
            addNewLine(frmcash, null);
            frmcash.appendChild(lblref);
            frmcash.appendChild(inpref);
            addNewLine(frmcash, null);
            frmcash.appendChild(btnupdate);
            addNewLine(frmcash, null);
            frmcash.appendChild(lblcashconf);
            frmcash.appendChild(inpclientid);

            main.appendChild(frmcash);
        }

        function maintainProducts() {
            var frmproduct;
            var lblinsttype;
            var inpinsttype;
            var lbldesc;
            var inpdesc;
            var lblisin;
            var inpisin;
            var lblsedol;
            var inpsedol;
            var lblcurrency;
            var inpcurrency;
            var lblmarket;
            var inpmarket;
            var lblsector;
            var inpsector;
            var lblmargin;
            var inpmargin;
            var lblhedge;
            var opthedgeyes;
            var lblhedgeyes;
            var opthedgeno;
            var lblhedgeno
            var btnupdate;
            var lblsymbol;
            var inpsymbol;
            var lblinstconf;
            var lblptmlevy;
            var inpptmlevy;
            var optptmexempt;
            var lblptmexempt;
            var optptmnotexempt;
            var lblptmnotexempt;

            selectStock("frmproduct", null, false, true, null);

            frmproduct = document.getElementById("frmproduct");
            if (frmproduct == null) {
                frmproduct = document.createElement("form");
                frmproduct.id = "frmproduct";
            }

            addNewLine(frmproduct, null);
            lblsymbol = newlabel("lblsymbol", "Symbol:", "formlabel", frmproduct);
            inpsymbol = newinput("inpsymbol", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lbldesc = newlabel("lbldesc", "Description:", "formlabel", frmproduct);
            inpdesc = newinput("inpdesc", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblisin = newlabel("lblisin", "Isin:", "formlabel", frmproduct);
            inpisin = newinput("inpisin", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblsedol = newlabel("lblsedol", "Sedol:", "formlabel", frmproduct);
            inpsedol = newinput("inpsedol", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblinsttype = newlabel("lblinsttype", "Instrument Type:", "formlabel", frmproduct);
            inpinsttype = newinput("inpinsttype", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblcurrency = newlabel("lblcurrency", "Currency:", "formlabel", frmproduct);
            inpcurrency = newinput("inpcurrency", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblmarket = newlabel("lblmarket", "Market:", "formlabel", frmproduct);
            inpmarket = newinput("inpmarket", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblsector = newlabel("lblsector", "Sector:", "formlabel", frmproduct);
            inpsector = newinput("inpsector", "forminput", frmproduct, true);
            addNewLine(frmproduct, null);
            lblmargin = newlabel("lblmargin", "Margin %:", "formlabel", frmproduct);
            inpmargin = newinput("inpmargin", "forminput", frmproduct);
            addNewLine(frmproduct, null);
            lblhedge = newlabel("lblhedge", "Hedge:", "formlabel", frmproduct);
            opthedgeyes = newoption("opthedgeyes", "opthedge", "formcheckbox", frmproduct);
            lblhedgeyes = newlabel("lblhedgeyes", "Yes", "", frmproduct);
            opthedgeno = newoption("opthedgeno", "opthedge", "formcheckbox", frmproduct);
            lblhedgeno = newlabel("lblhedgeno", "No", "", frmproduct);
            addNewLine(frmproduct, null);
            lblptmlevy = newlabel("lblptmlevy", "PTM Levy exempt", "formlabel", frmproduct);
            optptmexempt = newoption("optptmexempt", "optptm", "formcheckbox", frmproduct);
            lblptmexempt = newlabel("lblptmexempt", "Yes", "", frmproduct);
            optptmnotexempt = newoption("optptmnotexempt", "optptm", "formcheckbox", frmproduct);
            lblptmnotexempt = newlabel("lblhedgeno", "No", "", frmproduct);
            addNewLine(frmproduct, null);
            btnupdate = newbutton("btnupdate", "Update", "formbutton", frmproduct);
            addNewLine(frmproduct, null);
            lblinstconf = newlabel("lblinstconf", "", "", frmproduct);

            btnupdate.onclick = function() {
                var inst = {};

                if (!validateNumeric(inpmargin, "Margin")) {
                    return;
                }

                if (inpmargin.value > 100) {
                    alert("Enter a Margin less than 100");
                    return;
                }

                inst.symbol = inpsymbol.value;
                inst.marginpercent = inpmargin.value;

                if (opthedgeyes.checked) {
                    inst.hedge = 1;
                } else {
                    inst.hedge = 0;                    
                }

                if (optptmexempt.checked) {
                    inst.ptmexempt = 1;
                } else {
                    inst.ptmexempt = 0;
                }

                sockjs.send("{\"instupdate\":" + JSON.stringify(inst) + "}");
            }

            main.appendChild(frmproduct);
        }

        function displayProduct(inst) {
            var inpsymbol = document.getElementById("inpsymbol");
            var inpdesc = document.getElementById("inpdesc");
            var inpisin = document.getElementById("inpisin");
            var inpsedol = document.getElementById("inpsedol");
            var inpinsttype = document.getElementById("inpinsttype");
            var inpsymbol = document.getElementById("inpsymbol");
            var inpsector = document.getElementById("inpsector");
            var inpmargin = document.getElementById("inpmargin");
            var opthedgeyes = document.getElementById("opthedgeyes");
            var opthedgeno = document.getElementById("opthedgeno");
            var lblinstconf = document.getElementById("lblinstconf");
            var optptmexempt = document.getElementById("optptmexempt");
            var optptmnotexempt = document.getElementById("optptmnotexempt");

            inpsymbol.value = inst.symbol;
            inpdesc.value = inst.description;
            inpisin.value = inst.isin;
            inpsedol.value = inst.sedol;
            inpinsttype.value = inst.instrumenttype;
            inpsector.value = inst.sector;
            inpmargin.value = inst.marginpercent;
            inpcurrency.value = inst.currency;
            inpmarket.value = inst.market;

            if (parseInt(inst.hedge)) {
                opthedgeyes.checked = true;
            } else {
                opthedgeno.checked = true;                
            }

            if (parseInt(inst.ptmexempt)) {
                optptmexempt.checked = true;
            } else {
                optptmnotexempt.checked = true;                
            }

            lblinstconf.innerHTML = "";
        }

        function maintainHedgebooks() {
            var insttype = "CFD";
            var currency = "GBP";

            var frmhedge = getForm("frmhedge");

            var lblinsttype = newlabel("lblinsttype", "Instrument Type:", "formlabel", frmhedge);
            var selinsttype = newselect("selinsttype", "formselect", frmhedge);
            addNewLine(frmhedge, null);
            var lblcurrency = newlabel("lblcurrency", "Currency:", "formlabel", frmhedge);
            var selcurrency = newselect("selcurrency", "formselect", frmhedge);
            addNewLine(frmhedge, null);
            var lblhedgebook = newlabel("lblhedgebook", "Hedge Book:", "formlabel", frmhedge);
            var selhedgebook = newselect("selhedgebook", "formselect", frmhedge);
            addNewLine(frmhedge, null);
            var btnupdate = newbutton("btnupdate", "Update", "formbutton", frmhedge);
            addNewLine(frmhedge, null);
            var lblhedgeconf = newlabel("lblhedgeconf", "", "", frmhedge);

            populateInstrumentTypes(selinsttype, insttype);
            populateCurrencies(selcurrency, currency);

            selinsttype.onchange = function() {
                insttype = selinsttype[selinsttype.selectedIndex].value;
                repopulateHedgebooks();
            }

            selcurrency.onchange = function() {
                currency = selcurrency[selcurrency.selectedIndex].value;
                repopulateHedgebooks();
            }

            btnupdate.onclick = function() {
                var hedgebook = {};

                hedgebook.insttype = selinsttype[selinsttype.selectedIndex].value;
                hedgebook.currency = selcurrency[selcurrency.selectedIndex].value;
                hedgebook.hedgebookid = selhedgebook[selhedgebook.selectedIndex].value;

                sockjs.send("{\"hedgebookupdate\":" + JSON.stringify(hedgebook) + "}");
            }

            function repopulateHedgebooks() {
                var hedgebookkey = insttype + ":" + currency;
                if (hedgebookkey in hedgebooks) {
                    populateHedgebooks(selhedgebook, hedgebooks[hedgebookkey].hedgebookid);                    
                } else {
                    populateHedgebooks(selhedgebook, defaultHedgebook);                                        
                }
                lblhedgeconf.innerHTML = "";
            }

            repopulateHedgebooks();

            main.appendChild(frmhedge);
        }

        function maintainCosts() {
            var insttype = "DE";
            var currency = "GBP";
            var side = 1;

            var frmcosts = getForm("frmcosts");

            var lblinsttype = newlabel("lblinsttype", "Instrument Type:", "formlabel", frmcosts);
            var selinsttype = newselect("selinsttype", "formselect", frmcosts);
            addNewLine(frmcosts, null);
            var lblcurrency = newlabel("lblcurrency", "Currency:", "formlabel", frmcosts);
            var selcurrency = newselect("selcurrency", "formselect", frmcosts);
            addNewLine(frmcosts, null);
            var lblside = newlabel("lblside", "Buy/Sell:", "formlabel", frmcosts);
            var selside = newselect("selside", "formselect", frmcosts);
            addNewLine(frmcosts, null);
            var lblcommissionpercent = newlabel("lblcommissionpercent", "Commission %:", "formlabel", frmcosts);
            var inpcommissionpercent = newinput("inpcommissionpercent", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblcommissionmin = newlabel("lblcommissionmin", "Commission Min:", "formlabel", frmcosts);
            var inpcommissionmin = newinput("inpcommissionmin", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblptmlevylimit = newlabel("lblptmlevylimit", "PTM Levy Limit:", "formlabel", frmcosts);
            var inpptmlevylimit = newinput("inpptmlevylimit", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblptmlevy = newlabel("lblptmlevy", "PTM Levy:", "formlabel", frmcosts);
            var inpptmlevy = newinput("inpptmlevy", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblstampdutylimit = newlabel("lblstampdutylimit", "Stamp Duty Limit:", "formlabel", frmcosts);
            var inpstampdutylimit = newinput("inpstampdutylimit", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblstampdutypercent = newlabel("lblstampdutypercent", "Stamp Duty %:", "formlabel", frmcosts);
            var inpstampdutypercent = newinput("inpstampdutypercent", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblcontractcharge = newlabel("lblcontractcharge", "Contract Charge:", "formlabel", frmcosts);
            var inpcontractcharge = newinput("inpcontractcharge", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lblfinance = newlabel("lblfinance", "Finance %:", "formlabel", frmcosts);
            var inpfinance = newinput("inpfinance", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var lbldefaultnosettdays = newlabel("lbldefaultnosettdays", "Default Settl. Days:", "formlabel", frmcosts);
            var inpdefaultnosettdays = newinput("inpdefaultnosettdays", "forminput", frmcosts, false);
            addNewLine(frmcosts, null);
            var btnupdate = newbutton("btnupdate", "Update", "formbutton", frmcosts);
            addNewLine(frmcosts, null);
            var lblcostsconf = newlabel("lblcostsconf", "", "", frmcosts);

            selinsttype.onchange = function() {
                insttype = selinsttype[selinsttype.selectedIndex].value;
                repopulateCosts();
            }

            selcurrency.onchange = function() {
                currency = selcurrency[selcurrency.selectedIndex].value;
                repopulateCosts();
            }

            selside.onchange = function() {
                side = selside[selside.selectedIndex].value;
                repopulateCosts();
            }

            btnupdate.onclick = function() {
                var cost = {};

                cost.insttype = selinsttype[selinsttype.selectedIndex].value;
                cost.currency = selcurrency[selcurrency.selectedIndex].value;
                cost.side = selside[selside.selectedIndex].value;
                cost.commissionpercent = inpcommissionpercent.value;
                cost.commissionmin = inpcommissionmin.value;
                cost.ptmlevylimit = inpptmlevylimit.value;
                cost.ptmlevy = inpptmlevy.value;
                cost.stampdutylimit = inpstampdutylimit.value;
                cost.stampdutypercent = inpstampdutypercent.value;
                cost.contractcharge = inpcontractcharge.value;
                cost.finance = inpfinance.value;
                cost.defaultnosettdays = inpdefaultnosettdays.value;

                sockjs.send("{\"cost\":" + JSON.stringify(cost) + "}");
            }

            function repopulateCosts() {
                displayCosts(selinsttype[selinsttype.selectedIndex].value, selcurrency[selcurrency.selectedIndex].value, selside[selside.selectedIndex].value);
                inpcommissionpercent.focus();         
                lblcostsconf.innerHTML = "";
            }

            populateInstrumentTypes(selinsttype, insttype);
            populateCurrencies(selcurrency, currency);
            populateSide(selside, side);

            main.appendChild(frmcosts);

            repopulateCosts();
        }

        function displayCosts(insttype, currency, side) {
            var costkey = insttype + ":" + currency + ":" + side;

            var inpcommissionpercent = document.getElementById("inpcommissionpercent");
            var inpcommissionmin = document.getElementById("inpcommissionmin");
            var inpptmlevylimit = document.getElementById("inpptmlevylimit");
            var inpptmlevy = document.getElementById("inpptmlevy");
            var inpstampdutylimit = document.getElementById("inpstampdutylimit");
            var inpstampdutypercent = document.getElementById("inpstampdutypercent");
            var inpcontractcharge = document.getElementById("inpcontractcharge");
            var inpfinance = document.getElementById("inpfinance");
            var inpdefaultnosettdays = document.getElementById("inpdefaultnosettdays");

            if (costkey in costs) {
                inpcommissionpercent.value = costs[costkey].commissionpercent;
                inpcommissionmin.value = costs[costkey].commissionmin;
                inpptmlevylimit.value = costs[costkey].ptmlevylimit;
                inpptmlevy.value = costs[costkey].ptmlevy;
                inpstampdutylimit.value = costs[costkey].stampdutylimit;
                inpstampdutypercent.value = costs[costkey].stampdutypercent;
                inpcontractcharge.value = costs[costkey].contractcharge;
                inpfinance.value = costs[costkey].finance;
                inpdefaultnosettdays.value = costs[costkey].defaultnosettdays;
            } else {
                inpcommissionpercent.value = "";
                inpcommissionmin.value = "";
                inpptmlevylimit.value = "";
                inpptmlevy.value = "";
                inpstampdutylimit.value = "";
                inpstampdutypercent.value = "";
                inpcontractcharge.value = "";
                inpfinance.value = "";
                inpdefaultnosettdays.value = "";            
            }
        }

        function maintainIfas() {
            var frmifa = getForm("frmifa");

            var selifa = newselect("selinsttype", "formselect", frmifa);
            addNewLine(frmifa, null);
            var lblname = newlabel("lblname", "Name:", "formlabel", frmifa);
            var inpname = newinput("inpname", "forminput", frmifa);
            addNewLine(frmifa, null);
            var lblemail = newlabel("lblemail", "Email:", "formlabel", frmifa);
            var inpemail = newinput("inpemail", "forminput", frmifa);
            addNewLine(frmifa, null);
            var lblmobile = newlabel("lblmobile", "Mobile:", "formlabel", frmifa);
            var inpmobile = newinput("inpmobile", "forminput", frmifa);
            addNewLine(frmifa, null);
            var lbladdress = document.createElement("label");
            lbladdress.className = "formlabel";
            lbladdress.innerHTML = "Address:";
            var inpaddress = document.createElement("textarea");
            inpaddress.id = "inpaddress";
            var divaddress = document.createElement("div");
            divaddress.appendChild(lbladdress);
            divaddress.appendChild(inpaddress);
            frmifa.appendChild(divaddress);
            addNewLine(frmifa, null);
            var lblifaid = newlabel("lblifaid", "Id:", "formlabel", frmifa);
            var inpifaid = newinput("inpifaid", "forminput", frmifa, true);
            addNewLine(frmifa, null);
            var btnupdate = newbutton("btnupdate", "Update", "formbutton", frmifa);
            addNewLine(frmifa, null);
            var lblifaconf = newlabel("lblifaconf", "", "", frmifa);

            selifa.onchange = function() {
                repopulateIfa();
            }

            btnupdate.onclick = function() {
                var ifa = {};

                ifa.ifaid = inpifaid.value;
                ifa.name = inpname.value;
                ifa.email = inpemail.value;
                ifa.mobile = inpmobile.value;
                ifa.address = inpaddress.value;

                sockjs.send("{\"ifa\":" + JSON.stringify(ifa) + "}");
            }

            function repopulateIfa() {
                displayIfa(selifa[selifa.selectedIndex].value);                    
                lblifaconf.innerHTML = "";                
            }

            populateIfas(selifa, 0, 1);

            main.appendChild(frmifa);

            repopulateIfa();
        }

        function displayIfa(ifaid) {
            var inpname = document.getElementById("inpname");
            var inpemail = document.getElementById("inpemail");
            var inpmobile = document.getElementById("inpmobile");
            var inpaddress = document.getElementById("inpaddress");
            var inpifaid = document.getElementById("inpifaid");

            if (ifaid in ifas) {
                inpname.value = ifas[ifaid].name;
                inpemail.value = ifas[ifaid].email;
                inpmobile.value = ifas[ifaid].mobile;
                inpaddress.value = ifas[ifaid].address;
                inpifaid.value = ifas[ifaid].ifaid;
            } else {
                inpname.value = "";
                inpemail.value = "";
                inpmobile.value = "";
                inpaddress.value = "";
                inpifaid.value = "";
            }

            inpname.focus();
        }

        //
        // various routines to create presentation elements
        //

        function addNewLine(frm, id) {
            var newline = document.createElement("label");
            newline.innerHTML = "<br>";
            if (id != null) {
                newline.id = id;
            }
            frm.appendChild(newline);
            return newline;
        }

        function getForm(id) {
            var form = document.getElementById(id);
            if (form == null) {
                form = document.createElement("form");
                form.id = id;
            }
            return form;  
        }

        function newlabel(id, text, classname, form) {
            var label = document.createElement("label");
            label.id = id;
            if (classname != "") {
                label.className = classname;
            }
            label.innerHTML = text;
            if (form != null) {
                form.appendChild(label);
            }
            return label;    
        }

        function newinput(id, classname, form, disabled) {
            var input = document.createElement("input");
            input.id = id;
            if (classname != "") {
                input.className = classname;
            }
            if (disabled) {
                input.disabled = true;
            }
            form.appendChild(input);   
            return input;
        }

        function newselect(id, classname, form) {
            var select = document.createElement("select");
            select.id = id;
            if (classname != "") {
                select.className = classname;
            }
            form.appendChild(select);   
            return select;
        }

        function newoption(id, name, classname, form) {
            var option = document.createElement("input");
            option.type = "radio";
            option.id = id;
            option.name = name;
            if (classname != "") {
                option.className = classname;
            }
            form.appendChild(option);   
            return option;
        }

        function newbutton(id, value, classname, form) {
            var button = document.createElement("input");
            button.type = "button";
            button.id = id;
            button.value = value;
            if (classname != "") {
                button.className = classname;
            }
            form.appendChild(button);   
            return button;
        }

        function newlink(id, text, classname, form) {
            var link = document.createElement('a');
            link.id = id;
            link.innerHTML = text;
            if (classname != "") {
                newlink.className = classname;
            }
            form.appendChild(link);
            return link;
        }

        //
        // various populate routines to populate selection boxes
        //

        function populateBrokers(brokerselect, defaultid) {
            var i = 0;

            for (var j in brokers) {
                if (brokers[j].brokerid == defaultid) {
                    brokerselect[i] = new Option(brokers[j].name, brokers[j].brokerid, true, true);
                } else {
                    brokerselect[i] = new Option(brokers[j].name, brokers[j].brokerid, false, false);                    
                }
                i++;
            }
        }

        function populateIfas(ifaselect, defaultid, option) {
            var i = 0;

            for (var j in ifas) {
                if (ifas[j].ifaid == defaultid) {
                    ifaselect[i] = new Option(ifas[j].name, ifas[j].ifaid, true, true);
                } else {
                    ifaselect[i] = new Option(ifas[j].name, ifas[j].ifaid, false, false);                    
                }
                i++;
            }

            if (option == 1) {
                if (i == 0) {
                    ifaselect[i] = new Option("New IFA", 0, true, true);
                } else {
                    ifaselect[i] = new Option("New IFA", 0, false, false);
                }
            } else if (option == 0) {
                if (i == 0) {
                    ifaselect[i] = new Option("None", 0, true, true);
                } else {
                    ifaselect[i] = new Option("None", 0, false, false);
                }
            }
        }

        function populateCurrencies(currselect, defaultid) {
            var i = 0;

            for (var j in currencies) {
                if (currencies[j] == defaultid) {
                    currselect[i] = new Option(currencies[j], currencies[j], true, true);
                } else {
                    currselect[i] = new Option(currencies[j], currencies[j], false, false);                    
                }
                i++;
            }
        }

        function populateCashtranstypes(transtypeselect, defaultid) {
            var i = 0;

            for (var j in cashtranstypes) {
                if (cashtranstypes[j].cashtranstypeid == defaultid) {
                    transtypeselect[i] = new Option(cashtranstypes[j].description, cashtranstypes[j].cashtranstypeid, true, true);
                } else {
                    transtypeselect[i] = new Option(cashtranstypes[j].description, cashtranstypes[j].cashtranstypeid, false, false);         
                }
                i++;
            }
        }

        function populateClientTypes(clienttypeselect, defaultid) {
            var i = 0;

            for (var j in clienttypes) {
                if (clienttypes[j].clienttypeid == defaultid) {
                    clienttypeselect[i] = new Option(clienttypes[j].description, clienttypes[j].clienttypeid, true, true);
                } else {
                    clienttypeselect[i] = new Option(clienttypes[j].description, clienttypes[j].clienttypeid, false, false);         
                }
                i++;
            }            
        }

        function populateInstrumentTypes(insttypeselect, defaultid) {
            var i = 0;

            for (var j in instrumenttypes) {
                if (instrumenttypes[j].instrumenttypeid == defaultid) {
                    insttypeselect[i] = new Option(instrumenttypes[j].description, instrumenttypes[j].instrumenttypeid, true, true);
                } else {
                    insttypeselect[i] = new Option(instrumenttypes[j].description, instrumenttypes[j].instrumenttypeid, false, false);         
                }
                i++;
            }            
        }

        function populateHedgebooks(hedgebookselect, defaultid) {
            var i = 0;

            for (var j in clients) {
                if (clients[j].type == 2) {
                    if (clients[j].clientid == defaultid) {
                        hedgebookselect[i] = new Option(clients[j].name, clients[j].clientid, true, true);
                    } else {
                        hedgebookselect[i] = new Option(clients[j].name, clients[j].clientid, false, false);         
                    }
                    i++;
                }
            }                        
        }

        function populateSide(sideselect, defaultside) {
            if (defaultside == 1) {
                sideselect[0] = new Option("Buy", 1, true, true);
                sideselect[1] = new Option("Sell", 2, false, false);
            } else {
                sideselect[0] = new Option("Buy", 2, false, false);
                sideselect[1] = new Option("Sell", 1, true, true);                
            }
        }

        function requestHistory() {
            var inpclientid;
            var historyrequest = {};

            var frmhistory = getForm("frmhistory");

            selectClient("frmhistory", null, null, true, "", "inpclientid", "", true);

            var lnkquoterequests = newlink("lnkquoterequests", "Quote Requests", "", frmhistory);
            var lnkquotes = newlink("lnkquotes", "Quotes", "", frmhistory);
            var lnkorders = newlink("lnkorders", "Orders", "", frmhistory);
            var lnktrades = newlink("lnktrades", "Trades", "", frmhistory);
            var lnkcash = newlink("lnkcash", "Cash", "", frmhistory);
            var lnkchat = newlink("lnkchat", "Chat", "", frmhistory);

            lnkquoterequests.onclick = function() {
                if (!validateClientid(false)) {return;}

                setSelected(lnkquoterequests);
                historyrequest.clientid = inpclientid.value;
                sockjs.send("{\"quoterequesthistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkquotes.onclick = function() {
                if (!validateClientid(false)) {return;}

                setSelected(lnkquotes);
                historyrequest.clientid = inpclientid.value;
                sockjs.send("{\"quotehistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkorders.onclick = function() {
                if (!validateClientid(false)) {return;}

                setSelected(lnkorders);
                historyrequest.clientid = inpclientid.value;
                sockjs.send("{\"orderhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnktrades.onclick = function() {
                if (!validateClientid(true)) {return;}

                setSelected(lnktrades);
                historyrequest.clientid = inpclientid.value;
                sockjs.send("{\"tradehistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkcash.onclick = function() {
                if (!validateClientid(false)) {return;}

                setSelected(lnkcash);
                historyrequest.clientid = inpclientid.value;
                historyrequest.currency = "GBP";
                sockjs.send("{\"cashhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkchat.onclick = function() {
                if (!validateClientid(false)) {return;}

                setSelected(lnkchat);
                historyrequest.clientid = inpclientid.value;
                sockjs.send("{\"chathistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            inpclientid = document.createElement("input");
            inpclientid.type = "hidden";
            inpclientid.id = "inpclientid";
            inpclientid.value = "";

            frmhistory.appendChild(inpclientid);

            addNewLine(frmhistory, null);
            addNewLine(frmhistory, null);
            
            main.appendChild(frmhistory);

            function validateClientid(zeroclientidok) {
                var validclient = true;

                if (inpclientid.value == "") {
                    alert("Please select a client");
                    validclient = false;
                    selectClientFocus("clientboxinput");
                }

                // only allow "All clients" for trades
                if (inpclientid.value == "0" && zeroclientidok == false) {
                    alert("Please select an individual client");
                    validclient = false;
                    selectClientFocus("clientboxinput");
                }

                return validclient;
            }

            function setSelected(link) {
                lnkquoterequests.className = "";
                lnkquotes.className = "";
                lnkorders.className = "";
                lnktrades.className = "";
                lnkchat.className = "";
                lnkcash.className = "";

                link.className = "linkselected";
            }
        }

        function holidays() {
            var listholidays;

            var divholidays = getDiv("divholidays");

            var lblmarket = newlabel("lblmarket", "Market:", "formlabel", divholidays);

            var selmarket = newselect("selmarket", "formselect", divholidays);

            populateMarkets(selmarket, "L");

            selmarket.onchange = function() {
                var holidayreq = {};

                holidayreq.market = selmarket[selmarket.selectedIndex].value;
                sockjs.send("{\"holidayrequest\":" + JSON.stringify(holidayreq) + "}");
            }

            listholidays = document.createElement('ul');
            listholidays.id = "listholidays";
            listholidays.id = "listholidays";
            //listholidays.className = "***"; // done
            listholidays.className = "lsthol"; // add .lsthol to css


            listholidays.onclick = function() {
                var del = confirm("Are you sure you want to delete this date ?");
                // alert confirming delete list element //done
                // if delete confirmed, send a message to server //done
                if (del === true) {
                    var rmv = remove.selectedIndex;
                    sockjs.send("{\"listHolidays\":" + JSON.stringify(rmv) + "}");
                }
            }

             // add a button to add a holiday //done
            var addhol = document.createElement("button");
            addhol.innerHTML = "Add";
            // if cliecked, send a message to server //

            divholidays.appendChild(listholidays);
        }

        //
        // called when a holidays message arrives
        //
        function displayHolidays(holidays) {
            var i = 0;
            var listholidays;

            console.log("displayHolidays");

            listholidays = document.getElementById("listholidays");
            if (holidays != null) {
                for (var j in holidays) {
                    addElement(holidays[j].date, listholidays, i);
                    i++;
                }
            }
        }

        //
        // receive an addholiday message
        //
        function addHoliday(holiday) {
            //get list //done
            var gtlstah = getElementById(listholidays);
            // add item to list //done
            var additm = add(holidays[j].date);
        }

        //
        // receive an removeholiday message
        //
        function removeHoliday(holiday) {
            //get list //done
            var gtlstrh = getElementById(listholidays);
            //remove element from list //done
            var rmvitm = remove(holidays.selectedIndex);
        }

        function populateMarkets(mktselect, defaultid) {
            var i = 0;

            for (var j in markets) {
                if (j == defaultid) {
                    mktselect[i] = new Option(markets[j].name, markets[j].market, true, true);
                } else {
                    mktselect[i] = new Option(markets[j].name, markets[j].market, false, false);                    
                }
                i++;
            }
        }

        function displayStatus() {
            var msg;

            clearList("list1", false);
            var list1 = getList("list1");

            msg = "Trade Server:" + getServerStatus(serverstatus.tsstatus);
            addElement(msg, list1, 0);
            msg = "Price Server:" + getServerStatus(serverstatus.psstatus);
            addElement(msg, list1, 1);
        }

        function monitor() {
            var list1 = getList("list1");
            main.appendChild(list1);
            displayStatus();
        }

        function endOfDay() {
            var eoddate = new Date();

            var frmeod = getForm("frmeod");

            var lbleoddate = newlabel("lbleoddate", "Run End Of Day for " + eoddate, "", frmeod);

            var btneod = newbutton("btneod", "Confirm", "formbutton", frmeod);
        }

        function populateDate(day, month, year, defaultdate) {
            var today = new Date();
            var thisyear = today.getFullYear();

            var defaultday = defaultdate.getDate();
            var defaultmonth = defaultdate.getMonth();
            var defaultyear = defaultdate.getFullYear();
            var nummonthdays = getMonthDays(defaultyear, defaultmonth);

            populateDay(day, nummonthdays, defaultday);

            for (var m = 0; m < 12; m++) {
                if (m == defaultmonth) {
                    month[m] = new Option(monthtext[m], m + 1, true, true);
                } else {
                    month[m] = new Option(monthtext[m], m + 1, false, false);
                }
            }

            for (var y = 0; y < 2; y++) {
                if (thisyear == defaultyear) {
                    year[y] = new Option(thisyear, thisyear, true, true);
                } else {
                    year[y] = new Option(thisyear, thisyear, false, false);
                }

                thisyear += 1;
            }

            month.onchange = function() {
                var selectedday = day[day.selectedIndex].value;
                day.length = 0;
                nummonthdays = getMonthDays(year[year.selectedIndex].value, month.selectedIndex);
                populateDay(day, nummonthdays, selectedday);
            }
        }

        function populateDay(day, numdays, defaultday) {
            for (var i = 0; i < numdays; i++) {
                if (i == defaultday - 1) {
                    day[i] = new Option(i + 1, i + 1, true, true);
                } else {
                    day[i] = new Option(i + 1, i + 1, false, false);
                }
            }
        }

        function populateTime(hour, minute, second) {
            hour[0] = new Option("00", "00", true, true);
            minute[0] = new Option("00", "00", true, true);
            second[0] = new Option("00", "00", true, true);
        }

        function getDefaultSettleDate() {
            var today = new Date();

            for (var i = 0; i < 3; i++) {
                today.setDate(today.getDate() + 1);

                // ignore weekends
                if (today.getDay() == 6) {
                    today.setDate(today.getDate() + 2);
                } else if (today.getDay() == 0) {
                    today.setDate(today.getDate() + 1);
                }
            }

            return today;
        }

        function getServerStatus(status) {
            var desc;

            switch (status) {
            case 0:
                desc = "started";
                break;    
            case 1:
                desc = "connected";
                break;    
            case 2:
                desc = "disconnected";
                break;    
            }

            return desc;
        }

        function getOrderStatusDesc(status) {
            var desc;

            switch (status) {
            case '0':
                desc = "New";
                break;
            case '1':
                desc = "Partially filled";
                break;
            case '2':
                desc = "Filled";
                break;
            case '3':
                desc = "Done for day";
                break;
            case '4':
                desc = "Cancelled";
                break;
            case '5':
                desc = "Replaced";
                break;
            case '6':
                desc = "Pending Cancel"; // (e.g. result of Order Cancel Request <F>) 7 = Stopped
                break;
            case '8':
                desc = "Rejected";
                break;
            case '9':
                desc = "Suspended";
                break;
            case 'A':
                desc = "Pending New";
                break;
            case 'B':
                desc = "Calculated";
                break;
            case 'C':
                desc = "Expired";
                break;
            case 'D':
                desc = "Accepted for bidding";
                break;
            case 'E':
                desc = "Pending Replace";
                break;
            default:
                desc = "Unknown status";
            }

            return desc;
        }

        function getMonthDays(year, month) {
            var isLeap = ((year % 4) == 0 && ((year % 100) != 0 || (year % 400) == 0));
            return [31, (isLeap ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
        }

        function getReasonDesc(reason) {
            var desc;

            if (reason == "") {
                return "";
            }

            switch (parseInt(reason)) {
            case 1001:
                desc = "No currency held for this instrument";
                break;
            case 1002:
                desc = "Insufficient cash in settlement currency";
                break;
            case 1003:
                desc = "No position held in this instrument";
                break;
            case 1004:
                desc = "Insufficient position size in this instrument";
                break;
            case 1005:
                desc = "System error";
                break;
            case 1006:
                desc = "Invalid order";
                break;
            case 1007:
                desc = "Invalid instrument";
                break;
            case 1008:
                desc = "Order already cancelled";
                break;
            case 1009:
                desc = "Order not found";
                break;
            case 1010:
                desc = "Order already filled";
                break;
            case 1011:
                desc = "Order currency does not match symbol currency";
                break;
            case 1012:
                desc = "Order already rejected";
                break;
            case 1013:
                desc = "Ordercancelrequest not found";
                break;
            case 1014:
                desc = "Quoterequest not found";
                break;
            case 1015:
                desc = "Symbol not found";
                break;
            case 1016:
                desc = "Proquote symbol not found";
                break;
            case 1017:
                desc = "Client not found";
                break;
            case 1018:
                desc = "Client not authorised to trade this type of product";
                break;
            case 1019:
                desc = "Quantity greater than position quantity";
                break;
            case 1020:
                desc = "Insufficient free margin";
                break;
            case 1021:
                desc = "Order held externally";
                break;
            case 1022:
                desc = "Order already expired";
                break;
            default:
                desc = "Unknown reason";
            }

            return desc;
        }

        function init() {
            // a replacement indexOf()
            if (!Array.prototype.indexOf) {
                Array.prototype.indexOf = function (searchElement, fromIndex) {
                    if ( this === undefined || this === null ) {
                        throw new TypeError( '"this" is null or not defined' );
                    }

                    var length = this.length >>> 0; // Hack to convert object.length to a UInt32

                    fromIndex = +fromIndex || 0;

                    if (Math.abs(fromIndex) === Infinity) {
                        fromIndex = 0;
                    }

                    if (fromIndex < 0) {
                        fromIndex += length;
                        if (fromIndex < 0) {
                            fromIndex = 0;
                        }
                    }

                    for (;fromIndex < length; fromIndex++) {
                        if (this[fromIndex] === searchElement) {
                            return fromIndex;
                        }
                    }

                    return -1;
                };
            }

            // a replacement Object.keys()
            if (!Object.keys) {
                Object.keys = (function () {
                    'use strict';
                    var hasOwnProperty = Object.prototype.hasOwnProperty,
                        hasDontEnumBug = !({toString: null}).propertyIsEnumerable('toString'),
                        dontEnums = [
                            'toString',
                            'toLocaleString',
                            'valueOf',
                            'hasOwnProperty',
                            'isPrototypeOf',
                            'propertyIsEnumerable',
                            'constructor'
                        ],
                        dontEnumsLength = dontEnums.length;

                    return function (obj) {
                        if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
                            throw new TypeError('Object.keys called on non-object');
                        }

                        var result = [], prop, i;

                        for (prop in obj) {
                            if (hasOwnProperty.call(obj, prop)) {
                                result.push(prop);
                            }
                        }

                        if (hasDontEnumBug) {
                            for (i = 0; i < dontEnumsLength; i++) {
                                if (hasOwnProperty.call(obj, dontEnums[i])) {
                                    result.push(dontEnums[i]);
                                }
                            }
                        }
                        return result;
                    };
                }());
            }
        }

    </script>
</body></html>