<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>TG-Online v0.9</title>
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
    .axis path,
    .axis line {
        fill: none;
        /*stroke: grey;*/
        stroke: #ccc;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }
    .sb {
        color: steelblue;
    }
    .yl {
        color: yellow;
    }
    body {
        /*font: 12px Arial;*/
        font: 12px sans-serif;
    }
    .x.axis path {
        /*stroke: blue;*/
        /*display: none;*/
    }
    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .divchart {
        width: 960px;
        margin-left: auto;
        margin-right: auto;
    }
    .node {
        cursor: pointer;
    }
    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .node text {
        font: 18px sans-serif;
    }
    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }
    .rfqbutton {
        font-size: 21px;
        border-style: none;
        background-color: rgb(28, 184, 65);
        color: white;
        cursor: pointer;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }

    </style>
</head>
<body lang="en">
    <script>
        var sockjs_url = '/echo';
        var sockjs;
        var orderbooks = {};
        var ukx = [];
        var pricehist = [];
        var operatortype = 5; // web
        var clientid = 1; // todo

        var datain = function(msg) {
            try {
                var obj = JSON.parse(msg);

                if ("prices" in obj) {
                    updateChart(obj.prices);
                } else if ("orderbooks" in obj) {
                    loadOrderBooks(obj.orderbooks);
                } else if ("orderbook" in obj) {
                    updateOrderBook(obj.orderbook);
                } else if ("index" in obj) {
                    updateIndex(obj.index);
                    displayIndex(ukx);
                } else if ("pricehistory" in obj) {
                    console.log(obj);
                    //updatePricehistory(obj.pricehistory);
                    pricehist = obj.pricehistory.prices;
                    createChart();
                }
            } catch(e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        var newconn = function() {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function()  {
                console.log("connection open");

                // we are ready
                start();
            };

            sockjs.onmessage = function(e) {
                datain(e.data);
            };

            sockjs.onclose = function()  {
                console.log("connection closed");
            };

            sockjs.onheartbeat = function() {
            };
        };

        // get a connection
        newconn();

        // things start here
        function start() {
            // start with FTSE 100
            //requestIndex("UKX");
            //requestPricehistory("LLOY.L");
            displayTable("LLOY.L");
            //displayForm("LLOY.L");
        }

        function loadOrderBooks(orderbookarr) {
            for (var i = 0; i < orderbookarr.length; ++i) {
                updateOrderBook(orderbookarr[i]);
            }
        }

        function updateOrderBook(orderbook) {
            var level;

            // create an entry in the orderbooks array for this symbol
            if (!(orderbook.symbol in orderbooks)) {
                // 6 levels
                orderbooks[orderbook.symbol] = [{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0}];
            }
        }

        function updatePricehistory(pricehist) {
            console.log("pricehist");
        }

        function removeOrderBook(symbol) {
            delete orderbooks[symbol];
        }

        function updateIndex(index) {
            console.log("updateIndex");

            var rootnode = {};
            rootnode.name = "FTSE 100";
            rootnode.children = [];
            ukx.push(rootnode);

            for (var i = 0; i < index.symbols.length; ++i) {
                var node = {};
                node.name = index.symbols[i].shortname;
                node.parent = "FTSE 100";
                node.symbol = index.symbols[i].symbol;
                ukx[0].children.push(node);
            }
        }

        function requestIndex(index) {
            console.log("requestIndex:" + index);
            sockjs.send("{\"index\":" + JSON.stringify(index) + "}");
        }

        // assumes today
        function requestPricehistory(symbol) {
            var pricehistoryrequest = {};

            var today = new Date();
            var startofday = new Date();
            startofday.setHours(08);
            startofday.setMinutes(00);
            startofday.setSeconds(00);

            console.log(startofday.getTime());
            console.log(today.getTime());

            pricehistoryrequest.symbol = symbol;
            pricehistoryrequest.startperiod = startofday.getTime();
            pricehistoryrequest.endperiod = today.getTime();
            sockjs.send("{\"pricehistoryrequest\":" + JSON.stringify(pricehistoryrequest) + "}");
        }

        // display a tree
        function displayIndex(treedata) {
            var margin = {top: 20, right: 120, bottom: 20, left: 120},
                width = 960 - margin.right - margin.left,
                height = 1200 - margin.top - margin.bottom;
    
            var i = 0;
            var duration = 750;

            var tree = d3.layout.tree()
                .size([height, width]);

            var diagonal = d3.svg.diagonal()
                .projection(function(d) { return [d.y, d.x]; });

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var root = treedata[0];
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            root.children.forEach(collapse);
            update(root);

            d3.select(self.frameElement).style("height", "700px");

            function update(source) {
                console.log("update");
                // Compute the new tree layout.
                var nodes = tree.nodes(root).reverse(),
                    links = tree.links(nodes);

                // Normalize for fixed-depth.
                nodes.forEach(function(d) { d.y = d.depth * 48; });

                // Update the nodes…
                var node = svg.selectAll("g.node")
                    .data(nodes, function(d) { return d.id || (d.id = ++i); });

                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                    .on("click", click);

                nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeEnter.append("text")
                    .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
                    .text(function(d) { return d.name; })
                    .style("fill-opacity", 1e-6);

                // Transition nodes to their new position.
                var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

                nodeUpdate.select("circle")
                    .attr("r", 4.5)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeUpdate.select("text")
                    .style("fill-opacity", 1);

                // Transition exiting nodes to the parent's new position.
                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                    .remove();

                nodeExit.select("circle")
                    .attr("r", 1e-6);

                nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

                // Update the links…
                var link = svg.selectAll("path.link")
                    .data(links, function(d) { return d.target.id; });

                // Enter any new links at the parent's previous position.
                link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function(d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

                // Transition links to their new position.
                link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link.exit().transition()
                    .duration(duration)
                    .attr("d", function(d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

                // Stash the old positions for transition.
                nodes.forEach(function(d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            // Toggle children on click.
            function click(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;

                    requestPricehistory(d.symbol);
                }

                update(d);
            }
        }

        // chart an array of prices
        function createChart() {
            console.log("createChartBaby");
            /*for (var i = 0; i < pricehist.length; i++) {
                console.log(pricehist[i].mid);
            }*/

            // set margin around graph & set width & height of graph canvas to reflect this
            var margin = {top: 50, right: 20, bottom: 30, left: 50},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            //  function for recognising datetime values
            parseDate = d3.format();

            // make sure range pixel values fit the x-axis & state that we are using datetime values
            x = d3.time.scale()
                .range([0, width]);

            // make sure range of pixel values fit the y-axis
            y = d3.scale.linear()
                .range([height, 0]);

            // set-up the x-axis
            xaxis = d3.svg.axis().scale(x)
                .orient("bottom").ticks(6);

             // set-up the y-axis
            yaxis = d3.svg.axis().scale(y)
                .orient("left").ticks(6);

            // convert data to work for graph coordinates
            line = d3.svg.line()
                .x(function(d) { return x(d.timestamp); })
                .y(function(d) { return y(d.mid); });

            // create our div
            var divchart = d3.select("body")
                .attr("class", "divchart")
                .append("div");

            var button = divchart.append("button")
                .on('click', function(d,i) {
                    //updateChart();
                    return;
                    // scale the range of the data again
                    x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
                    y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
                    //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

                    var svg = d3.select("body").transition();

                    // change the line
                    svg.select(".line")
                        //.datum(pricehist)
                        .attr("d", line(pricehist));

                    // change the x-axis
                    svg.select(".x.axis")
                        .call(xaxis);

                    // change the y-axis
                    svg.select(".y.axis")
                        .call(yaxis);

                        console.log("updated, i think");
                });

            // add an svg canvas
            var svg = divchart.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // convert data to something usable
            pricehist.forEach(function(d) {
                var dt = new Date(+d.timestamp);
                d.timestamp = parseDate(dt);
                d.mid = +d.mid;
            });

            // set the scope of data values for both axes
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
            //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

            // add the x-axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xaxis);

            // add the y-axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yaxis);

            // add the line
            svg.append("path")
                .datum(pricehist)
                .attr("class", "line")
                .attr("d", line);

            // title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("id", "textid")
                .attr("text-anchor", "middle")
                .style("font-size", "26px")
                .style("fill", "grey")
                .text("Lloyds - ")
                .append("tspan")
                    .attr("id", "bid")
                    .html("23.10")
                    .style("fill", "red")
                    .style("font-size", "33px")
                    //.text("23.10")
                .append("tspan")
                    .html(" / ")
                    .style("fill", "grey")
                    //.text(" / ")
                .append("tspan")
                    .attr("id", "ask")
                    .html(" 23.25")
                    .style("fill", "blue");
                    //.text(" 23.25");
        }

        function updateChart(prices) {
            console.log("updateChartBaby");
            console.log(prices);
            return;

            /*for (var i = 0; i < prices.length; i++) {
                var d = {};
                var dt = new Date(+prices[i].timestamp);

                if ("bid" in prices) {
                    d.bid = prices[i].bid;
                } else {
                    d.bid = prices[i].ask;
                }

                d.timestamp = parseDate(dt);
                d.bid = +d.bid;

                pricehist.push(d);
            }*/

            //var svg = d3.select("body").transition();

            /*svg.select("#textid")
                .text("Lloyds - " + prices[0].bid + " / " + prices[0].ask);*/

            for (var i = 0; i < prices.length; i++) {
                if ("bid" in prices[i]) {
                    d3.select("tspan")
                        .html(prices[i].bid);
                        console.log("updating bid");
                } else {
                    d3.select("#ask")
                        .html(prices[i].ask);
                        console.log("updating ask");
                }
            }

/*
            // re-scale the range of the data again
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));

            var svg = d3.select("body").transition();

            // update the line
            svg.select(".line")
                //.datum(pricehist)
                .attr("d", line(pricehist));

            // reset the x-axis
            svg.select(".x.axis")
                .call(xaxis);

            // reset the y-axis
            svg.select(".y.axis")
                .call(yaxis);
*/
            //console.log(line);
        }

        function displayTable(symbol) {
            // not used
            var fields = ["Quantity","Price","Settlement Date",""];
            var inputtypes = ["text","date"];
            var inputtexts = ["","","","Request Quote"];
            var fs = ["", "", "", "18px"];
            var onclicks = [null, null, null, "john()"];
            var tbldata = [{name:"Quantity",value:4},{name:"Price",value:3},{name:"Settlement Date",value:5},{name:"",value:6}];
            var columns = ["name","value","test"];

            var data = [
            ["Quantity",""],
            ["Settlement Date",""]
            ];

            console.log("displayTable:" + symbol);

            var table = d3.select("body")
                .append("table");
                //.attr("style", "margin-left: 250px");

            var thead = table.append("thead");
            var tbody = table.append("tbody");

            // append the header row
            /*thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                    .text(function(column) { return column; });*/

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(d) { return d; })
                .enter()
                .append("td")
                .each(function(d, i, j) { // i=column, j=row
                    if (i == 0) {
                        // text in first column
                        d3.select(this)
                            .text(function(d) { return d; });
                    } else if (i == 1) {
                        // input fields in second column
                        d3.select(this)
                            .append("input")
                            .attr("type", function(d) { return inputtypes[j]; });
                    }
                });

            //var descs = cells.filter(function(d, i) {return i == 0});
            //descs.text(function(d) { return d; });

            //console.log(descs);



            //var inputs = cells.filter(function(d, i) {return i == 1});

            /*d3.selectAll("td")
                .append("input")
                .attr("type", function(d, i) { console.log(d); console.log(i); return inputtypes[i]; });*/

                //console.log(inps);

            /*inputs.selectAll()
                .each(function(d,i) {
                    console.log(d);
                    console.log(i);
                });*/

            //console.log(inputs);
            //inputs.append("input");

            /*inputs.selectAll("input")
                .data(function(d, i) { console.log(d);console.log(i);return inputtypes[i]; })
                .enter()
                .append("input");*/
                //.attr("type", function(d, i) { console.log(d);return inputtypes[i]; });


                /*.each(function(d,i) {console.log("d="+d);console.log("i="+i);
                });*.
                //.attr("type", function(d, i) {console.log(i); return d; });
                /*.on("input", function(d, i) {
                    console.log(i);
                    console.log(this.value);
                    inputdata[i] = this.value;
                    console.log(inputdata);
                    //updateHeight(+this.value);
                });*/

            tbody.append("tr")
                .append("td")
                    .append("input")
                        .attr("type", "button")
                        .attr("value", "Request Quote")
                        .attr("class", "rfqbutton")
                        .on("click", sendRfq);

            // send a request for quote
            function sendRfq() {
                var rfq = {};

                rfq.clientid = clientid;
                rfq.symbol = symbol;
                rfq.cashorderqty = "";
                rfq.currency = "GBP"; // todo
                rfq.settlcurrency = "GBP"; // todo
                rfq.nosettdays = 2;
                rfq.operatortype = operatortype;
                rfq.operatorid = clientid;

                var inps = d3.selectAll("td input")
                    .each(function(d,i) {
                        switch (i) {
                        case 0:
                            rfq.quantity = this.value;
                            break;
                        case 1:
                            rfq.settldate = this.value;
                            break;
                        }
                    });

                    //symbol, quantity, cashorderqty, currency, settlcurrency, nosettdays

                console.log(rfq);
                sockjs.send("{\"quoterequest\":" + JSON.stringify(rfq) + "}");
            }

            /*d3.selectAll("input")
                .each(function(d, i) {
                    var inp = d3.select(this);
                    console.log(inp[0]);
                    console.log(inp[1]);
                });*/


            //console.log(inputs);

            //d3.selectAll('input').data(...)
                //inputs.property('value', function (d) { return d.field; }) .on('change', function (d) { d.field = this.value; });


            //var jj = d3.select("input #input:0");





                //console.log(cells);

                    //.attr("value", "hello");

                //.attr("style", "font-family: Courier") // sets the font style
                //.text(function(d) { return d; });

            /*var colinput = cells.filter(function(d, i) { console.log(d); console.log(i);
                if (i == 1) return d; return null;  })*/
//var odds = cells.select(function(d, i) { return i & 1 ? this : null; });
            //console.log("colinput");
            //console.log(colinput);

            //console.log(odds);

            /*odds.selectAll("input")
                .data(function(d) { return d; })
                .enter()
                .append("input");*/

/*var td = d3.selectAll("tbody tr").selectAll("td");
td.style("color", function(d, i) { return i ? null : "red"; });
var odds = td.select(function(d, i) { return i ? null : this; });

            odds.selectAll("input")
                .data(function(d, i) { return d; })
                .enter()
                .append("input");*/

            //console.log(cells);

            // create a cell in each row for each column
            /*var cells = rows.selectAll("td")
                .data(function(row) {
                    return columns.map(function(column) {
                        console.log(column);
                        return {
                            column: column,
                            value: row[column]
                        };
                    });
                })
                .enter()
                .append("td")
                //.attr("style", "font-family: Courier") // sets the font style
                .html(function(d) { //console.log(d);
                    return d.value;
                });*/

                //console.log(cells);

            /*cells.append("td")
                .attr("style", "font-family: Courier") // sets the font style
                .html(function(d) { return d; });

            cells.append("td")
                .attr("style", "font-family: Courier") // sets the font style
                .attr("style", "font-size: 18px") // sets the font style
                .html(function(d) { return d; });*/

                /*cells.append("td")
                //.attr("style", "font-family: Courier") // sets the font style
                .html(function(d) { return d; });*/

            // add a column for each field description
            /*rows.append("td")
                .html(function(d) { return d; });*/

            /*rows.append("td")
                .append("input")
                    .attr("id", function(d, i) { return "input:" + i; });*/

            // add an input element for each field, using the inputtypes array to determine type
            /*rows.append("input")
                .style("font-size", function(d, i) { return fs[i]; })
                .attr("type", function(d, i) { return inputtypes[i]; })
                .attr("id", function(d, i) { return "input:" + i; })
                .attr("value", function(d, i) { return inputtexts[i]; });*/

            //d3.select("#input:3");
                //.style("font-size", "44px");

            //console.log(rows);

                //.on("click", john);

                //.on("click", function(d, i) { scopepreserver(d, i); });

                    /*d3.select(this)
                        //.style("font-size", "18px")
                        .attr("value", function() {
                            console.log("d="+d);
                            console.log("i="+i);
                            return inputtexts[i];});*/

                        /*.on("click", function(d) {console.log("d:"+d);
                            console.log("i=:"+i);return onclicks[i];})*/


            /*d3.select("#input:0")
                .attr("width", "220px");*/

            /*var cols = rows.selectAll("td")
                .data(fields)
                .enter()
                .append("td")
                .html(function(d) {return d;});*/

            /*var row = tbody.append("tr");

            row.append("td")
                .html("test");

            row.append("td")
                .append("input")
                .attr("type","button");

            row.append("td").html("test1");*/
        }

/*function scopepreserver(a, b) {
  return function () {
    //do something with a and b
console.log("yipee!");
  };
}*/

        function john(d, i) {
            console.log("john");
            var smith = d3.select(this);
            console.log(smith);
            console.log(d);
            console.log(i);
            //console.log(smith.value);

/*d3.selectAll('input').data(...)
.property('value', function (d) { return d.field; }) .on('change', function (d) { d.field = this.value; });*/
        };

        function test(sel) {
            console.log(sel);
            sel.html(function(d,i) {
                console.log("d:"+d);
                console.log("i:"+i);
            });
        }

        function displayForm(symbol) {
            var data = [11, 22, 33, 44];
            /*var labeldata = ["test1", "test2"];

            console.log("displayForm:" + symbol);

            var form = d3.select("body")
                .append("form");

            form.selectAll("label")
                .data(labeldata)
                .enter()
                .append("label")
                .text("test2");*/

            d3.select("body").selectAll("input")
                .data(data)
                .enter()
                .append('label')
                    .attr('for',function(d,i){ return 'a'+i; })
                    .text(function(d) { return d; })
                .append("input")
                    .attr("checked", true)
                    .attr("type", "checkbox")
                    .attr("id", function(d,i) { return 'a'+i; })
                    .attr("onClick", "change(this)");

        var sel = d3.select("body");//.append('form');

sel.append('form').call(function (sel) { sel.append('label'); sel.append('textarea'); sel.append('p').text("Detailed instructions..."); sel.append('label').call(function (sel) {
sel.append('input').attr('type', "checkbox");
sel.append('span').text("Some option"); });
});

            /*form.append("label")
                .text("test");

            form.append("input");

            form.append("label")
                .text("test2");

            form.append("input");*/
        }

        function change(sel) {
            console.log(sel);
        }

        //d3.select('button').on('click', function() {
     </script>
</body>
</html>