<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <title>TG-Online v0.9</title>
    <script src="http://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
    .axis path,
    .axis line {
        fill: none;
        /*stroke: grey;*/
        stroke: #ccc;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }
    .sb {
        color: steelblue;
    }
    .yl {
        color: yellow;
    }
    header {
        font-size: 24px;
        text-align: center;
        color: gray;
    }
    body {
        color: gray;
        /*font: 12px Arial;*/
        /*font: 12px sans-serif;*/
    }
    li:hover {
        background-color: #ccc;
    }
    a:link {
        font-size: 21px;
        text-decoration: underline;
        color: gray;
    }
    a:visited {
        text-decoration: none;
        color: darkgray;
    }
    a:hover {
        cursor: pointer;
        color: dimgray;
    }
    a:active {
        color: gray;
    }
    .x.axis path {
        /*stroke: blue;*/
        /*display: none;*/
    }
    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .divchart {
        width: 960px;
        margin-left: auto;
        margin-right: auto;
    }
    .node {
        cursor: pointer;
    }
    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .node text {
        font: 18px sans-serif;
    }
    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }
    .selcashorshares {
        background-color: #ddd;
        border-style: none;
        font-size: 21px;
        color: gray;
        outline: none;
    }
    .rfqqty {
        font-size: 21px;
        color: gray;
        border: solid 1px #c0c0c0;
    }
    .rfqqty:focus {
        border: solid 1px;
        outline: none;
    }
    .rfqbutton {
        font-size: 21px;
        color: gray;
        border-style: none;
        background-color: #ddd;
        outline: none;
    }
    .rfqbutton:hover {
        background-color: #ccc;
        cursor: pointer;
    }
    .rfqbutton:active {
        background: #bbb;
    }
    .quotebutton {
        font-size: 21px;
        background-color: #ddd;
        color: gray;
        border-style: none;        
    }
    .quotebutton:hover {
        background-color: #ccc;
        cursor: pointer;
    }
    .quotebuttonbuy {
        font-size: 21px;
        background-color: #ddd;
        color: blue;
        border-style: none;        
    }
    .quotebuttonbuy:hover {
        background-color: #ccc;
        cursor: pointer;
    }
    .quotebuttonsell {
        font-size: 21px;
        background-color: #ddd;
        color: red;
        border-style: none;        
    }
    .quotebuttonsell:hover {
        background-color: #ccc;
        cursor: pointer;
    }
    .quotebuttonsellexpired {
        font-size: 21px;
        background-color: white;
        color: red;
        border-style: none;        
    }
    .quotebuttonbuyexpired {
        font-size: 21px;
        background-color: white;
        color: blue;
        border-style: none;        
    }
    .tradebutton {
        font-size: 21px;
        border-style: none;
        cursor: pointer;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);        
    }
    .buybutton {
        background-color: blue;
        color: white;
    }
    .sellbutton {
        background-color: red;
        color: white;        
    }
    .stockboxtitle {
        /*font: courier;*/
        font-size: 21px;
        text-align: center;
        /*color: steelblue;*/
    }
    .stockboxdiv {
        width: 50%;
        /*float: left;*/
                     margin : 0 auto;

        /*position: relative;*/
        /*width: 50%;
        height: 50%;*/
        /*left: 50%;*/
        /*top: 33%;*/
        /*width: 300px;
        height: 100px;*/
        /*margin-top: -50px;
        margin-left: -150px;*/
    }
    .stockboxinput {
        display: block;
             margin : 0 auto;
             margin-top: 15px;
        /*position: relative;*/
        /*width: 300px;*/
        width: 30%;
        height: 27px;
        /*line-height: 27px;*/
        text-indent: 3px;
        /*font-family: courier, arial, sans-serif;*/
        font-size: 1em;
        color: gray;
        /*background: #fff;*/
        border: solid 1px #c0c0c0;
        /*border:solid 1px #d9d9d9;*/
        /*border-top:solid 1px #c0c0c0;*/
    }
    .stockboxinput:focus { 
        /*border: solid 1px steelblue;*/
        border: solid 1px;
        outline: none;
    }
    .stocklist {
        position: absolute;
        list-style-type: none;
        /*border: 1px solid gray;*/
        /*border: 1px solid steelblue;*/
        border: 1px solid;
        padding: 3px;
        background-color: white;
        /*margin: 0px;*/
        /*margin-left: auto;
        margin-right: auto;*/
        /*width: 300px;*/
        width: 30%;
        margin : 0 auto;
        left: 0;
        right: 0;
    }
    .tblprice {
        margin : 0 auto;
        margin-top: 15px;
        border-collapse: collapse;
        border-spacing: 0;
    }
    .tblprice tr td {
        text-align: center;
        background-color: yellow;
    }
    .yellowstrip {
        font-size: 36px;
    }
    .yellowstripsub {
        font-size: 18px;
    }
    .pad {
        padding-left: 25px;
        padding-right: 25px;
    }
    .tickup {
        color: blue;
    }
    .tickdn {
        color: red;
    }
    .ticknc {
        color: green;
    }
    .tbltradeconf {
        margin : 0 auto;
    }
    .signindiv {
        position: absolute;
        left: 50%;
        top: 33%;
        width: 400px;
        height: 200px;
        margin-top: -50px;
        margin-left: -150px;
    }
    .signininput {
        font-size: 15px;
        width: 100%;
        margin-bottom: 20px;
    }
    .signinbutton {
        background-color: lightgray;
        color: gray;
        font-size: 21px;
        border-style: none;
        cursor: pointer;
        /*border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);*/
    }
    .signintitle {
        /*font: courier;*/
        font-size: 36px;
        /*color: steelblue;*/
    }
    .divprice {
        margin : 0 auto;
        margin-top: 20px;
    }
    .divcontainer {
        width: 70%;
        margin : 0 auto;
    }
    .tblmenu {
        margin : 0 auto;
        margin-top: 10px;
    }
    .tblmenu tr td {
        text-align: center;
        padding: 10px;
    }
    .tblrfq {
        margin : 0 auto;
    }
    .tblrfq tr td {
        padding: 10px;
        font-size: 21px;
    }
    .tblquote {
        margin-top: 20px;
        margin : 0 auto;  
        font-size: 21px;
    }
    .tblquoterequest {
        margin : 0 auto;
        margin-top: 15px;        
        font-size: 21px;
    }
    .tblquoterequest tr td {
        margin-left: 30px;
    }
    .tblmyquote {
        margin : 0 auto;        
    }
    .tblquoteform {
        margin : 0 auto;        
        margin-top: 15px;
    }
    .divposition {
        margin-top: 21px;
        font-size: 21px;
        text-align: center;        
    }
    .tblposition {
        margin : 0 auto;        
    }
    .tblposition tr td {
        padding: 15px;
        text-align: center;
    }
    .tblpositionhdr {
        font-size: 15px;
        color: darkgray;
    }
    .tblaccountsummary {
        margin : 0 auto;        
        margin-top: 15px;
    }
    .tblaccountsummary tr td {
        padding: 15px;
        text-align: center;
        font-size: 21px;
    }
    .tblaccountsummaryhdr {
        color: darkgray;
    }
    .tbltrade {
        margin : 0 auto;
        margin-top: 15px;        
    }
    .tbltrade tr td {
        padding: 10px;
        text-align: center;
        white-space: nowrap;
    }
    .tbltradehdr {
        color: darkgray;
    }
    .divrfq {
        margin-top: 10px;
        text-align: center;
    }
    .divrfqhdr {
        margin-top: 20px;
    }
    .divquoterequest {
        margin-top: 20px;        
    }
    .myquoteinp {
        font-size: 21px;
    }
    </style>
</head>
<body lang="en">
    <script>
        var sockjs_url = '/echo';
        var sockjs;
        var ukx = [];
        var pricehist = [];
        var symbols = {};
        var pricedata = [];
        var quotes = [];
        var quoterequests = [];
        var quoteresponses = [];
        var myquotes = [];
        var positions = [];
        var trades = [];
        var accountsummary = [];
        var statement = [];
        var watchlist = [];
        var qbroker = "TGRANT";
        var email = "";
        var operatortype = 1; // client
        var clientid;
        var selectedsymbol = "";
        var MENURFQ = 0;
        var MENUWATCH = 1;
        var MENUPORTFOLIO = 2;
        var MENUACCOUNTSUMMARY = 3;
        var MENUSTATEMENT = 4;
        var MENUTRADES = 5;
        var MENUQUOTEREQUESTS = 6;
        var MENULOGOUT = 7;
        var selectedmenu = MENURFQ;

        var datain = function(msg) {
            console.log(msg);
            try {
                var obj = JSON.parse(msg);

                if ("price" in obj) {
                    priceReceived(obj.price);
                } else if ("prices" in obj) {
                    updateChart(obj.prices);
                } else if ("index" in obj) {
                    updateIndex(obj.index);
                    displayIndex(ukx);
                } else if ("quoteack" in obj) {
                    quoteackReceived(obj.quoteack);
                } else if ("quote" in obj) {
                    quoteReceived(obj.quote);
                /*} else if ("myquotes" in obj) {
                    myquotesReceived(obj.myquotes);*/
                } else if ("order" in obj) {
                    orderReceived(obj.order);
                } else if ("trades" in obj) {
                    tradesReceived(obj.trades);
                } else if ("trade" in obj) {
                    tradeReceived(obj.trade);
                } else if ("pricehistory" in obj) {
                    console.log(obj);
                    //updatePricehistory(obj.pricehistory);
                    pricehist = obj.pricehistory.prices;
                    createChart();
                } else if ("symbols" in obj) {
                    loadSymbols(obj.symbols);
                } else if ("quoterequest" in obj) {
                    quoterequestReceived(obj.quoterequest);
                } else if ("quoterequests" in obj) {
                    quoterequestsReceived(obj.quoterequests);
                } else if ("positions" in obj) {
                    positionsReceived(obj.positions);
                } else if ("position" in obj) {
                    positionReceived(obj.position);
                } else if ("signinreply" in obj) {
                    replySignin(obj.signinreply);
                } else if ("status" in obj) {
                    statusReceived(obj.status);
                } else if ("accountsummary" in obj) {
                    accountSummaryReceived(obj.accountsummary);                    
                } else if ("statement" in obj) {
                    statementReceived(obj.statement);
                } else if ("watchlist" in obj) {
                    watchlistReceived(obj.watchlist);
                } else if ("unwatchlist" in obj) {
                    unwatchlistReceived(obj.unwatchlist);
                }
            } catch(e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        var newconn = function() {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function()  {
                console.log("connection open");

                // we are ready
                displayFormSignin();
                //cheat();
            };

            sockjs.onmessage = function(e) {
                datain(e.data);
            };

            sockjs.onclose = function()  {
                console.log("connection closed");
                newconn();
             };

            sockjs.onheartbeat = function() {
            };
        };

        // get a connection
        newconn();

            // start with FTSE 100
            //requestIndex("UKX");
            //requestPricehistory("LLOY.L");
            //displayForm("LLOY.L");

        // things start here
        function start() {
            // request all instruments
            var instruments = {};
            instruments.symbolid = "*";

            // request all instruments
            sockjs.send("{\"symbolrequest\":" + JSON.stringify(instruments) + "}");

            // create our container div
            var divcontainer = d3.select("body").append("div")
                .attr("id", "divcontainer")
                .attr("class", "divcontainer");

            // add a header
            divcontainer.append("header")
                .attr("id", "stockboxtitle")
                .text("TG Online - " + email);

            // default menu selection
            selectedmenu = MENURFQ;

            // display main menu
            createMenu();

            // single symbol select
            selectSymbol();
        }

        //
        // request single position or all positions - symbol = ""
        //
        function requestPosition(symbolid) {
            var positionrequest = {};
            positionrequest.symbolid = symbolid;

            // request position
            sockjs.send("{\"positionrequest\":" + JSON.stringify(positionrequest) + "}");
        }

        function requestUnsubscribePositions() {
            var unsubscribepositionsrequest = {};

            // request position
            sockjs.send("{\"unsubscribepositionsrequest\":" + JSON.stringify(unsubscribepositionsrequest) + "}");            
        }

        function requestAccountSummary() {
            var accountsummrequest = {};

            // request account
            sockjs.send("{\"accountsummaryrequest\":" + JSON.stringify(accountsummrequest) + "}");
        }

        function cheat() {
            var signin = {};
            signin.email = "js@js.com";
            signin.password = "js@js.com";
            sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");
        }

        function loadSymbols(symbolarr) {
            console.log("loadSymbols");
            for (var i = 0; i < symbolarr.length; ++i) {
                symbols[symbolarr[i].symbolid] = symbolarr[i];
            }
        }

        function updatePricehistory(pricehist) {
            console.log("pricehist");
        }

        function updateIndex(index) {
            var rootnode = {};
            rootnode.name = "FTSE 100";
            rootnode.children = [];
            ukx.push(rootnode);

            for (var i = 0; i < index.symbols.length; ++i) {
                var node = {};
                node.name = index.symbols[i].shortname;
                node.parent = "FTSE 100";
                node.symbolid = index.symbols[i].symbolid;
                ukx[0].children.push(node);
            }
        }

        function initPrice() {
            pricedata = [];

            var p = {};
            p.bid = "0.00";
            p.ask = "0.00";
            p.bidtick = '';
            p.asktick = '';
            pricedata.push(p);

            var q = {};
            q.bid = "0.00";
            q.ask = "0.00";
            q.bidtick = '';
            q.asktick = '';
            pricedata.push(q);
        }

        function formatCurrency(num, dp) {
            num = num != num || num === '' || num === null ? 0.00 : num;
            return parseFloat(num).toFixed(dp).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatDate(utcdate) {
            var utcdateformat = d3.time.format("%Y%m%d");
            var dt = utcdateformat.parse(utcdate);

            var displaydateformat = d3.time.format("%e-%b-%Y");
            return displaydateformat(dt);
        }

        function formatDatetime(utcdatetime) {
            var utcdatetimeformat = d3.time.format("%Y%m%d-%H:%M:%S");
            var dt = utcdatetimeformat.parse(utcdatetime);

            var displaydatetimeformat = d3.time.format("%e-%b-%Y %H:%M:%S");
            return displaydatetimeformat(dt);
        }

        function priceReceived(price) {
            // only update price stuff for single symbol view
            if (selectedmenu == MENURFQ) {
                if (price.symbolid == selectedsymbol) {
                    // update price data
                    updatePriceData(price);

                    // update price display
                    updatePriceTable(price);
                }

                // update position data
                updatePositionData(price);
                updatePositionTable();
            } else if (selectedmenu == MENUWATCH) {
                updateWatchlist(price);
                updateWatchlistTable();
            } else if (selectedmenu == MENUPORTFOLIO) {
                // update position data
                updatePositionData(price);
                updatePositionTable();
            }
        }

        // update price array
        function updatePriceData(price) {
            if ("bid" in price) {
                if (price.bidchange > 0) {
                    pricedata[0].bidtick = '+';
                } else if (price.bidchange < 0) {
                    pricedata[0].bidtick = '-';
                } else {
                    pricedata[0].bidtick = '0';                    
                }

                pricedata[0].bid = price.bid;
            }

            if ("ask" in price) {
                if (price.askchange > 0) {
                    pricedata[0].asktick = '+';
                } else if (price.askchange < 0) {
                    pricedata[0].asktick = '-';
                } else {
                    pricedata[0].asktick = '0';                    
                }

                pricedata[0].ask = price.ask;
            }

            if ("midnetchg" in price) {
                pricedata[1].bid = price.midnetchg;
            }

            if ("midpctchg" in price) {
                pricedata[1].ask = price.midpctchg;
            }
        }

        function updatePriceTable(price) {
            var cols = ["bid", "-", "ask"];

            // create a price table if one does not exist
            var tblprice = d3.select("#tblprice");
            if (tblprice.empty()) {
                tblprice = createPriceTable(price, cols);
                createPriceMenu(price.symbolid);
            }

            // row data
            var tblpricerows = tblprice.select("tbody").selectAll("tr")
                .data(pricedata);

            // create rows
            tblpricerows.enter()
                .append("tr")
                .attr("class", function(d, i) {
                    if (i == 0) {
                        return "yellowstrip";
                    } else {
                        return "yellowstripsub";
                    }
                });

            // col data
            var cells = tblpricerows.selectAll("td")
                .data(function(row, i) {
                    return cols.map(function(column) {
                        var ret;
                        var col;

                        if (column == "bid") {
                            if (i == 0) {
                                col = column;
                                ret = {price: row[column], tick: pricedata[0].bidtick};
                            } else {
                                col = column;
                                ret = "change on day";
                            }
                        } else if (column == "ask") {
                            if (i == 0) {
                                col = column;
                                ret = {price: row[column], tick: pricedata[0].asktick};
                            } else {
                                col = column;
                                ret = pricedata[1].bid;
                                if (parseFloat(pricedata[1].bid) > 0) {
                                    ret += '↑';
                                } else if (parseFloat(pricedata[1].bid) < 0) {
                                    ret += '↓';
                                }
                                ret += ' (' + pricedata[1].ask + ')';
                            }
                        } else if (column == "-") {
                            if (i == 0) {
                                col = column;
                                ret = "-";
                            } else {
                                col = column;
                                ret = "";
                            }
                        }

                        return {column: col, value: ret};
                    });
                 });

            // update
            cells.each(function(d, i, j) {
                if (d.column == "bid" || d.column == "ask") {
                    if (j == 0) {
                        d3.select(this)
                            .text(function(d) { return formatCurrency(d.value.price, 2); })
                            .attr("class", function(d) {
                                if (d.value.tick == '+') {
                                    return "tickup pad";
                                } else if (d.value.tick == '-') {
                                    return "tickdn pad";
                                } else {
                                    return "ticknc pad";
                                }
                            });
                    } else {
                        d3.select(this)
                            .text(function(d) { return d.value; });                        
                    }
                }
            });

            // enter
            cells.enter()
                .append("td")
                .each(function(d, i, j) {
                    if (d.column == "bid" || d.column == "ask") {
                        if (j == 0) {
                            d3.select(this)
                                .text(function(d) { return formatCurrency(d.value.price, 2); })
                                .attr("class", "pad");
                        } else {
                            d3.select(this)
                                .text(function(d) { return d.value; });                            
                        }
                    } else {
                        d3.select(this)
                            .text(function(d) { return d.value; });
                    }
                });
        }

        function createPriceTable(price, cols) {
            var hdr = ["bid", "ask"];

            // create a price div
            var divprice = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divprice")
                .attr("class", "divprice");

            divprice.append("header")
                .text(symbols[price.symbolid].shortname + " - " + price.symbolid);

            // create a table
            var tblprice = divprice.append("table")
                .attr("id", "tblprice")
                .attr("class", "tblprice");

            // add header & body
            var thead = tblprice.append("thead");
            var tbody = tblprice.append("tbody");

            return tblprice;
        }

        function createMenu() {
            var data = [""];
            var cols = ["Request Quotes", "Watchlist", "Portfolio", "Account Summary", "Statement", "Trades", "Out of Hours", "Logout"];

            // create a table
            var tblmenu = d3.select("#divcontainer")
                .append("table")
                .attr("id", "tblmenu")
                .attr("class", "tblmenu");

            // add a body
            var tbody = tblmenu.append("tbody");

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return col;
                    });
                 })
                .enter()
                .append("td")
                    .append("a")
                        .attr("href", "#")
                        .attr("id", function(d) { return d == cols[0] ? "mnusinglesymbol" : null; })
                        .html(function (d) { return d; })
                        // add a style to treat first menu item as default
                        .style("color", function(d) { return d == cols[0] ? "gray" : null; })
                        .on("click", function(d, i) {
                            if (selectedmenu == MENUPORTFOLIO) {
                                // we have subscribed to positions, so need to unsubscribe
                                requestUnsubscribePositions();
                            } else if (selectedmenu == MENUWATCH) {
                                // need to unsubscribe from watchlist
                                requestUnwatchlist("");
                            }
                            selectedmenu = i;

                            // unsubscribe current symbol
                            if (selectedsymbol != "") {
                                requestUnsubscribeSymbol(selectedsymbol);
                                selectedsymbol = "";
                            }

                            clearData();
                            clearQuotes();
                            clearScreen();

                            // switch off styles
                            d3.select("#tblmenu").selectAll("a")
                                .style("color", "");

                            // highlight selected
                            d3.select(this)
                                .style("color", "gray");

                            if (d == cols[0]) {
                                selectSymbol();
                            } else if (d == cols[1]) {
                                requestWatchlist();
                            } else if (d == cols[2]) {
                                requestPosition("*");
                            } else if (d == cols[3]) {
                                requestAccountSummary();
                            } else if (d == cols[4]) {
                                requestStatement();
                            } else if (d == cols[5]) {
                                requestTrades();
                            } else if (d == cols[6]) {
                                requestOpenQuoteRequests("");
                            } else if (d == cols[7]) {
                                logout();
                            }
                        });
        }

        function createPriceMenu(symbolid) {
            var data = [""];
            var cols = ["Request A Quote"];

            // create a table
            var tblmenu = d3.select("#divcontainer")
                .append("table")
                .attr("id", "tblmenuprice")
                .attr("class", "tblmenu");

            // add a body
            var tbody = tblmenu.append("tbody");

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return col;
                    });
                 })
                .enter()
                .append("td")
                    .append("a")
                        .attr("href", "#")
                        .html(function (d) { return d; })
                        .on("click", function(d) {
                            clearQuotes();

                            // & clear any previous request & trade
                            d3.select("#divrfq").remove();

                            requestQuote(symbolid, "");
                        });            
        }

        function clearScreen() {
            d3.select("#divposition").remove();
            d3.select("#divrfq").remove();
            d3.select("#divquote").remove();
            d3.select("#divquoterequest").remove();
            d3.select("#divprice").remove();
            d3.select("#tblmenuprice").remove();
            d3.select("#stockboxdiv").remove();
            d3.select("#tbltrade").remove();
            d3.select("#tblaccountsummary").remove();
            d3.select("#tblstatement").remove();
            d3.select("#tblwatchlist").remove();
        }

        function clearData() {
            // reset price
            initPrice();

            // clear positions
            positions = [];
        }

        function clearQuotes() {
            // clear any timers
            for (var i = 0; i < quotes.length; i++) {
                if ('bidquote' in quotes[i]) {
                    clearInterval(quotes[i].bidquote.interval);
                }
                if ('offerquote' in quotes[i]) {
                    clearInterval(quotes[i].offerquote.interval);
                }
            }

            quotes = [];
        }

        function logout() {
            sockjs.close();

            d3.select("#divcontainer").remove();
        }

        function singleSymbol(symbolid) {
            selectedmenu = MENURFQ;
            selectedsymbol = symbolid;
            clearData();
            clearScreen();
            selectSymbol();
            requestSubscribeSymbol(symbolid);
            requestPosition(symbolid);

            // switch off styles
            d3.select("#tblmenu").selectAll("a")
                .style("color", "");

            // highlight selected
            d3.select("#mnusinglesymbol")
                .style("color", "gray");
        }

        function tradesReceived(tradearr) {
            // clear global array
            trades = [];

            for (var i = 0; i < tradearr.length; i++) {
                // add quote request to global array
                trades.push(tradearr[i]);
            }

            // update display
            updateTradeTable();
        }

        function updateTradeTable() {
            var cols = ["timestamp","symbolid","tradeid","orderid","side","quantity","price","currencyid","commission","ptmlevy","stampduty","contractcharge","externaltradeid"];

            // create a trade table if one does not exist
            var tbltrade = d3.select("#tbltrade");
            if (tbltrade.empty()) {
                tbltrade = createTradeTable(cols);
            }

            // base the table on the trades array
            var rows = tbltrade.select("tbody").selectAll("tr")
                .data(trades);

            // enter
            rows.enter()
                .append("tr");

            // columns data
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 });

            // columns enter
            cells.enter()
                .append("td");

            // columns enter & update
            cells.each(function(d) {
                if (d.col == "symbolid") {
                    var lnk = d3.select(this).select("a");
                    if (lnk.empty()) {
                        // add a link for this symbol
                        lnk = d3.select(this)
                            .append("a")
                                .attr("href", "#")
                                .on("click", function(d) {
                                    singleSymbol(d.value);
                                });

                    }
                    lnk.html(function(d) { return d.value; });
                } else {
                    d3.select(this)
                        .text(function(d) {
                            if (d.col == "timestamp") {
                                return formatDatetime(d.value);
                            } else if (d.col == "side") {
                                if (d.value == "1") {
                                    return "buy";
                                } else {
                                    return "sell";
                                }
                            } else {
                                return d.value;
                            }
                        });
                }
            });
        }

        function createTradeTable(cols) {
            // using full screen width
            var tbltrade = d3.select("body")
                .append("table")
                .attr("id", "tbltrade")
                .attr("class", "tbltrade");

            // add header & body
            var thead = tbltrade.append("thead");
            var tbody = tbltrade.append("tbody");

            // add the column headings
            thead.selectAll("th")
                .data(cols)
                .enter()
                .append("th")
                    .attr("class", "tbltradehdr")
                    .text(function(d) { return d; });

            return tbltrade;
        }

        function requestSubscribeSymbol(symbolid) {
            var symbol = {}
            symbol.symbolid = symbolid;

            sockjs.send("{\"subscribepricerequest\":" + JSON.stringify(symbol) + "}");
        }

        function requestUnsubscribeSymbol(symbolid) {
            var symbol = {}
            symbol.symbolid = symbolid;

            sockjs.send("{\"unsubscribepricerequest\":" + JSON.stringify(symbol) + "}");
        }

        function requestIndex(index) {
            sockjs.send("{\"index\":" + JSON.stringify(index) + "}");
        }

        // assumes today
        function requestPricehistory(symbolid) {
            var pricehistoryrequest = {};

            var today = new Date();
            var startofday = new Date();

            startofday.setHours(08);
            startofday.setMinutes(00);
            startofday.setSeconds(00);

            console.log(startofday.getTime());
            console.log(today.getTime());

            pricehistoryrequest.symbolid = symbolid;
            pricehistoryrequest.startperiod = startofday.getTime();
            pricehistoryrequest.endperiod = today.getTime();

            sockjs.send("{\"pricehistoryrequest\":" + JSON.stringify(pricehistoryrequest) + "}");
        }

        // display a tree
        function displayIndex(treedata) {
            var margin = {top: 20, right: 120, bottom: 20, left: 120},
                width = 960 - margin.right - margin.left,
                height = 1200 - margin.top - margin.bottom;
    
            var i = 0;
            var duration = 750;

            var tree = d3.layout.tree()
                .size([height, width]);

            var diagonal = d3.svg.diagonal()
                .projection(function(d) { return [d.y, d.x]; });

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var root = treedata[0];
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            root.children.forEach(collapse);
            update(root);

            d3.select(self.frameElement).style("height", "700px");

            function update(source) {
                // Compute the new tree layout.
                var nodes = tree.nodes(root).reverse(),
                    links = tree.links(nodes);

                // Normalize for fixed-depth.
                nodes.forEach(function(d) { d.y = d.depth * 48; });

                // Update the nodes…
                var node = svg.selectAll("g.node")
                    .data(nodes, function(d) { return d.id || (d.id = ++i); });

                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                    .on("click", click);

                nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeEnter.append("text")
                    .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
                    .text(function(d) { return d.name; })
                    .style("fill-opacity", 1e-6);

                // Transition nodes to their new position.
                var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

                nodeUpdate.select("circle")
                    .attr("r", 4.5)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeUpdate.select("text")
                    .style("fill-opacity", 1);

                // Transition exiting nodes to the parent's new position.
                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                    .remove();

                nodeExit.select("circle")
                    .attr("r", 1e-6);

                nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

                // Update the links…
                var link = svg.selectAll("path.link")
                    .data(links, function(d) { return d.target.id; });

                // Enter any new links at the parent's previous position.
                link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function(d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

                // Transition links to their new position.
                link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link.exit().transition()
                    .duration(duration)
                    .attr("d", function(d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

                // Stash the old positions for transition.
                nodes.forEach(function(d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            // Toggle children on click.
            function click(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;

                    requestPricehistory(d.symbolid);
                }

                update(d);
            }
        }

        // chart an array of prices
        function createChart() {
            console.log("createChartBaby");
            /*for (var i = 0; i < pricehist.length; i++) {
                console.log(pricehist[i].mid);
            }*/

            // set margin around graph & set width & height of graph canvas to reflect this
            var margin = {top: 50, right: 20, bottom: 30, left: 50},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            // function for recognising datetime values
            parseDate = d3.format();

            // make sure range pixel values fit the x-axis & state that we are using datetime values
            x = d3.time.scale()
                .range([0, width]);

            // make sure range of pixel values fit the y-axis
            y = d3.scale.linear()
                .range([height, 0]);

            // set-up the x-axis
            xaxis = d3.svg.axis().scale(x)
                .orient("bottom").ticks(6);

             // set-up the y-axis
            yaxis = d3.svg.axis().scale(y)
                .orient("left").ticks(6);

            // convert data to work for graph coordinates
            line = d3.svg.line()
                .x(function(d) { return x(d.timestamp); })
                .y(function(d) { return y(d.mid); });

            // create our div
            var divchart = d3.select("body")
                .attr("class", "divchart")
                .append("div");

            var button = divchart.append("button")
                .on('click', function(d,i) {
                    //updateChart();
                    return;
                    // scale the range of the data again
                    x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
                    y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
                    //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

                    var svg = d3.select("body").transition();

                    // change the line
                    svg.select(".line")
                        //.datum(pricehist)
                        .attr("d", line(pricehist));

                    // change the x-axis
                    svg.select(".x.axis")
                        .call(xaxis);

                    // change the y-axis
                    svg.select(".y.axis")
                        .call(yaxis);

                        console.log("updated, i think");
                });

            // add an svg canvas
            var svg = divchart.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // convert data to something usable
            pricehist.forEach(function(d) {
                var dt = new Date(+d.timestamp);
                d.timestamp = parseDate(dt);
                d.mid = +d.mid;
            });

            // set the scope of data values for both axes
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
            //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

            // add the x-axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xaxis);

            // add the y-axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yaxis);

            // add the line
            svg.append("path")
                .datum(pricehist)
                .attr("class", "line")
                .attr("d", line);

            // title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("id", "textid")
                .attr("text-anchor", "middle")
                .style("font-size", "26px")
                .style("fill", "grey")
                .text("Lloyds - ")
                .append("tspan")
                    .attr("id", "bid")
                    .html("23.10")
                    .style("fill", "red")
                    .style("font-size", "33px")
                    //.text("23.10")
                .append("tspan")
                    .html(" / ")
                    .style("fill", "grey")
                    //.text(" / ")
                .append("tspan")
                    .attr("id", "ask")
                    .html(" 23.25")
                    .style("fill", "blue");
                    //.text(" 23.25");
        }

        function updateChart(prices) {
            console.log("updateChartBaby");
            console.log(prices);

            /*for (var i = 0; i < prices.length; i++) {
                var d = {};
                var dt = new Date(+prices[i].timestamp);

                if ("bid" in prices) {
                    d.bid = prices[i].bid;
                } else {
                    d.bid = prices[i].ask;
                }

                d.timestamp = parseDate(dt);
                d.bid = +d.bid;

                pricehist.push(d);
            }*/

            //var svg = d3.select("body").transition();

            /*svg.select("#textid")
                .text("Lloyds - " + prices[0].bid + " / " + prices[0].ask);*/

            for (var i = 0; i < prices.length; i++) {
                if ("bid" in prices[i]) {
                    d3.select("tspan")
                        .html(prices[i].bid);
                        console.log("updating bid");
                } else {
                    d3.select("#ask")
                        .html(prices[i].ask);
                        console.log("updating ask");
                }
            }

/*
            // re-scale the range of the data again
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));

            var svg = d3.select("body").transition();

            // update the line
            svg.select(".line")
                //.datum(pricehist)
                .attr("d", line(pricehist));

            // reset the x-axis
            svg.select(".x.axis")
                .call(xaxis);

            // reset the y-axis
            svg.select(".y.axis")
                .call(yaxis);
*/
            //console.log(line);
        }

        function requestQuote(symbolid, quantity) {
            var fields = ["Quantity"]; // one per row

            var cashorshares = ["Number of shares", "Cash amount"];
            var qtycashorshares = ["Quantity", "Cash"];

            // create a div
            var divrfq = createDiv("divrfq", "divrfq");

            // add a table
            var tblrfq = divrfq.append("table")
                .attr("id", "tblrfq")
                .attr("class", "tblrfq");

            // add header & body
            var thead = tblrfq.append("thead");
            var tbody = tblrfq.append("tbody");

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(fields)
                .enter()
                .append("tr");

            // option to select cash or shares
            var selcashorshares = rows.append("td")
                .append("select")
                    .attr("id", "selcashorshares")
                    .attr("class", "selcashorshares")
                    .on("change", function() {
                        var rfqqty = d3.select("#rfqqty");
                        if (this.value == cashorshares[0]) {
                            rfqqty.attr("placeholder", qtycashorshares[0]);
                        } else {
                            rfqqty.attr("placeholder", qtycashorshares[1]);
                        }
                        d3.select("#rfqqty").node().focus();
                    });

            selcashorshares.append("option")
                .text(cashorshares[0]);

            selcashorshares.append("option")
                .text(cashorshares[1]);

            // quantity
            rows.append("td")
                .append("input")
                    .attr("id", "rfqqty")
                    .attr("class", "rfqqty")
                    .attr("value", quantity)
                    .attr("placeholder", qtycashorshares[0])
                    .on("keydown", function() {
                        if (d3.event.keyCode == 13) {
                            rfq();
                        }
                    });

            // add a button, with associated function to send rfq
            rows.append("td")
                .attr("id", "tdrfq")
                .append("input")
                    .attr("type", "button")
                    .attr("value", "Send Quote Request")
                    .attr("class", "rfqbutton")
                    .on("click", function() {
                        if (!validateRfq()) {
                            d3.select("#rfqqty").node().focus();
                        } else {
                            rfq();
                        }
                    });

            d3.select("#rfqqty").node().focus();

            function validateRfq() {
                var quantity = d3.select("#rfqqty").node().value;

                // validate qty
                if (quantity == "") {
                    alert("Please enter a quantity");
                    return false;
                } else if (isNaN(quantity)) {
                    alert("Quantity must be numeric");
                    return false;
                } else if (quantity <= 0) {
                    alert("Quantity must be greater than zero");
                    return false;
                }

                return true
            }

            function rfq() {
                // quantity as cash or shares
                var selcashorshares = d3.select("#selcashorshares");
                var qty;
                var cashorderqty;

                if (selcashorshares.node().value == cashorshares[0]) {
                    cashorderqty = "";
                    qty = d3.select("#rfqqty").node().value;
                } else {
                    cashorderqty = d3.select("#rfqqty").node().value;
                    qty = "";                    
                }

                var nosettdays = symbols[symbolid].instrumenttypeid == "CFD" ? "" : ""; // todo: cfd=10?

                sendRfq(qty, cashorderqty, symbolid, "", "GBP", nosettdays, ""); // todo: currency

                // remove button
                d3.select(this).remove();

                // add text
                d3.select("#tdrfq")
                    .text("Quote Request Sent");
            }
        }

        function createDiv(id, cl) {
            var div = d3.select("#" + id);
            if (div.empty()) {
                div = d3.select("#divcontainer")
                    .append("div")
                    .attr("id", id)
                    .attr("class", cl);
            }

            return div;
        }

        function sendRfq(quantity, cashorderqty, symbolid, side, currencyid, nosettdays, futsettdate) {
            var rfq = {};

            //rfq.clientid = clientid;
            rfq.symbolid = symbolid;
            rfq.quantity = quantity;
            rfq.cashorderqty = cashorderqty;
            rfq.side = side;
            rfq.currencyid = currencyid;
            rfq.settlcurrencyid = currencyid;
            rfq.nosettdays = nosettdays;
            rfq.futsettdate = futsettdate;
            //rfq.operatortype = operatortype;
            //rfq.operatorid = clientid;

            sockjs.send("{\"quoterequest\":" + JSON.stringify(rfq) + "}");
        }

        /*function sendCloseRfq(quotereqid) {
            console.log("sendCloseRfq");
            console.log(quotereqid);

            var rfqclose = {};
            rfqclose.quotereqid = quotereqid;

            sockjs.send("{\"quoterequestclose\":" + JSON.stringify(rfqclose) + "}");
        }*/

        function displayForm(symbolid) {
            var data = [11, 22, 33, 44];
            /*var labeldata = ["test1", "test2"];

            console.log("displayForm:" + symbolid);

            var form = d3.select("body")
                .append("form");

            form.selectAll("label")
                .data(labeldata)
                .enter()
                .append("label")
                .text("test2");*/

            d3.select("body").selectAll("input")
                .data(data)
                .enter()
                .append('label')
                    .attr('for',function(d,i){ return 'a'+i; })
                    .text(function(d) { return d; })
                .append("input")
                    .attr("checked", true)
                    .attr("type", "checkbox")
                    .attr("id", function(d,i) { return 'a'+i; })
                    .attr("onClick", "change(this)");

        }

        function displayTable(data) {
            console.log("displayTable");

            var columns = ["key", "value"];

            // create a table
            var table = d3.select("body")
                .append("table");
                //.attr("style", "margin-left: 250px");

            // add header & body
            var thead = table.append("thead");
            var tbody = table.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                    .text(function(column) { return column; });

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return columns.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d) { console.log(d); return d.value; });

            return tbody;
        }

        function sendOrder(symbolid, side, quantity, price, ordertype, delivertocompid, settlcurrencyid, nosettdays, settdate, quoteid, timeinforce, expiredate, expiretime) {
            var order = {};

            order.clientid = clientid;
            order.side = side;
            order.symbolid = symbolid;
            order.quantity = quantity;
            order.price = price;
            order.currencyid = "GBP"; // todo - use quote currency? symbols[symbolid].currency;
            order.ordertype = ordertype;
            order.delivertocompid = delivertocompid;
            order.settlcurrencyid = settlcurrencyid;
            order.nosettdays = nosettdays;
            order.futsettdate = settdate;
            order.quoteid = quoteid;
            order.timeinforce = timeinforce;
            order.expiredate = expiredate;
            order.expiretime = expiretime;
            order.operatortype = operatortype;
            order.operatorid = clientid;

            sockjs.send("{\"order\":" + JSON.stringify(order) + "}");
        }

        function orderReceived(order) {
            if (order.status == "8") {
                var msg = "Order rejected";

                if ("reason" in order) {
                    msg += ", reason: " + getOrderReasonDesc(order.reason);
                }

                if ("text" in order && order.text != "") {
                    msg += " - " + order.text;
                }

                d3.select("#divrfq")
                    .append("p")
                    .html(msg);
            }
        }

        function tradeReceived(trade) {
            var inquotes = false;

            // add to trades, if that is what we are looking at
            if (selectedmenu == MENUTRADES) {
                trades.unshift(trade); // add to start of array
                updateTradeTable();
                return;
            }

            // indicate the quote has been traded
            // quote may be in rfq quotes
            for (var i = 0; i < quotes.length; i++) {
                if (trade.side == "1") {
                    if (trade.quoteid == quotes[i].offerquote.quoteid) {
                        quotes[i].offerquote.tradeid = trade.tradeid;

                        // update display
                        updateQuoteTable();

                        // clear timer
                        clearInterval(quotes[i].interval);

                        tradeConfirm(trade);

                        inquotes = true;
                        break;
                    }
                } else {
                    if (trade.quoteid == quotes[i].bidquote.quoteid) {
                        quotes[i].bidquote.tradeid = trade.tradeid;

                        // update display
                        updateQuoteTable();

                        tradeConfirm(trade);

                        // clear timer
                        clearInterval(quotes[i].interval);

                        inquotes = true;
                        break;
                    }
                }
            }

            // or quote may be in myquotes, responding to an rfq
            if (!inquotes) {
                for (var i = 0; i < myquotes.length; i++) {
                    if (trade.quoteid == myquotes[i][0].quoteid) {
                        myquotes[i][0].tradeid = trade.tradeid;

                        // update display
                        updateMyQuoteForm(i);

                        // clear timer
                        clearInterval(myquotes[i][0].interval);
                        break;
                    }
                }
            }
        }

        function tradeConfirm(trade) {
            var tradeconf = [];

            tradeconf.push({"key":"side", "value": trade.side == 1 ? "Buy" : "Sell"});
            tradeconf.push({"key":"quantity", "value": trade.quantity});
            tradeconf.push({"key":"price", "value": trade.price});
            tradeconf.push({"key":"consideration", "value": trade.settlcurramt});
            tradeconf.push({"key":"currency", "value": trade.currencyid});
            tradeconf.push({"key":"commission", "value": trade.commission});
            tradeconf.push({"key":"ptmlevy", "value": trade.ptmlevy});
            tradeconf.push({"key":"stampduty", "value": trade.stampduty});
            tradeconf.push({"key":"contractcharge", "value": trade.contractcharge});
            tradeconf.push({"key":"futsettdate", "value": formatDate(trade.futsettdate)});
            tradeconf.push({"key":"timestamp", "value": formatDatetime(trade.timestamp)});
            tradeconf.push({"key":"tradeid", "value": trade.tradeid});

            updateTradeConfirmTable(tradeconf);
        }

        function updateTradeConfirmTable(tradeconf) {
            var cols = ["key", "value"];

            var tbltradeconf = d3.select("#tbltradeconf");
            if (tbltradeconf.empty()) {
                tbltradeconf = createTradeConfirmTable();
            }

            var rows = tbltradeconf.select("tbody").selectAll("tr")
                .data(tradeconf);

            rows.enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d) { return d.value; });
        }

        function createTradeConfirmTable() {
            var tbltradeconf = d3.select("#divrfq")
                .append("table")
                .attr("id", "tbltradeconf")
                .attr("class", "tbltradeconf");

            tbltradeconf.append("caption")
                .attr("class", "divrfqhdr")
                .text("Trade Confirmation");

            // add body
            var tbody = tbltradeconf.append("tbody");

            return tbltradeconf;
        }

        function requestWatchlist() {
            watchlist = [];
            watchlistRequest("");
            selectSymbol();
        }

        function requestUnwatchlist(symbolid) {
            var uwl = {};

            if (symbolid != "") {
                uwl.symbolid = symbolid;
            }

            sockjs.send("{\"unwatchlistrequest\":" + JSON.stringify(uwl) + "}");            
        }

        function watchlistRequest(symbolid) {
            var wl = {};

            if (symbolid != "") {
                if (inWatchlist(symbolid)) {
                    alert("Symbol: " + symbolid + " is already in your watchlist");
                    return;
                }
                wl.symbolid = symbolid;
            }

            sockjs.send("{\"watchlistrequest\":" + JSON.stringify(wl) + "}");
        }

        function watchlistReceived(watchlistarr) {
            for (var i = 0; i < watchlistarr.length; ++i) {
                if (!(inWatchlist(watchlistarr[i].symbolid))) {
                    watchlistarr[i].remove = "x";
                    watchlistarr[i].bidtick = '';
                    watchlistarr[i].asktick = '';
                    watchlistarr[i].midnetchg = '';
                    watchlistarr[i].midpctchg = '';

                    watchlist.push(watchlistarr[i]);
                }
            }

            updateWatchlistTable();
        }

        function unwatchlistReceived(symbolid) {
            for (var i = 0; i < watchlist.length; ++i) {
                if (symbolid == watchlist[i].symbolid) {
                    watchlist.splice(i, 1);
                    break;
                }
            }

            updateWatchlistTable();   
        }

        function inWatchlist(symbolid) {
            for (i = 0; i < watchlist.length; i++) {
                if (symbolid == watchlist[i].symbolid) {
                    return true;
                }
            }
            return false;
        }

        function updateWatchlist(price) {
            for (var i = 0; i < watchlist.length; ++i) {
                if (price.symbolid == watchlist[i].symbolid) {
                    if ("bid" in price) {
                        if (price.bidchange > 0) {
                           watchlist[i].bidtick = '+';
                        } else if (price.bidchange < 0) {
                            watchlist[i].bidtick = '-';
                        } else {
                            watchlist[i].bidtick = '0';
                        }

                        watchlist[i].bid = price.bid;
                    }

                    if ("ask" in price) {
                        if (price.askchange > 0) {
                           watchlist[i].asktick = '+';
                        } else if (price.askchange < 0) {
                            watchlist[i].asktick = '-';
                        } else {
                            watchlist[i].asktick = '0';
                        }

                        watchlist[i].ask = price.ask;
                    }

                    if ("midnetchg" in price) {
                        watchlist[i].midnetchg = price.midnetchg;
                    }

                    if ("midpctchg" in price) {
                        watchlist[i].midpctchg = price.midpctchg;
                    }

                    break;
                }
            }            
        }

        function updateWatchlistTable() {
            var cols = ["symbolid", "bid", "ask", "midnetchg", "midpctchg", "remove"];

            var tblwatchlist = d3.select("#tblwatchlist");
            if (tblwatchlist.empty()) {
                tblwatchlist = createWatchlistTable(cols);
            }

            // base the table on the watchlist array
            var rows = tblwatchlist.select("tbody").selectAll("tr")
                .data(watchlist);

            rows.enter()
                .append("tr");

            rows.exit().remove();

            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 });

            cells.enter()
                .append("td")
                .each(function(d, i, j) {
                    if (d.col == "symbolid") {
                        // display a link for this symbol
                        d3.select(this)
                            .append("a")
                                .attr("href", "#")
                                .on("click", function(d) {
                                    requestUnwatchlist("");
                                    singleSymbol(d.value);
                                });
                    } else if (d.col == "remove") {
                        // display a link for this symbol
                        d3.select(this)
                            .append("a")
                                .attr("href", "#")
                                .text(function (d) { return d.value; })
                                .on("click", function(d) {
                                    requestUnwatchlist(watchlist[j].symbolid);
                                });
                    }
                });

            cells.each(function(d) {
                if (d.col == "symbolid") {
                    // update text for link as symbol may have changed
                    d3.select(this).select("a")
                        .text(function (d) { return d.value; });
                } else if (d.col == "remove") {
                } else {
                    d3.select(this)
                        .text(function(d) { return formatCurrency(d.value, 2); })
                        .attr("class", function(d, i, j) {
                            if (d.col == "bid") {
                                if (watchlist[j].bidtick == '+') {
                                    return "tickup";
                                } else if (watchlist[j].bidtick == '-') {
                                    return "tickdn";
                                } else if (watchlist[j].bidtick == '0') {
                                    return "ticknc";
                                }
                            } else if (d.col == "ask") {
                                if (watchlist[j].asktick == '+') {
                                    return "tickup";
                                } else if (watchlist[j].asktick == '-') {
                                    return "tickdn";
                                } else if (watchlist[j].asktick == '0') {
                                    return "ticknc";
                                }
                            } else if (d.col == "midnetchg" || d.col == "midpctchg") {
                                if (parseFloat(d.value) > 0) {
                                    return "tickup";
                                } else if (parseFloat(d.value) < 0) {
                                    return "tickdn";
                                } else {
                                    return "ticknc";
                                }
                            }

                            return null;
                        });
                }
            });
        }

        function createWatchlistTable(cols) {
            var tblwatchlist = d3.select("#divcontainer")
                .append("table")
                .attr("id", "tblwatchlist")
                .attr("class", "tblaccountsummary");

            // add header & body
            var thead = tblwatchlist.append("thead");
            var tbody = tblwatchlist.append("tbody");

            // add the column headings
            thead.selectAll("th")
                .data(cols)
                .enter()
                .append("th")
                    .attr("class", "tblaccountsummaryhdr")
                    .text(function(d) {
                        if (d == "midnetchg") {
                            return "change";
                        } else if (d == "midpctchg") {
                            return "change (%)";
                        }
                        return d;
                    });

            return tblwatchlist;
        }

        function selectSymbol() {
            var symboldata = [];

            var stockboxdiv = d3.select("#divcontainer")
                .append("div")
                .attr("id", "stockboxdiv")
                .attr("class", "stockboxdiv")
                .on("click", function () {
                    if (d3.event.target.id == "stockboxdiv") {
                        buildList("");
                        displayList();
                    }
                });

            var stockboxinput = stockboxdiv
                .append("input")
                .attr("id", "stockboxinput")
                .attr("class", "stockboxinput")
                .attr("placeholder", "Enter Symbol")
                .on("keyup", function() {
                    buildList(this.value);
                    displayList();
                });

            stockboxinput.node().focus();      

            function buildList(searchtext) {
                // clear array
                symboldata = [];

                if (searchtext == "") return;

                // lower case to match on
                searchtext = searchtext.toLowerCase();
                var searchtextlen = searchtext.length;

                // match with instruments
                for (var i in symbols) {
                    if (symbols[i].shortname.toLowerCase().substr(0, searchtextlen) == searchtext) {
                        var elem = {};
                        elem.name = symbols[i].shortname + " - " + symbols[i].symbolid;
                        symboldata.push(elem);
                    }
                }
            }

            function displayList() {
                var stocklist = d3.select("#stocklist");

                if (symboldata.length == 0) {
                    // clear the list if no data
                    if (!stocklist.empty()) {
                        stocklist.remove();

                        // remove listener
                        d3.select("#stockboxdiv")
                            .on('click', null);
                    }
                } else {
                    // create the list if necessary
                    if (stocklist.empty()) {
                        stocklist = d3.select("#stockboxdiv").append("ul")
                            .attr("id", "stocklist")
                            .attr("class", "stocklist");
                    }
                }

                // update
                var stockitems = stocklist.selectAll("li")
                    .data(symboldata)
                        .text(function(d) { return d.name; });

                // enter
                stockitems.enter()
                    .append("li")
                        .text(function(d) { return d.name; })
                        .on("click", function(d, i) {
                            var lastspace = this.innerHTML.lastIndexOf(' ');

                            if (selectedmenu == MENURFQ) {
                                // unsubscribe current symbol
                                if (selectedsymbol != "") {
                                    requestUnsubscribeSymbol(selectedsymbol);
                                }

                                selectedsymbol = this.innerHTML.substr(lastspace+1);

                                clearData();
                                clearQuotes();

                                // clear price display in case of a previously selected symbol
                                d3.select("#divprice").remove();
                                d3.select("#tblmenuprice").remove();
                                d3.select("#divrfq").remove();

                                // subscribe to a symbol
                                requestSubscribeSymbol(selectedsymbol);
                                requestPosition(selectedsymbol);
                            } else {
                                watchlistRequest(this.innerHTML.substr(lastspace+1));
                            }

                            // clear array
                            symboldata = [];

                            // clear display
                            displayList();
                        });

                // exit
                stockitems.exit().remove();
            }
        }

        function countdownQuote(quote) {
            quote.noseconds--;

            if (quote.noseconds == 0) {
                clearInterval(quote.interval);
            }
        }

        function quoteReceived(quote) {
            // see if it is my quote
            if (quote.qclientid == clientid) {
                // start a timer
                quote.interval = startMyQuoteInterval(quote);

                // update the quote
                updateMyQuote(quote);

                // update the display
                updateMyQuoteForm(quote.quotereqid);
            } else {
                // start a timer
                quote.interval = startQuoteInterval(quote);

                // update quote array
                updateQuoteLadder(quote);

                // update display
                updateQuoteTable();
            }
        }

        //
        // update a ladder of quotes & start a timer for each quote
        //
        function updateQuoteLadder(quote) {
            // we create either a bid or offer quote for a quote level
            var updated = false;

            // button colours
            if (quote.bidpx != "") {
                quote.bkcolor = d3.rgb(255, 0, 0);
            } else {
                quote.bkcolor = d3.rgb(0, 0, 255);
            }
            quote.color = d3.rgb(255, 255, 255);                

            // see if we can add the quote to an existing quote level
            for (var i = 0; i < quotes.length; i++) {
                if (quote.bidpx != "") {
                    if (!('bidquote' in quotes[i])) {
                        quotes[i].bidquote = quote;
                        updated = true;
                        break;
                    }
                } else {
                    if (!('offerquote' in quotes[i])) {
                        quotes[i].offerquote = quote;
                        updated = true;
                        break;
                    }           
                }
            }

            // if not, create a new level
            if (!updated) {
                quotes.push([]);

                if (quote.bidpx != "") {
                    quotes[quotes.length - 1].bidquote = quote;
                } else {
                    quotes[quotes.length - 1].offerquote = quote;
                }
            }
        }

        function updateQuoteTable() {
            var cols = ["bidquote", "offerquote"];

            // create a quote table if one does not exist
            var tblquote = d3.select("#tblquote");
            if (tblquote.empty()) {
                tblquote = createQuoteTable();
            }

            // base the table on the quotes array
            var rows = tblquote.select("tbody").selectAll("tr")
                .data(quotes);

            // create a new row for each quote level (may be bid/offer/both)
            rows.enter()
                .append("tr");

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    if (cols[0] in row) {
                        if (cols[1] in row) {
                            return [{col: cols[0], value: row[cols[0]]},{col: cols[1], value: row[cols[1]]}];
                        } else {
                            return [{col: cols[0], value: row[cols[0]]}];
                        }
                    } else {
                        return [{col: cols[1], value: row[cols[1]]}];
                    }
                 });

            // enter
            cells.enter()
                .append("td")
                .append("input")
                    .attr("type", "button")
                    .on("click", function(d, i, j) { // d=data, i=col, j=row
                        if (d.col == "bidquote") {
                            // we are selling
                            sendOrder(d.value.symbolid, 2, d.value.bidquantity, d.value.bidpx, 'D', "", d.value.settlcurrencyid, d.value.nosettdays, d.value.futsettdate, d.value.quoteid, "4", "", "");
                        } else {
                            // we are buying
                            sendOrder(d.value.symbolid, 1, d.value.offerquantity, d.value.offerpx, 'D', "", d.value.settlcurrencyid, d.value.nosettdays, d.value.futsettdate, d.value.quoteid, "4", "", "");
                        }

                        // stop timer
                        clearInterval(d.value.interval);

                        // disable button & remove the event listener
                        d3.select(this)
                            .style("cursor", "default")
                            .attr("disabled", null)
                            .on('click', null);
                    });

            // enter & update
            cells.each(function(d, i, j) {
                // display on button
                d3.select(this).select("input")
                    .attr("class", function(d) {
                        if (d.col == cols[0]) {
                            if ("tradeid" in d.value) {
                                return "quotebuttonsellexpired";
                            } else {
                                return "quotebuttonsell";
                            }
                        } else {
                            if ("tradeid" in d.value) {
                                return "quotebuttonbuyexpired";
                            } else {
                                return "quotebuttonbuy";
                            }                            
                        }
                    })
                    .attr("value", function(d) {
                        var txt;

                        // button text
                        if (d.col == cols[0]) {
                            if ("tradeid" in d.value) {
                                txt = "Sold " + d.value.bidquantity + " @ " + d.value.bidpx;
                            } else {
                                txt = "Sell " + d.value.bidquantity + " @ " + d.value.bidpx;

                                if (d.value.noseconds == 0) {
                                    txt += " - Expired";
                                } else {
                                    txt += " - " + (d.value.noseconds < 10 ? " " : "") + d.value.noseconds + " Seconds";
                                }
                            }
                        } else {
                            if ("tradeid" in d.value) {
                                txt = "Bought " + d.value.offerquantity + " @ " + d.value.offerpx;
                            } else {
                                txt = "Buy " + d.value.offerquantity + " @ " + d.value.offerpx;

                                if (d.value.noseconds == 0) {
                                    txt += " - Expired";
                                } else {
                                    txt += " - " + (d.value.noseconds < 10 ? " " : "") + d.value.noseconds + " Seconds";
                                }
                            }
                        }
                        return txt;
                    });

                // disable
                if (d.value.noseconds == 0) {
                    d3.select(this).select("input")
                        .style("cursor", "default")
                        .attr("disabled", null)
                        .attr("class", function(d) { return d.col == cols[0] ? "quotebuttonsellexpired" : "quotebuttonbuyexpired"; })
                        .on('click', null);
                }
            });
        }

        function createQuoteTable() {
            // use the rfq div, may not exist
            var divrfq = createDiv("divrfq", "divrfq");

            divrfq.append("header")
                .attr("class", "divrfqhdr")
                .text("Quotes");

            // create a table
            var tblquote = divrfq.append("table")
                .attr("id", "tblquote")
                .attr("class", "tblquote");

            // add header & body
            //var thead = tblquote.append("thead");
            var tbody = tblquote.append("tbody");

            return tblquote;
        }

        function startQuoteInterval(quote) {
            var interval = setInterval(function() {
                countdownQuote(quote);
                updateQuoteTable();
            }, 1000);

            return interval;
        }

        function startMyQuoteInterval(quote) {
            var interval = setInterval(function() {
                countdownQuote(quote);
                updateMyQuoteForm(quote.quotereqid);
            }, 1000);

            return interval;
        }

        // open quote requests
        function quoterequestsReceived(quoterequestarr) {
            // we have requested all open quote requests, so we need to clear our global array
            quoterequests = [];

            for (var i = 0; i < quoterequestarr.length; i++) {
                // add quote request to global array
                quoterequests.push(quoterequestarr[i]);
            }

            // update display
            updateQuoterequestTables();
        }

        // single quote request
        function quoterequestReceived(quoterequest) {
            // todo: get from price
            quoterequest.bidpx = 1.23; //prices[quoterequest.symbolid].bid;
            quoterequest.offerpx = 1.25; //prices[quoterequest.symbolid].ask;
            //quoterequest.quoted = false;

            // add quote request to global array
            quoterequests.push(quoterequest);

            // initialise array of quotes i may make for this request
            //myquotes[quoterequest.quotereqid] = [];

            // update display
            updateQuoterequestTables();
        }

        // display one table per quote request, allowing for a table of any related quotes in between
        function updateQuoterequestTables() {
            var cols = ["timestamp", "symbolid", "quantity", "quote"];

            var divquoterequest = d3.select("#divquoterequest");
            if (divquoterequest.empty()) {
                divquoterequest = createQuoterequestDiv();
            }

            // create a table per quote request
            // select on class so as not to confuse with quote tables in the same div
            var tblquoterequests = divquoterequest.selectAll(".tblquoterequest")
                .data(quoterequests);

            // add table, body, row
            var tblquoterequestsnew = tblquoterequests.enter()
                .append("table")
                    .attr("id", function(d) { return "tblquoterequest" + d.quotereqid; })
                    .attr("class", "tblquoterequest")
                .append("tbody")
                .append("tr");

            // add columns
            var cells = tblquoterequestsnew.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret;
                        if (col == "quote" || col == "viewquotes") {
                            ret = row;
                        } else {
                            ret = row[col];
                        }
                        return {col: col, value: ret};
                    });
                })
                .enter()
                .append("td");

            // enter - add variable inputs such as text/buttons
            cells.each(function(d, i, j) { // d=data, i=col, j=row
                if (d.col == "timestamp") {
                    d3.select(this)
                        .html(function(d) { return formatDatetime(d.value); });
                } else if (d.col == "quantity") {
                    d3.select(this)
                        .html(function(d) { return d.value; });
                } else if (d.col == "quote") {
                    d3.select(this)
                        .append("a")
                            .attr("href", "#")
                            .html("Place A Quote")
                            .on("click", function(d) {
                                // create a quote from the quote request
                                createMyQuote(d.value);

                                d3.select("#tblquoteform" + d.value.quotereqid).remove();

                                // fill it out
                                updateMyQuoteForm(d.value.quotereqid);
                            });
                /*} else if (d.col == "viewquotes") {
                    d3.select(this)
                        .append("a")
                            .attr("href", "#")
                            .html("View Quotes")
                            .on("click", function(d) {
                                requestMyQuotes(d.value.quotereqid);
                            });*/
                } else {
                    d3.select(this)
                        .html(function(d) { return d.value; });
                }
            });

            // add tables for client quotes
            /*tblquoterequests.each(function(d) {
                updateMyQuoteTable(d.quotereqid, this);
            });*/

            // exit
            tblquoterequests.exit().remove();
        }

        function createQuoterequestDiv() {
            divquoterequest = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquoterequest")
                .attr("class", "divquoterequest");

            // add a header
            /*divquoterequest.append("header")
                .attr("class", "divrfqhdr")
                .text("Quote Requests");*/

            return divquoterequest;
        }

        // create a quote from a quote request
        function createMyQuote(quoterequest) {
            var myquote = {};

            myquote.symbolid = quoterequest.symbolid;
            myquote.price = 1.23;
            myquote.quantity = quoterequest.quantity;
            myquote.currencyid = quoterequest.currencyid;
            myquote.settlcurrencyid = quoterequest.settlcurrencyid;
            myquote.quotereqid = quoterequest.quotereqid;

            updateMyQuote(myquote);
        }

        function updateMyQuote(quote) {
            // initialise array of quotes for this quote request, if necessary
            if (!(quote.quotereqid in myquotes)) {
                myquotes[quote.quotereqid] = [];
            }

            // there can be only one quote per quote request at any one time
            myquotes[quote.quotereqid][0] = quote;
        }

        /*function updateQuoterequestTable(quoterequest) {
            //input type="number" min="0" max="360" step="5" value="0" id="nValue"
            var testquoterequests = [];
            testquoterequests.push(quoterequest);

            var cols = ["timestamp", "buybutton", "quantity", "sellbutton"];
            var buysell = ["buy", "sell"];

            // create a quoterequest table if one does not exist
            var tblquoterequest = d3.select("#tblquoterequest" + quoterequest.quotereqid);
            if (tblquoterequest.empty()) {
                createQuoterequestTable(quoterequest);
            }

            // create a row for each quote
            var rows = d3.select("#tblquoterequest" + quoterequest.quotereqid).select("tbody").selectAll("tr")
                .data(testquoterequests);

            // enter
            rows.enter()
                .append("tr");

            // columns
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret;
                        if (col == "") {
                            ret = "";
                        } else {
                            ret = row[col];
                        }
                        return {col: col, value: ret};
                    });
                });


            // enter - create columns
            var cellsenter = cells.enter()
                .append("td");

            // enter - add variable inputs such as text/buttons
            cellsenter.each(function(d, i, j) { // d=data, i=col, j=row
                console.log("enter & update?");
                console.log(d);
                console.log(j);
                if (d.col == "timestamp") {
                    d3.select(this)
                        .html(function(d) { return d.value; });
                } else if (d.col == "quantity") {
                    d3.select(this)
                        .html(function(d) { return d.value; });
                } else if (d.col == "buybutton") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("value", "Place a Buy Quote")
                        .on("click", function() {
                            console.log("clicked");
                            console.log(d);
                            console.log(i);
                            console.log(j);
                            //cols.push("test");
                            //quoterequests[j].quoted = true;
                            console.log(quoterequests[j].quotereqid);
                            myquotes[quoterequests[j].quotereqid] = "test";

                            // todo: needed?
                            updateQuoterequestTable();
                            //updateMyQuoteTable(1, j);
                        });
                } else if (d.col == "sellbutton") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("value", "Place a Sell Quote")
                        .on("click", function() {
                            console.log("clicked");
                            console.log(d);
                            console.log(i);
                            console.log(j);
                            //cols.push("test");
                            //quoterequests[j].quoted = true;

                            // todo: needed?
                            //updateQuoterequestTable();
                            //updateMyQuoteTable(2, j);
                        });
                }
            });

            // exit
            cells.exit().remove();
        }*/
                            /*d3.select(this)
                        .append("br");
                    d3.select(this)
                        .append("input")
                        .attr("type", "text");
                    d3.select(this)
                        .append("input")
                        .attr("type", "text");
                                        d3.select(this)
                        .append("br");
                    d3.select(this)
                        .append("input")
                        .attr("type", "text");
                    d3.select(this)
                        .append("input")
                        .attr("type", "text");*/


            /*function sendQuote(j) {
                var quote = {};

                var price = d3.select("#inpprice" + j).node().value;
                var quantity = d3.select("#inpquantity" + j).node().value;

                console.log(d3.select("#buysellselect").node().value);

                if (d3.select("#buysellselect").node().value == "buy") {
                    quote.bidpx = price;
                    quote.bidsize = quantity;
                } else {
                    quote.offerpx = price;
                    quote.offersize = quantity                    
                }

                quote.symbolid = quoterequests[j].symbolid;
                quote.currencyid = "GBP"; // todo - use quote currencyid? symbols[symbolid].currencyid;
                quote.settlcurrencyid = quoterequests[j].settlcurrencyid;
                quote.futsettdate = quoterequests[j].futsettdate;
                quote.noseconds = 30;
                quote.operatortype = operatortype;
                quote.operatorid = clientid;
                quote.qbroker = qbroker;
                quote.qclientid = clientid;
                quote.quotereqid = quoterequests[j].quotereqid;

                console.log(quote);

                sockjs.send("{\"quote\":" + JSON.stringify(quote) + "}");
            }*/

            // update
            /*cells.each(function(d, i, j) {
                console.log("update?");
                if (d.column == "quoted" && d.value == true) {
                    if (d3.select("inpprice" + j).empty()) {
                        var buysellselect = d3.select(this)
                            .append("select")
                            .attr("id", "buysellselect")
                            .on("change", function() { console.log(this.value); });

                        buysellselect.append("option")
                            .text("Buy")
                            .attr('value', "buy");

                        buysellselect.append("option")
                            .text("Sell")
                            .attr('value', "sell");

                        d3.select(this)
                            .append("input")
                            .attr("id", "inpprice" + j)
                            .attr("type", "number")
                            .attr("step", "0.01")
                            .attr("value", function(d) { return quoterequests[j].bidpx; });

                        d3.select(this)
                            .append("input")
                            .attr("id", "inpquantity" + j)
                            .attr("type", "number")
                            .attr("step", "10")
                            .attr("value", function(d) { return quoterequests[j].quantity; });

                        d3.select(this)
                            .append("input")
                            .attr("type", "button")
                            .attr("value", "Send")
                            .on("click", function() {
                                console.log(d);
                                console.log(i);
                                console.log(j);
                                sendQuote(j);
                        });
                    }
                }
            });*/

        function createQuoterequestTable(quoterequest) {
            console.log("createQuoterequestTable");
            //var hdr = ["Timestamp", "Quantity", "Buy Price", "Buy Size", "Valid For (Secs)", "", "Sell Price", "Sell Size", "Valid For (Secs)", ""];
            var hdr = ["","Placed", "Quantity"];

            var divquoterequest = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquoterequest");

            // create a table
            var tblquoterequest = divquoterequest.append("table")
                .attr("id", "tblquoterequest" + quoterequest.quotereqid);

            // add header & body
            //var thead = tblquoterequest.append("thead");
            var tbody = tblquoterequest.append("tbody");

            // append the header row
            /*thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    .attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });*/
        }
                    //var t = document.createElement('text');
                    //this.parentNode.insertBefore(t, this.nextSibling);

        /*function myquotesReceived(myquotearr) {
            console.log(myquotearr);

            // sort the array on price
            myquotearr.sort(compareQuotes);
            console.log("after");
            console.log(myquotearr);

            for (var i = 0; i < myquotearr.length; i++) {
                updateMyQuoteLadder(myquotearr[i]);
            }

            updateMyQuoteTables();
        }*/

        function compareQuotes(a, b) {
            if (a.bidpx != "" && b.bidpx != "") {
                if (a.bidpx > b.bidpx) {
                    return 1;
                } else if (b.bidpx > a.bidpx) {
                    return -1;
                } else {
                    return 0;
                }
            } else if (a.offerpx != "" && b.offerpx != "") {
                if (a.offerpx > b.offerpx) {
                    return 1;
                } else if (b.offerpx > a.offerpx) {
                    return -1;
                } else {
                    return 0;
                }
            } else {
                return 0;
            }
        }

        function updateMyQuoteLadder(quote) {
            // we create either a bid or offer quote for a quote level
            var updated = false;

            // see if we can add the quote to an existing quote level
            for (var i = 0; i < myquotes.length; i++) {
                if (quote.bidpx != "") {
                    if (!('bidquote' in myquotes[i])) {
                        myquotes[i].bidquote = quote;
                        updated = true;
                        break;
                    }
                } else {
                    if (!('offerquote' in myquotes[i])) {
                        myquotes[i].offerquote = quote;
                        updated = true;
                        break;
                    }           
                }
            }

            // if not, create a new level
            if (!updated) {
                myquotes.push([]);

                if (quote.bidpx != "") {
                    myquotes[myquotes.length - 1].bidquote = quote;
                } else {
                    myquotes[myquotes.length - 1].offerquote = quote;
                }
            }
        }

        function updateMyQuoteTables() {
            console.log("updateMyQuoteTables");

            // make an array of myquotes[quotereqid] for d3
            /*var myquotearr = [];
            for (var i in myquotes) {
                myquotearr.push(i);
            }*/

            // get our div
            var divquoterequest = d3.select("#divquoterequest");
            if (divquoterequest.empty()) {
                // this has to be already set-up for quote requests for quote display to be meaningful
                return;
            }

            // create a table of quotes per quote request
            // select on class so as not to confuse with quote tables in the same div
            var tblquotes = divquoterequest.selectAll(".tblmyquote")
                .data(myquotes);

            // add table, body, row
            tblquotes.enter()
                .append("table")
                    .attr("id", function(d) { return "tblmyquote" + d; })
                    .attr("class", "tblmyquote")
                .append("tbody");

            // update each table
            tblquotes.each(function(d) {
                updateMyQuoteTable(d);
            });
        }

        //
        // create table of my quotes for a quote request
        //
        function updateMyQuoteTable(quotereqid) {
            console.log("updateMyQuoteTable");
            console.log(quotereqid);

            var cols = ["buysell", "quantity", "price", "validuntiltime", "cancel"];

            createMyQuoteTableHdr(quotereqid);

            // get a ref to the appropriate table
            var tblmyquote = d3.select("#tblmyquote" + quotereqid);

            // enter data
            var rows = tblmyquote.select("tbody").selectAll("tr")
                .data(myquotes[quotereqid]);

            // create a row for each associated quote
            var rowsenter = rows.enter()
                .append("tr");

            // create a header row
            /*rowsenter.each(function(d) {
                createMyQuoteTableHdr(quotereqid);
            });*/

            // columns
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret;
                        if (col == "buysell") {
                            ret = row.bidpx != "" ? "Buy" : "Sell";
                        } else if (col == "quantity") {
                            ret = row.bidquantity != "" ? row.bidquantity : row.offerquantity;
                        } else if (col == "price") {
                            ret = row.bidpx != "" ? row.bidpx : row.offerpx;
                        } else if (col == "cancel") {
                            ret = "cancel";
                        } else {
                            ret = row[col];
                        }
                        return {col: col, value: ret};
                    });
                });

            // add columns
            var cellsenter = cells.enter().append("td");

            cells.each(function (d) {
                if (d.col == "cancel") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("value", "Cancel Quote");
                } else {
                    d3.select(this)
                        .text(function(d) { return d.value; });
                }
            });
        }

        // enter a quote
        function updateMyQuoteForm(quotereqid) {
            console.log("updateMyQuoteForm");
            console.log(quotereqid);

            console.log(myquotes[quotereqid]);

            var cols = ["buy", "quantity", "price", "sell"];

            // create a table for this quote, if necessary
            var tblquoteform = d3.select("#tblquoteform" + quotereqid);
            if (tblquoteform.empty()) {
                tblquoteform = createMyQuoteForm(quotereqid);
            }

            // update
            var rows = tblquoteform.select("tbody").selectAll("tr")
                .data(myquotes[quotereqid]);

            // create a row for each associated quote
            var rowsenter = rows.enter()
                .append("tr");

            // columns
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row};
                    });
                });

            // update - triggered when quote received from server
            cells.each(function(d) {
                if (d.col == "buy") {
                    if (d.value.offerpx != "") {
                        // remove the button
                        var buybutton = d3.select("#buybutton" + d.value.quotereqid);
                        if (!(buybutton.empty())) {
                            buybutton.remove();
                        }

                        displayTimer(this, d.value);
                    }
                } else if (d.col == "sell") {
                    if (d.value.bidpx != "") {
                        // remove the button
                        var buybutton = d3.select("#sellbutton" + d.value.quotereqid);
                        if (!(buybutton.empty())) {
                            buybutton.remove();
                        }

                        displayTimer(this, d.value);
                    }
                }
            });

            // add columns
            var cellsenter = cells.enter().append("td");

            // enter - add text/buttons
            cellsenter.each(function(d, i, j) {
                if (d.col == "quantity") {
                    d3.select(this)
                        .append("input")
                        .attr("id", "inpquantity" + d.value.quotereqid)
                        .attr("type", "number")
                        .attr("step", "10")
                        .attr("class", "myquoteinp")
                        .attr("value", function(d) { return d.value.quantity; });
                } else if (d.col == "price") {
                    d3.select(this)
                        .attr("id", "colinpprice" + d.value.quotereqid)
                        .append("input")
                        .attr("id", "inpprice" + d.value.quotereqid)
                        .attr("type", "number")
                        .attr("step", "0.01")
                        .attr("class", "myquoteinp")
                        .attr("value", function(d) { return d.value.price; });
                } else if (d.col == "buy") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("id", function(d) { return "buybutton" + d.value.quotereqid; })
                        .attr("value", "Place Buy Quote")
                        .attr("class", "quotebutton")
                        .on("click", function() {
                            sendQuote(1, d.value);

                            // disable buttons immediately
                            d3.select(this)
                                .attr("disabled", null)
                                .attr("value", "Buy Quote Placed")
                                .style("cursor", "default");

                            d3.select("#sellbutton" + d.value.quotereqid)
                                .attr("disabled", null)
                                .style("cursor", "default");
                        });
                } else if (d.col == "sell") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("id", function(d) { return "sellbutton" + d.value.quotereqid; })
                        .attr("value", "Place Sell Quote")
                        .attr("class", "quotebutton")
                        .on("click", function() {
                            sendQuote(2, d.value);

                            // disable buttons immediately
                            d3.select(this)
                                .attr("disabled", null)
                                .attr("value", "Sell Quote Placed")
                                .style("cursor", "default");

                            d3.select("#buybutton" + d.value.quotereqid)
                                .attr("disabled", null)
                                .style("cursor", "default");
                         });
                }
            });

            function displayTimer(col, quote) {
                console.log("displayTimer");
                var lbltimer = d3.select("#lbltimer" + quote.quotereqid);
                if (lbltimer.empty()) {
                    lbltimer = d3.select(col)
                        .append("label")
                        .attr("id", "lbltimer" + quote.quotereqid);
                }

                lbltimer.text(function(d) {
                    if ('tradeid' in quote) {
                        return "Trade Done";
                    } else if (quote.noseconds == 0) {
                        return "Expired";
                    } else {
                        return quote.noseconds + " Seconds";
                    }
                });
            }
        }

        // create a quote entry table for a quote request
        function createMyQuoteForm(quotereqid) {
            // insert the new quote table immediately after the associated quote request table
            var tblquoterequest = document.getElementById("tblquoterequest" + quotereqid);
            var t = document.createElement('table');
            tblquoterequest.parentNode.insertBefore(t, tblquoterequest.nextSibling);
            t.id = "tblquoteform" + quotereqid;

            // get d3 selection
            var tblquoteform = d3.select("#tblquoteform" + quotereqid)
                .attr("class", "tblquoteform");

            tblquoteform.append("tbody");

            return tblquoteform;
        }

        function validUntilOptions(col, externalquoteid) {
            var data = ["30 Seconds"];

            // create select box
            var selvalid = d3.select(col)
                .attr("id", "colvaliduntil")
                .append("select")
                .attr("id", "selvaliduntil" + externalquoteid)
                .attr("class", "selcashorshares");

            // add options
            selvalid.selectAll("option")
                .data(data)
                .enter()
                .append("option")
                .text(function(d) { return d; });
        }

        function createMyQuoteTable(quotereqid, tblquoterequest) {
            var divquoterequest = d3.select("#divquoterequest");

                                    /*var t = document.createElement('table');
                    tblquoterequest.parentNode.insertBefore(t, tblquoterequest.nextSibling);
                                t.id = "tblmyquote" + quotereqid;*/

            // create a table
            var tblmyquote = divquoterequest.append("table")
                .attr("id", "tblmyquote" + quotereqid)
                .attr("class", "tblmyquote");

            // add a body
            var tbody = tblmyquote.append("tbody");

            return tblmyquote;
        }

        function createMyQuoteTableHdr(quotereqid) {
            var hdr = ["Quote Type", "Quantity", "Price", "Valid Until"];

            var tblmyquote = d3.select("#tblmyquote" + quotereqid);

            // we only want one header
            //var thead = d3.select("#tblmyquotehdr" + quotereqid);
            //if (!(thead.empty())) { return; };

            // create the header
            thead = tblmyquote.append("thead")
                //.attr("id", "tblmyquotehdr" + quotereqid)
                .append("tr");

            // add the column headings
            thead.selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    //.attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });
        }

        function sendQuote(side, quote) {
            console.log("sendQuote");

            // set-up bid or offer price/size
            if (side == 1) {
                quote.bidpx = d3.select("#inpprice" + quote.quotereqid).node().value;
                quote.bidsize = d3.select("#inpquantity" + quote.quotereqid).node().value;
            } else {
                quote.offerpx = d3.select("#inpprice" + quote.quotereqid).node().value;
                quote.offersize = d3.select("#inpquantity" + quote.quotereqid).node().value;
            }

            // remove starting values
            delete quote['price'];
            delete quote['quantity'];

            quote.noseconds = 30;
            quote.operatortype = operatortype;
            quote.operatorid = clientid;
            quote.qbroker = qbroker;
            quote.qclientid = clientid;
            console.log(quote);

            sockjs.send("{\"quote\":" + JSON.stringify(quote) + "}");
        }

        //
        // my quote returned
        //
        /*function quoteresponseReceived(quote) {
            console.log("quoteresponseReceived");
            console.log(quote);

            // add quote response to global array
            quoteresponses.push(quote);

            // update display
            updateQuoteresponseTable();
        }*/

        /*function updateQuoteresponseTable() {
            console.log("updateQuoteresponseTable");

            var cols = ["transacttime","bidpx","bidquantity"];

            // create a quoteresponse table if one does not exist
            var tblquoteresponse = d3.select("#quoteresponse");
            if (tblquoteresponse.empty()) {
                createQuoteresponseTable();
            }

            // create a row for each quote response
            var rows = d3.select("#tblquoteresponse").select("tbody").selectAll("tr")
                .data(quoteresponses);

            // enter
            rows.enter()
                .append("tr");

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value : row[column]};
                    });
                })
                .enter()
                .append("td")
                    .text(function(d) { console.log(d);return d.value; });
        }*/

        /*function createQuoteresponseTable() {
            console.log("createQuoteresponseTable");

            var hdr = ["test1", "test2", "test3"];

            var divquoteresponse = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquoteresponse");

            // create a table
            var tblquoteresponse = divquoteresponse.append("table")
                .attr("id", "tblquoteresponse");

            // add header & body
            var thead = tblquoteresponse.append("thead");
            var tbody = tblquoteresponse.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    //.attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });
        }*/

            // create a row for each quote
            /*var rows = tbody.selectAll("tr")
                .data(quoterequests)
                .enter()
                .append("tr");*/

            // create a cell in each row for each quote column
            /*var cells = rows.selectAll("td")
                .data(function(d) { return d; })*/
                /*.data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 })*/
                /*.enter()
                .append("td")
                .each(function(d, i, j) { // i=column, j=row
                    console.log(d);
                    console.log(i);
                    console.log(j);
                    if (i == 0) {
                        // text in first column
                        d3.select(this)
                            .text(function(d) { return d; });
                    } else if (i == 1) {
                        // input fields in second column
                        d3.select(this)
                            .append("input")
                            .attr("type", function(d) { return "button"; });
                    }
                });*/

                /*.append("td")
                    .text(function(d, i) { return d.value; });*/

            // create a cell & button in each row for each button column
            /*cells = rows.selectAll("td")
                .data(buttons);*/
                /*.data(function(row) {
                    return buttons.map(function(col) {
                        return col;
                        //return {col: col, value: row[col]};
                    });
                 })*/
                /*cells.enter()
                .append("td")
                    .text("test");*/
                    /*.append("input")
                        .attr("type", "button")
                        .attr("value", function(d, i) { console.log(d);return d; });*/

            /*var cells = rows.selectAll("td")
                .data(function(d) { return d; })
                .enter()
                .append("td")
                .each(function(d, i, j) { // i=column, j=row
                    if (i == 0) {
                        // text in first column
                        d3.select(this)
                            .text(function(d) { return d; });
                    } else if (i == 1) {
                        // input fields in second column
                        d3.select(this)
                            .append("input")
                            .attr("type", function(d) { return inputtypes[j]; });
                    }
                });*/

            /*cells.selectAll("td")
                .data(buttons)
                .each(function(d) { console.log(d) });*/
                /*.enter()
                .append("input")
                    .attr("type", "button")
                    .attr("class", "tradebutton sellbutton")
                    .attr("value", "test");*/

            /*cells.each(function(d) {
                console.log(d);
                console.log(this);
                d3.select(this)
                    .append("input")
                        .attr("type", "button")
                    .attr("class", "tradebutton sellbutton")
                        .attr("value", "test");
                    });*/

            /*cells.selectAll("input")
                .data(buttons)
                .enter()
                .append("input")
                    .attr("type", "button")
                    .attr("value", function(d) { return d; });*/


        //
        // sign-in form
        //
        function displayFormSignin() {
            var signindiv = d3.select("body")
                .append("div")
                .attr("id", "signindiv")
                .attr("class", "signindiv");

            signindiv.append("p")
                .attr("class", "signintitle")
                .html("TG Online");

            var signinemail = signindiv.append("input")
                .attr("id", "signinemail")
                .attr("class", "signininput")
                .attr("placeholder", "Email")
                .on("keydown", key);

            var signinpwd = signindiv.append("input")
                .attr("id", "signinpwd")
                .attr("class", "signininput")
                .attr("type", "password")
                .attr("placeholder", "Password")
                .on("keydown", key);

            signindiv.append("input")
                .attr("type", "button")
                .attr("value", "Sign In")
                .attr("class", "signinbutton")
                .on("click", function() {
                    signin();
                });                

            d3.select("#signinemail").node().focus();

            // return key test
            function key() {
                if (d3.event.keyCode == 13) {
                    signin();
                }
            }

            function signin() {
                var signin = {};
                signin.email = document.getElementById("signinemail").value;
                signin.password = document.getElementById("signinpwd").value;
                sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");                
            }
        }

        //
        // signin reply
        //
        function replySignin(reply) {
            if (reply.success) {
                clientid = reply.clientid;
                email = reply.email;

                // clear the sign in form
                d3.select("#signindiv").remove();

                start();
            } else {
                // signin failed
                d3.select("#signindiv")
                    .append("p")
                    .html("Sign in failed, please try again");

                d3.select("#signinemail").node().focus();
            }
        }

        function statusReceived(status) {
            console.log(status);
        }

        function quoteackReceived(quoteack) {
            var divrfq = createDiv("divrfq", "divrfq");

            divrfq.append("p")
                .html("Quote request rejected: " + quoteack.text);
        }

        function positionsReceived(positionsarr) {
            // empty array
            positions = [];

            for (var i = 0; i < positionsarr.length; i++) {
                positionsarr[i].costpershare = Math.abs(positionsarr[i].cost / positionsarr[i].quantity);

                positions.push(positionsarr[i]);
            }

            updatePositionTable();
        }

        function positionReceived(position) {
            var posupdated = false;

            // todo - check this
            if (!('symbolid' in position)) {
                return;
            }

            // single symbol/portfolio only
            if (selectedmenu != MENURFQ && selectedmenu != MENUPORTFOLIO) { return; }

            // only display position if this is the symbol we are looking at
            if (selectedmenu == MENURFQ && position.symbolid != selectedsymbol) { return; }

            position.costpershare = Math.abs(position.cost / position.quantity);

            // update or remove position
            for (var i = 0; i < positions.length; i++) {
                if (positions[i].symbolid == position.symbolid) {
                    if (position.quantity == 0) {
                        positions.splice(i, 1);
                    } else {
                        positions[i] = position;
                    }
                    posupdated = true;
                    break;
                }
            }

            // add to array
            if (!posupdated) {
                positions.push(position);

                // position has been created by someone else's actions, so request prices
                if (selectedmenu == MENUPORTFOLIO) {
                    requestSubscribeSymbol(position.symbolid);
                }
            }

            updatePositionTable();
        }

        function updatePositionData(price) {
            // see if a position for this product exists &, if so, update p&l
            for (var i = 0; i < positions.length; i++) {
                if (positions[i].symbolid == price.symbolid) {
                    if (positions[i].quantity < 0) {
                        if ('ask' in price) {
                            positions[i].mktprice = price.ask;
                            updatePandL(i);
                            updateMargin(i);
                        }
                    } else {
                        if ('bid' in price) {
                            positions[i].mktprice = price.bid;
                            updatePandL(i);
                            updateMargin(i);
                        }                        
                    }
                }
            }
        }

        function updatePandL(i) {
            var newpandl;
            if (positions[i].quantity > 0) {
                newpandl = positions[i].quantity * positions[i].mktprice / 100 - parseFloat(positions[i].cost);
            } else {
                newpandl = positions[i].quantity * positions[i].mktprice / 100 + parseFloat(positions[i].cost);
            }

            if (newpandl > positions[i].unrealisedpandl) {
                positions[i].unrealisedpandltick = '+';
            } else if (newpandl < positions[i].unrealisedpandl) {
                positions[i].unrealisedpandltick = '-';                                
            } else {
                positions[i].unrealisedpandltick = '0';                                
            }
            positions[i].unrealisedpandl = newpandl;
        }

        function updateMargin(i) {
            // update margin for derivs
            if (symbols[positions[i].symbolid].instrumenttypeid != "DE" && symbols[positions[i].symbolid].instrumenttypeid != "IE") {
                positions[i].margin = Math.abs(positions[i].quantity) * positions[i].mktprice / 100 * symbols[positions[i].symbolid].marginpercent / 100;
            }
        }

        function updatePositionTable() {
            var cols = ["symbolid", "futsettdate", "quantity", "cost", "currencyid", "margin", "costpershare", "mktprice", "unrealisedpandl"];

            if (positions.length == 0) {
                cols = [];
            } else if (selectedmenu == MENURFQ) {
                for (i = 0; i < positions.length; i++) {
                    if (symbols[positions[i].symbolid].instrumenttypeid == "CFD") {
                        // add option to close position
                        cols.push("close");
                        break;
                    }
                }
            }

            // always call create routine as this controls addition & removal of headers
            var tblposition = createPositionTable(cols);

            // create a row for a position
            var rows = tblposition.select("tbody").selectAll("tr")
                .data(positions);

            // enter
            rows.enter()
                .append("tr");
                /*.attr("class", function(d, i, j) {
                    // todo
                    console.log(d);
                    console.log(i);
                    console.log(j);
                    return null;
                });*/

            // exit
            rows.exit().remove();

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 })
                .each(function(d, i, j) {
                    if (d.col == "symbolid" || d.col == "close") {
                    } else if (d.col == "quantity" && selectedmenu == MENURFQ) {
                        d3.select(this).select("a")
                            .html(function (d) { return d.value; })
                            .on("click", function(d) {
                                // clear quote data
                                clearQuotes();

                                // & clear any previous request
                                d3.select("#divrfq").remove();

                                requestQuote(positions[j].symbolid, positions[j].quantity);
                            });
                    } else {
                        d3.select(this)
                            .text(display(d))
                            .attr("class", function(d, i, j) {
                                if (d.col == "unrealisedpandl") {
                                    if (positions[j].unrealisedpandltick == '+') {
                                        return "tickup";
                                    } else if (positions[j].unrealisedpandltick == '-') {
                                        return "tickdn";
                                    } else if (positions[j].unrealisedpandltick == '0') {
                                        return "ticknc";
                                    }
                                }
                            });
                    }
                });

            // enter
            cells.enter()
                .append("td")
                .each(function(d, i, j) {
                    if (d.col == "symbolid" && selectedmenu != MENURFQ) {
                        // display a link for this symbol
                        d3.select(this)
                            .append("a")
                                .attr("href", "#")
                                .html(function (d) { return d.value; })
                                .on("click", function(d) {
                                    requestUnsubscribePositions();
                                    singleSymbol(d.value);
                                });
                    } else if (d.col == "quantity" && selectedmenu == MENURFQ) {
                        d3.select(this)
                            .append("a")
                                .attr("href", "#")
                                .html(function (d) { return d.value; })
                                .on("click", function(d) {
                                    // clear quote data
                                    clearQuotes();

                                    // & clear any previous request
                                    d3.select("#divrfq").remove();

                                    requestQuote(positions[j].symbolid, positions[j].quantity);
                                });
                    } else if (d.col == "close") {
                        d3.select(this)
                            .append("input")
                            .attr("type", "button")
                            .attr("value", "Close")
                            .attr("class", "rfqbutton")
                            .on("click", function() {
                                // clear quote data
                                clearQuotes();

                                // & clear any previous request
                                d3.select("#divrfq").remove();

                                var side = positions[j].quantity > 0 ? 2 : 1;

                                // todo: does sett date need to depend on inst type 

                                sendRfq(Math.abs(positions[j].quantity), "", positions[j].symbolid, side, "GBP", "", positions[j].futsettdate); // todo: currency

                                // disable button & remove the event listener
                                d3.select(this)
                                    .style("cursor", "default")
                                    .attr("disabled", null)
                                    .on('click', null);
                            });
                    } else {
                        d3.select(this)
                            .text(display(d));
                    }
                });

            function display(d) {
                if (d.col == "cost" || d.col == "margin" || d.col == "unrealisedpandl") {
                    return formatCurrency(d.value, 2);
                } else if (d.col == "costpershare" || d.col == "mktprice") {
                    return formatCurrency(d.value, 4);
                } else if (d.col == "futsettdate") {
                    return formatDate(d.value);
                } else {
                    return d.value;
                }
            }
        }

        function createPositionTable(cols) {
            var tblposition = d3.select("#tblposition");
            if (tblposition.empty()) {
                var divposition;

                // may be a single position or array of positions
                var divprice = d3.select("#divprice");
                if (!divprice.empty()) {
                    divposition = divprice.append("div")
                        .attr("class", "divposition")
                        .attr("id", "divposition");
                } else {
                    divposition = d3.select("#divcontainer").append("div")
                        .attr("class", "divposition")
                        .attr("id", "divposition");
                }

                // create the table
                tblposition = divposition.append("table")
                    .attr("class", "tblposition")
                    .attr("id", "tblposition");

                // add header & body
                var thead = tblposition.append("thead")
                    .attr("class", "tblpositionhdr")
                    .append("tr");

                var tbody = tblposition.append("tbody");
            }

            // update
            var theadcells = tblposition.select("thead").selectAll("th")
                .data(cols);

            // enter
            theadcells.enter()
                .append("th")
                    .text(function(d) {
                        if (d == "costpershare") {
                            return "cost per share";
                        } else if (d == "mktprice") {
                            return "mkt. price";
                        } else if (d == "unrealisedpandl") {
                            return "unrealised p&l";
                        } else {
                            return d;
                        }
                    });

            // exit
            theadcells.exit().remove();

            return tblposition;
        }

        function requestOpenQuoteRequests(symbolid) {
            var requestrfq = {};

            requestrfq.symbolid = symbolid;

            sockjs.send("{\"openquoterequestrequest\":" + JSON.stringify(requestrfq) + "}");
        }

        function requestMyQuotes(quotereqid) {
            var myquotesrequest = {};

            myquotesrequest.quotereqid = quotereqid;

            sockjs.send("{\"myquotesrequest\":" + JSON.stringify(myquotesrequest) + "}");            
        }

        function requestTrades() {
            var historyrequest = {};

            sockjs.send("{\"tradehistoryrequest\":" + JSON.stringify(historyrequest) + "}");
        }

        function requestStatement() {
            var statementrequest = {};

            statementrequest.currencyid = "GBP";

            sockjs.send("{\"statementrequest\":" + JSON.stringify(statementrequest) + "}");            
        }

        function statementReceived(statementarr) {
            statement = [];

            for (var i = 0; i < statementarr.length; ++i) {
                statement.push(statementarr[i]);
            }

            updateStatementTable();
        }

        function updateStatementTable() {
            var cols = ["timestamp", "transtype", "description", "reference", "amount", "balance"];

            var tblstatement = d3.select("#tblstatement");
            if (tblstatement.empty()) {
                tblstatement = createStatementTable(cols);
            }

            // base the table on the statement array
            var rows = tblstatement.select("tbody").selectAll("tr")
                .data(statement);

            // enter
            rows.enter()
                .append("tr");

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d, i, j) {
                        if (d.col == "amount") {
                            if (statement[j].drcr == "1") {
                                return formatCurrency(d.value, 2);
                            } else {
                                return formatCurrency(-d.value, 2);                                
                            }
                        } else if (d.col == "balance") {
                            return formatCurrency(d.value, 2);
                        } else if (d.col == "transtype") {
                            return getCashtransType(d.value);
                        } else {
                            return d.value;
                        }
                    });
        }

        function createStatementTable(cols) {
            var tblstatement = d3.select("#divcontainer")
                .append("table")
                .attr("id", "tblstatement")
                .attr("class", "tblaccountsummary");

            // add header & body
            var thead = tblstatement.append("thead");
            var tbody = tblstatement.append("tbody");

            // add the column headings
            thead.selectAll("th")
                .data(cols)
                .enter()
                .append("th")
                    .attr("class", "tblaccountsummaryhdr")
                    .text(function(d) {
                        return d;
                    });

            return tblstatement;
        }

        function accountSummaryReceived(acctarr) {
            accountsummary = [];

            // account per currency
            for (var i = 0; i < acctarr.length; ++i) {
                accountsummary.push(acctarr[i]);
            }

            updateAccountSummaryTable();
        }

        function updateAccountSummaryTable() {
            var cols = ["currencyid", "cash", "balance", "unrealisedpandl", "margin", "freemargin"];

            var tblaccountsummary = d3.select("#tblaccountsummary");
            if (tblaccountsummary.empty()) {
                tblaccountsummary = createAccountSummaryTable(cols);
            }

            // base the table on the account array
            var rows = tblaccountsummary.select("tbody").selectAll("tr")
                .data(accountsummary);

            // enter
            rows.enter()
                .append("tr");

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d) {
                        if (d.col == "currencyid") {
                            return d.value;
                        } else {
                            return formatCurrency(d.value, 2);
                        }
                    });
        }

        function createAccountSummaryTable(cols) {
            var tblaccountsummary = d3.select("#divcontainer")
                .append("table")
                .attr("id", "tblaccountsummary")
                .attr("class", "tblaccountsummary");

            // add header & body
            var thead = tblaccountsummary.append("thead");
            var tbody = tblaccountsummary.append("tbody");

            // add the column headings
            thead.selectAll("th")
                .data(cols)
                .enter()
                .append("th")
                    .attr("class", "tblaccountsummaryhdr")
                    .text(function(d) {
                        if (d == "unrealisedpandl") {
                            return "unrealised p&l";
                        } else if (d == "freemargin") {
                            return "free margin";
                        } else {
                            return d;
                        }
                    });

            return tblaccountsummary;
        }

        function getOrderReasonDesc(reason) {
            var desc;

            if (reason == "") {
                return "";
            }

            switch (parseInt(reason)) {
            case 1001:
                desc = "No currency held for this instrument";
                break;
            case 1002:
                desc = "Insufficient cash in settlement currency";
                break;
            case 1003:
                desc = "No position held in this instrument";
                break;
            case 1004:
                desc = "Insufficient position size in this instrument";
                break;
            case 1005:
                desc = "System error";
                break;
            case 1006:
                desc = "Invalid order";
                break;
            case 1007:
                desc = "Invalid instrument";
                break;
            case 1008:
                desc = "Order already cancelled";
                break;
            case 1009:
                desc = "Order not found";
                break;
            case 1010:
                desc = "Order already filled";
                break;
            case 1011:
                desc = "Order currency does not match symbol currency";
                break;
            case 1012:
                desc = "Order already rejected";
                break;
            case 1013:
                desc = "Ordercancelrequest not found";
                break;
            case 1014:
                desc = "Quoterequest not found";
                break;
            case 1015:
                desc = "Symbol not found";
                break;
            case 1016:
                desc = "Proquote symbol not found";
                break;
            case 1017:
                desc = "Client not found";
                break;
            case 1018:
                desc = "Client not authorised to trade this type of product";
                break;
            case 1019:
                desc = "Quantity greater than position quantity";
                break;
            case 1020:
                desc = "Insufficient free margin";
                break;
            case 1021:
                desc = "Order held externally";
                break;
            case 1022:
                desc = "Order already expired";
                break;
            case 1023:
                desc = "Email already exists";
                break;
            default:
                desc = "Unknown reason";
            }

            return desc;
        }

        function getCashtransType(type) {
            if (type == "CD") {
                return "Cash Deposit";
            } else if (type == "CW") {
                return "Cash Withdrawal";
            } else if (type == "BT") {
                return "Buy";
            } else if (type == "ST") {
                return "Sell";
            } else if (type == "CO") {
                return "Commission";
            } else if (type == "DI") {
                return "Dividend";
            } else if (type == "FI") {
                return "Finance";
            } else if (type == "IN") {
                return "Interest";
            } else if (type == "PL") {
                return "PTM Levy";
            } else if (type == "CC") {
                return "Contract Charge";
            } else if (type == "SD") {
                return "Stamp Duty";
            } else if (type == "OT") {
                return "Other";
            }            
        }

     </script>
</body>
</html>