<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>TG-Online v0.9</title>
    <script src="https://d1fxtkz8shb9d2.cloudfront.net/sockjs-0.3.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
    .axis path,
    .axis line {
        fill: none;
        /*stroke: grey;*/
        stroke: #ccc;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }
    .sb {
        color: steelblue;
    }
    .yl {
        color: yellow;
    }
    header {
        font: 24px courier;
        text-align: center;
        color: grey;
    }
    body {
        /*font: 12px Arial;*/
        /*font: 12px sans-serif;*/
    }
    li:hover { 
        background-color: #ccc;
    }
    a {
        font-size: 24px;
        color: green;
        text-decoration: underline;
    }
    a:hover {
        cursor: pointer;
    }
    .x.axis path {
        /*stroke: blue;*/
        /*display: none;*/
    }
    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .divchart {
        width: 960px;
        margin-left: auto;
        margin-right: auto;
    }
    .node {
        cursor: pointer;
    }
    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
    .node text {
        font: 18px sans-serif;
    }
    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }
    .rfqbutton {
        /*width: 100px;
        height: 30px;*/

        /*font: courier;*/
        font-size: 24px;
        border-style: none;
        /*background-color: rgb(28, 184, 65);*/
        background-color: green;
        color: white;
        cursor: pointer;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        /*margin: 3px;*/
    }
    .tradebutton {
        font-size: 21px;
        border-style: none;
        cursor: pointer;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);        
    }
    .buybutton {
        background-color: blue;
        color: white;
    }
    .sellbutton {
        background-color: red;
        color: white;        
    }
    .stockboxtitle {
        font: courier;
        font-size: 27px;
        text-align: center;
        color: steelblue;
    }
    .stockboxdiv {
        width: 50%;
        /*float: left;*/
                     margin : 0 auto;

        /*position: relative;*/
        /*width: 50%;
        height: 50%;*/
        /*left: 50%;*/
        /*top: 33%;*/
        /*width: 300px;
        height: 100px;*/
        /*margin-top: -50px;
        margin-left: -150px;*/
    }
    .stockboxinput {
        display: block;
             margin : 0 auto;
             margin-top: 10px;
        /*position: relative;*/
        /*width: 300px;*/
        width: 30%;
        height: 27px;
        /*line-height: 27px;*/
        text-indent: 3px;
        font-family: courier, arial, sans-serif; 
        font-size: 1em;
        /*color: #333;*/
        /*background: #fff;*/
        border: solid 1px #c0c0c0;
        /*border:solid 1px #d9d9d9;*/
        /*border-top:solid 1px #c0c0c0;*/
    }
    .stockboxinput:focus { 
        border: solid 1px steelblue;
        outline: none;
    }
    .stocklist {
        position: absolute;
        list-style-type: none;
        /*border: 1px solid gray;*/
        border: 1px solid steelblue;
        padding: 3px;
        background-color: white;
        /*margin: 0px;*/
        /*margin-left: auto;
        margin-right: auto;*/
        /*width: 300px;*/
        width: 30%;
        margin : 0 auto;
        left: 0;
        right: 0;
    }
    .tblprice {
        margin : 0 auto;
    }
    .tblpricehdr {
        font: courier;
        font-size: 18px;
        color: lightgrey;        
    }
    .tblpricerow {
        /*text-align: center;*/
        /*font: courier;*/
        font-size: 36px;
        background-color: yellow;
        color: grey;
    }
    .signindiv {
        position: absolute;
        left: 50%;
        top: 33%;
        width: 400px;
        height: 200px;
        margin-top: -50px;
        margin-left: -150px;
    }
    .signininput {
        font-size: 15px;
        width: 100%;
        margin-bottom: 20px;
    }
    .signinbutton {
        background-color: lightgrey;
        color: grey;
        font-size: 21px;
        border-style: none;
        cursor: pointer;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);        
    }
    .signintitle {
        font: courier;
        font-size: 36px;
        color: steelblue;
    }
    .divprice {
        /*width: 50%;*/
        /*float: left;*/
                     margin : 0 auto;
        /*position: absolute;*/
        /*left: 50%;
        width: 300px;
        height: 100px;
        margin-left: -150px;*/
    }
    .divcontainer {
        width: 70%;
        /*background-color: #b0e0e6;*/
        margin-left: auto;
        margin-right: auto;
    }
    .tblmenu {
        margin : 0 auto;
    }
    .tblrfq {
        margin : 0 auto;        
    }
    </style>
</head>
<body lang="en">
    <script>
        var sockjs_url = '/echo';
        var sockjs;
        var orderbooks = {};
        var ukx = [];
        var pricehist = [];
        var operatortype = 1; // client
        var clientid;
        var instruments = {};
        var pricedata = [];
        var quotes = [];
        var quoterequests = [];
        var qbroker = "TGRANT";
        var quoteresponses = [];
        var email = "";
        var myquotes = [""];

        var datain = function(msg) {
            //console.log(msg);
            try {
                var obj = JSON.parse(msg);

                if ("price" in obj) {
                    priceReceived(obj.price);
                } else if ("prices" in obj) {
                    updateChart(obj.prices);
                } else if ("orderbooks" in obj) {
                    loadOrderBooks(obj.orderbooks);
                } else if ("orderbook" in obj) {
                    updateOrderBook(obj.orderbook);
                } else if ("index" in obj) {
                    updateIndex(obj.index);
                    displayIndex(ukx);
                } else if ("quoteack" in obj) {
                    quoteackReceived(obj.quoteack);
                } else if ("quote" in obj) {
                    quoteReceived(obj.quote);
                } else if ("order" in obj) {
                    orderReceived(obj.order);
                } else if ("trade" in obj) {
                    tradeReceived(obj.trade);
                } else if ("pricehistory" in obj) {
                    console.log(obj);
                    //updatePricehistory(obj.pricehistory);
                    pricehist = obj.pricehistory.prices;
                    createChart();
                } else if ("instruments" in obj) {
                    loadInstruments(obj.instruments);
                } else if ("quoterequest" in obj) {
                    quoterequestReceived(obj.quoterequest);
                } else if ("positions" in obj) {
                    positionsReceived(obj.positions);
                } else if ("signinreply" in obj) {
                    replySignin(obj.signinreply);
                } else if ("status" in obj) {
                    statusReceived(obj.status);
                }
            } catch(e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        var newconn = function() {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function()  {
                console.log("connection open");

                // we are ready
                displayFormSignin();
                //cheat();
            };

            sockjs.onmessage = function(e) {
                datain(e.data);
            };

            sockjs.onclose = function()  {
                console.log("connection closed");
            };

            sockjs.onheartbeat = function() {
            };
        };

        // get a connection
        newconn();

            // start with FTSE 100
            //requestIndex("UKX");
            //requestPricehistory("LLOY.L");
            //displayForm("LLOY.L");
            //sendOrder("LLOY.L", '1', 100, 0, 1, "BEST", "GBP", 2, "", "", "4", "", "");
            //requestOrderbook("LLOY.L.CFD");
            //requestRemoveOrderbook("LLOY.L");


        // things start here
        function start() {
            // create our container div
            var divcontainer = d3.select("body").append("div")
                .attr("id", "divcontainer")
                .attr("class", "divcontainer");

            // add a header
            divcontainer.append("header")
                .attr("id", "stockboxtitle")
                .text("Cantwaittotrade - " + email);

            // single symbol select
            selectSymbol();
        }

        function cheat() {
            var signin = {};
            signin.email = "js@js.com";
            signin.password = "js@js.com";
            sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");
        }

        function loadOrderBooks(orderbookarr) {
            for (var i = 0; i < orderbookarr.length; ++i) {
                updateOrderBook(orderbookarr[i]);
            }
        }

        function loadInstruments(instrumentarr) {
            console.log("loadInstruments");
            for (var i = 0; i < instrumentarr.length; ++i) {
                instruments[instrumentarr[i].symbol] = instrumentarr[i];
            }
        }

        function updateOrderBook(orderbook) {
            var level;

            // create an entry in the orderbooks array for this symbol
            if (!(orderbook.symbol in orderbooks)) {
                // 6 levels
                orderbooks[orderbook.symbol] = [{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0},{bid:0, offer:0, bidvol:0, offervol:0}];
            }
        }

        function updatePricehistory(pricehist) {
            console.log("pricehist");
        }

        function removeOrderBook(symbol) {
            delete orderbooks[symbol];
        }

        function updateIndex(index) {
            console.log("updateIndex");

            var rootnode = {};
            rootnode.name = "FTSE 100";
            rootnode.children = [];
            ukx.push(rootnode);

            for (var i = 0; i < index.symbols.length; ++i) {
                var node = {};
                node.name = index.symbols[i].shortname;
                node.parent = "FTSE 100";
                node.symbol = index.symbols[i].symbol;
                ukx[0].children.push(node);
            }
        }

        function priceReceived(price) {
            console.log("priceReceived");
            console.log(price);

            var cols = ["bid","ask"];

            // create a price table if one does not exist
            if (d3.select("#tblprice").empty()) {
                createPriceTable(price, cols);
                createTradeMenu(price.symbol);
            }

            // update price array
            if ("bid" in price) {
                pricedata[0].bid = price.bid;
            }
            if ("ask" in price) {
                pricedata[0].ask = price.ask;
            }

            // get the table price row
            var tblpricerow = d3.select("#tblpricerow");

            // update
            tblpricerow.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .text(function(d, i) { return d.value; });
        }

        function createPriceTable(price, cols) {
            var hdr = ["bid","ask"];

            pricedata.push(price);

            // create a price div
            var divprice = d3.select("#divcontainer").append("div")
                .attr("id", "divprice");

            divprice.append("header")
                .text(instruments[price.symbol].description)
                .style("margin-top", "10px");

            divprice.append("header")
                .text(price.symbol + " - " + price.timestamp);

            // create a table
            var tblprice = divprice.append("table")
                .attr("id", "tblprice")
                .attr("class", "tblprice");

            // add header & body
            var thead = tblprice.append("thead");
            var tbody = tblprice.append("tbody");

            // append the header row
            /*thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    .attr("class", "tblpricehdr")
                    .text(function(d) { return d; });*/

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(pricedata)
                .enter()
                .append("tr")
                .attr("id", "tblpricerow")
                .attr("class", "tblpricerow");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d, i) { return d.value; });
        }

        function createTradeMenu(symbol) {
            var data = [""];
            var columns = ["Request A Quote"];

            // create a table
            var tblmenu = d3.select("#divcontainer")
                .append("table")
                .attr("class", "tblmenu");

            // add a body
            var tbody = tblmenu.append("tbody");

            // append the header row
            /*thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                    .text(function(column) { return column; });*/

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return columns.map(function(column) {
                        //return {column: column, value: column};
                        return column;
                    });
                 })
                .enter()
                .append("td")
                    .append("a")
                        .attr("href", "#")
                        .on("click", function() {
                            requestQuote(symbol);
                        })
                        .html(function (d) { return d; });
        }

        function createTradeTable() {
            var hdr = [];
            var cols = ["bid","ask"];

            // update data arrays
            hdr.push(price.symbol);
            pricedata.push(price);

            // create a table
            var tbltrade = d3.select("body")
                .append("table")
                .attr("id", "tbltrades");

            // add header & body
            var thead = tbltrade.append("thead");
            var tbody = tbltrade.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    .attr("colspan", 2)
                    .attr("class", "tbltradehdr")
                    .text(function(d) { return d + " - " + instruments[d].description; });

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(pricedata)
                .enter()
                .append("tr")
                .attr("class", "tbltraderow")
                .attr("id", "tbltraderow");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d, i) { return d.value; });
        }

        function requestOrderbook(symbol) {
            console.log("requestOrderbook:"+symbol);
            sockjs.send("{\"orderbookrequest\":" + JSON.stringify(symbol) + "}");
        }

        function requestRemoveOrderbook(symbol) {
            sockjs.send("{\"orderbookremoverequest\":" + JSON.stringify(symbol) + "}");
        }

        function requestIndex(index) {
            console.log("requestIndex:" + index);
            sockjs.send("{\"index\":" + JSON.stringify(index) + "}");
        }

        // assumes today
        function requestPricehistory(symbol) {
            var pricehistoryrequest = {};

            var today = new Date();
            var startofday = new Date();

            startofday.setHours(08);
            startofday.setMinutes(00);
            startofday.setSeconds(00);

            console.log(startofday.getTime());
            console.log(today.getTime());

            pricehistoryrequest.symbol = symbol;
            pricehistoryrequest.startperiod = startofday.getTime();
            pricehistoryrequest.endperiod = today.getTime();

            sockjs.send("{\"pricehistoryrequest\":" + JSON.stringify(pricehistoryrequest) + "}");
        }

        // display a tree
        function displayIndex(treedata) {
            var margin = {top: 20, right: 120, bottom: 20, left: 120},
                width = 960 - margin.right - margin.left,
                height = 1200 - margin.top - margin.bottom;
    
            var i = 0;
            var duration = 750;

            var tree = d3.layout.tree()
                .size([height, width]);

            var diagonal = d3.svg.diagonal()
                .projection(function(d) { return [d.y, d.x]; });

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var root = treedata[0];
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            root.children.forEach(collapse);
            update(root);

            d3.select(self.frameElement).style("height", "700px");

            function update(source) {
                console.log("update");
                // Compute the new tree layout.
                var nodes = tree.nodes(root).reverse(),
                    links = tree.links(nodes);

                // Normalize for fixed-depth.
                nodes.forEach(function(d) { d.y = d.depth * 48; });

                // Update the nodes…
                var node = svg.selectAll("g.node")
                    .data(nodes, function(d) { return d.id || (d.id = ++i); });

                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                    .on("click", click);

                nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeEnter.append("text")
                    .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
                    .text(function(d) { return d.name; })
                    .style("fill-opacity", 1e-6);

                // Transition nodes to their new position.
                var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

                nodeUpdate.select("circle")
                    .attr("r", 4.5)
                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                nodeUpdate.select("text")
                    .style("fill-opacity", 1);

                // Transition exiting nodes to the parent's new position.
                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                    .remove();

                nodeExit.select("circle")
                    .attr("r", 1e-6);

                nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

                // Update the links…
                var link = svg.selectAll("path.link")
                    .data(links, function(d) { return d.target.id; });

                // Enter any new links at the parent's previous position.
                link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function(d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

                // Transition links to their new position.
                link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link.exit().transition()
                    .duration(duration)
                    .attr("d", function(d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

                // Stash the old positions for transition.
                nodes.forEach(function(d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            // Toggle children on click.
            function click(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;

                    requestPricehistory(d.symbol);
                }

                update(d);
            }
        }

        // chart an array of prices
        function createChart() {
            console.log("createChartBaby");
            /*for (var i = 0; i < pricehist.length; i++) {
                console.log(pricehist[i].mid);
            }*/

            // set margin around graph & set width & height of graph canvas to reflect this
            var margin = {top: 50, right: 20, bottom: 30, left: 50},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            //  function for recognising datetime values
            parseDate = d3.format();

            // make sure range pixel values fit the x-axis & state that we are using datetime values
            x = d3.time.scale()
                .range([0, width]);

            // make sure range of pixel values fit the y-axis
            y = d3.scale.linear()
                .range([height, 0]);

            // set-up the x-axis
            xaxis = d3.svg.axis().scale(x)
                .orient("bottom").ticks(6);

             // set-up the y-axis
            yaxis = d3.svg.axis().scale(y)
                .orient("left").ticks(6);

            // convert data to work for graph coordinates
            line = d3.svg.line()
                .x(function(d) { return x(d.timestamp); })
                .y(function(d) { return y(d.mid); });

            // create our div
            var divchart = d3.select("body")
                .attr("class", "divchart")
                .append("div");

            var button = divchart.append("button")
                .on('click', function(d,i) {
                    //updateChart();
                    return;
                    // scale the range of the data again
                    x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
                    y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
                    //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

                    var svg = d3.select("body").transition();

                    // change the line
                    svg.select(".line")
                        //.datum(pricehist)
                        .attr("d", line(pricehist));

                    // change the x-axis
                    svg.select(".x.axis")
                        .call(xaxis);

                    // change the y-axis
                    svg.select(".y.axis")
                        .call(yaxis);

                        console.log("updated, i think");
                });

            // add an svg canvas
            var svg = divchart.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // convert data to something usable
            pricehist.forEach(function(d) {
                var dt = new Date(+d.timestamp);
                d.timestamp = parseDate(dt);
                d.mid = +d.mid;
            });

            // set the scope of data values for both axes
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));
            //y.domain([0, d3.max(pricehist, function(d) { return d.bid; })]);

            // add the x-axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xaxis);

            // add the y-axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yaxis);

            // add the line
            svg.append("path")
                .datum(pricehist)
                .attr("class", "line")
                .attr("d", line);

            // title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("id", "textid")
                .attr("text-anchor", "middle")
                .style("font-size", "26px")
                .style("fill", "grey")
                .text("Lloyds - ")
                .append("tspan")
                    .attr("id", "bid")
                    .html("23.10")
                    .style("fill", "red")
                    .style("font-size", "33px")
                    //.text("23.10")
                .append("tspan")
                    .html(" / ")
                    .style("fill", "grey")
                    //.text(" / ")
                .append("tspan")
                    .attr("id", "ask")
                    .html(" 23.25")
                    .style("fill", "blue");
                    //.text(" 23.25");
        }

        function updateChart(prices) {
            console.log("updateChartBaby");
            console.log(prices);

            /*for (var i = 0; i < prices.length; i++) {
                var d = {};
                var dt = new Date(+prices[i].timestamp);

                if ("bid" in prices) {
                    d.bid = prices[i].bid;
                } else {
                    d.bid = prices[i].ask;
                }

                d.timestamp = parseDate(dt);
                d.bid = +d.bid;

                pricehist.push(d);
            }*/

            //var svg = d3.select("body").transition();

            /*svg.select("#textid")
                .text("Lloyds - " + prices[0].bid + " / " + prices[0].ask);*/

            for (var i = 0; i < prices.length; i++) {
                if ("bid" in prices[i]) {
                    d3.select("tspan")
                        .html(prices[i].bid);
                        console.log("updating bid");
                } else {
                    d3.select("#ask")
                        .html(prices[i].ask);
                        console.log("updating ask");
                }
            }

/*
            // re-scale the range of the data again
            x.domain(d3.extent(pricehist, function(d) { return d.timestamp; }));
            y.domain(d3.extent(pricehist, function(d) { return d.mid; }));

            var svg = d3.select("body").transition();

            // update the line
            svg.select(".line")
                //.datum(pricehist)
                .attr("d", line(pricehist));

            // reset the x-axis
            svg.select(".x.axis")
                .call(xaxis);

            // reset the y-axis
            svg.select(".y.axis")
                .call(yaxis);
*/
            //console.log(line);
        }

        function requestQuote(symbol) {
            var fields = ["Quantity"]; // one per row

            var cashorshares = ["Number of shares", "Cash amount"];
            var qtycashorshares = ["Quantity", "Cash"];

            // create a table
            var tblrfq = d3.select("#divcontainer")
                .append("table")
                .attr("class", "tblrfq");

            // add header & body
            var thead = tblrfq.append("thead");
            var tbody = tblrfq.append("tbody");

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(fields)
                .enter()
                .append("tr");

            // option to select cash or shares
            var selcashorshares = rows.append("td")
                .append("select")
                    .attr("id", "selcashorshares")
                    .on("change", function() {
                        var rfqqty = d3.select("#rfqqty");
                        if (this.value == cashorshares[0]) {
                            rfqqty.attr("placeholder", qtycashorshares[0]);
                        } else {
                            rfqqty.attr("placeholder", qtycashorshares[1]);
                        }
                        d3.select("#rfqqty").node().focus();
                    });

            selcashorshares.append("option")
                        .text(cashorshares[0]);

            selcashorshares.append("option")
                        .text(cashorshares[1]);

            // quantity
            rows.append("td")
                .append("input")
                    .attr("id", "rfqqty")
                    .attr("placeholder", qtycashorshares[0]);

            // add a button, with associated function to send rfq
            rows.append("td")
                .append("input")
                    .attr("type", "button")
                    .attr("value", "Send")
                    .attr("class", "rfqbutton")
                    .on("click", function() {
                        if (!validateRfq()) {
                            d3.select("#rfqqty").node().focus();
                        } else {
                            sendRfq();
                            d3.select(this)
                                .style("cursor", "default")
                                .attr("disabled", null)
                                .on("click", null);
                        }
                    });

            d3.select("#rfqqty").node().focus();

            function validateRfq() {
                var quantity = d3.select("#rfqqty").node().value;

                // validate qty
                if (quantity == "") {
                    alert("Please enter a number");
                    return false;
                } else if (isNaN(quantity)) {
                    alert("Quantity must be numeric");
                    return false;
                } else if (quantity <= 0) {
                    alert("Quantity must be greater than zero");
                    return false;
                }

                return true
            }

            function sendRfq() {
                var rfq = {};

                // quantity as cash or shares
                var selcashorshares = d3.select("#selcashorshares");
                var quantity = d3.select("#rfqqty").node().value;

                if (selcashorshares.node().value == cashorshares[0]) {
                    rfq.cashorderqty = "";
                    rfq.quantity = quantity;
                } else {
                    rfq.cashorderqty = quantity;
                    rfq.quantity = "";                    
                }

                rfq.clientid = clientid;
                rfq.symbol = symbol;
                rfq.currency = "GBP"; // todo
                rfq.settlcurrency = "GBP"; // todo
                rfq.nosettdays = 2;
                rfq.operatortype = operatortype;
                rfq.operatorid = clientid;
                //rfq.futsettdate = this.value;

                console.log(rfq);
                sockjs.send("{\"quoterequest\":" + JSON.stringify(rfq) + "}");
            }
        }

        function displayForm(symbol) {
            var data = [11, 22, 33, 44];
            /*var labeldata = ["test1", "test2"];

            console.log("displayForm:" + symbol);

            var form = d3.select("body")
                .append("form");

            form.selectAll("label")
                .data(labeldata)
                .enter()
                .append("label")
                .text("test2");*/

            d3.select("body").selectAll("input")
                .data(data)
                .enter()
                .append('label')
                    .attr('for',function(d,i){ return 'a'+i; })
                    .text(function(d) { return d; })
                .append("input")
                    .attr("checked", true)
                    .attr("type", "checkbox")
                    .attr("id", function(d,i) { return 'a'+i; })
                    .attr("onClick", "change(this)");

        }

        function displayTable(data) {
            console.log("displayTable");

            var columns = ["key", "value"];

            // create a table
            var table = d3.select("body")
                .append("table");
                //.attr("style", "margin-left: 250px");

            // add header & body
            var thead = table.append("thead");
            var tbody = table.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                    .text(function(column) { return column; });

            // create a row for each field
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return columns.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                 })
                .enter()
                .append("td")
                    .text(function(d) { console.log(d); return d.value; });

            return tbody;
        }

        function getDateString(utcdatetime) {
            return (utcdatetime.substr(0,4) + "/" + utcdatetime.substr(4,2) + "/" + utcdatetime.substr(6,2) + " " + utcdatetime.substr(9,8));
        }

        function getSeconds(startutctime, finishutctime) {
            var startdt = new Date(getDateString(startutctime));
            var finishdt = new Date(getDateString(finishutctime));
            return ((finishdt - startdt) / 1000);
        }

        /*function quoteReceived(quote) {
            console.log("quote received");
            console.log(quote);

            quotes.push(quote);

            // get the number of seconds the quote is valid for
            var noseconds = getSeconds(quote.transacttime, quote.validuntiltime);

            var tbody = d3.select("tbody");

            var row = tbody.append("tr");

            // add a buy button
            row.append("td")
                    .append("input")
                        .attr("type", "button")
                        .attr("value", "Buy " + quote.offerquantity + " @ " + quote.offerpx)
                        .attr("class", "tradebutton buybutton")
                        .on("click", function() {
                            sendOrder(quote.symbol, '1', quote.offerquantity, quote.offerpx, 'D', "", quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "");
                            disable();
                            lblseconds.text("Order sent, please wait...");
                        });

            // add a label for time remaining
            var lblseconds = row.append("td")
                .attr("id", "lblseconds")
                .text("Seconds remaining: " + noseconds);

            // add a sell button
            row.append("td")
                .append("input")
                    .attr("type", "button")
                    .attr("value", "Sell " + quote.bidquantity + " @ " + quote.bidpx)
                    .attr("class", "tradebutton sellbutton")
                    .on("click", function() {
                        sendOrder(quote.symbol, '2', quote.bidquantity, quote.bidpx, 'D', "", quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "");
                        disable();
                        lblseconds.text("Order sent, please wait...");
                    });

            // function to count down seconds remaining
            var quotetimer = setInterval(function() {
                noseconds -= 1;
                if (noseconds == 0) {
                    disable();
                    lblseconds.text("Quote Expired");
                } else {
                    lblseconds.text("Seconds remaining: " + noseconds);
                }
            }, 1000);

            // nothing done, so tidy
            function disable() {
                clearInterval(quotetimer);

                // disable both buy & sell buttons
                d3.selectAll(".tradebutton")
                    .style("cursor", "default")
                    .disabled = true;
            }
        }*/

        function sendOrder(symbol, side, quantity, price, ordertype, delivertocompid, settlcurrency, nosettdays, settdate, quoteid, timeinforce, expiredate, expiretime) {
            var order = {};

            order.clientid = clientid;
            order.side = side;
            order.symbol = symbol;
            order.quantity = quantity;
            order.price = price;
            order.currency = "GBP"; // todo - use quote currency? instruments[symbol].currency;
            order.ordertype = ordertype;
            order.delivertocompid = delivertocompid;
            order.settlcurrency = settlcurrency;
            order.nosettdays = nosettdays;
            order.futsettdate = settdate;
            order.quoteid = quoteid;
            order.timeinforce = timeinforce;
            order.expiredate = expiredate;
            order.expiretime = expiretime;
            order.operatortype = operatortype;
            order.operatorid = clientid;

            sockjs.send("{\"order\":" + JSON.stringify(order) + "}");
        }

        function orderReceived(order) {
            console.log("orderReceived");
            console.log(order);

            if (order.status == "8") {
                var msg = "Order rejected";

                if ("text" in order) {
                    msg += ": " + order.text;
                }

                d3.select("#divquote")
                    .append("p")
                    .html(msg);
            }
        }

        function tradeReceived(trade) {
            console.log(trade);

            var tbldata = [];

            d3.select("#lblseconds")
                .text("Order filled");

            for (var key in trade) {
                if (trade.hasOwnProperty(key)) {
                    var elem = {};
                    elem.key = key;
                    elem.value = trade[key];
                    tbldata.push(elem);
                }
            }

            displayTable(tbldata);
        }

        function selectSymbol() {
            var symboldata = [];

            var stockboxdiv = d3.select("#divcontainer")
            //var stockboxdiv = d3.select("body")
                .append("div")
                .attr("id", "stockboxdiv")
                .attr("class", "stockboxdiv");

            //var stockboxinput = stockboxdiv.append("input")
            var stockboxinput = stockboxdiv
                .append("input")
                .attr("id", "stockboxinput")
                .attr("class", "stockboxinput")
                .attr("placeholder", "Enter Symbol")
                .on("keyup", function() {
                    buildList(this.value);
                    displayList();
                });

            /*var stocklist = stockboxdiv.append("ul")
                .attr("id", "stocklist")
                .attr("class", "stocklist");*/

            d3.select("#stockboxinput").node().focus();      

            function buildList(searchtext) {
                // clear array
                symboldata = [];

                if (searchtext == "") return;

                // lower case to match on
                searchtext = searchtext.toLowerCase();
                var searchtextlen = searchtext.length;

                // match with instruments
                for (var i in instruments) {
                    if (instruments[i].description.toLowerCase().substr(0, searchtextlen) == searchtext) {
                        var elem = {};
                        elem.name = instruments[i].description + " - " + instruments[i].symbol;
                        symboldata.push(elem);
                    }
                }
            }

            function displayList() {
                var stocklist = d3.select("#stocklist");

                if (symboldata.length == 0) {
                    // clear the list if no data
                    if (!stocklist.empty()) {
                        stocklist.remove();
                    }
                } else {
                    // create the list if necessary
                    if (stocklist.empty()) {
                        stocklist = d3.select("#stockboxdiv").append("ul")
                            .attr("id", "stocklist")
                            .attr("class", "stocklist");
                    }
                }

                // update
                var stockitems = stocklist.selectAll("li")
                    .data(symboldata)
                        .text(function(d) { return d.name; });

                // enter
                stockitems.enter()
                    .append("li")
                        .text(function(d) { return d.name; })
                        .on("click", function(d, i) {
                            var lastspace = this.innerHTML.lastIndexOf(' ');
                            var symbol = this.innerHTML.substr(lastspace+1);

                            // request a symbol
                            requestOrderbook(symbol);

                            // clear array
                            symboldata = [];

                            // clear display
                            displayList();
                        });

                // exit
                stockitems.exit().remove();
            }
        }

        function countdownQuotes(quoteobj) {
            if (quoteobj.noseconds > 0) {
                quoteobj.noseconds--;
            } else {
                clearInterval(quoteobj.interval);
            }
        }

        /*function countdownQuotes(bidoffer, index) {
            //console.log(bidoffer);
            //console.log(index);
            if (bidoffer == "bid") {
                if (quotes[index].bidnoseconds > 0) {
                    quotes[index].bidnoseconds--;
                } else {
                    //console.log("clear bid interval");
                    clearInterval(quotes[index].bidinterval);
                }
            } else {
                if (quotes[index].offernoseconds > 0) {
                    quotes[index].offernoseconds--;
                } else {
                    //console.log("clear offer interval");
                    clearInterval(quotes[index].offerinterval);                    
                }
            }
        }*/

        function quoteReceived(quote) {
            console.log("quoteReceived");
            console.log(quote);

            // see if it is my quote
            if (quote.qclientid == clientid) {
                quoteresponseReceived(quote);
            } else {
                // update quote array
                updateQuoteLadder(quote);

                // update display
                updateQuoteTable();
            }
        }

        //
        // update a ladder of quotes & start a timer for each quote
        //
        function updateQuoteLadder(quote) {
            // we create either a bid or offer quote for a quote level
            var cols = ["bidquote", "offerquote"];
            var updated = false;

            // calculate the duration of the quote
            quote.noseconds = getSeconds(quote.transacttime, quote.validuntiltime);

            // see if we can add the quote to an existing quote level
            for (var i = 0; i < quotes.length; i++) {
                if (quote.bidpx != "") {
                    if (!(cols[0] in quotes[i])) {
                        quotes[i].bidquote = quote;
                        startQuoteInterval(quotes[i].bidquote);
                        updated = true;
                        break;
                    }
                } else {
                    if (!(cols[1] in quotes[i])) {
                        quotes[i].offerquote = quote;
                        startQuoteInterval(quotes[i].offerquote);
                        updated = true;
                        break;
                    }           
                }
            }

            // create a new level, if necessary
            if (!updated) {
                quotes.push([]);

                if (quote.bidpx != "") {
                    quotes[quotes.length - 1].bidquote = quote;
                    startQuoteInterval(quotes[i].bidquote);
                } else {
                    quotes[quotes.length - 1].offerquote = quote;
                    startQuoteInterval(quotes[i].offerquote);
                }
            }
        }

        //
        // update quotes array in a 'ladder' format
        //
        /*function updateQuoteLadder(quote) {
            var bidupdated = false;
            var offerupdated = false;
            var indexupdated;

            if (quote.bidpx == "") { bidupdated = true };
            if (quote.offerpx == "") { offerupdated = true };

            // may have a one or two-way quote
            for (var i = 0; i < quotes.length; i++) {
                // add bid quote to existing 'highest level' quote, if there is one
                if (quote.bidpx != "" && quotes[i].bidpx == "") {
                    quotes[i].bidpx = quote.bidpx;
                    quotes[i].bidsize = quote.bidsize;
                    quotes[i].bidquantity = quote.bidquantity;
                    quotes[i].bidnoseconds = getSeconds(quote.transacttime, quote.validuntiltime);
                    quotes[i].bidquoteid = quote.quoteid;
                    bidupdated = true;
                    startQuoteInterval("bid", i);
                }

                // add offer quote to existing 'highest level' quote, if there is one
                if (quote.offerpx != "" && quotes[i].offerpx == "") {
                    quotes[i].offerpx = quote.offerpx;
                    quotes[i].offersize = quote.offersize;
                    quotes[i].offerquantity = quote.offerquantity;
                    quotes[i].offernoseconds = getSeconds(quote.transacttime, quote.validuntiltime);
                    quotes[i].offerquoteid = quote.quoteid;
                    offerupdated = true;
                    startQuoteInterval("offer", i);
                }
            }

            // create a new quote & add to array
            if (!bidupdated || !offerupdated) {
                var newquote = {};

                newquote.symbol = quote.symbol;
                newquote.settlcurrency = quote.settlcurrency;
                newquote.nosettdays = quote.nosettdays;
                newquote.futsettdate = quote.futsettdate;
                //newquote.quoteid = quote.quoteid;
                newquote.bidpx = "";
                newquote.bidsize = "";
                newquote.bidquantity = "";
                newquote.offerpx = "";
                newquote.offersize = "";
                newquote.offerquantity = "";

                if (!bidupdated) {
                    newquote.bidpx = quote.bidpx;
                    newquote.bidsize = quote.bidsize;
                    newquote.bidquantity = quote.bidquantity;
                    newquote.bidnoseconds = getSeconds(quote.transacttime, quote.validuntiltime);
                    newquote.bidquoteid = quote.quoteid;
                }

                if (!offerupdated) {
                    newquote.offerpx = quote.offerpx;
                    newquote.offersize = quote.offersize;
                    newquote.offerquantity = quote.offerquantity;
                    newquote.offernoseconds = getSeconds(quote.transacttime, quote.validuntiltime);
                    newquote.offerquoteid = quote.quoteid;
                }

                // add to array
                quotes.push(newquote);

                // start interval
                if (!bidupdated) {
                    startQuoteInterval("bid", quotes.length - 1);
                }
                if (!offerupdated) {
                    startQuoteInterval("offer", quotes.length - 1);
                }
            }
        }*/

        function updateQuoteTable() {
            var cols = ["bidquote", "offerquote"];

            // create a quote table if one does not exist
            var tblquote = d3.select("#tblquote");
            if (tblquote.empty()) {
                createQuoteTable();
            }

            // base the table on the quotes array
            var rows = d3.select("#tblquote").select("tbody").selectAll("tr")
                .data(quotes);

            // create a new row for each quote level (my be bid/offer/both)
            rows.enter()
                .append("tr")
                .attr("class", "tblquote");

                console.log(cols);

            var cells = rows.selectAll("td")
                .data(function(row) {
                    if (cols[0] in row) {
                        if (cols[1] in row) {
                            return [{col: cols[0], value: row[cols[0]]},{col: cols[1], value: row[cols[1]]}];
                        } else {
                            return [{col: cols[0], value: row[cols[0]]}];
                        }
                    } else {
                            return [{col: cols[1], value: row[cols[1]]}];
                    }
                    //return cols.map(function(col) {
                        /*var ret = "";
                        if (col == "bid") {
                            if (row.bidpx != "") {
                                ret = "Sell " + row.bidquantity + " @ " + row.bidpx + " - " + row.bidnoseconds + " Seconds";
                            }
                        } else {
                            if (row.offerpx != "") {
                                ret = "Buy " + row.offerquantity + " @ " + row.offerpx + " - " + row.offernoseconds + " Seconds";
                            }
                        }*/
                        //return {col: col, value: row[col]};
                        //var ret = null;
                        //if (col in row) {
                            //ret = row[col];
                            //return {col: col, value: row[col]};
                        //}
                        //return {col: col, value: ret};
                    //});
                 });
//console.log(cells);

            cells.enter()
                .append("td")
                .append("input")
                    .attr("type", "button");

            cells.each(function(d, i, j) { // i=column, j=row
                console.log("each");
                console.log(d);
                console.log(i);
                console.log(j);
                var txt;
                if (d.col == cols[0]) {
                    txt = "Sell " + d.value.bidquantity + " @ " + d.value.bidpx + " - " + d.value.noseconds + " Seconds";
                } else {
                    txt = "Buy " + d.value.offerquantity + " @ " + d.value.offerpx + " - " + d.value.noseconds + " Seconds";                    
                }

                d3.select(this).select("input")
                    .attr("value", txt);
            });
        }

        /*function updateQuoteTable() {
            var cols = ["bid", "offer"];

            // create a quote table if one does not exist
            var tblquote = d3.select("#tblquote");
            if (tblquote.empty()) {
                createQuoteTable();
            }

            // base the table on the quotes array
            var rows = d3.select("#tblquote").select("tbody").selectAll("tr")
                .data(quotes);

            // create a new row for each quote
            rows.enter()
                .append("tr")
                .attr("class", "tblquote");

            // update quote button text
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret = "";
                        if (col == "bid") {
                            if (row.bidpx != "") {
                                ret = "Sell " + row.bidquantity + " @ " + row.bidpx + " - " + row.bidnoseconds + " Seconds";
                            }
                        } else {
                            if (row.offerpx != "") {
                                ret = "Buy " + row.offerquantity + " @ " + row.offerpx + " - " + row.offernoseconds + " Seconds";
                            }
                        }
                        //return {col: col, value: row[col]};
                        return {col: col, value: ret};
                    });
                 })
                .each(function(d, i, j) { // i=column, j=row
                    console.log("update");
                    console.log(d);
                    //console.log(this.value);
                    //console.log(d3.select(this).size());
                    //console.log(d3.select(this).node());
                    if (d.value != "") {
                        console.log("vis");
                        d3.select(this).select("input")
                            .attr("visibility", "visible")
                            .attr("value", function(d) { return d.value; });
                    } else {
                        console.log("hid");
                        d3.select(this).select("input")
                            .attr("visibility", "hidden");
                    }
                    //var t = d3.select(this).property("value");
                    //console.log(t);
                    //d3.select(this)//.property("value", "test")
                        //.attr("value", "test");//function(d) { return d.value; });
                });

            // create quote buttons
            cells.enter()
                .append("td")
                .append("input")
                    .attr("type", "button")
                    .attr("value", function(d) { return d.value; })
                    .on("click", function(d, i, j) { // i=col, j=row
                        //var order = {};
                        console.log("clicked");
                        console.log(d);
                        console.log(i);
                        console.log(j);
                        if (d.col == "bid") {
                            sendOrder(quotes[j].symbol, '2', quotes[j].bidquantity, quotes[j].bidpx, 'D', "", quotes[j].settlcurrency, quotes[j].nosettdays, quotes[j].futsettdate, quotes[j].bidquoteid, "4", "", "");

                            // stop timer
                            clearInterval(quotes[j].bidinterval);
                        } else {
                            sendOrder(quotes[j].symbol, '1', quotes[j].offerquantity, quotes[j].offerpx, 'D', "", quotes[j].settlcurrency, quotes[j].nosettdays, quotes[j].futsettdate, quotes[j].offerquoteid, "4", "", "");

                            // stop timer
                            clearInterval(quotes[j].offerinterval);
                        }

                        // remove the event listener
                        d3.select(this)
                            .on('click', null);

                        // disable button
                        d3.select(this)
                            .style("cursor", "default")
                            .attr("disabled", null);
                    });
        }*/

        function createQuoteTable() {
            console.log("createQuoteTable");
            var hdr = ["Quotes"];

            // quote div
            var divquote = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquote");

            // create a table
            var tblquote = divquote.append("table")
                .attr("id", "tblquote");

            // add header & body
            var thead = tblquote.append("thead");
            var tbody = tblquote.append("tbody");

            // add header
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    .attr("class", "tblquotehdr")
                    .text(function(d) { return d; });
        }

        function startQuoteInterval(quoteobj) {
            var interval = setInterval(function() {
                countdownQuotes(quoteobj);
                updateQuoteTable();
            }, 1000);

            // keep track of timer
            quoteobj.interval = interval;
        }

        // function to count down seconds remaining per quote
        /*function startQuoteInterval(bidoffer, index) {
            var quoteinterval = setInterval(function() {
                countdownQuotes(bidoffer, index);
                updateQuoteTable();
            }, 1000);

            // keep track of timers as there may be more than one
            if (bidoffer == "bid") {
                quotes[index].bidinterval = quoteinterval;
            }
            if (bidoffer == "offer") {
                quotes[index].offerinterval = quoteinterval;
            }
        }*/

        function quoterequestReceived(quoterequest) {
            console.log("quoterequestReceived");
            console.log(quoterequest);

            // todo: get from price
            quoterequest.bidpx = 1.23; //prices[quoterequest.symbol].bid;
            quoterequest.offerpx = 1.25; //prices[quoterequest.symbol].ask;
            //quoterequest.quoted = false;

            // add quote request to global array
            quoterequests.push(quoterequest);

            // update display
            updateQuoterequestTable();
        }

        function updateQuoterequestTable() {
            //input type="number" min="0" max="360" step="5" value="0" id="nValue"

            var cols = ["buybutton", "timestamp", "quantity", "sellbutton", "quoted"];
            var buysell = ["buy", "sell"];

            // create a quoterequest table if one does not exist
            var tblquoterequest = d3.select("#tblquoterequest");
            if (tblquoterequest.empty()) {
                createQuoterequestTable();
            }

            // create a row for each quote
            var rows = d3.select("#tblquoterequest").select("tbody").selectAll("tr")
                .data(quoterequests);

            // enter
            rows.enter()
                .append("tr");

            // columns
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret;
                        if (col == "") {
                            ret = "";
                        } else {
                            ret = row[col];
                        }
                        return {col: col, value: ret};
                    });
                });

            // update
            /*cells.each(function(d, i, j) {
                console.log("update?");
                if (d.column == "quoted" && d.value == true) {
                    if (d3.select("inpprice" + j).empty()) {
                        var buysellselect = d3.select(this)
                            .append("select")
                            .attr("id", "buysellselect")
                            .on("change", function() { console.log(this.value); });

                        buysellselect.append("option")
                            .text("Buy")
                            .attr('value', "buy");

                        buysellselect.append("option")
                            .text("Sell")
                            .attr('value', "sell");

                        d3.select(this)
                            .append("input")
                            .attr("id", "inpprice" + j)
                            .attr("type", "number")
                            .attr("step", "0.01")
                            .attr("value", function(d) { return quoterequests[j].bidpx; });

                        d3.select(this)
                            .append("input")
                            .attr("id", "inpquantity" + j)
                            .attr("type", "number")
                            .attr("step", "10")
                            .attr("value", function(d) { return quoterequests[j].quantity; });

                        d3.select(this)
                            .append("input")
                            .attr("type", "button")
                            .attr("value", "Send")
                            .on("click", function() {
                                console.log(d);
                                console.log(i);
                                console.log(j);
                                sendQuote(j);
                        });
                    }
                }
            });*/

            // enter - create columns
            var cellsenter = cells.enter()
                .append("td");

            // enter - add variable inputs such as text/buttons
            cellsenter.each(function(d, i, j) {
                console.log("enter & update?");
                console.log(d);
                if (d.col == "timestamp" || d.col == "quantity") {
                    d3.select(this)
                        .html(function(d) { return d.value; });
                } else if (d.col == "buybutton") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("value", "Place a Buy Quote")
                        .on("click", function() {
                            console.log("clicked");
                            console.log(d);
                            console.log(i);
                            console.log(j);
                            //cols.push("test");
                            //quoterequests[j].quoted = true;

                            // todo: needed?
                            //updateQuoterequestTable();
                            updateMyQuoteTable(1, j);
                        });
                } else if (d.col == "sellbutton") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .attr("value", "Place a Sell Quote")
                        .on("click", function() {
                            console.log("clicked");
                            console.log(d);
                            console.log(i);
                            console.log(j);
                            //cols.push("test");
                            //quoterequests[j].quoted = true;

                            // todo: needed?
                            //updateQuoterequestTable();
                            updateMyQuoteTable(2, j);
                        });
                }
            });

            // exit
            cells.exit().remove();

            /*function sendQuote(j) {
                var quote = {};

                var price = d3.select("#inpprice" + j).node().value;
                var quantity = d3.select("#inpquantity" + j).node().value;

                console.log(d3.select("#buysellselect").node().value);

                if (d3.select("#buysellselect").node().value == "buy") {
                    quote.bidpx = price;
                    quote.bidsize = quantity;
                } else {
                    quote.offerpx = price;
                    quote.offersize = quantity                    
                }

                quote.symbol = quoterequests[j].symbol;
                quote.currency = "GBP"; // todo - use quote currency? instruments[symbol].currency;
                quote.settlcurrency = quoterequests[j].settlcurrency;
                quote.futsettdate = quoterequests[j].futsettdate;
                quote.noseconds = 30;
                quote.operatortype = operatortype;
                quote.operatorid = clientid;
                quote.qbroker = qbroker;
                quote.qclientid = clientid;
                quote.quotereqid = quoterequests[j].quotereqid;

                console.log(quote);

                sockjs.send("{\"quote\":" + JSON.stringify(quote) + "}");
            }*/
        }

        function createQuoterequestTable() {
            console.log("createQuoterequestTable");
            //var hdr = ["Timestamp", "Quantity", "Buy Price", "Buy Size", "Valid For (Secs)", "", "Sell Price", "Sell Size", "Valid For (Secs)", ""];
            var hdr = ["","Placed", "Quantity"];

            var divquoterequest = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquoterequest");

            // create a table
            var tblquoterequest = divquoterequest.append("table")
                .attr("id", "tblquoterequest");

            // add header & body
            var thead = tblquoterequest.append("thead");
            var tbody = tblquoterequest.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    .attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });
        }

        function updateMyQuoteTable(side, index) {
            var cols = ["quantity","price","send"];
            var buysell;

            if (side == 1) {
                buysell = "Buy";
            } else {
                buysell = "Sell";                        
            }

            // create a myquote table if one does not exist
            var tblmyquote = d3.select("#tblmyquote");
            if (tblmyquote.empty()) {
                createMyQuoteTable();
            }

            // create a row for each quote
            var rows = d3.select("#tblmyquote").select("tbody").selectAll("tr")
                .data(myquotes);

            // enter
            rows.enter()
                .append("tr");

            // columns
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(col) {
                        var ret;
                        if (col == "") {
                            ret = "";
                        } else {
                            ret = row[col];
                        }
                        return {col: col, value: ret};
                    });
                });

            // add columns
            var cellsenter = cells.enter().append("td");

            // add text/buttons
            cellsenter.each(function(d,i,j) {
                if (d.col == "quantity") {
                    d3.select(this)
                        .append("input")
                        .attr("id", "inpquantity")
                        .attr("type", "number")
                        .attr("step", "10")
                        .attr("value", function(d) { return quoterequests[index].quantity; });
                } else if (d.col == "price") {
                    d3.select(this)
                        .append("input")
                        .attr("id", "inpprice")
                        .attr("type", "number")
                        .attr("step", "0.01")
                        .attr("value", function(d) { return quoterequests[index].bidpx; });
                } else if (d.col == "send") {
                    d3.select(this)
                        .append("input")
                        .attr("type", "button")
                        .on("click", function() {
                            console.log(d);
                                console.log(i);
                                console.log(j);
                            sendQuote(side, index);
                        });
                }
            });

            // update button text
            cells.each(function(d,i,j) {
                if (d.col == "send") {
                    d3.select(this).select("input")
                        .attr("value", "Send " + buysell + " Quote");
                }
            });

            function sendQuote(side, index) {
                var quote = {};

                var price = d3.select("#inpprice" + j).node().value;
                var quantity = d3.select("#inpquantity" + j).node().value;

                //console.log(d3.select("#buysellselect").node().value);

                if (side == 1) { // buy
                    quote.bidpx = price;
                    quote.bidsize = quantity;
                } else {
                    quote.offerpx = price;
                    quote.offersize = quantity                    
                }

                quote.symbol = quoterequests[index].symbol;
                quote.currency = "GBP"; // todo - use quote currency? instruments[symbol].currency;
                quote.settlcurrency = quoterequests[index].settlcurrency;
                quote.futsettdate = quoterequests[index].futsettdate;
                quote.noseconds = 30;
                quote.operatortype = operatortype;
                quote.operatorid = clientid;
                quote.qbroker = qbroker;
                quote.qclientid = clientid;
                quote.quotereqid = quoterequests[index].quotereqid;

                console.log(quote);

                sockjs.send("{\"quote\":" + JSON.stringify(quote) + "}");
            }            
        }

        function createMyQuoteTable() {
            console.log("createMyQuoteTable");

            var hdr = ["Quantity", "price"];

            var divmyquote = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divmyquote");

            // create a table
            var tblmyquote = divmyquote.append("table")
                .attr("id", "tblmyquote");

            // add header & body
            var thead = tblmyquote.append("thead");
            var tbody = tblmyquote.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    //.attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });
        }

        //
        // my quote returned
        //
        function quoteresponseReceived(quote) {
            console.log("quoteresponseReceived");
            console.log(quote);

            // add quote response to global array
            quoteresponses.push(quote);

            // update display
            updateQuoteresponseTable();
        }

        function updateQuoteresponseTable() {
            console.log("updateQuoteresponseTable");

            var cols = ["transacttime","bidpx","bidquantity"];

            // create a quoteresponse table if one does not exist
            var tblquoteresponse = d3.select("#quoteresponse");
            if (tblquoteresponse.empty()) {
                createQuoteresponseTable();
            }

            // create a row for each quote response
            var rows = d3.select("#tblquoteresponse").select("tbody").selectAll("tr")
                .data(quoteresponses);

            // enter
            rows.enter()
                .append("tr");

            // update
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return cols.map(function(column) {
                        return {column: column, value : row[column]};
                    });
                })
                .enter()
                .append("td")
                    .text(function(d) { console.log(d);return d.value; });
        }

        function createQuoteresponseTable() {
            console.log("createQuoteresponseTable");

            var hdr = ["test1", "test2", "test3"];

            var divquoteresponse = d3.select("#divcontainer")
                .append("div")
                .attr("id", "divquoteresponse");

            // create a table
            var tblquoteresponse = divquoteresponse.append("table")
                .attr("id", "tblquoteresponse");

            // add header & body
            var thead = tblquoteresponse.append("thead");
            var tbody = tblquoteresponse.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(hdr)
                .enter()
                .append("th")
                    //.attr("class", "tblquoterequesthdr")
                    .text(function(d) { return d; });
        }

            // create a row for each quote
            /*var rows = tbody.selectAll("tr")
                .data(quoterequests)
                .enter()
                .append("tr");*/

            // create a cell in each row for each quote column
            /*var cells = rows.selectAll("td")
                .data(function(d) { return d; })*/
                /*.data(function(row) {
                    return cols.map(function(col) {
                        return {col: col, value: row[col]};
                    });
                 })*/
                /*.enter()
                .append("td")
                .each(function(d, i, j) { // i=column, j=row
                    console.log(d);
                    console.log(i);
                    console.log(j);
                    if (i == 0) {
                        // text in first column
                        d3.select(this)
                            .text(function(d) { return d; });
                    } else if (i == 1) {
                        // input fields in second column
                        d3.select(this)
                            .append("input")
                            .attr("type", function(d) { return "button"; });
                    }
                });*/

                /*.append("td")
                    .text(function(d, i) { return d.value; });*/

            // create a cell & button in each row for each button column
            /*cells = rows.selectAll("td")
                .data(buttons);*/
                /*.data(function(row) {
                    return buttons.map(function(col) {
                        return col;
                        //return {col: col, value: row[col]};
                    });
                 })*/
                /*cells.enter()
                .append("td")
                    .text("test");*/
                    /*.append("input")
                        .attr("type", "button")
                        .attr("value", function(d, i) { console.log(d);return d; });*/

            /*var cells = rows.selectAll("td")
                .data(function(d) { return d; })
                .enter()
                .append("td")
                .each(function(d, i, j) { // i=column, j=row
                    if (i == 0) {
                        // text in first column
                        d3.select(this)
                            .text(function(d) { return d; });
                    } else if (i == 1) {
                        // input fields in second column
                        d3.select(this)
                            .append("input")
                            .attr("type", function(d) { return inputtypes[j]; });
                    }
                });*/

            /*cells.selectAll("td")
                .data(buttons)
                .each(function(d) { console.log(d) });*/
                /*.enter()
                .append("input")
                    .attr("type", "button")
                    .attr("class", "tradebutton sellbutton")
                    .attr("value", "test");*/

            /*cells.each(function(d) {
                console.log(d);
                console.log(this);
                d3.select(this)
                    .append("input")
                        .attr("type", "button")
                    .attr("class", "tradebutton sellbutton")
                        .attr("value", "test");
                    });*/

            /*cells.selectAll("input")
                .data(buttons)
                .enter()
                .append("input")
                    .attr("type", "button")
                    .attr("value", function(d) { return d; });*/


        //
        // sign-in form
        //
        function displayFormSignin() {
            var signindiv = d3.select("body")
                .append("div")
                .attr("id", "signindiv")
                .attr("class", "signindiv");

            signindiv.append("p")
                .attr("class", "signintitle")
                .html("Cantwaittotrade");

            var signinemail = signindiv.append("input")
                .attr("id", "signinemail")
                .attr("class", "signininput")
                .attr("placeholder", "Email");

            var signinpwd = signindiv.append("input")
                .attr("id", "signinpwd")
                .attr("class", "signininput")
                .attr("type", "password")
                .attr("placeholder", "Password");

            signindiv.append("input")
                .attr("type", "button")
                .attr("value", "Sign In")
                    .attr("class", "signinbutton")
                    .on("click", function() {
                        var signin = {};
                        signin.email = document.getElementById("signinemail").value;
                        signin.password = document.getElementById("signinpwd").value;
                        sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");
                    });

            d3.select("#signinemail").node().focus();
        }

        //
        // signin reply
        //
        function replySignin(reply) {
            if (reply.success) {
                clientid = reply.clientid;
                email = reply.email;

                // clear the sign in form
                d3.select("#signindiv").remove();

                start();
            } else {
                // signin failed
                d3.select("#signindiv")
                    .append("p")
                    .html("Sign in failed, please try again");

                d3.select("#signinemail").node().focus();
            }
        }

        function statusReceived(status) {
            console.log(status);
        }

        function quoteackReceived(quoteack) {
            console.log("quoteackReceived");
            console.log(quoteack);

            d3.select("body")
                .append("p")
                .html("Quote request rejected: " + quoteack.text);
        }

        function positionRequest() {
            var positionrequest = {};

            sockjs.send("{\"positionrequest\":" + JSON.stringify(positionrequest) + "}");
        }

        function positionsReceived(positions) {
            console.log("positionsReceived");
            console.log(positions);
        }
     </script>
</body>
</html>