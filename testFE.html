<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>cw2t online client v10.0 ALPHA TEST ONLY</title>
    <script src="https://d1fxtkz8shb9d2.cloudfront.net/sockjs-0.3.js"></script>
    <link href="testfe.css" rel="stylesheet" type="text/css" />
</head>

<body lang="en" style="color: white; width: 100%; border: 0px; left: 0px; margin: 0px">
    <div id="heading">
        <div id="cw2t" class="cw2t">
          <img border="0" src="testfelogo.jpg"></div>
    </div>
    <div id="main" class="main">
    </div>
    <script>
        var sockjs_url = 'https://54.76.12.182/echo';
        //var sockjs_url = 'https://54.229.76.60/echo';
        //var sockjs_url = 'https://localhost/echo';
        //var sockjs_url = '/echo';
        var sockjs;
        var selectedmenu = -1;
        var selectedlistelement = 0;
        var placeneworder = false;
        var orders = {};
        var orderbooks = {};
        var positions = {};
        var reserves = {};
        var cash = {};
        var margins = {};
        var trades = {};
        var instruments = {};
        var obdisplay = {};
        var ordervol = {};
        var ordertypes = {};
        var quotes = {};
        var indices = {};
        var timeinforces = {};
        var lastElement = null;
        var lastsymbol = null;
        var extendedsettlement = false;
        var defaultsettlcurrency = "GBP";
        var monthtext = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
        var pricetimer;
        var priceflash = {};
        var heartbeattimer = null;
        var inconnectiontest = false;
        var restarttimer;
        var operatortype = 1; // client
        var clientid;
        var account = {};
        var quoterequests = {};
        var cashhistory = {};
        var showvolume = false;
        var quotetimer;
        var loggedout;
        var coheading = "cant wait to trade";
        var touchdevice = false;

        // redefine console.log for IE
        if (typeof console == "undefined")
            var console = { log: function () { } };

        var datain = function (msg) {
            try {
                var obj = JSON.parse(msg);

                if ("orderbooks" in obj) {
                    clearOrderBooks();
                    loadOrderBooks(obj.orderbooks);
                } else if ("orderbook" in obj) {
                    updateOrderBook(obj.orderbook);
                } else if ("orders" in obj) {
                    clearOrders();
                    loadOrders(obj.orders);
                    displayOrders();
                } else if ("ordercancelreject" in obj) {
                    orderCancelReject(obj.ordercancelreject);
                } else if ("ordertypes" in obj) {
                    loadOrderTypes(obj.ordertypes);
                } else if ("order" in obj) {
                    updateOrder(obj.order);
                } else if ("trades" in obj) {
                    clearTrades();
                    loadTrades(obj.trades);
                    displayTrades();
                } else if ("trade" in obj) {
                    updateTrade(obj.trade);
                } else if ("quoterequests" in obj) {
                    clearQuoteRequests();
                    loadQuoteRequests(obj.quoterequests);
                    displayQuoteRequests();
                } else if ("quotes" in obj) {
                    clearQuotes();
                    loadQuotes(obj.quotes);
                    displayQuotes();
                } else if ("quoteack" in obj) {
                    quoteAckReceived(obj.quoteack);
                } else if ("quote" in obj) {
                    quoteReceived(obj.quote);
                } else if ("positions" in obj) {
                    clearPositions();
                    loadPositions(obj.positions);
                    displayPositions();
                } else if ("position" in obj) {
                    updatePosition(obj.position);
                } else if ("positionhistory" in obj) {
                    positionHistory(obj.positionhistory);
                } else if ("cashitem" in obj) {
                    updateCash(obj.cashitem);
                } else if ("cash" in obj) {
                    clearCash();
                    loadCash(obj.cash);
                    displayCash();
                } else if ("cashhistory" in obj) {
                    clearCashHistory();
                    loadCashHistory(obj.cashhistory);
                    displayCashHistory();
                } else if ("account" in obj) {
                    clearAccount();
                    loadAccount(obj.account);
                    displayAccount();
                } else if ("instruments" in obj) {
                    loadInstruments(obj.instruments);
                } else if ("instrument" in obj) {
                    loadInstrument(obj.instrument);
                } else if ("margins" in obj) {
                    loadMargins(obj.margins);
                } else if ("margin" in obj) {
                    updateMargin(obj.margin);
                } else if ("reserves" in obj) {
                    loadReserves(obj.reserves);
                } else if ("reserve" in obj) {
                    updateReserve(obj.reserve);
                } else if ("signinreply" in obj) {
                    replySignIn(obj.signinreply);
                } else if ("pwdupdate" in obj) {
                    passwordUpdate(obj.pwdupdate);
                } else if ("index" in obj) {
                    loadIndex(obj.index);
                } else if ("status" in obj) {
                    statusMsg(obj.status);
                } else if ("chat" in obj) {
                    newChat(obj.chat);
                } else if ("pong" in obj) {
                    console.log("received pong");
                    inconnectiontest = false;
                } else {
                    console.log("Unknown message:" + msg);
                }
            } catch (e) {
                console.log(e);
                console.log(msg);
                return;
            }
        };

        function loadIndex(index) {
            indices[index.name] = index.symbols;
            displayIndex(index.name);
        }

        function loadOrderBooks(orderbookarr) {
            for (var i = 0; i < orderbookarr.length; ++i) {
                updateOrderBook(orderbookarr[i]);
            }
        }

        function loadOrders(orderarr) {
            for (var i = 0; i < orderarr.length; ++i) {
                //updateOrderVol(orderarr[i]);
                orders[orderarr[i].orderid] = orderarr[i];
            }
        }

        function loadPositions(positionarr) {
            for (var i = 0; i < positionarr.length; ++i) {
                positions[positionarr[i].positionid] = positionarr[i];
            }
        }

        function loadCash(casharr) {
            for (var i = 0; i < casharr.length; ++i) {
                cash[casharr[i].currency] = casharr[i];
            }
        }

        function loadMargins(marginarr) {
            for (var i = 0; i < marginarr.length; ++i) {
                margins[marginarr[i].currency] = marginarr[i];
            }
        }

        function loadReserves(reservearr) {
            var reskey;

            for (var i = 0; i < reservearr.length; ++i) {
                reskey = reservearr[i].symbol + ":" + reservearr[i].currency;
                reserves[reskey] = reservearr[i];
            }
        }

        function loadTrades(tradearr) {
            for (var i = 0; i < tradearr.length; ++i) {
                trades[tradearr[i].tradeid] = tradearr[i];
            }
        }

        function loadInstruments(instrumentarr) {
            for (var i = 0; i < instrumentarr.length; ++i) {
                instruments[instrumentarr[i].symbol] = instrumentarr[i];
            }
        }

        function loadInstrument(instrument) {
            instruments[instrument.symbol] = instrument;
        }

        function loadOrderTypes(ordertypearr) {
            for (var i = 0; i < ordertypearr.length; ++i) {
                ordertypes[ordertypearr[i].id] = ordertypearr[i];
            }

            loadTimeinforces();
        }

        function loadTimeinforces() {
            timeinforces[0] = "Good For Day";
            timeinforces[1] = "Good Till Date";
            timeinforces[2] = "Good Till Cancelled";
        }

        function loadAccount(acctarr) {
            for (var i = 0; i < acctarr.length; ++i) {
                account[acctarr[i].currency] = acctarr[i];
            }
        }

        function loadQuoteRequests(quotereqarr) {
            for (var i = 0; i < quotereqarr.length; ++i) {
                quoterequests[quotereqarr[i].quotereqid] = quotereqarr[i];
            }
        }

        function loadQuotes(quotearr) {
            for (var i = 0; i < quotearr.length; ++i) {
                quotes[quotearr[i].quoteid] = quotearr[i];
            }
        }

        function loadCashHistory(cashhistarr) {
            for (var i = 0; i < cashhistarr.length; ++i) {
                cashhistory[cashhistarr[i].cashtransid] = cashhistarr[i];
            }
        }

        function clearPositions() {
            positions = [];
        }

        function clearCash() {
            cash = [];
        }

        function clearAccount() {
            account = [];
        }

        function clearQuoteRequests() {
            quoterequests = [];
        }

        function clearQuotes() {
            quotes = [];
        }

        function clearOrders() {
            orders = [];
        }

        function clearOrderBooks() {
            orderbooks = [];
        }

        function clearTrades() {
            trades = [];
        }

        function clearCashHistory() {
            cashhistory = [];
        }

        function displayIndex(index) {
            var s;
            var sym;

            if (!(index in indices)) { return };

            for (var i = 0; i < indices[index].length; ++i) {
                sym = indices[index][i].symbol;
                if (sym in instruments) {
                    s = instruments[sym].symbol + ' ' + instruments[sym].description;
                    addElement(s, list1, sym);
                }
            }
        }

        function start() {
            init();
            clearScreen();
            displayMenu();
            selectedmenu = 0;
            displayOrderBooks();
        }

        function statusMsg(status) {
            if (status == "readytotrade") {
                start();
            }
        }

        function isTouchDevice() {
            try {
                document.createEvent("TouchEvent");
                return true;
            }
            catch (e) {
                return false;
            }
        }

        function startHeartbeatTimer() {
            stopHeartbeatTimer();
            heartbeattimer = setTimeout(connectionTest, 30000);
        }

        function stopHeartbeatTimer() {
            clearTimeout(heartbeattimer);
        }

        function startPriceTimer() {
            pricetimer = setInterval(flashText, 1000);
        }

        function stopPriceTimer() {
            clearInterval(pricetimer);
        }

        function startRestartTimer() {
            // attempt restart after 1-10 seconds
            var randomonetoten = Math.floor((Math.random() * 10) + 1);
            console.log("attempt restart after " + randomonetoten + " seconds");
            restarttimer = setTimeout(newconn, randomonetoten * 1000);
        }

        function stopRestartTimer() {
            clearTimeout(restarttimer);
        }

        function connectionTest() {
            if (inconnectiontest) {
                console.log("need to reconnect");
                return;
            }

            inconnectiontest = true;
        }

        var newconn = function () {
            sockjs = new SockJS(sockjs_url);

            sockjs.onopen = function () {
                console.log("connection open");
                stopRestartTimer();
                startPriceTimer();
                touchdevice = isTouchDevice();
                displayFormSignin();
                loggedout = false;
            };

            sockjs.onmessage = function (e) {
                datain(e.data);
            };

            sockjs.onclose = function () {
                console.log("connection closed");
                stopRestartTimer();
                stopPriceTimer();
                if (!loggedout) {
                    startRestartTimer();
                } else {
                    newconn();
                }
            };

            sockjs.onheartbeat = function () {
            };
        };

        newconn();

        function flashText() {
            var bidprice;
            var offerprice;
            var removesymbol;

            for (var symbol in priceflash) {
                removesymbol = true;

                for (var i = 0; i < orderbooks[symbol].length; i++) {
                    // bid prices
                    orderbooks[symbol][i].bidflashcount--;
                    if (orderbooks[symbol][i].bidflashcount == 0) {
                        bidprice = document.getElementById("bidprice:" + symbol + ":" + i);
                        if (bidprice != null) {
                            if (i == 0) {
                                if (orderbooks[symbol][i].lastbidchange == 1) {
                                    bidprice.className = "yellowstripbidup";
                                } else if (orderbooks[symbol][i].lastbidchange == 2) {
                                    bidprice.className = "yellowstripbiddn";
                                } else {
                                    bidprice.className = "yellowstripbidnochange";
                                }
                            } else {
                                if (orderbooks[symbol][i].lastbidchange == 1) {
                                    bidprice.className = "bidup";
                                } else if (orderbooks[symbol][i].lastbidchange == 2) {
                                    bidprice.className = "biddn";
                                } else {
                                    bidprice.className = "bidnochange";
                                }
                            }
                        }
                    }

                    // offer prices
                    orderbooks[symbol][i].offerflashcount--;
                    if (orderbooks[symbol][i].offerflashcount == 0) {
                        offerprice = document.getElementById("offerprice:" + symbol + ":" + i);
                        if (offerprice != null) {
                            if (i == 0) {
                                if (orderbooks[symbol][i].lastofferchange == 1) {
                                    offerprice.className = "yellowstripofferup";
                                } else if (orderbooks[symbol][i].lastofferchange == 2) {
                                    offerprice.className = "yellowstripofferdn";
                                } else {
                                    offerprice.className = "yellowstripoffernochange";
                                }
                            } else {
                                if (orderbooks[symbol][i].lastofferchange == 1) {
                                    offerprice.className = "offerup";
                                } else if (orderbooks[symbol][i].lastofferchange == 2) {
                                    offerprice.className = "offerdn";
                                } else {
                                    offerprice.className = "offernochange";
                                }
                            }
                        }
                    }

                    // keep track of whether we can remove this symbol
                    if (orderbooks[symbol][i].bidflashcount > 0 || orderbooks[symbol][i].offerflashcount > 0) {
                        removesymbol = false;
                    }
                }

                if (removesymbol) {
                    delete priceflash[symbol];
                }
            }
        }

        function clearMenu() {
            var menu = document.getElementById("menu");
            if (menu != null) {
                for (var i = 0; i < menu.childNodes.length; ++i) {
                    menu.removeChild(menu.childNodes[i]);
                }
                heading.removeChild(menu);
            }
        }

        function clearHeadings() {
            for (var i = 0; i < main.childNodes.length; ++i) {
                if (main.childNodes[i].nodeType == 3) {
                    main.removeChild(main.childNodes[i]);
                }
            }
        }

        function clearOrderBookHeadings() {
            var headingstrip = document.getElementById("headingstrip");
            if (headingstrip != null) {
                while (headingstrip.hasChildNodes()) {
                    headingstrip.removeChild(headingstrip.childNodes[0]);
                }
                main.removeChild(headingstrip);
            }
        }

        function clearList(liststr) {
            var list = document.getElementById(liststr);
            if (list != null) {
                while (list.hasChildNodes()) {
                    list.removeChild(list.childNodes[0])
                }
            }
        }

        function clearForm(formid, remove) {
            var frm = document.getElementById(formid);
            if (frm != null) {
                while (frm.hasChildNodes()) {
                    frm.removeChild(frm.childNodes[0]);
                }
                if (remove) {
                    main.removeChild(frm);
                }
            }
        }

        function clearSymbolDiv(symbol) {
            clearDiv("orderdiv:" + symbol);
        }

        function clearAllSymbolDivs() {
            for (var symbol in orderbooks) {
                clearSymbolDiv(symbol);
            }
        }

        function clearSelectStockDivs() {
            clearDiv("stockbox");
        }

        function clearStrip(stripid) {
            var strip = document.getElementById(stripid);
            if (strip != null) {
                while (strip.hasChildNodes()) {
                    strip.removeChild(strip.childNodes[0]);
                }
                main.removeChild(strip);
            }
        }

        function clearStrips() {
            clearStrip("headingstrip");

            for (var symbol in orderbooks) {
                for (var i = 0; i < orderbooks[symbol].length; ++i) {
                    clearStrip("strip:" + symbol + ":" + i);
                    if (symbol in obdisplay) {
                        if (!(obdisplay[symbol].level2)) {
                            break;
                        }
                    }
                }
            }
        }

        function clearAllStrips(symbol) {
            var depth;

            if (obdisplay[symbol].level2) {
                depth = orderbooks[symbol].length;
            } else {
                depth = 1;
            }

            for (var i = 0; i < depth; ++i) {
                clearStrip("strip:" + symbol + ":" + i);
            }
        }

        function clearScreen() {
            clearHeadings();
            clearOrderBookHeadings();
            clearLists();
            clearForms();
            clearStrips();
            clearSelectStockDivs();
            clearAllSymbolDivs();
            clearDivs();
            clearEmptyLines();
            clearTables();
            clearLabels();
        }

        function clearLabels() {
            clearElementById("lbltrades");
        }

        function clearLists() {
            clearList("list1");
            clearList("list2");
            clearList("list3");
            clearList("list4");
            clearList("list5");
            clearList("list6");
        }

        function clearForms() {
            clearForm("frmsignin", true);
            clearForm("frminstrument", true);
            clearForm("frmpositions", true);
            clearForm("frmhistory", true);
            clearForm("frmsettings", true);
            clearForm("frmpassword", true);
        }

        function clearDivs() {
            clearDiv("chatdiv");
        }

        function clearTable(tablestr) {
            var tbl = document.getElementById(tablestr);
            if (tbl != null) {
                while (tbl.hasChildNodes()) {
                    tbl.removeChild(tbl.childNodes[0])
                }
                main.removeChild(tbl);
            }
        }

        function clearTables() {
            clearTable("tblpositions");
            clearTable("tblaccount");
            clearTable("tblcashhistory");
            clearTable("tbltrades");
        }

        function clearEmptyLines() {
            for (var i = 1; i < 6; ++i) {
                clearElementById("emptyline:" + i);
            }
        }

        function addElement(msg, list, index) {
            var listelem;

            listelem = document.createElement("li");
            listelem.setAttribute('value', index);
            listelem.innerHTML = msg;

            list.appendChild(listelem);

            return listelem;
        }

        function cashMsg(cash) {
            return formatCurrency(cash.amount) + " " + cash.currency;
        }

        function formatCurrency(num) {
            num = isNaN(num) || num === '' || num === null ? 0.00 : num;
            return parseFloat(num).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        /*function orderCancel(event) {
            console.log(this);
            console.log(event);
            var element = ((window.event)?(event.srcElement):(event.target));
            var orderid = element.value;
            confirmOrderCancel(orderid);
        }*/

        function confirmOrderCancel(orderid) {
            var msg;
            var ordercancelrequest = {};

            msg = "Cancel order #" + orderid;
            msg += " to " + getSideDesc(orders[orderid].side);
            msg += " " + orders[orderid].remquantity;
            msg += " " + orders[orderid].symbol;
            if ('price' in orders[orderid]) {
                msg += " @ " + orders[orderid].price;
            }
            msg += " " + getOrdertypeDesc(orders[orderid].ordertype);

            var result = confirm(msg);
            if (result == true) {
                ordercancelrequest.orderid = orderid;
                sockjs.send("{\"ordercancelrequest\":" + JSON.stringify(ordercancelrequest) + "}");
            }
        }

        function displayOrderBooks() {
            selectStock();

            displayOrderBookHeadings();

            for (var symbol in orderbooks) {
                displayOrderBook(symbol);
            }
        }

        function displayOrders() {
            var firstorder = true;
            var firstorderpartfilled = true;
            var firstorderfilled = true;
            var firstorderrejected = true;
            var firstordercancelled = true;
            var firstorderexpired = true;
            var msg;
            var listelement;
            var lblnopartfilled;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            var list1 = getList("list1");
            var emptyline1 = addNewLine(main, "emptyline:1");
            var list2 = getList("list2");
            var emptyline2 = addNewLine(main, "emptyline:2");
            var list3 = getList("list3");
            var emptyline3 = addNewLine(main, "emptyline:3");
            var list4 = getList("list4");
            var emptyline4 = addNewLine(main, "emptyline:4");
            var list5 = getList("list5");
            var emptyline5 = addNewLine(main, "emptyline:5");
            var list6 = getList("list6");

            displayOrderHeadings();

            for (var x in orders) {
                if (orders[x].status == "0") { // new
                    if (firstorder) {
                        firstorder = false;
                    }

                    msg = orderNewMsg(orders[x]);
                    listelement = addElement(msg, list1, orders[x].orderid);
                    optionToViewCancel(listelement, true, true);
                } else if (orders[x].status == "1") { // part-filled
                    if (firstorderpartfilled) {
                        firstorderpartfilled = false;
                    }

                    msg = orderFillMsg(orders[x]);
                    listelement = addElement(msg, list2, orders[x].orderid);
                } else if (orders[x].status == "2") { // filled
                    if (firstorderfilled) {
                        firstorderfilled = false;
                    }

                    msg = orderFillMsg(orders[x]);
                    listelement = addElement(msg, list3, orders[x].orderid);
                } else if (orders[x].status == "8") { // rejected
                    if (firstorderrejected) {
                        firstorderrejected = false;
                    }

                    msg = orderRejectMsg(orders[x]);
                    listelement = addElement(msg, list4, orders[x].orderid);
                } else if (orders[x].status == "4") { // cancelled
                    if (firstordercancelled) {
                        firstordercancelled = false;
                    }

                    msg = orderCancelMsg(orders[x]);
                    listelement = addElement(msg, list5, orders[x].orderid);
                } else if (orders[x].status == "C") { // expired
                    if (firstorderexpired) {
                        firstorderexpired = false;
                    }

                    msg = orderExpireMsg(orders[x]);
                    listelement = addElement(msg, list6, orders[x].orderid);
                }
            }

            if (firstorder) {
                addElement("No new orders", list1, 0)
            }

            if (firstorderpartfilled) {
                addElement("No part-filled orders", list2, 0)
            } else {
                list2.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }
            }

            if (firstorderfilled) {
                addElement("No filled orders", list3, 0)
            } else {
                list3.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }
            }

            if (firstorderrejected) {
                addElement("No rejected orders", list4, 0)
            } else {
                list4.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }
            }

            if (firstordercancelled) {
                addElement("No cancelled orders", list5, 0)
            } else {
                list5.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }
            }

            if (firstorderexpired) {
                addElement("No expired orders", list6, 0)
            } else {
                list6.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewOrder(element.value);
                }
            }
        }

        function displayOrderHeadings() {
            addHeading("New", list1);
            addHeading("Part-filled", list2);
            addHeading("Filled", list3);
            addHeading("Rejected", list4);
            addHeading("Cancelled", list5);
            addHeading("Expired", list6);
        }

        function displayPositions() {
            var tblpositions;
            var tblbody;
            var posrow;
            var headingrow;
            var numcols = 11;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            if (Object.keys(positions).length == 0) {
                var list = getList("list1");
                addElement("No positions", list, 0);
                return;
            }

            tblpositions = document.createElement("table");
            tblpositions.id = "tblpositions";
            tblpositions.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblpositions.appendChild(tblbody);
            main.appendChild(tblpositions);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                    case 0:
                        col.innerHTML = "Symbol";
                        break;
                    case 1:
                        col.innerHTML = "Currency";
                        break;
                    case 2:
                        col.innerHTML = "Long/Short";
                        break;
                    case 3:
                        col.innerHTML = "Quantity";
                        col.className = "colrightalign";
                        break;
                    case 4:
                        col.innerHTML = "Cost";
                        col.className = "colrightalign";
                        break;
                    case 5:
                        col.innerHTML = "Avg. Cost";
                        col.className = "colrightalign";
                        break;
                    case 6:
                        col.innerHTML = "Margin";
                        col.className = "colrightalign";
                        break;
                    case 7:
                        col.innerHTML = "Realised P&L";
                        col.className = "colrightalign";
                        break;
                    case 8:
                        col.innerHTML = "Market Price";
                        col.className = "colrightalign";
                        break;
                    case 9:
                        col.innerHTML = "Unrealised P&L";
                        col.className = "colrightalign";
                        break;
                    case 10:
                        col.innerHTML = "View Trades";
                        break;
                    default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            for (var x in positions) {
                var posrow = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                        case 0:
                            col.innerHTML = positions[x].symbol;
                            break;
                        case 1:
                            col.innerHTML = positions[x].currency;
                            break;
                        case 2:
                            if (positions[x].side == 1) {
                                col.innerHTML = "Long";
                                posrow.className = "rowlong";
                            } else {
                                col.innerHTML = "Short";
                                posrow.className = "rowshort";
                            }
                            break;
                        case 3:
                            col.innerHTML = positions[x].quantity;
                            col.className = "colrightalign";
                            break;
                        case 4:
                            col.innerHTML = positions[x].cost;
                            col.className = "colrightalign";
                            break;
                        case 5:
                            col.innerHTML = positions[x].averagecostpershare;
                            col.className = "colrightalign";
                            break;
                        case 6:
                            col.innerHTML = positions[x].margin;
                            col.className = "colrightalign";
                            break;
                        case 7:
                            col.innerHTML = positions[x].realisedpandl;
                            col.className = "colrightalign";
                            break;
                        case 8:
                            col.innerHTML = positions[x].mktprice;
                            col.className = "colrightalign";
                            break;
                        case 9:
                            col.innerHTML = positions[x].unrealisedpandl;
                            col.className = "colrightalign";
                            break;
                        case 10:
                            displayPostrades(col);
                            break;
                        default:
                    }

                    posrow.appendChild(col);
                }

                tblbody.appendChild(posrow);
            }

            function displayPostrades(col) {
                var tradehistoryrequest = {};

                var lnktrades = newlink(positions[x].symbol + ":" + positions[x].currency, "trades", "", col);

                lnktrades.onclick = function () {
                    tradehistoryrequest.positionkey = this.id;
                    sockjs.send("{\"tradehistoryrequest\":" + JSON.stringify(tradehistoryrequest) + "}");
                    whichPos(tradehistoryrequest.positionkey);
                }
            }

            function whichPos(pos) {
                var postrades = document.getElementById("postrades");
                if (postrades == null) {
                    postrades = document.createElement("input");
                    postrades.type = "hidden";
                    postrades.id = "postrades";
                    main.appendChild(postrades);
                }
                postrades.value = pos;
            }
        }

        function displayAccount() {
            var tblaccount;
            var tblbody;
            var numrows = 7;
            var firstcurr = true;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            if (Object.keys(account).length == 0) {
                var list = getList("list1");
                addElement("No cash or transactions", list, 0);
                return;
            }

            tblaccount = document.createElement("table");
            tblaccount.id = "tblaccount";

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblaccount.appendChild(tblbody);
            main.appendChild(tblaccount);

            for (var x in account) {
                if (!firstcurr) {
                    var emptyrow = document.createElement("tr");
                    var emptycol = document.createElement("td");
                    emptycol.innerHTML = "---";
                    emptyrow.appendChild(emptycol);
                    tblbody.appendChild(emptyrow);
                } else {
                    firstcurr = false;
                }

                var headingrow = document.createElement("tr");

                var col = document.createElement("td");
                col.innerHTML = account[x].currency;
                col.className = "colleftalign";

                headingrow.appendChild(col);
                tblbody.appendChild(headingrow);

                for (var i = 0; i < numrows; ++i) {
                    var row = document.createElement("tr");
                    var col = document.createElement("td");
                    var colval = document.createElement("td");

                    row.appendChild(col);

                    switch (i) {
                        case 0:
                            col.innerHTML = "Cash";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].cash);
                            colval.className = "colrightalign";
                            break;
                        case 1:
                            col.innerHTML = "Realised P&L";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].realisedpandl);
                            colval.className = "colunderline";
                            break;
                        case 2:
                            col.innerHTML = "Trading Balance";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].balance);
                            colval.className = "colrightalign";
                            var colempty = document.createElement("td");
                            row.appendChild(colempty);
                            break;
                        case 3:
                            col.innerHTML = "Unrealised P&L";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].unrealisedpandl);
                            colval.className = "colunderline";
                            var colempty = document.createElement("td");
                            row.appendChild(colempty);
                            break;
                        case 4:
                            col.innerHTML = "Equity";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].equity);
                            colval.className = "colrightalign";
                            var colempty1 = document.createElement("td");
                            row.appendChild(colempty1);
                            var colempty2 = document.createElement("td");
                            row.appendChild(colempty2);
                            break;
                        case 5:
                            col.innerHTML = "Margin";
                            col.className = "colleftalign";
                            colval.innerHTML = "(" + formatCurrency(account[x].margin) + ")";
                            colval.className = "colunderline";
                            var colempty1 = document.createElement("td");
                            row.appendChild(colempty1);
                            var colempty2 = document.createElement("td");
                            row.appendChild(colempty2);
                            break;
                        case 6:
                            col.innerHTML = "Free Margin";
                            col.className = "colleftalign";
                            colval.innerHTML = formatCurrency(account[x].freemargin);
                            colval.className = "coldoubleunderline";
                            var colempty1 = document.createElement("td");
                            row.appendChild(colempty1);
                            var colempty2 = document.createElement("td");
                            row.appendChild(colempty2);
                            var colempty3 = document.createElement("td");
                            row.appendChild(colempty3);
                            break;
                        default:
                    }

                    row.appendChild(colval);
                    tblbody.appendChild(row);
                }
            }
        }

        function displayPrices() {
            //addElement(msg, list1, orders[x].orderid);
        }

        function selectStock() {
            var stockbox;
            var stockboxinput;
            var stocklist;
            var searchtext;

            stockbox = document.createElement("div");
            stockbox.id = "stockbox";
            stockbox.className = "stockbox";

            stockboxinput = document.createElement("input");
            stockboxinput.className = "stockboxinput";
            stockboxinput.id = "stockboxinput";
            stockboxinput.placeholder = "Enter symbol";

            stockboxinput.onkeyup = function () {
                clearList(stocklist.id);

                if (stockboxinput.value.length == 0) {
                    stocklist.style.visibility = "hidden";
                    return;
                }

                searchtext = stockboxinput.value.toLowerCase();

                for (var i in instruments) {
                    if (i.toLowerCase().indexOf(searchtext) == 0 || instruments[i].description.toLowerCase().indexOf(searchtext) == 0) {
                        addElement(i + " " + instruments[i].description, stocklist, i);
                    }
                }

                if (stocklist.getElementsByTagName('li').length > 0) {
                    stocklist.style.visibility = "visible";
                } else {
                    stocklist.style.visibility = "hidden";
                }
            }

            stocklist = document.createElement('ul');
            stocklist.id = "stocklist";
            stocklist.className = "stocklist";
            stocklist.style.visibility = "hidden";

            stocklist.onclick = function (e) {
                var firstspace;
                var symbol;
                var element;

                if (!e) e = window.event;
                element = e.target || e.srcElement;

                firstspace = element.innerHTML.indexOf(' ');
                symbol = element.innerHTML.substr(0, firstspace);

                if (symbol in obdisplay) {
                    alert(symbol + " already in watch list");
                    e.stopPropagation();
                } else {
                    sockjs.send("{\"orderbookrequest\":" + JSON.stringify(symbol) + "}");
                    stocklist.style.visibility = "hidden";
                    stockboxinput.value = "";
                    stockboxinput.focus();
                }
            }

            stockbox.appendChild(stockboxinput);
            stockbox.appendChild(stocklist);

            main.appendChild(stockbox);

            main.onclick = function (e) {
                var elem;

                if (!e) e = window.event;
                elem = e.target || e.srcElement;

                if (elem.id == "stocklist" || elem.id == "stockboxinput") {
                    return;
                }

                stocklist.style.visibility = "hidden";
            }

            stockboxinput.focus();
        }

        function displayTrades() {
            var tbltrades;
            var tblbody;
            var traderow;
            var headingrow;
            var numcols = 19;
            var lbltrades;

            if (selectedmenu == 1) {
                clearLists();
                clearEmptyLines();
                clearHeadings();
                clearTables();
            } else {
                clearElementById("emptyline:2");
                clearElementById("lbltrades");
                clearTable("tbltrades");
                clearList("list1", true);
            }

            var emptyline2 = addNewLine(main, "emptyline:2");

            if (selectedmenu == 2) {
                var postrades = document.getElementById("postrades");
                if (postrades != null) {
                    lbltrades = newlabel("lbltrades", "Trades for position " + postrades.value, "", main);
                }
            }

            if (Object.keys(trades).length == 0) {
                var list = getList("list1");
                addElement("No trades", list, 0);
                return;
            }

            tbltrades = document.createElement("table");
            tbltrades.id = "tbltrades";
            tbltrades.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tbltrades.appendChild(tblbody);
            main.appendChild(tbltrades);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                    case 0:
                        col.innerHTML = "Client";
                        break;
                    case 1:
                        col.innerHTML = "Symbol";
                        break;
                    case 2:
                        col.innerHTML = "Side";
                        break;
                    case 3:
                        col.innerHTML = "Quantity";
                        col.className = "colrightalign";
                        break;
                    case 4:
                        col.innerHTML = "Price";
                        col.className = "colrightalign";
                        break;
                    case 5:
                        col.innerHTML = "Settlcurramt";
                        col.className = "colrightalign";
                        break;
                    case 6:
                        col.innerHTML = "Nosettdays";
                        break;
                    case 7:
                        col.innerHTML = "Settl.Date";
                        break;
                    case 8:
                        col.innerHTML = "Currency";
                        break;
                    case 9:
                        col.innerHTML = "Commission";
                        col.className = "colrightalign";
                        break;
                    case 10:
                        col.innerHTML = "Ptm Levy";
                        col.className = "colrightalign";
                        break;
                    case 11:
                        col.innerHTML = "Stamp Duty";
                        col.className = "colrightalign";
                        break;
                    case 12:
                        col.innerHTML = "Contract Charge";
                        col.className = "colrightalign";
                        break;
                    case 13:
                        col.innerHTML = "Counterparty";
                        break;
                    case 14:
                        col.innerHTML = "External Trade Id";
                        break;
                    case 15:
                        col.innerHTML = "Timestamp";
                        break;
                    case 16:
                        col.innerHTML = "Trade Id";
                        break;
                    case 17:
                        col.innerHTML = "Finance";
                        col.className = "colrightalign";
                        break;
                    case 18:
                        col.innerHTML = "Margin";
                        col.className = "colrightalign";
                        break;
                    default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            for (var x in trades) {
                var traderow = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                        case 0:
                            col.innerHTML = trades[x].clientid;
                            break;
                        case 1:
                            col.innerHTML = trades[x].symbol;
                            break;
                        case 2:
                            col.innerHTML = getSideDesc(trades[x].side);
                            break;
                        case 3:
                            col.innerHTML = trades[x].quantity;
                            col.className = "colrightalign";
                            break;
                        case 4:
                            col.innerHTML = trades[x].price;
                            col.className = "colrightalign";
                            break;
                        case 5:
                            col.innerHTML = trades[x].settlcurramt;
                            col.className = "colrightalign";
                            break;
                        case 6:
                            col.innerHTML = "T+" + trades[x].nosettdays;
                            break;
                        case 7:
                            col.innerHTML = formatUTCDate(trades[x].futsettdate);
                            break;
                        case 8:
                            col.innerHTML = trades[x].settlcurrency;
                            break;
                        case 9:
                            col.innerHTML = trades[x].commission;
                            col.className = "colrightalign";
                            break;
                        case 10:
                            col.innerHTML = trades[x].ptmlevy;
                            col.className = "colrightalign";
                            break;
                        case 11:
                            col.innerHTML = trades[x].stampduty;
                            col.className = "colrightalign";
                            break;
                        case 12:
                            col.innerHTML = trades[x].contractcharge;
                            col.className = "colrightalign";
                            break;
                        case 13:
                            col.innerHTML = trades[x].counterpartyid;
                            break;
                        case 14:
                            col.innerHTML = trades[x].externaltradeid;
                            break;
                        case 15:
                            col.innerHTML = formatUTCDateTime(trades[x].timestamp);
                            break;
                        case 16:
                            col.innerHTML = trades[x].tradeid;
                            break;
                        case 17:
                            col.innerHTML = trades[x].finance;
                            break;
                        case 18:
                            col.innerHTML = trades[x].margin;
                            break;
                        default:
                    }

                    traderow.appendChild(col);
                }

                tblbody.appendChild(traderow);
            }
        }

        function displayQuoteRequests() {
            var firstquoterequest = true;
            var msg;
            var list;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            list = getList("list1");

            for (var x in quoterequests) {
                msg = quoteRequestMsg(quoterequests[x]);
                addElement(msg, list, quoterequests[x].quotereqid);
                firstquoterequest = false;
            }

            if (firstquoterequest) {
                addElement("No quote requests", list, 0);
            } else {
                list.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewQuoteRequest(element.value);
                }
            }
        }

        function displayQuotes() {
            var firstquote = true;
            var msg;

            clearLists();
            clearHeadings();
            clearEmptyLines();
            clearTables();

            var list = getList("list1");

            for (var x in quotes) {
                msg = quoteMsg(quotes[x]);
                addElement(msg, list, quotes[x].quoteid);
                firstquote = false;
            }

            if (firstquote) {
                addElement("No quotes", list, 0);
            } else {
                list.onclick = function (e) {
                    var element;

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    viewQuote(element.value);
                }
            }
        }

        function displayCashHistory() {
            var tblcashhistory;
            var tblbody;
            var posrow;
            var headingrow;
            var numcols = 8;
            var firstrow;

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();

            var emptyline = addNewLine(main);
            emptyline.id = "emptyline:" + "1";

            if (Object.keys(cashhistory).length == 0) {
                var list = getList("list1");
                addElement("No cash transactions", list, 0);
                return;
            }

            tblcashhistory = document.createElement("table");
            tblcashhistory.id = "tblcashhistory";
            tblcashhistory.setAttribute("border", "1");

            tblbody = document.createElement("tbody");
            tblbody.id = "tblbody";

            tblcashhistory.appendChild(tblbody);
            main.appendChild(tblcashhistory);

            headingrow = document.createElement("tr");

            for (var i = 0; i < numcols; ++i) {
                var col = document.createElement("td");

                switch (i) {
                    case 0:
                        col.innerHTML = "Datetime";
                        col.className = "colleftalign";
                        break;
                    case 1:
                        col.innerHTML = "Currency";
                        col.className = "colleftalign";
                        break;
                    case 2:
                        col.innerHTML = "Type";
                        col.className = "colleftalign";
                        break;
                    case 3:
                        col.innerHTML = "Description";
                        col.className = "colleftalign";
                        break;
                    case 4:
                        col.innerHTML = "Reference";
                        col.className = "colleftalign";
                        break;
                    case 5:
                        col.innerHTML = "In(+)";
                        col.className = "colrightalign";
                        break;
                    case 6:
                        col.innerHTML = "Out(-)";
                        col.className = "colrightalign";
                        break;
                    case 7:
                        col.innerHTML = "Balance";
                        col.className = "colrightalign";
                        break;
                    default:
                }

                headingrow.appendChild(col);
            }

            tblbody.appendChild(headingrow);

            firstrow = document.createElement("tr");

            for (var i = 0; i < numcols - 1; ++i) {
                var col = document.createElement("td");
                if (i == 3) {
                    col.innerHTML = "Start Balance";
                } else {
                    col.innerHTML = "";
                }
                firstrow.appendChild(col);
            }

            var col = document.createElement("td");
            col.innerHTML = "0.00";
            col.className = "colrightalign";
            firstrow.appendChild(col);

            tblbody.appendChild(firstrow);

            for (var x in cashhistory) {
                var row = document.createElement("tr");

                for (var i = 0; i < numcols; ++i) {
                    var col = document.createElement("td");

                    switch (i) {
                        case 0:
                            col.innerHTML = formatUTCDateTime(cashhistory[x].timestamp);
                            break;
                        case 1:
                            col.innerHTML = cashhistory[x].currency;
                            break;
                        case 2:
                            col.innerHTML = cashhistory[x].transtype;
                            break;
                        case 3:
                            col.innerHTML = cashhistory[x].description;
                            break;
                        case 4:
                            col.innerHTML = cashhistory[x].reference;
                            break;
                        case 5:
                            if (cashhistory[x].drcr == 1) {
                                var amount = formatCurrency(cashhistory[x].amount);
                                col.innerHTML = amount;
                            } else {
                                col.innerHTML = "";
                            }
                            col.className = "colrightalign";
                            break;
                        case 6:
                            if (cashhistory[x].drcr == 2) {
                                var amount = formatCurrency(cashhistory[x].amount);
                                col.innerHTML = amount;
                            } else {
                                col.innerHTML = "";
                            }
                            col.className = "colrightalign";
                            break;
                        case 7:
                            var balance = formatCurrency(cashhistory[x].balance);
                            col.innerHTML = balance;
                            col.className = "colrightalign";
                            break;
                        default:
                    }

                    row.appendChild(col);
                }

                tblbody.appendChild(row);
            }
        }

        function displayCash() {
            var firstCash = true;
            var tmpcasharr = [];

            clearLists();
            clearEmptyLines();
            clearHeadings();
            clearTables();
            clearElementById("lbltrades");

            var emptyline = addNewLine(main, "emptyline:1");

            var list = getList("list1");

            var i = 0;
            for (var x in cash) {
                addElement(cashMsg(cash[x]), list, i);
                tmpcasharr[i] = cash[x].currency;
                i++;
                firstCash = false;
            }

            if (firstCash) {
                addElement("No cash", list, "");
            } else {
                list.onclick = function (e) {
                    var element;
                    var historyrequest = {};

                    if (!e) e = window.event;
                    element = e.target || e.srcElement;

                    historyrequest.currency = tmpcasharr[element.value];
                    sockjs.send("{\"cashhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
                }
            }
        }

        function displayMargins() {
            var firstMargin = true;

            addHeading("Margin", list2);

            for (var x in margins) {
                addElement(marginMsg(margins[x]), list2, margins[x].currency);
                firstMargin = false;
            }

            if (firstMargin) {
                addElement("No margins", list2, "");
            }
        }

        function displayReserves() {
            var reskey;
            var msg;
            var firstReserve = true;

            addHeading("Stock Reserved", list3);

            for (var x in reserves) {
                reskey = reserves[x].symbol + " " + reserves[x].currency;
                msg = reserveMsg(reserves[x]);
                addElement(msg, list3, reskey);
                firstReserve = false;
            }

            if (firstReserve) {
                addElement("No reserves", list3, "");
            }
        }

        function updateOrder(order) {
            var msg;
            var listelement;

            //updateOrderVol(order);

            orders[order.orderid] = order;

            // add to quote
            if (order.quoteid != "") {
                var quote = quotes[order.quoteid];
                quote.orderid = order.orderid;
            }

            if (selectedmenu == 0) {
                if (!(order.symbol in orderbooks)) { return; }

                if (order.status == "0") {
                    msg = "Order acknowledged, id: " + order.orderid;
                    if ('text' in order && order.text != "") {
                        msg += ", " + order.text;
                    }
                } else if (order.status == "1") {
                    msg = "Order part-filled, order id: " + order.orderid;
                } else if (order.status == "2") {
                    msg = "Order filled, order id: " + order.orderid;
                } else if (order.status == "8") {
                    msg = "Order rejected, reason: " + getReasonDesc(order.reason);
                    if (order.text != "") {
                        msg += " " + order.text;
                    }
                    msg += ", order id: " + order.orderid;
                } else if (order.status == "4") {
                    msg = "Order cancelled";
                }

                addMessageToDiv(msg, "orderdiv:" + order.symbol, order.symbol);
            } else if (selectedmenu == 2) {
                if (order.status == "0") {
                    msg = orderNewMsg(order);
                    listelement = updateElement(msg, list1, order.orderid);
                    if (listelement == null) {
                        removeElementFromList(0, list1);
                        listelement = addElement(msg, list1, order.orderid);
                        optionToViewCancel(listelement, true);
                    } else {
                        optionToViewCancel(listelement, true);
                    }
                } else if (order.status == "1") {
                    removeOrderAndTidy(order.orderid, list1);
                    msg = orderFillMsg(order);
                    listelement = updateElement(msg, list2, order.orderid);
                    if (listelement == null) {
                        removeElementFromList(0, list2);
                        listelement = addElement(msg, list2, order.orderid);
                        optionToViewCancel(listelement, true);
                    } else {
                        optionToViewCancel(listelement, true);
                    }
                } else if (order.status == "2") {
                    removeOrderAndTidy(order.orderid, list1);
                    removeOrderAndTidy(order.orderid, list2);
                    removeElementFromList(0, list3);
                    msg = orderFillMsg(order);
                    listelement = addElement(msg, list3, order.orderid);
                    optionToViewCancel(listelement, false);
                } else if (order.status == "8") {
                    removeOrderAndTidy(order.orderid, list1);
                    removeElementFromList(0, list4);
                    msg = orderRejectMsg(order);
                    listelement = addElement(msg, list4, order.orderid);
                    optionToViewCancel(listelement, false);
                } else if (order.status == "4") {
                    removeOrderAndTidy(order.orderid, list1);
                    removeOrderAndTidy(order.orderid, list2);
                    removeElementFromList(0, list5);
                    msg = orderCancelMsg(order);
                    listelement = addElement(msg, list5, order.orderid);
                    optionToViewCancel(listelement, false);
                }
            }
        }

        function removeOrderAndTidy(orderid, list) {
            var headingtext;

            if (list == list1) {
                headingtext = "No new orders";
            } else {
                headingtext = "No part-filled orders";
            }

            removeElementFromList(orderid, list);
            if (list.childNodes.length == 0) {
                addElement(headingtext, list, 0);
            }
        }

        function optionToViewCancel(listelement, cancelorder) {
            var addfuncdiv;

            if (!touchdevice) {
                listelement.onmouseover = function () {
                    addfuncdiv.style.visibility = "visible";
                }
                listelement.onmouseout = function () {
                    addfuncdiv.style.visibility = "hidden";
                }
            }

            addfuncdiv = document.createElement('div');
            addfuncdiv.style.visibility = "hidden";

            var vieworderlnk = newlink("vieworderlnk", "View Order", "", addfuncdiv);

            vieworderlnk.onclick = function () {
                viewOrder(listelement.value);
            }

            if (cancelorder) {
                var cancelorderlnk = newlink("cancelorderlnk", "Cancel Order", "", addfuncdiv);

                cancelorderlnk.onclick = function () {
                    confirmOrderCancel(listelement.value);
                }
            }

            listelement.appendChild(addfuncdiv);
        }

        function viewOrder(orderid) {
            var msg = "";
            var order;
            var fieldcontents;
            var fielddesc;

            order = orders[orderid];

            for (var field in order) {
                fieldcontents = order[field];

                switch (field) {
                    case 'side':
                        fielddesc = getSideDesc(fieldcontents);
                        break;
                    case 'status':
                        fielddesc = getOrderStatusDesc(fieldcontents);
                        break;
                    case 'ordertype':
                        fielddesc = getOrdertypeDesc(fieldcontents);
                        break;
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    case 'reason':
                        fielddesc = getReasonDesc(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function viewQuoteRequest(quotereqid) {
            var msg = "";
            var quoterequest;

            quoterequest = quoterequests[quotereqid];

            for (var field in quoterequest) {
                msg += field + ": " + quoterequest[field] + "\n";
            }

            alert(msg);
        }

        function viewQuote(quoteid) {
            var msg = "";
            var quote;
            var fieldcontents;
            var fielddesc;

            quote = quotes[quoteid];

            for (var field in quote) {
                fieldcontents = quote[field];

                switch (field) {
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function viewTrade(tradeid) {
            var msg = "";
            var trade;
            var fieldcontents;
            var fielddesc;

            trade = trades[tradeid];

            for (var field in trade) {
                fieldcontents = trade[field];

                switch (field) {
                    case 'futsettdate':
                        fielddesc = formatUTCDate(fieldcontents);
                        break;
                    case 'timestamp':
                        fielddesc = formatUTCDateTime(fieldcontents);
                        break;
                    default:
                        fielddesc = fieldcontents;
                }

                msg += field + ": " + fielddesc + "\n";
            }

            alert(msg);
        }

        function getOrderStatusDesc(status) {
            var desc;

            switch (status) {
                case '0':
                    desc = "New";
                    break;
                case '1':
                    desc = "Partially filled";
                    break;
                case '2':
                    desc = "Filled";
                    break;
                case '3':
                    desc = "Done for day";
                    break;
                case '4':
                    desc = "Cancelled";
                    break;
                case '5':
                    desc = "Replaced";
                    break;
                case '6':
                    desc = "Pending Cancel"; // (e.g. result of Order Cancel Request <F>) 7 = Stopped
                    break;
                case '8':
                    desc = "Rejected";
                    break;
                case '9':
                    desc = "Suspended";
                    break;
                case 'A':
                    desc = "Pending New";
                    break;
                case 'B':
                    desc = "Calculated";
                    break;
                case 'C':
                    desc = "Expired";
                    break;
                case 'D':
                    desc = "Accepted for bidding";
                    break;
                case 'E':
                    desc = "Pending Replace";
                    break;
                default:
                    desc = "Unknown status";
            }

            return desc;
        }

        /*function updateOrderVol(order) {
            var key = order.symbol + order.side + order.price;

            if (order.status == "0" || order.status == "1") {
                if (order.orderid in orders) {
                    ordervol[key] -= parseInt(orders[order.orderid].remquantity);
                }

                if (key in ordervol) {
                    ordervol[key] += parseInt(order.remquantity);
                } else {
                    ordervol[key] = parseInt(order.remquantity);
                }
            } else if (order.status == "2" || order.status == "4") {
                if (order.orderid in orders) {
                    ordervol[key] -= parseInt(orders[order.orderid].remquantity);
                }
            }
        }*/

        /*function requestPositionHistory(event) {
            var element = ((window.event)?(event.srcElement):(event.target));
            var poskey = element.value;

            sockjs.send("{\"positionhistoryrequest\":\"" + poskey + "\"}");
        }*/

        function positionHistory(trades) {
        }

        function updateElement(msg, list, index) {
            var listelement = null;

            for (var i = 0; i < list.childNodes.length; ++i) {
                if (list.childNodes[i].value == index || list.childNodes[i].value == 0) {
                    listelement = list.childNodes[i];
                    listelement.value = index;
                    listelement.innerHTML = msg;
                    break;
                }
            }

            return listelement;
        }

        function addHeading(text, list) {
            var newtext = document.createTextNode(text);
            main.insertBefore(newtext, list);
        }

        function removeHeading(text) {
            for (var i = 0; i < main.childNodes.length; ++i) {
                if (main.childNodes[i].nodeType == 3 && main.childNodes[i].nodeValue == text) {
                    main.removeChild(main.childNodes[i]);
                    break;
                }
            }
        }

        function removeElementFromList(index, list) {
            for (var i = 0; i < list.childNodes.length; ++i) {
                if (list.childNodes[i].value == index) {
                    list.removeChild(list.childNodes[i]);
                    break;
                }
            }
        }

        function quoteRequestMsg(quoterequest) {
            var msg;

            if (quoterequest.quantity != "") {
                msg = quoterequest.quantity;
            } else {
                msg = quoterequest.cashorderqty + " (value)";
            }

            msg += " " + quoterequest.symbol + " requested in " + quoterequest.settlcurrency + ", T+" + quoterequest.nosettdays + " at " + formatUTCDateTime(quoterequest.timestamp);

            return msg;
        }

        function quoteMsg(quote) {
            var msg;

            msg = quote.symbol + ", quoted " + quote.bidpx + " " + quote.settlcurrency + " to Sell, " + quote.offerpx + " " + quote.settlcurrency + " to Buy, at " + formatUTCDateTime(quote.transacttime) + ", quote id " + quote.quoteid;

            if ('orderid' in quote) {
                msg += ", order id " + quote.orderid;
            } else {
                msg += ", no order placed";
            }

            return msg;
        }

        function orderNewMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }
            msg += " " + getOrdertypeDesc(order.ordertype) + ", order id " + order.orderid + ", placed at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderFillMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }
            msg += " " + getOrdertypeDesc(order.ordertype);
            if (order.remquantity > 0) {
                msg += ", " + order.remquantity + " remaining";
            }
            msg += ", order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderRejectMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.remquantity + " " + order.symbol;

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += " " + getOrdertypeDesc(order.ordertype) + ", rejected, reason: " + getReasonDesc(order.reason);

            if (order.text != "") {
                msg += " " + order.text;
            }

            msg += ", order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderCancelMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol + ", " + order.remquantity + " remaining";

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += " " + getOrdertypeDesc(order.ordertype) + ", cancelled, order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function orderExpireMsg(order) {
            var msg = getSideDesc(order.side) + " " + order.quantity + " " + order.symbol + ", " + order.remquantity + " remaining";

            if ('price' in order) {
                msg += " @ " + order.price;
            }

            msg += " " + getOrdertypeDesc(order.ordertype) + ", expired, order id " + order.orderid + ", at " + formatUTCDateTime(order.timestamp);

            return msg;
        }

        function tradeMsg(trade) {
            var msg;

            msg = getSideDescTrade(trade.side) + " " + trade.quantity + " " + trade.symbol;

            if (instruments[trade.symbol].instrumenttype == "DE") {
                if (trade.nosettdays != 3) {
                    msg += " T+" + trade.nosettdays;
                }
            }

            msg += " @ " + trade.price;

            if (trade.settlcurrency != "GBP" || trade.settlcurrency != trade.currency) {
                msg += " (" + trade.settlcurrency + ")"
            }

            msg += ", trade id: " + trade.tradeid + ", order id: " + trade.orderid + ", executed " + formatUTCDateTime(trade.timestamp);

            return msg;
        }

        function marginMsg(margin) {
            return parseFloat(margin.amount).toFixed(2) + " " + margin.currency;
        }

        function getSideDescTrade(side) {
            if (side == "1") {
                return "Bought ";
            } else {
                return "Sold ";
            }
        }

        function positionMsg(position) {
            var msg;

            if (position.quantity > 0) {
                msg = "Long ";
            } else {
                msg = "Short ";
            }
            msg += position.quantity + " " + position.symbol + " cost " + parseFloat(position.cost).toFixed(2) + " " + position.currency;

            return msg;
        }

        function reserveMsg(reserve) {
            return reserve.quantity + " " + reserve.symbol + " " + reserve.currency;
        }

        function orderCancelReject(ordercancelreject) {
            alert("Request to cancel order #" + ordercancelreject.orderid + " rejected, reason: " + ordercancelreject.reasondesc);
        }

        function updateTrade(trade) {
            var msg;

            trades[trade.tradeid] = trade;

            if (selectedmenu == 0) {
                if (!(trade.symbol in orderbooks)) { return; }
                msg = tradeMsg(trade);
                addMessageToDiv(msg, "orderdiv:" + trade.symbol, trade.symbol);
            } else if (selectedmenu == 3) {
                msg = tradeMsg(trade);
                if (updateElement(msg, list1, trade.tradeid) == null) {
                    addElement(msg, list1, trade.tradeid);
                }
            }
        }

        function updatePosition(position) {
            var msg;
            //var poskey = position.symbol + ":" + position.currency;
            var poskey = position.positionid;

            if (position.quantity == 0) {
                delete positions[poskey];

                if (selectedmenu == 4) {
                    removeElementFromList(poskey, list1);
                }
            } else {
                positions[poskey] = position;

                if (selectedmenu == 4) {
                    msg = positionMsg(position);
                    if (updateElement(msg, list1, poskey) == null) {
                        addElement(msg, list1, poskey);
                    }
                }
            }
        }

        function updateCash(cashitem) {
            var msg;

            if (cashitem.amount == 0) {
                delete cash[cashitem.currency];

                if (selectedmenu == 5) {
                    removeElementFromList(cashitem.currency, list1);
                }
            } else {
                cash[cashitem.currency] = cashitem;

                // display if we are looking at cash
                if (selectedmenu == 5) {
                    msg = JSON.stringify(cashitem);
                    if (updateElement(msg, list1, cashitem.currency) == null) {
                        addElement(msg, list1, cashitem.currency);
                    }
                }
            }
        }

        function updateMargin(margin) {
            var msg;

            if (margin.amount == 0) {
                delete margins[margin.currency];

                if (selectedmenu == 5) {
                    removeElementFromList(margin.currency, list2);

                    if (list2.childNodes.length == 0) {
                        removeHeading("Margin");
                    }
                }
            } else {
                margins[margin.currency] = margin;

                // display if we are looking at cash
                if (selectedmenu == 5) {
                    msg = marginMsg(margin);

                    if (updateElement(msg, list2, margin.currency) == null) {
                        addElement(msg, list2, margin.currency);
                    }
                }
            }
        }

        function updateReserve(reserve) {
            var msg;

            if (reserve.quantity == 0) {
                delete reserves[reserve.symbol];

                if (selectedmenu == 5) {
                    removeElementFromList(reserve.symbol, list3);

                    if (list2.childNodes.length == 0) {
                        removeHeading("Reserved");
                    }
                }
            } else {
                reserves[reserve.symbol] = reserve;

                // display if we are looking at cash
                if (selectedmenu == 5) {
                    msg = JSON.stringify(reserve);
                    if (updateElement(msg, list3, reserve.symbol) == null) {
                        addElement(msg, list3, reserve.symbol);
                    }
                }
            }
        }

        function updateOrderBook(orderbook) {
            var level;

            // create an entry in the orderbooks array for this symbol
            if (!(orderbook.symbol in orderbooks)) {
                // 6 levels
                orderbooks[orderbook.symbol] = [{ bid: 0, offer: 0 }, { bid: 0, offer: 0 }, { bid: 0, offer: 0 }, { bid: 0, offer: 0 }, { bid: 0, offer: 0 }, { bid: 0, offer: 0 }];
            }

            // update the prices
            for (var i = 0; i < orderbook.prices.length; ++i) {
                level = orderbook.prices[i].level - 1;

                if ("bid" in orderbook.prices[i]) {
                    if (orderbook.prices[i].bid > orderbooks[orderbook.symbol][level].bid) {
                        orderbooks[orderbook.symbol][level].lastbidchange = 1;
                    } else if (orderbook.prices[i].bid < orderbooks[orderbook.symbol][level].bid) {
                        orderbooks[orderbook.symbol][level].lastbidchange = 2;
                    } else {
                        orderbooks[orderbook.symbol][level].lastbidchange = 0;
                    }
                    orderbooks[orderbook.symbol][level].bid = orderbook.prices[i].bid;
                    orderbooks[orderbook.symbol][level].bidflashcount = 3;
                    priceflash[orderbook.symbol] = true;
                }
                if ("offer" in orderbook.prices[i]) {
                    if (orderbook.prices[i].offer > orderbooks[orderbook.symbol][level].offer) {
                        orderbooks[orderbook.symbol][level].lastofferchange = 1;
                    } else if (orderbook.prices[i].offer < orderbooks[orderbook.symbol][level].offer) {
                        orderbooks[orderbook.symbol][level].lastofferchange = 2;
                    } else {
                        orderbooks[orderbook.symbol][level].lastofferchange = 0;
                    }
                    orderbooks[orderbook.symbol][level].offer = orderbook.prices[i].offer;
                    orderbooks[orderbook.symbol][level].offerflashcount = 3;
                    priceflash[orderbook.symbol] = true;
                }
            }

            if (selectedmenu == 0) {
                displayOrderBook(orderbook.symbol);
            }
        }

        function removeOrderBook(symbol) {
            var stockboxinput;

            if (symbol in orderbooks) {
                clearSymbolDiv(symbol);
                clearAllStrips(symbol);

                if (obdisplay[symbol].previoussymbol != null) {
                    if (obdisplay[symbol].insertbefore != null) {
                        obdisplay[obdisplay[symbol].previoussymbol].insertbefore = obdisplay[symbol].insertbefore;
                    } else {
                        obdisplay[obdisplay[symbol].previoussymbol].insertbefore = null;
                    }
                }

                if (obdisplay[symbol].insertbefore != null) {
                    if (obdisplay[symbol].previoussymbol != null) {
                        obdisplay[obdisplay[symbol].insertbefore].previoussymbol = obdisplay[symbol].previoussymbol;
                    } else {
                        obdisplay[obdisplay[symbol].insertbefore].previoussymbol = null;
                    }
                }

                if (symbol == lastsymbol) {
                    if (obdisplay[symbol].previoussymbol != null) {
                        lastsymbol = obdisplay[symbol].previoussymbol;
                    } else {
                        lastsymbol = null;
                    }
                }

                delete obdisplay[symbol];
                delete orderbooks[symbol];
                delete priceflash[symbol];

                if (Object.keys(orderbooks).length == 0) {
                    clearOrderBookHeadings();
                }

                stockboxinput = document.getElementById("stockboxinput");
                if (stockboxinput != null) {
                    stockboxinput.focus();
                }
            }
        }

        function newbutton(id, value, classname, form) {
            var button = document.createElement("input");
            button.type = "button";
            button.id = id;
            button.value = value;
            if (classname != "") {
                button.className = classname;
            }
            form.appendChild(button);
            return button;
        }

        function addNewLine(frm, id) {
            var newline = document.createElement("label");
            newline.innerHTML = "<br>";
            if (id != null) {
                newline.id = id;
            }
            frm.appendChild(newline);
            return newline;
        }

        function displayChat() {
            var chattext;
            var chatbtn;
            var chattextlen;
            var chatid;

            var chatdiv = getDiv("chatdiv", null);

            chattext = document.createElement("textarea");
            chattext.id = "chattext";

            chatdiv.appendChild(chattext);

            addNewLine(chatdiv);

            chatbtn = newbutton("chatbtn", "Send", "chatbtn", chatdiv);

            chatbtn.onclick = function () {
                var newchat = {};

                newchat.chatid = chatid.value;
                newchat.clientid = clientid;
                newchat.text = chattext.value.substr(chattextlen.value);

                sockjs.send("{\"chat\":" + JSON.stringify(newchat) + "}");

                chattext.focus();
            }

            chattextlen = document.createElement("input");
            chattextlen.type = "hidden";
            chattextlen.id = "chattextlen";

            chatid = document.createElement("input");
            chatid.type = "hidden";
            chatid.id = "chatid";
            chatid.value = "0";

            chatdiv.appendChild(chattextlen);
            chatdiv.appendChild(chatid);

            main.appendChild(chatdiv);

            chattext.focus();
            chattext.value = ">>";
            chattextlen.value = 2;
        }

        function newChat(chat) {
            var chattext;
            var chattextlen;
            var chatid;

            chattext = document.getElementById("chattext");
            if (chattext != null) {
                chattext.focus();

                chattext.value += "\n" + chat.text + "\n" + ">>";

                chattextlen = document.getElementById("chattextlen");
                if (chattextlen != null) {
                    chattextlen.value = chattext.value.length;
                }
            }

            chatid = document.getElementById("chatid");
            if (chatid != null) {
                chatid.value = chat.chatid;
            }
        }

        function displayOrderBook(symbol) {
            var strip;
            var display = {};
            var bidprice;
            var offerprice;
            var bidquantity;
            var offerquantity;
            var level2;
            var stock;
            var slash;
            var y;
            var removestock;
            var orderdiv;
            var nextsymbol;
            var links;

            if (!(symbol in orderbooks)) {
                return;
            }

            if (!(symbol in obdisplay)) {
                display.level2 = false;
                display.insertbefore = null;
                display.previoussymbol = null;
                obdisplay[symbol] = display;

                displayOrderBookHeadings();

                if (lastsymbol != null) {
                    obdisplay[lastsymbol].insertbefore = symbol;
                    obdisplay[symbol].previoussymbol = lastsymbol;
                }
                lastsymbol = symbol;
            }

            for (y = 0; y < orderbooks[symbol].length; ++y) {
                strip = document.getElementById("strip:" + symbol + ":" + y);
                if (strip != null) {
                    bidprice = document.getElementById("bidprice:" + symbol + ":" + y);
                    offerprice = document.getElementById("offerprice:" + symbol + ":" + y);
                    bidquantity = document.getElementById("bidquantity:" + symbol + ":" + y);
                    offerquantity = document.getElementById("offerquantity:" + symbol + ":" + y);
                } else {
                    // first time through, so create elements
                    strip = document.createElement('div');
                    strip.id = "strip:" + symbol + ":" + y;

                    if (!touchdevice) {
                        strip.onmouseover = function () {
                            links.style.visibility = "visible";
                        }
                        strip.onmouseout = function () {
                            links.style.visibility = "hidden";
                        }
                    }

                    if (showvolume) {
                        level2 = document.createElement('span');
                        level2.className = "level2";
                    }

                    stock = document.createElement('span');
                    stock.className = "stock";
                    bidprice = document.createElement('span');
                    bidprice.id = "bidprice:" + symbol + ":" + y;
                    bidprice.title = "Place a new sell order";
                    bidprice.onclick = function () { setOrderPrice(this, "2", symbol); }
                    offerprice = document.createElement('span');
                    offerprice.id = "offerprice:" + symbol + ":" + y;
                    offerprice.title = "Place a new buy order";
                    offerprice.onclick = function () { setOrderPrice(this, "1", symbol); }

                    if (showvolume) {
                        bidquantity = document.createElement('span');
                        bidquantity.className = "bidquantity";
                        bidquantity.id = "bidquantity:" + symbol + ":" + y;
                        bidquantity.title = "Place a new sell order";
                        bidquantity.onclick = function () { setOrderQuantity(this, "2", symbol); }
                        offerquantity = document.createElement('span');
                        offerquantity.className = "offerquantity";
                        offerquantity.id = "offerquantity:" + symbol + ":" + y;
                        offerquantity.title = "Place a new buy order";
                        offerquantity.onclick = function () { setOrderQuantity(this, "1", symbol); }
                    }

                    slash = document.createElement('span');
                    slash.className = "slash";
                    slash.innerHTML = " ";
                    removestock = document.createElement('span');
                    removestock.className = "removestock";

                    if (y == 0) {
                        strip.className = "yellowstrip";

                        links = document.createElement('div');

                        if (!touchdevice) {
                            links.style.visibility = "hidden";
                        }

                        var reqquotelnk = newlink("reqquotelnk", "Request Quote", "", links);
                        var buyorderlnk = newlink("buyorderlnk", "Limit Buy", "", links);
                        var sellorderlnk = newlink("sellorderlnk", "Limit Sell", "", links);
                        var clearquotelnk = newlink("clearquotelnk", "Clear Ticket", "", links);

                        reqquotelnk.onclick = function () { requestQuote(symbol); }
                        buyorderlnk.onclick = function () { placeOrder(symbol, '1', 0, 0); }
                        sellorderlnk.onclick = function () { placeOrder(symbol, '2', 0, 0); }
                        clearquotelnk.onclick = function () { clearSymbolDiv(symbol); }

                        if (showvolume) {
                            level2.onclick = function () {
                                clearAllStrips(symbol);
                                obdisplay[symbol].level2 = !obdisplay[symbol].level2;
                                displayOrderBook(symbol);
                            }

                            if (obdisplay[symbol].level2) {
                                level2.title = "hide depth";
                                level2.innerHTML = "-";
                            } else {
                                level2.title = "show depth";
                                level2.innerHTML = "+";
                            }
                        }

                        stock.innerHTML = symbol;
                        stock.title = "Request a quote";

                        stock.onclick = function () {
                            requestQuote(symbol);
                        }

                        removestock.innerHTML = "x";
                        removestock.title = "Remove from watch list";

                        removestock.onclick = function () {
                            if (symbol in obdisplay) {
                                removeOrderBook(symbol);
                                sockjs.send("{\"orderbookremoverequest\":" + JSON.stringify(symbol) + "}");
                            } else {
                                alert(symbol + " not in watch list");
                            }
                        }
                    } else {
                        strip.className = "depthstrip";
                    }

                    if (showvolume) {
                        strip.appendChild(level2);
                    }
                    strip.appendChild(stock);
                    if (showvolume) {
                        strip.appendChild(bidquantity);
                    }
                    strip.appendChild(bidprice);
                    strip.appendChild(slash);
                    strip.appendChild(offerprice);
                    if (showvolume) {
                        strip.appendChild(offerquantity);
                    }
                    strip.appendChild(removestock);

                    if (y == 0) {
                        strip.appendChild(links);
                    }

                    orderdiv = document.getElementById("orderdiv:" + symbol);

                    if (orderdiv != null) {
                        main.insertBefore(strip, orderdiv);
                    } else if (obdisplay[symbol].insertbefore == null) {
                        main.appendChild(strip);
                    } else {
                        nextsymbol = document.getElementById("strip:" + obdisplay[symbol].insertbefore + ":0");
                        main.insertBefore(strip, nextsymbol);
                    }
                }

                priceChange(symbol, y, bidprice, offerprice);

                bidprice.innerHTML = orderbooks[symbol][y].bid;
                offerprice.innerHTML = orderbooks[symbol][y].offer;

                if (showvolume) {
                    bidquantity.innerHTML = orderbooks[symbol][y].bidsize;
                    offerquantity.innerHTML = orderbooks[symbol][y].offersize;
                }

                if (!obdisplay[symbol].level2) { break; }
            }
        }

        function priceChange(symbol, y, bidprice, offerprice) {
            if (y == 0) {
                // bid
                if (orderbooks[symbol][y].bidflashcount > 0) {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "yellowstripbidflashup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "yellowstripbidflashdn";
                    } else {
                        bidprice.className = "yellowstripbidflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "yellowstripbidup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "yellowstripbiddn";
                    } else {
                        bidprice.className = "yellowstripbidnochange";
                    }
                }

                // offer
                if (orderbooks[symbol][y].offerflashcount > 0) {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "yellowstripofferflashup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "yellowstripofferflashdn";
                    } else {
                        offerprice.className = "yellowstripofferflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "yellowstripofferup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "yellowstripofferdn";
                    } else {
                        offerprice.className = "yellowstripoffernochange";
                    }
                }
            } else {
                // bid
                if (orderbooks[symbol][y].bidflashcount > 0) {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "bidflashup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "bidflashdn";
                    } else {
                        bidprice.className = "bidflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastbidchange == 1) {
                        bidprice.className = "bidup";
                    } else if (orderbooks[symbol][y].lastbidchange == 2) {
                        bidprice.className = "biddn";
                    } else {
                        bidprice.className = "bidnochange";
                    }
                }

                // offer
                if (orderbooks[symbol][y].offerflashcount > 0) {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "offerflashup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "offerflashdn";
                    } else {
                        offerprice.className = "offerflashnochange";
                    }
                } else {
                    if (orderbooks[symbol][y].lastofferchange == 1) {
                        offerprice.className = "offerup";
                    } else if (orderbooks[symbol][y].lastofferchange == 2) {
                        offerprice.className = "offerdn";
                    } else {
                        offerprice.className = "offernochange";
                    }
                }
            }
        }

        function displayOrderBookHeadings() {
            var headingstrip;
            var headinglevel2;
            var headingstock;
            var headingbidquantity;
            var headingbidprice;
            var headingofferprice;
            var headingofferquantity;
            var headingslash;

            if (Object.keys(orderbooks).length == 0) {
                return;
            }

            headingstrip = document.getElementById("headingstrip");
            if (headingstrip != null) {
                return;
            }

            headingstrip = document.createElement('div');
            headingstrip.id = "headingstrip";
            headingstrip.className = "headingstrip";
            if (showvolume) {
                headinglevel2 = document.createElement('span');
                headinglevel2.className = "level2heading";
            }
            headingstock = document.createElement('span');
            headingstock.innerHTML = "Symbol";
            headingstock.className = "stockheading";
            if (showvolume) {
                headingbidquantity = document.createElement('span');
                headingbidquantity.innerHTML = "Bid Vol";
                headingbidquantity.className = "bidquantityheading";
            }
            headingbidprice = document.createElement('span');
            headingbidprice.innerHTML = "Bid";
            headingbidprice.className = "bidheading";
            headingofferprice = document.createElement('span');
            headingofferprice.innerHTML = "Offer";
            headingofferprice.className = "offerheading";
            if (showvolume) {
                headingofferquantity = document.createElement('span');
                headingofferquantity.innerHTML = "Offer Vol";
                headingofferquantity.className = "offerquantityheading";
            }
            headingslash = document.createElement('span');
            headingslash.innerHTML = " ";
            headingslash.className = "slashheading";

            if (showvolume) {
                headingstrip.appendChild(headinglevel2);
            }
            headingstrip.appendChild(headingstock);
            if (showvolume) {
                headingstrip.appendChild(headingbidquantity);
            }
            headingstrip.appendChild(headingbidprice);
            headingstrip.appendChild(headingslash);
            headingstrip.appendChild(headingofferprice);
            if (showvolume) {
                headingstrip.appendChild(headingofferquantity);
            }

            main.appendChild(headingstrip);
        }

        function requestQuote(symbol) {
            var quotereqbutton;
            var quotereqqty;
            var stocklabel;
            var settlabel;
            var orderdiv;
            var quantity;
            var cashorderqty;
            var settlcurrency;
            var currencysel;
            var qtyascashorshares = 1; // 1=shares, 2=cash
            var settlperiod;
            var nosettdays;

            clearSymbolDiv(symbol);

            quotereqbutton = document.createElement("input");
            quotereqbutton.type = "button";
            quotereqbutton.className = "quotereqbutton";
            quotereqbutton.id = "quotereqbutton" + symbol;
            quotereqbutton.value = "Request a quote";

            quotereqbutton.onclick = function () {
                sendIt();
            }

            quantitycashsel = document.createElement("select");
            quantitycashsel.id = "quantitycashsel" + symbol;
            quantitycashsel.className = "quantitycashsel";

            quantitycashsel[0] = new Option("Number of shares", 1, true, true);
            quantitycashsel[1] = new Option("Cash amount", 2, false, false);

            quantitycashsel.onchange = function () {
                qtyascashorshares = quantitycashsel[quantitycashsel.selectedIndex].value;
                quotereqqty.placeholder = getQuantityDesc(qtyascashorshares);
                quotereqqty.focus();
            }

            quotereqqty = document.createElement("input");
            quotereqqty.id = "quotereqquantity" + symbol;
            quotereqqty.className = "quotereqquantity";
            quotereqqty.placeholder = getQuantityDesc(qtyascashorshares);

            quotereqqty.onkeypress = function (event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            stocklabel = document.createElement("label");
            stocklabel.className = "orderstock";
            stocklabel.innerHTML = symbol;

            settlabel = document.createElement("label");
            settlabel.className = "quotereqlabel";
            settlabel.innerHTML = " for settlement ";

            settlcurrency = defaultsettlcurrency;

            // option to change settlement currency for non-uk shares
            if (instruments[symbol].currency != defaultsettlcurrency) {
                settlabel.innerHTML = settlabel.innerHTML + "in ";
                currencysel = document.createElement("select");
                currencysel.id = "currency" + symbol;
                currencysel.className = "currency";
                currencysel[0] = new Option(defaultsettlcurrency, defaultsettlcurrency, true, true);
                currencysel[1] = new Option(instruments[symbol].currency, instruments[symbol].currency, false, false);

                currencysel.onchange = function () {
                    settlcurrency = currencysel[currencysel.selectedIndex].value;
                }
            }

            settlperiod = document.createElement("select");
            settlperiod.id = "settlperiod:" + symbol;

            populateSettlPeriod(settlperiod, instruments[symbol].instrumenttype);

            orderdiv = getDiv("orderdiv:" + symbol, symbol);

            orderdiv.appendChild(quotereqbutton);
            orderdiv.appendChild(quantitycashsel);
            orderdiv.appendChild(quotereqqty);
            orderdiv.appendChild(stocklabel);
            orderdiv.appendChild(settlabel);
            if (instruments[symbol].currency != defaultsettlcurrency) {
                orderdiv.appendChild(currencysel);
            }
            orderdiv.appendChild(settlperiod);

            function sendIt() {
                if (validateNumeric(quotereqqty, getQuantityDesc(qtyascashorshares))) {
                    if (qtyascashorshares == 1) {
                        quantity = quotereqqty.value;
                        cashorderqty = "";
                    } else {
                        cashorderqty = quotereqqty.value;
                        quantity = "";
                    }

                    nosettdays = settlperiod[settlperiod.selectedIndex].value;

                    sendRequestQuote(symbol, quantity, cashorderqty, instruments[symbol].currency, settlcurrency, nosettdays);
                    disable();
                } else {
                    quotereqqty.focus();
                }
            }

            function disable() {
                quotereqbutton.disabled = true;
                quotereqqty.disabled = true;
                quotereqqty.onkeypress = null;
            }

            quotereqqty.focus();
        }

        function getQuantityDesc(qtyval) {
            var qtydesc;

            if (qtyval == 1) {
                qtydesc = "Quantity";
            } else {
                qtydesc = "Cash Amt";
            }

            return qtydesc;
        }

        // todo: get it right
        function formatToUTCDate(day, month, year) {
            if (day.length == 1) {
                day = "0" + day;
            }
            if (month.length == 1) {
                month = "0" + month;
            }
            return year + month + day;
        }

        function formatToUTCTime(hour, minute, second) {
            return (hour + ":" + minute + ":" + second);
        }

        function formatUTCDate(utcdate) {
            var month = parseInt(utcdate.substr(4, 2));
            return (utcdate.substr(6, 2) + " " + monthtext[month - 1] + " " + utcdate.substr(0, 4));
        }

        function formatUTCDateTime(utcdatetime) {
            return (formatUTCDate(utcdatetime) + utcdatetime.substr(8));
        }

        function getDiv(divid, symbol) {
            var div = document.getElementById(divid);

            if (div == null) {
                div = document.createElement("div");
                div.id = divid;
                displayElement(div, symbol);
            }

            return div;
        }

        function displayElement(element, symbol) {
            var nextsymbol;

            if (symbol == null || obdisplay[symbol].insertbefore == null) {
                main.appendChild(element);
            } else {
                nextsymbol = document.getElementById("strip:" + obdisplay[symbol].insertbefore + ":0");
                main.insertBefore(element, nextsymbol);
            }
        }

        function clearElementById(element) {
            var elem = document.getElementById(element);
            if (elem != null) {
                elem.parentNode.removeChild(elem);
            }
        }

        function sendRequestQuote(symbol, quantity, cashorderqty, currency, settlcurrency, nosettdays) {
            var quotereq = {};
            var msg;

            quotereq.clientid = clientid;
            quotereq.quantity = quantity;
            quotereq.cashorderqty = cashorderqty;
            quotereq.symbol = symbol;
            quotereq.currency = currency;
            quotereq.settlcurrency = settlcurrency;
            quotereq.nosettdays = nosettdays;
            quotereq.operatortype = operatortype;
            quotereq.operatorid = clientid;

            sockjs.send("{\"quoterequest\":" + JSON.stringify(quotereq) + "}");

            msg = "Placed a quote request for ";
            if (quantity != "") {
                msg += quantity;
            } else {
                msg += cashorderqty + " " + settlcurrency + " of";
            }

            if (instruments[symbol].instrumenttype == "DE") {
                msg += " " + symbol + " for settlement T+" + nosettdays;
            } else {
                msg += " " + symbol + " for rolling settlement";
            }

            if (settlcurrency != instruments[symbol].currency) {
                msg += " in " + settlcurrency;
            }

            msglabel = document.createElement("label");
            msglabel.innerHTML = msg;

            addMessageToDiv(msg, "orderdiv:" + symbol, symbol);
        }

        function validateNumeric(field, fieldname) {
            if (field.value == "") {
                alert("Enter a " + fieldname);
                field.focus();
                return false;
            } else if (isNaN(field.value)) {
                alert(fieldname + " must be numeric");
                field.focus();
                return false;
            } else if (field.value <= 0) {
                alert(fieldname + " must be greater than zero");
                field.focus();
                return false;
            }

            return true;
        }

        function clearDiv(divid) {
            var div = document.getElementById(divid);
            if (div != null) {
                while (div.hasChildNodes()) {
                    div.removeChild(div.childNodes[0]);
                }
                main.removeChild(div);
            }
        }

        function addMessageToDiv(msg, divid, symbol) {
            var div;
            var msglabel;

            div = document.getElementById(divid);
            if (div == null) {
                div = getDiv(divid, symbol);
            }

            msglabel = document.createElement("label");
            msglabel.innerHTML = "<br>" + msg;

            div.appendChild(msglabel);
        }

        function quoteAckReceived(quoteack) {
            msg = " Quote request rejected, reason: " + quoteack.quoterejectreasondesc;
            if ('text' in quoteack && quoteack.text != "") {
                msg += ", " + quoteack.text;
            }
            addMessageToDiv(msg, "orderdiv:" + quoteack.symbol, quoteack.symbol);
            return;
        }

        function quoteReceived(quote) {
            var buybutton;
            var sellbutton;
            var timerlabel;
            var numsecsremaining;
            var timertext = "Seconds Remaining";
            var orderdiv;
            var msg;
            var sellmsg;
            var buymsg;
            var refreshbutton;
            var clearbutton;

            quotes[quote.quoteid] = quote;

            clearSymbolDiv(quote.symbol);

            sellmsg = "Sell " + quote.bidquantity + " " + quote.symbol;
            buymsg = "Buy " + quote.offerquantity + " " + quote.symbol;

            if (quote.nosettdays != "3" && quote.nosettdays != "0") {
                sellmsg += " " + "T+" + quote.nosettdays;
                buymsg += " " + "T+" + quote.nosettdays;
            }

            sellmsg += " @ " + quote.bidpx;
            buymsg += " @ " + quote.offerpx;

            if (parseFloat(quote.bidfinance) != 0) {
                sellmsg += ", finance " + quote.bidfinance;
                if (quote.nosettdays == "0") {
                    sellmsg += " per day";
                }
            }
            if (parseFloat(quote.offerfinance) != 0) {
                buymsg += ", finance " + quote.offerfinance;
                if (quote.nosettdays == "0") {
                    buymsg += " per day";
                }
            }

            if (quote.settlcurrency != "GBP" || quote.settlcurrency != instruments[quote.symbol].currency) {
                sellmsg += " " + quote.settlcurrency;
                buymsg += " " + quote.settlcurrency;
            }

            sellbutton = document.createElement("input");
            sellbutton.type = "button";
            sellbutton.className = "quotesellbutton";
            sellbutton.value = sellmsg;

            sellbutton.onclick = function () {
                sendOrder(quote.symbol, '2', quote.bidquantity, quote.bidpx, 'D', quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "");
                disable();
            }

            buybutton = document.createElement("input");
            buybutton.type = "button";
            buybutton.className = "quotebuybutton";
            buybutton.value = buymsg;

            buybutton.onclick = function () {
                sendOrder(quote.symbol, '1', quote.offerquantity, quote.offerpx, 'D', quote.settlcurrency, quote.nosettdays, quote.futsettdate, quote.quoteid, "4", "", "");
                disable();
            }

            refreshbutton = document.createElement("input");
            refreshbutton.type = "button";
            refreshbutton.className = "refreshbutton";
            refreshbutton.value = "Refresh Quote";

            refreshbutton.onclick = function () {
                sendRequestQuote(quote.symbol, quote.bidquantity, "", instruments[quote.symbol].currency, quote.settlcurrency, quote.nosettdays);
                disable();
            }

            clearbutton = document.createElement("input");
            clearbutton.type = "button";
            clearbutton.className = "refreshbutton";
            clearbutton.value = "Clear Quote";

            clearbutton.onclick = function () {
                clearQuoteTimer();
                clearSymbolDiv(quote.symbol);
            }

            numsecsremaining = parseInt(quote.noseconds);

            timerlabel = document.createElement("label");
            timerlabel.innerHTML = numsecsremaining + " " + timertext;
            timerlabel.className = "timerlabel";

            numsecsremaining = parseInt(quote.noseconds);
            quotetimer = setInterval(function () {
                numsecsremaining -= 1;
                if (numsecsremaining == 0) {
                    disable();
                    timerlabel.innerHTML = "Quote Expired";
                } else {
                    timerlabel.innerHTML = numsecsremaining + " " + timertext;
                }
            }, 1000);

            orderdiv = getDiv("orderdiv:" + quote.symbol, quote.symbol);

            orderdiv.appendChild(sellbutton);
            orderdiv.appendChild(timerlabel);
            orderdiv.appendChild(buybutton);
            addNewLine(orderdiv);
            orderdiv.appendChild(refreshbutton);
            orderdiv.appendChild(clearbutton);

            function disable() {
                clearQuoteTimer();
                buybutton.disabled = true;
                buybutton.style.cursor = 'default';
                sellbutton.disabled = true;
                sellbutton.style.cursor = 'default';
                refreshbutton.disabled = true;
                refreshbutton.style.cursor = 'default';
            }
        }

        function clearQuoteTimer() {
            clearInterval(quotetimer);
        }

        function placeOrder(symbol, side, quantity, price) {
            var stocklabel;
            var quantityinput;
            var priceinput;
            var btn;
            var ordertypesel;
            var orderdiv;
            var ordertype = '2';
            var settlabel;
            var timeinforce;
            var expiredate = "";
            var expiretime = "";
            var qtydesc;
            var timeinforcesel;
            var pricedesc;
            var settlcurrency;
            var currencysel;
            var qtyascashorshares = 1;
            var expireday;
            var expiremonth;
            var expireyear;
            var settlperiod;
            var nosettdays;

            clearSymbolDiv(symbol);

            btn = document.createElement("input");
            btn.type = "button";
            btn.id = "orderbuysell" + symbol;
            btn.value = getSideDesc(side);
            if (side == "1") {
                btn.className = "orderbuttonbuy";
            } else {
                btn.className = "orderbuttonsell";
            }

            btn.onclick = function () {
                sendIt();
            }

            quantityinput = document.createElement("input");
            quantityinput.id = "orderquantity:" + symbol;
            quantityinput.className = "orderquantity";
            quantityinput.placeholder = "Quantity";

            if (quantity != 0) {
                quantityinput.value = quantity;
            }

            quantityinput.onkeypress = function (event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            stocklabel = document.createElement("label");
            stocklabel.className = "orderstock";
            stocklabel.innerHTML = symbol + " @";

            /*ordertypesel = document.createElement("select");
            ordertypesel.id = "ordertype" + symbol;
            ordertypesel.className = "ordertype";
            for (var i in ordertypes) {
                option = document.createElement("option");
                option.setAttribute('value', i);
                option.innerHTML = ordertypes[i].description;
                ordertypesel.appendChild(option);
            }

            ordertypesel.onchange = function() {
                ordertype = ordertypesel[ordertypesel.selectedIndex].value;
                pricedisplay();
            }*/

            priceinput = document.createElement("input");
            priceinput.id = "orderprice:" + symbol;
            priceinput.className = "orderprice";
            pricedesc = "PriceLimit";
            priceinput.placeholder = pricedesc;

            priceinput.onkeypress = function (event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    sendIt();
                }
            }

            timeinforcesel = document.createElement("select");
            timeinforcesel.id = "timeinforce:" + symbol;
            timeinforcesel.className = "timeinforce";
            for (var i in timeinforces) {
                option = document.createElement("option");
                // todo: this is a hack
                if (i == 0) {
                    timeinforce = "0";
                } else if (i == 1) {
                    timeinforce = "6";
                } else if (i == 2) {
                    timeinforce = "1";
                }
                option.setAttribute('value', timeinforce);
                option.innerHTML = timeinforces[i];
                timeinforcesel.appendChild(option);
            }

            timeinforcesel.onchange = function () {
                timeinforce = timeinforcesel[timeinforcesel.selectedIndex].value;
                expiredatedisplay();
            }

            function expiredatedisplay() {
                if (timeinforce == "6") {
                    expireday = document.getElementById("expireday:" + symbol);
                    if (expireday == null) {
                        expireday = document.createElement("select");
                        expireday.id = "expireday:" + symbol;
                        expiremonth = document.createElement("select");
                        expiremonth.id = "expiremonth:" + symbol;
                        expireyear = document.createElement("select");
                        expireyear.id = "expireyear:" + symbol;
                        /*expirehour = document.createElement("select");
                        expirehour.id = "expirehour:" + symbol;
                        expireminute = document.createElement("select");
                        expireminute.id = "expireminute:" + symbol;
                        expiresecond = document.createElement("select");
                        expiresecond.id = "expiresecond:" + symbol;*/

                        populateDate(expireday, expiremonth, expireyear, new Date());
                        //populateTime(expirehour, expireminute, expiresecond);

                        orderdiv.insertBefore(expireday, settlabel);
                        orderdiv.insertBefore(expiremonth, settlabel);
                        orderdiv.insertBefore(expireyear, settlabel);
                        //orderdiv.insertBefore(expirehour, settlabel);
                        //orderdiv.insertBefore(expireminute, settlabel);
                        //orderdiv.insertBefore(expiresecond, settlabel);
                    }
                } else {
                    expireday = document.getElementById("expireday:" + symbol);
                    if (expireday != null) {
                        orderdiv.removeChild(expireday);
                    }
                    expiremonth = document.getElementById("expiremonth:" + symbol);
                    if (expiremonth != null) {
                        orderdiv.removeChild(expiremonth);
                    }
                    expireyear = document.getElementById("expireyear:" + symbol);
                    if (expireyear != null) {
                        orderdiv.removeChild(expireyear);
                    }
                    /*expirehour = document.getElementById("expirehour:" + symbol);
                    if (expirehour != null) {
                        orderdiv.removeChild(expirehour);
                    }
                    expireminute = document.getElementById("expireminute:" + symbol);
                    if (expireday != null) {
                        orderdiv.removeChild(expireminute);
                    }
                    expiresecond = document.getElementById("expiresecond:" + symbol);
                    if (expiresecond != null) {
                        orderdiv.removeChild(expiresecond);
                    }*/
                }
            }

            settlabel = document.createElement("label");
            settlabel.innerHTML = " for settlement ";
            settlabel.className = "settlabel";

            settlcurrency = defaultsettlcurrency;

            // todo: combine with quoterequest?
            if (instruments[symbol].currency != defaultsettlcurrency) {
                settlabel.innerHTML = settlabel.innerHTML + "in ";
                currencysel = document.createElement("select");
                currencysel.id = "currency" + symbol;
                currencysel.className = "currency";
                currencysel[0] = new Option(defaultsettlcurrency, defaultsettlcurrency, true, true);
                currencysel[1] = new Option(instruments[symbol].currency, instruments[symbol].currency, false, false);

                currencysel.onchange = function () {
                    settlcurrency = currencysel[currencysel.selectedIndex].value;
                }
            }

            /*settday = document.createElement("select");
            settday.id = "ordersettday:" + symbol;
            settmonth = document.createElement("select");
            settmonth.id = "ordersettmonth:" + symbol;
            settyear = document.createElement("select");
            settyear.id = "ordersettyear:" + symbol;

            populateDate(settday, settmonth, settyear, getDefaultSettleDate());*/

            settlperiod = document.createElement("select");
            settlperiod.id = "settlperiod:" + symbol;

            //settlperiod[0] = new Option("GBP", defaultsettlcurrency, true, true);

            populateSettlPeriod(settlperiod, instruments[symbol].instrumenttype);

            orderdiv = getDiv("orderdiv:" + symbol, symbol);

            orderdiv.appendChild(btn);
            orderdiv.appendChild(quantityinput);
            orderdiv.appendChild(stocklabel);
            orderdiv.appendChild(priceinput);
            //orderdiv.appendChild(ordertypesel);
            orderdiv.appendChild(timeinforcesel);
            orderdiv.appendChild(settlabel);
            if (instruments[symbol].currency != defaultsettlcurrency) {
                orderdiv.appendChild(currencysel);
            }
            //orderdiv.appendChild(settday);
            //orderdiv.appendChild(settmonth);
            //orderdiv.appendChild(settyear);
            orderdiv.appendChild(settlperiod);

            //pricedisplay();

            function disable() {
                btn.disabled = true;
                btn.style.cursor = 'default';
                quantityinput.disabled = true;
                quantityinput.onkeypress = null;
                priceinput.disabled = true;
                priceinput.onkeypress = null;
            }

            /*function pricedisable() {
                priceinput.disabled = true;
                priceinput.onkeypress = null;
            }*/

            /*function pricedisplay() {
                if (ordertype == '1') {
                    stocklabel.innerHTML = symbol;
                    priceinput = document.getElementById("orderprice:" + symbol);
                    if (priceinput != null) {
                        orderdiv.removeChild(priceinput);
                    }
                } else {
                    stocklabel.innerHTML = symbol + " @ ";
                    priceinput = document.getElementById("orderprice:" + symbol);
                    if (priceinput == null) {
                        priceinput = document.createElement("input");
                        priceinput.id = "orderprice:" + symbol;
                        priceinput.className = "orderprice";
                        priceinput.placeholder = "PriceLimit";
                        if (price != 0) {
                            priceinput.value = price;
                        }

                        priceinput.onkeypress = function(event) {
                            event = event || window.event;  // cross-browser event

                            if (event.keyCode == 13) {
                                sendIt();
                            }
                        }

                        orderdiv.insertBefore(priceinput, ordertypesel);
                        priceinput.focus();
                    }
                }
            }*/

            function sendIt() {
                var settdate = "";

                if ((!validateNumeric(quantityinput, getQuantityDesc(qtyascashorshares))) || (!validateNumeric(priceinput, pricedesc))) {
                    return;
                }

                // todo: validate timeinforce
                timeinforce = timeinforcesel[timeinforcesel.selectedIndex].value;
                if (timeinforce == "6") {
                    expiredate = formatToUTCDate(expireday.value, expiremonth.value, expireyear.value);
                    expiretime = "00:00:00";//formatToUTCTime(expirehour.value, expireminute.value, expiresecond.value);
                }

                nosettdays = settlperiod[settlperiod.selectedIndex].value;

                sendOrder(symbol, getSide(btn.value), quantityinput.value, priceinput.value, ordertype, settlcurrency, nosettdays, settdate, "", timeinforce, expiredate, expiretime, "");

                disable();
            }

            quantityinput.focus();
        }

        function populateSettlPeriod(settlperiod, instrumenttype) {
            settlperiod.options.length = 0;

            if (instrumenttype == "DE" || instrumenttype == "IE") {
                for (var i = 0; i < 10; i++) {
                    var s = i + 1;
                    if (s == 3) {
                        settlperiod[i] = new Option("T+" + s, s, true, true);
                    } else {
                        settlperiod[i] = new Option("T+" + s, s, false, false);
                    }
                }
            } else if (instrumenttype == "CCFD") {
                settlperiod[0] = new Option("T+10", 10, true, true);
            } else {
                settlperiod[0] = new Option("T+0 (Rolling)", 0, true, true);
            }
        }

        function sendOrder(symbol, side, quantity, price, ordertype, settlcurrency, nosettdays, settdate, quoteid, timeinforce, expiredate, expiretime) {
            var neworder = {};
            var msg;

            neworder.clientid = clientid;
            neworder.side = side;
            neworder.quantity = quantity;
            neworder.symbol = symbol;
            neworder.currency = instruments[symbol].currency;
            neworder.price = price;
            neworder.ordertype = ordertype;
            neworder.settlcurrency = settlcurrency;
            neworder.nosettdays = nosettdays;
            neworder.futsettdate = settdate;
            neworder.quoteid = quoteid;
            neworder.timeinforce = timeinforce;
            neworder.expiredate = expiredate;
            neworder.expiretime = expiretime;
            neworder.operatortype = operatortype;
            neworder.operatorid = clientid;

            sockjs.send("{\"order\":" + JSON.stringify(neworder) + "}");

            msg = "Placed order to " + getSideDesc(side) + " " + quantity + " " + symbol;
            if (price != "") {
                msg += " @ " + price;
            }
            msg += ", " + getOrdertypeDesc(ordertype);

            if (instruments[symbol].instrumenttype == "DE") {
                msg += ", for settlement T+" + nosettdays;
            } else {
                msg += ", for rolling settlement";
            }

            if (neworder.settlcurrency != "GBP" || neworder.settlcurrency != neworder.currency) {
                msg += " in " + neworder.settlcurrency;
            }

            if (quoteid != "") {
                msg += ", quote id " + quoteid;
            }

            addMessageToDiv(msg, "orderdiv:" + symbol, symbol);
        }

        function getForm(id) {
            var form = document.getElementById(id);
            if (form == null) {
                form = document.createElement("form");
                form.id = id;
            }
            return form;
        }

        function getList(liststr) {
            var list = document.getElementById(liststr);

            if (list == null) {
                list = document.createElement("list");
                list.className = "list";
                list.id = liststr;
            }

            main.appendChild(list);

            return list;
        }

        function newlabel(id, text, classname, form) {
            var label = document.createElement("label");
            label.id = id;
            if (classname != "") {
                label.className = classname;
            }
            label.innerHTML = text;
            if (form != null) {
                form.appendChild(label);
            }
            return label;
        }

        function newinput(id, classname, form, disabled, focus) {
            var input = document.createElement("input");
            input.id = id;
            if (classname != "") {
                input.className = classname;
            }
            if (disabled) {
                input.disabled = true;
            }
            if (focus) {
                input.focus();
            }
            form.appendChild(input);
            return input;
        }

        function newlink(id, text, classname, form) {
            var link = document.createElement('a');
            link.id = id;
            link.innerHTML = text;
            if (classname != "") {
                newlink.className = classname;
            }
            form.appendChild(link);
            return link;
        }

        function getSideDesc(side) {
            if (side == '1') {
                return 'Buy';
            } else {
                return 'Sell';
            }
        }

        function getSide(sidedesc) {
            if (sidedesc == 'Buy') {
                return '1';
            } else {
                return '2';
            }
        }

        function getOrdertypeDesc(ordertype) {
            if (ordertype in ordertypes) {
                return ordertypes[ordertype].description;
            } else {
                return "";
            }
        }

        function setOrderPrice(elem, side, symbol) {
            var priceelem = document.getElementById(elem.id);
            placeOrder(symbol, side, 0, priceelem.innerHTML);
        }

        function setOrderQuantity(elem, side, symbol) {
            var cumqty = 0;
            var price = 0;
            var quantityelemid;
            var quantityelem;
            var priceelem;

            for (var i = 0; i < orderbooks[symbol].length; ++i) {
                if (side == "1") {
                    quantityelemid = "offerquantity:" + symbol + ":" + i;
                } else {
                    quantityelemid = "bidquantity:" + symbol + ":" + i;
                }

                quantityelem = document.getElementById(quantityelemid);
                cumqty += parseInt(quantityelem.innerHTML);

                if (quantityelemid == elem.id) {
                    if (side == "1") {
                        priceelem = document.getElementById("offerprice:" + symbol + ":" + i);
                    } else {
                        priceelem = document.getElementById("bidprice:" + symbol + ":" + i);
                    }
                    price = priceelem.innerHTML;
                    break;
                }
            }

            placeOrder(symbol, side, cumqty, price);
        }

        function cancelOrderQuantity(elem, side, symbol) {
            var price;

            // todo: fix
            for (var i in orders) {
                if ((orders[i].status == "0" || orders[i].status == "1") && orders[i].price == price && orders[i].side == side) {
                    confirmOrderCancel(orders[i].orderid);
                }
            }
        }

        //
        // sign-in form
        //
        function displayFormSignin() {
            var frmsignin;
            var email;
            var password;
            var btnsignin;
            var cw2theading;

            clearMenu();
            clearScreen();

            cw2theading = document.getElementById('cw2t');
            cw2theading.innerHTML = coheading;

            frmsignin = document.createElement("form");
            frmsignin.id = "frmsignin";

            email = document.createElement("input");
            email.placeholder = "enter your email";
            email.className = "formsignininput";

            email.onkeypress = function (event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    disable();
                    signin();
                }
            }

            password = document.createElement("input");
            password.placeholder = "enter your password";
            password.className = "formsignininput";
            
            password.onkeypress = function (event) {
                event = event || window.event;  // cross-browser event

                if (event.keyCode == 13) {
                    disable();
                    signin();
                }
            }

            btnsignin = document.createElement("input");
            btnsignin.type = "button";
            btnsignin.value = "sign in";
            btnsignin.className = "formsigninbutton";

            btnsignin.onclick = function () {
                disable();
                signin();
            }

            if (touchdevice) {
                email.className = "formsignininputm";
                password.className = "formsignininputm";
                btnsignin.className = "formsigninbuttonm";
            }

            frmsignin.appendChild(email);
            addNewLine(frmsignin, null);
            frmsignin.appendChild(password);
            addNewLine(frmsignin, null);
            frmsignin.appendChild(btnsignin);

            main.appendChild(frmsignin);

            function disable() {
                btnsignin.disable = true;
                email.onkeypress = null;
                password.onkeypress = null;
            }

            function signin() {
                var signin = {};

                signin.email = email.value;
                signin.password = password.value;

                sockjs.send("{\"signin\":" + JSON.stringify(signin) + "}");
            }

            email.focus();
        }

        function replySignIn(reply) {
            var frm;
            var lblreason;
            var cw2theading;

            frm = document.getElementById("frmsignin");
            if (frm != null) {
                if (!reply.success) {
                    lblreason = document.getElementById("lblReason");
                    if (lblreason == null) {
                        lblreason = document.createElement("label");
                        lblreason.id = "lblReason";
                        frm.appendChild(lblreason);
                    }

                    lblreason.innerHTML = " " + reply.reason;
                } else {
                    // clear the screen
                    clearForm("frmsignin", true);

                    cw2theading = document.getElementById('cw2t');
                    cw2theading.innerHTML = coheading + " - " + reply.email;

                    clientid = reply.clientid;

                    displayWaitMsg();
                }
            }
        }

        function displayMenu() {
            var menu;
            var menuarr;
            var menuitem;

            menu = document.createElement('ul');
            menu.className = "menu";
            menu.id = "menu";

            // build the main menu
            menuarr = ["watchlist", "history", "portfolio", "settings", "chat", "signout"];
            for (var i = 0; i < menuarr.length; ++i) {
                menuitem = document.createElement("li");
                menuitem.value = i;
                menuitem.innerHTML = menuarr[i];

                if (i == 0) {
                    menuitem.className = "menuitemselected";
                    lastElement = menuitem;
                }
                menu.appendChild(menuitem);
            }

            heading.appendChild(menu);

            menu.onclick = function (e) {
                var element;

                if (!e) e = window.event;
                element = e.target || e.srcElement;

                if (element.id == "menu") {
                    return;
                }

                clearScreen();
                clearQuoteTimer();

                element.className = "menuitemselected";
                if (lastElement != null) {
                    lastElement.className = "menu";
                }
                lastElement = element;
                selectedmenu = element.value;

                switch (selectedmenu) {
                    case 0:
                        displayOrderBooks();
                        break;
                    case 1:
                        requestHistory();
                        break;
                    case 2:
                        requestPortfolio();
                        break;
                    case 3:
                        settings();
                        break;
                    case 4:
                        displayChat();
                        break;
                    case 5:
                        logout();
                        break;
                }
            }
        }

        function logout() {
            sockjs.close();
            loggedout = true;
        }

        function displayWaitMsg() {
            //addElement("Loading, please wait...", list1, "");
        }

        function requestHistory() {
            var historyrequest = {};

            var frmhistory = getForm("frmhistory");

            var lnkquoterequests = newlink("lnkquoterequests", "Quote Requests", "", frmhistory);
            var lnkquotes = newlink("lnkquotes", "Quotes", "", frmhistory);
            var lnkorders = newlink("lnkorders", "Orders", "", frmhistory);
            var lnktrades = newlink("lnktrades", "Trades", "", frmhistory);
            var lnkcash = newlink("lnkcash", "Cash", "", frmhistory);
            var lnkchat = newlink("lnkchat", "Chat", "", frmhistory);

            lnkquoterequests.onclick = function () {
                setSelected(lnkquoterequests);
                sockjs.send("{\"quoterequesthistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkquotes.onclick = function () {
                setSelected(lnkquotes);
                sockjs.send("{\"quotehistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkorders.onclick = function () {
                setSelected(lnkorders);
                sockjs.send("{\"orderhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnktrades.onclick = function () {
                setSelected(lnktrades);
                sockjs.send("{\"tradehistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkcash.onclick = function () {
                setSelected(lnkcash);
                historyrequest.currency = "GBP";
                sockjs.send("{\"cashhistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            lnkchat.onclick = function () {
                setSelected(lnkchat);
                sockjs.send("{\"chathistoryrequest\":" + JSON.stringify(historyrequest) + "}");
            }

            addNewLine(frmhistory);
            addNewLine(frmhistory);

            main.appendChild(frmhistory);

            function setSelected(link) {
                lnkquoterequests.className = "";
                lnkquotes.className = "";
                lnkorders.className = "";
                lnktrades.className = "";
                lnkchat.className = "";
                lnkcash.className = "";

                link.className = "linkselected";
            }
        }

        function requestPortfolio() {
            var frmpositions = getForm("frmpositions");

            var lnkpositions = newlink("lnkpositions", "Positions", "", frmpositions);
            var lnkcash = newlink("lnkcash", "Cash", "", frmpositions);
            //var lnkmargin = newlink("lnkmargin", "Margin", "", frmpositions);
            //var lnkreserves = newlink("lnkreserves", "Reserves", "", frmpositions);
            var lnkaccount = newlink("lnkaccount", "Account", "", frmpositions);

            lnkpositions.onclick = function () {
                var positionrequest = {};

                setSelected(lnkpositions);
                sockjs.send("{\"positionrequest\":" + JSON.stringify(positionrequest) + "}");
            }

            lnkcash.onclick = function () {
                var cashrequest = {};

                setSelected(lnkcash);
                sockjs.send("{\"cashrequest\":" + JSON.stringify(cashrequest) + "}");
            }

            /*lnkmargin.onclick = function() {
                var marginrequest = {};

                setSelected(lnkmargin);
                sockjs.send("{\"marginrequest\":" + JSON.stringify(marginrequest) + "}");
            }

            lnkreserves.onclick = function() {
                var reservesrequest = {};

                setSelected(lnkreserves);
                sockjs.send("{\"reservesrequest\":" + JSON.stringify(reservesrequest) + "}");
            }*/

            lnkaccount.onclick = function () {
                var accountrequest = {};

                setSelected(lnkaccount);
                sockjs.send("{\"accountrequest\":" + JSON.stringify(accountrequest) + "}");
            }

            main.appendChild(frmpositions);

            function setSelected(link) {
                lnkpositions.className = "";
                lnkcash.className = "";
                //lnkmargin.className = "";
                //lnkreserves.className = "";
                lnkaccount.className = "";

                link.className = "linkselected";
            }
        }

        function settings() {
            var frmsettings = getForm("frmsettings");

            var lnkpassword = newlink("lnkpassword", "Change Password", "", frmsettings);

            lnkpassword.onclick = function () {
                changePassword();
            }

            main.appendChild(frmsettings);

            function setSelected(link) {
                lnkpassword.className = "";

                link.className = "linkselected";
            }
        }

        function changePassword() {
            clearForm("frmpassword", true);

            var frmpassword = getForm("frmpassword");

            addNewLine(frmpassword);
            var lbloldpwd = newlabel("lbloldpwd", "Old Password:", "formlabel", frmpassword);
            var inpoldpwd = newinput("inpoldpwd", "forminput", frmpassword, false, true);
            addNewLine(frmpassword);
            var lblnewpwd = newlabel("lblnewpwd", "New Password:", "formlabel", frmpassword);
            var inpnewpwd = newinput("inpnewpwd", "forminput", frmpassword, false, false);
            addNewLine(frmpassword);
            var btnpwd = newbutton("btnpwd", "Update", "formbutton", frmpassword);

            btnpwd.onclick = function () {
                var pwdrequest = {};

                pwdrequest.oldpwd = inpoldpwd.value;
                pwdrequest.newpwd = inpnewpwd.value;

                sockjs.send("{\"pwdrequest\":" + JSON.stringify(pwdrequest) + "}");
            }

            main.appendChild(frmpassword);
        }

        function passwordUpdate(pwdupdate) {
            if (pwdupdate == "1") {
                alert("Password updated");
            } else {
                alert("Password not updated");
            }
        }

        function populateDate(day, month, year, defaultdate) {
            var today = new Date();
            var thisyear = today.getFullYear();

            var defaultday = defaultdate.getDate();
            var defaultmonth = defaultdate.getMonth();
            var defaultyear = defaultdate.getFullYear();
            var nummonthdays = getMonthDays(defaultyear, defaultmonth);

            populateDay(day, nummonthdays, defaultday);

            for (var m = 0; m < 12; m++) {
                if (m == defaultmonth) {
                    month[m] = new Option(monthtext[m], m + 1, true, true);
                } else {
                    month[m] = new Option(monthtext[m], m + 1, false, false);
                }
            }

            for (var y = 0; y < 2; y++) {
                if (thisyear == defaultyear) {
                    year[y] = new Option(thisyear, thisyear, true, true);
                } else {
                    year[y] = new Option(thisyear, thisyear, false, false);
                }

                thisyear += 1;
            }

            month.onchange = function () {
                var selectedday = day[day.selectedIndex].value;
                day.length = 0;
                nummonthdays = getMonthDays(year[year.selectedIndex].value, month.selectedIndex);
                populateDay(day, nummonthdays, selectedday);
            }
        }

        function populateDay(day, numdays, defaultday) {
            for (var i = 0; i < numdays; i++) {
                if (i == defaultday - 1) {
                    day[i] = new Option(i + 1, i + 1, true, true);
                } else {
                    day[i] = new Option(i + 1, i + 1, false, false);
                }
            }
        }

        function populateTime(hour, minute, second) {
            hour[0] = new Option("00", "00", true, true);
            minute[0] = new Option("00", "00", true, true);
            second[0] = new Option("00", "00", true, true);
        }

        function getDefaultSettleDate() {
            var today = new Date();

            for (var i = 0; i < 3; i++) {
                today.setDate(today.getDate() + 1);

                // ignore weekends
                if (today.getDay() == 6) {
                    today.setDate(today.getDate() + 2);
                } else if (today.getDay() == 0) {
                    today.setDate(today.getDate() + 1);
                }
            }

            return today;
        }

        function getMonthDays(year, month) {
            var isLeap = ((year % 4) == 0 && ((year % 100) != 0 || (year % 400) == 0));
            return [31, (isLeap ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
        }

        function getReasonDesc(reason) {
            var desc;

            if (reason == "") {
                return "";
            }

            switch (parseInt(reason)) {
                case 1001:
                    desc = "No currency held for this instrument";
                    break;
                case 1002:
                    desc = "Insufficient cash in settlement currency";
                    break;
                case 1003:
                    desc = "No position held in this instrument";
                    break;
                case 1004:
                    desc = "Insufficient position size in this instrument";
                    break;
                case 1005:
                    desc = "System error";
                    break;
                case 1006:
                    desc = "Invalid order";
                    break;
                case 1007:
                    desc = "Invalid instrument";
                    break;
                case 1008:
                    desc = "Order already cancelled";
                    break;
                case 1009:
                    desc = "Order not found";
                    break;
                case 1010:
                    desc = "Order already filled";
                    break;
                case 1011:
                    desc = "Order currency does not match symbol currency";
                    break;
                case 1012:
                    desc = "Order already rejected";
                    break;
                case 1013:
                    desc = "Ordercancelrequest not found";
                    break;
                case 1014:
                    desc = "Quoterequest not found";
                    break;
                case 1015:
                    desc = "Symbol not found";
                    break;
                case 1016:
                    desc = "Proquote symbol not found";
                    break;
                case 1017:
                    desc = "Client not found";
                    break;
                case 1018:
                    desc = "Client not authorised to trade this type of product";
                    break;
                case 1019:
                    desc = "Quantity greater than position quantity";
                    break;
                case 1020:
                    desc = "Insufficient free margin";
                    break;
                case 1021:
                    desc = "Order held externally";
                    break;
                case 1022:
                    desc = "Order already expired";
                    break;
                case 1023:
                    desc = "Email already exists";
                    break;
                default:
                    desc = "Unknown reason";
            }

            return desc;
        }

        function init() {
            // a replacement indexOf()
            if (!Array.prototype.indexOf) {
                Array.prototype.indexOf = function (searchElement, fromIndex) {
                    if (this === undefined || this === null) {
                        throw new TypeError('"this" is null or not defined');
                    }

                    var length = this.length >>> 0; // Hack to convert object.length to a UInt32

                    fromIndex = +fromIndex || 0;

                    if (Math.abs(fromIndex) === Infinity) {
                        fromIndex = 0;
                    }

                    if (fromIndex < 0) {
                        fromIndex += length;
                        if (fromIndex < 0) {
                            fromIndex = 0;
                        }
                    }

                    for (; fromIndex < length; fromIndex++) {
                        if (this[fromIndex] === searchElement) {
                            return fromIndex;
                        }
                    }

                    return -1;
                };
            }

            // a replacement Object.keys()
            if (!Object.keys) {
                Object.keys = (function () {
                    'use strict';
                    var hasOwnProperty = Object.prototype.hasOwnProperty,
                        hasDontEnumBug = !({ toString: null }).propertyIsEnumerable('toString'),
                        dontEnums = [
                            'toString',
                            'toLocaleString',
                            'valueOf',
                            'hasOwnProperty',
                            'isPrototypeOf',
                            'propertyIsEnumerable',
                            'constructor'
                        ],
                        dontEnumsLength = dontEnums.length;

                    return function (obj) {
                        if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
                            throw new TypeError('Object.keys called on non-object');
                        }

                        var result = [], prop, i;

                        for (prop in obj) {
                            if (hasOwnProperty.call(obj, prop)) {
                                result.push(prop);
                            }
                        }

                        if (hasDontEnumBug) {
                            for (i = 0; i < dontEnumsLength; i++) {
                                if (hasOwnProperty.call(obj, dontEnums[i])) {
                                    result.push(dontEnums[i]);
                                }
                            }
                        }
                        return result;
                    };
                }());
            }
        }

    </script>

    <div class="basebarright">
        <p><a href="mailto:terry.johnston@cantwaittotrade.com?subject=Website Contact">email</a></p>
        <p>© 2014 cant wait to trade ltd</p>
        <p>40A friar lane leicester leicestershire le1 5ra</p> 
        <p>fca registration #163296</p>
    </div>

</body>
</html>